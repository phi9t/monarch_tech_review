# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What This Repo Is

Interactive [marimo](https://marimo.io) notebooks for a GPU Mode presentation on [Monarch](https://github.com/pytorch/monarch) — PyTorch's framework for distributed actors, fault tolerance, and async RL. The notebooks progressively introduce Monarch concepts (01–04: core Monarch, 05–08: building async RL from scratch).

## Execution Policy (Zephyr Infra)

- Run commands through Zephyr container infra.
- Use `./scripts/zephyr_shell.sh` for interactive shell access (defaults to snapshot image `sygaldry/zephyr:spack`).
- Override image if needed: `./scripts/zephyr_shell.sh --image sygaldry/zephyr:base`.
- Use `./scripts/zephyr_uv_sync.sh` to manage `.venv`.
- Use `./scripts/zephyr_uv_run.sh ...` for repo commands (`marimo`, `pytest`, `ruff`, scripts).
- Do not install upstream PyTorch/CUDA wheel packages in `.venv`; Zephyr-provided packages from `/opt/spack_store/view` are the source of truth.
- For notebook launch + validation in one command, use:
  `.codex/skills/zephyr-launch-validate/scripts/launch_and_validate.sh --notebook notebooks/01_history_and_vision.py`

## Commands

```bash
# Open interactive Zephyr shell
./scripts/zephyr_shell.sh

# Install dependencies (Zephyr-managed .venv)
./scripts/zephyr_uv_sync.sh

# Run a notebook interactively (browser)
./scripts/zephyr_uv_run.sh marimo edit notebooks/01_history_and_vision.py

# Run a notebook as read-only app
./scripts/zephyr_uv_run.sh marimo run notebooks/01_history_and_vision.py

# Create a new notebook
./scripts/zephyr_uv_run.sh marimo new notebooks/09_new_topic.py

# Lint and format
./scripts/zephyr_uv_run.sh ruff check .
./scripts/zephyr_uv_run.sh ruff format .

# Run tests
./scripts/zephyr_uv_run.sh pytest

# Export all notebooks to HTML (outputs to docs/)
./scripts/export_html.sh

# Run Zorplex benchmark (requires GPU)
./scripts/zephyr_uv_run.sh scripts/run_zorplex_benchmark.py --num-samples 20
```

## Architecture

### Notebooks (`notebooks/`)
Marimo notebooks stored as plain `.py` files. Each is self-contained with marimo cell decorators (`@app.cell`). Notebooks 01–04 cover Monarch internals (actors, DevX, fault tolerance, distributed tensors). Notebooks 05–08 build up async RL (RL intro, services, RDMA weight sync, end-to-end loop). `train.py` is a standalone DDP training script used as a demo target in notebook 02.

### Source packages (`src/`)
- **`monarch_utils`** — Service infrastructure for Monarch actors. `ServiceRegistry` (singleton actor for discovery) and `Service` (manages worker replica pools with round-robin routing and health tracking). Used in notebook 06.
- **`zorplex_rl`** — Synthetic benchmark for training LLMs on multi-step tool use. `TaskSpec` subclasses define task types (simple lookup, compositional, multi-step, recursive). `evaluate.py` provides agentic generation loop with tool execution. Used in notebooks 05 and 08.
- **`rl_primitives.py`** — Shared dataclasses (`Trajectory`, `TrainMetrics`) used across the RL training pipeline in notebook 08.

### Scripts (`scripts/`)
- `export_html.sh` — Batch-exports all notebooks to `docs/` for GitHub Pages.
- `run_zorplex_benchmark.py` / `run_zorplex_eval.py` — CLI scripts to evaluate models on Zorplex tasks (require GPU).
- `test_transformers.py` / `test_vllm.py` — Quick model loading sanity checks.

### Docs (`docs/`)
Pre-exported HTML snapshots of notebooks, served via GitHub Pages. Regenerated by `export_html.sh`.

## Key Dependencies
- **torchmonarch** — The Monarch framework (actors, ProcMesh, ActorMesh, endpoints)
- **marimo** — Reactive notebook runtime (notebooks are `.py` files, not `.ipynb`)
- **torch** — On Zephyr infra, loaded from the Spack Python/site-packages instead of uv-installed wheels
- **transformers** — HuggingFace models, used in Zorplex RL benchmarks
