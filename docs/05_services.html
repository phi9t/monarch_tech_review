<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/apple-touch-icon.png" />
    <link rel="manifest" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        const scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          // Guard against race condition where iframe isn't ready
          if (!obj.contentWindow?.document?.documentElement) {
            return;
          }
          const element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          const hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          const newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((_entries) => {
          setHeight();
        });
        // Only observe if iframe content is ready
        if (obj.contentWindow?.document?.body) {
          resizeObserver.observe(obj.contentWindow.document.body);
        }
      }
    </script>
    <marimo-filename hidden>05_services.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>05 services</title>
    <script type="module" crossorigin crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/index-DGasP9Lh.js"></script>
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/preload-helper-DItdS47A.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/clsx-D8GwTfvk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/cn-BKtXLv3a.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chunk-LvLJmgfZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/react-BGmjiNul.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/compiler-runtime-DeeZ7FnK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/jsx-runtime-ZmTK25f3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/badge-Ce8wRjuQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/hotkeys-BHHWjLlp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useEventListener-DIUKKfEy.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/button-YC1gW_kJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/react-dom-C9fstfnp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/Combination-CMPwuAmi.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/menu-items-CJhvWPOk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-uzvC4uAK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/createLucideIcon-CnW3RofX.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/check-DdfN0k2d.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/select-V5IdpNiR.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/tooltip-CEc2ajau.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/use-toast-rmUWldD_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_Uint8Array-BGESiCQL.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_baseIsEqual-B9N9Mw_N.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useEvent-DO6uJBas.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/invariant-CAG_dYON.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_baseFor-Duhs3RiJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/merge-BBX6ug-N.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/zod-Cg4WLWh2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/utils-DXvhzCGS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/constants-B6Cb__3x.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/Deferred-CrO5-0RA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/config-CIrPQIbt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/uuid-DercMavo.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/DeferredRequestRegistry-CO2AyNfd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/requests-BsVD4CdD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/isSymbol-BGkTcW3U.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/toString-DlRqgfqz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_hasUnicode-CWqKLxBC.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/assertNever-CBU83Y6o.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_arrayReduce-TT0iOGKY.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useLifecycle-D35CBukS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useNonce-_Aax6sXd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useTheme-DUdVAZI8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/once-Bul8mtFs.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/capabilities-MM7JYRxj.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/createReducer-Dnna-AUO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-DBwNzi3C.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-ChS0Dc_R.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-CtsanegT.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-BIKFl48f.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-B0VqT_4z.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-TiFCI16_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-Cayq-K1c.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-BYyu59D8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-Gqv0jSNr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/stex-CtmkcLz7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/toDate-CgbKQM5E.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/cjs-CH5Rj0g8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_baseProperty-NKyJO2oh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/now-6sUe0ZdD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/debounce-B3mjKxHe.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/toInteger-CDcO32Gx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/database-zap-B9y7063w.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/main-U5Goe76G.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/cells-BpZ7g6ok.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/spinner-DaIKav-i.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chevron-right-DwagBitu.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dropdown-menu-B-6unW-7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/kbd-C3JY7O_u.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/renderShortcut-DEwfrKeS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/multi-map-C8GlnP-4.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/alert-BrGyZf9c.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/alert-dialog-DwQffb13.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dialog-CxGKN4C_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-CdxIjAOP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/label-Be1daUcS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useDebounce-D5NcotGm.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/textarea-DBO30D7K.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/numbers-iQunIAXf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/SSRProvider-CEHRCdjA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/context-JwD-oSsl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useNumberFormatter-c6GXymzg.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/usePress-Bup4EGrp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/input-pAun1m1X.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/links-DHZUhGz-.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/popover-Gz-GJzym.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/switch-8sn_4qbh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/table-C8uQmBAN.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/mode-DX8pdI-l.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useAsyncData-C4XRy1BE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/errors-2SszdW9t.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/error-banner-DUzsIXtq.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/copy-Bv2DBpIS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/memoize-BCOZVFBt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/get-6uJrSKbw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/capitalize-CmNnkG9y.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/copy-CQ15EONK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/plus-BD5o34_i.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/refresh-cw-CQd-1kjx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/trash-2-CyqGun26.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/triangle-alert-B65rDESJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/ai-model-dropdown-71lgLrLy.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/defaultLocale-D_rSvXvJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/precisionRound-BMPhtTJQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/defaultLocale-C92Rrpmf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/vega-loader.browser-CRZ52CKf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/tooltip-BGrCWNss.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/ErrorBoundary-ChCiwl15.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useInstallPackage-Bdnnp5fe.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/ImperativeModal-CUbWEBci.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/cell-link-Bw5bzt4a.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/datasource-B0OJBphG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/state-BfXVTTtD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/MarimoErrorOutput-5rudBbo3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/copy-icon-BhONVREY.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/html-to-image-DjukyIj4.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/focus-D51fcwZX.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/LazyAnyLanguageCodeMirror-yzHjsVJt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chunk-5FQGJX7Z-CVUXBqX6.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/katex-Dc8yG8NU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/markdown-renderer-DhMlG2dP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/command-DhzFN2CJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/download-BhCZMKuQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useRunCells-24p6hn99.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/purify.es-DNVQZNFu.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/RenderHTML-CQZqVk1Z.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useIframeCapabilities-DuIDx9mD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/formats-W1SWxSE3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/en-US-pRRbZZHE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/isValid-DcYggVWP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dates-Dhn1r-h6.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/maps-t9yNKYA8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/extends-B2LJnKU3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/emotion-is-prop-valid.esm-DD4AwVTU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useDateFormatter-CS4kbWl2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/range-D2UKkEg-.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/table-DZR6ewbN.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/JsonOutput-CknFTI_u.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/file-Cs1JbsV6.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/play-BPIh-ZEU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chat-components-CGlO4yUw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/isEmpty-CgX_-6Mt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chat-display-B4mGvJ0X.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useDeleteCell-5uYlTcQZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/icons-BhEXrzsb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/process-output-CagdHMzs.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/blob-CuXvdYPX.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/objectWithoutPropertiesLoose-DaPAPabU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/esm-DpMp6qko.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/add-cell-with-ai-pVFp5LZG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chart-no-axes-column-W42b2ZIs.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/square-function-CqXXKtIq.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/spec-D1kBp3jX.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/column-preview-CxMrs0B_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/toggle-jWKnIArU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/globals-DKH14XH0.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/share-CbPtIlnM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_baseSet-5Rdwpmr3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/react-resizable-panels.browser.esm-Ctj_10o2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/utilities.esm-CIPARd6-.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/floating-outline-DcxjrFFt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useAddCell-BmeZUK02.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/eye-off-BhExYOph.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/readonly-python-code-DyP9LVLc.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/file-video-camera-DW3v07j2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/types-DuQOSW7G.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/refresh-ccw-DLEiQDS3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/form-DUA_Rz_a.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/field-BEg1eC0P.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useBoolean-B1Xeh6vA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useDeepCompareMemoize-ZPd9PxYl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/types-CS34eOZi.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/prop-types-BiQYf0aU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/es-D8BOePqo.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/hasIn-CycJImp8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_baseFlatten-CUZNxU8H.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/flatten-D-7VEN0q.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/pick-B_6Qi5aM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/code-xml-XLwHyDBr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/download-B9SUL40m.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/house-DhFkiXz7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/settings-DOXWMfVd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/square-C8Tw_XXG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/bundle.esm-2AjO7UK5.js">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/cells-jmgGt1lS.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/markdown-renderer-DdDKmWlR.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/JsonOutput-B7vuddcd.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/index-CikhHYAB.css">
  
<script data-marimo="true">
    window.__MARIMO_STATIC__ = {};
    window.__MARIMO_STATIC__.files = {};
</script>
</head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "05_services.py",
            "mode": "read",
            "version": "0.19.7",
            "serverToken": "static",
            "config": {"ai": {"custom_providers": {}, "models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false, "signature_hint_on_typing": false}, "diagnostics": {"sql_linter": true}, "display": {"cell_output": "below", "code_editor_font_size": 14, "dataframes": "rich", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "medium", "reference_highlighting": true, "theme": "light"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": false}}, "mcp": {"mcpServers": {}, "presets": []}, "package_management": {"manager": "uv"}, "runtime": {"auto_instantiate": false, "auto_reload": "off", "default_csv_encoding": "utf-8", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "after_delay", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"sql_output": "auto", "width": "medium"},
            "view": {"showAppCode": true},
            "notebook": {"cells": [{"code": "import marimo as mo", "code_hash": "1d0db38904205bec4d6f6f6a1f6cec3e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hbol", "name": "_"}, {"code": "mo.md(r\"\"\"\n# Services: Building a Generator Pool\n\nWe just introduced async RL and why it matters. If you've used Claude Code or any coding-capable AI, you know that depending on the difficulty of your question, it could take a really long time to generate even one trajectory. As we showed in the previous notebook, there's also significant variance in how long generation takes.\n\nFor this reason, you'll typically want to run RL workloads with **many generator replicas running in parallel**.\n\n## The \"Service\" Abstraction\n\nWhen you get to this point, there are a few ways you could model this. A pretty natural approach is to create a **\"service\"**.\n\nIn traditional software engineering, a service is a component that:\n- Handles requests from clients\n- Can be replicated for throughput and reliability\n- Lives behind some kind of load balancer (think Kubernetes)\n\nThis idea applies here too. You *could* find and grab an off-the-shelf implementation, but since we're always working in Python, it would be nice to have a **Python-native implementation** - especially one you can easily customize to match your needs as an RL researcher.\n\n## What We'll Build\n\nThere are a lot of ideas that could go into a service, but what we'll focus on implementing here - using **pure Monarch** - is a service that can:\n\n1. **Load balance** across replicas (round-robin for simplicity, but you could implement more exotic strategies based on your workload)\n2. **Track and respond to faults** (health tracking, retry with different replica)\n3. **Be discoverable** (services register themselves, clients find them by name)\n4. **Support multi-GPU replicas** (each replica is an ActorMesh that can span multiple GPUs)\n5. **Target specific replicas** (grab a replica and keep using it - useful for stateful interactions)\n\nSince each replica is an ActorMesh, everything we build here *could* run multi-host - the abstraction supports it. For this tutorial, we'll run on a single node to keep things simple.\n\"\"\")", "code_hash": "77c5b831ba37a669455ebd5a781cd41f", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "MJUe", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Quick Recap: Monarch Actors\n\nBefore we dive in, a quick refresher on the Monarch primitives we'll use. If you've gone through the earlier notebooks, you'll recognize these:\n\n- **`@endpoint`** - Marks a method as callable from other actors. Returns a `Future` that you `.get()` to await.\n- **`__supervise__`** - Called when a child actor fails. You can log the error and decide whether to handle it.\n- **`get_or_spawn_controller`** - Gets or creates a singleton actor by name. First caller spawns it, subsequent callers get the existing one.\n- **`ActorMesh`** - A group of actors spawned together. When you call an endpoint, it runs on all actors in the mesh.\n\nWith that in mind, let's think about what API we want for our service.\n\"\"\")", "code_hash": "a05ebbee8258d6c364673351f4ef2eee", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "vblA", "name": "_"}, {"code": "mo.md(r\"\"\"\n## A Key Assumption: 1 Replica = 1 ActorMesh\n\nMost workloads we care about will need to span multiple GPUs. A 70B model needs tensor parallelism across 8 GPUs. Models like DeepSeek V3 may need to span multiple *hosts*.\n\nSo rather than treating single-GPU replicas as the default and multi-GPU as a special case, we'll make a basic assumption: **1 replica = 1 ActorMesh**.\n\nThis means:\n- Each replica is a group of workers (an ActorMesh)\n- Workers within a replica coordinate via **collectives** - each replica is its own distributed \"world\"\n- The service manages replicas, not individual workers\n\nThis design composes naturally with the existing ML ecosystem. A common pattern might be to plug **vLLM** or another inference engine into one of these meshes - it just sees a standard distributed environment.\n\nIf you happen to have a small model that fits on one GPU, you just have a replica with 1 worker. The abstraction still works.\n\"\"\")", "code_hash": "743ee67cbd5641e5f143dc9ae4d01f99", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "bkHC", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Designing the API First\n\nBefore we implement anything, let's sketch what we want the usage to look like. This helps us work backwards to the implementation.\n\n**What a client wants to do:**\n```python\n# Get a service by name\ngen_service = get_service(\"generators\")\n\n# Get a replica and call it\nreplica, replica_idx = gen_service.get_replica_with_idx()\nresult = replica.generate(task)\n\n# If something fails, mark it unhealthy and retry\ngen_service.mark_unhealthy(replica_idx)\n```\n\n**What a service wants to do on startup:**\n```python\n# Register itself so clients can find it\nregister_service(\"generators\", self)\n```\n\nThis gives us a clean separation: services register themselves, clients discover them by name. You *can* pass actor references around directly - that works fine - but referring to services by name is often a cleaner pattern, especially when services and clients are spawned independently.\n\"\"\")", "code_hash": "03717b8a6c2d29da2e6a9d9bd0479128", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "lEQa", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Service Discovery: The Registry Pattern\n\nLet's implement the discovery mechanism first. We'll create a `ServiceRegistry` singleton and wrap it with helper functions.\n\"\"\")", "code_hash": "dd567a8f958c4c88ad0d136988fc3e78", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "PKri", "name": "_"}, {"code": "from monarch.actor import Actor, endpoint, get_or_spawn_controller\n\nclass ServiceRegistry(Actor):\n    \"\"\"\n    Singleton registry for service discovery.\n\n    Found via get_or_spawn_controller(\"service_registry\", ServiceRegistry).\n    First caller spawns it, subsequent callers get the existing one.\n    \"\"\"\n\n    def __init__(self):\n        self.services: dict[str, Actor] = {}\n        print(\"[REGISTRY] ServiceRegistry spawned\")\n\n    @endpoint\n    def register(self, name: str, service) -\u003E None:\n        \"\"\"Register a service by name.\"\"\"\n        self.services[name] = service\n        print(f\"[REGISTRY] Registered '{name}'\")\n\n    @endpoint\n    def get(self, name: str):\n        \"\"\"Get a service by name.\"\"\"\n        if name not in self.services:\n            raise KeyError(f\"Service '{name}' not found\")\n        return self.services[name]\n\n    @endpoint\n    def list_services(self) -\u003E list[str]:\n        \"\"\"List all registered service names.\"\"\"\n        return list(self.services.keys())\n\n\ndef _get_registry():\n    \"\"\"Get the singleton ServiceRegistry.\"\"\"\n    return get_or_spawn_controller(\"service_registry\", ServiceRegistry).get()\n\n\ndef get_service(name: str):\n    \"\"\"Get a service by name. Raises KeyError if not found.\"\"\"\n    registry = _get_registry()\n    return registry.get.call_one(name).get()\n\n\ndef register_service(name: str, service) -\u003E None:\n    \"\"\"Register a service so others can find it by name.\"\"\"\n    registry = _get_registry()\n    registry.register.call_one(name, service).get()\n\n\ndef list_services() -\u003E list[str]:\n    \"\"\"List all registered service names.\"\"\"\n    registry = _get_registry()\n    return registry.list_services.call_one().get()", "code_hash": "526f89dbd8225f695dfa71a90e28a191", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Xref", "name": "_"}, {"code": "mo.md(r\"\"\"\nNow clients can simply call:\n```python\ngen_service = get_service(\"generators\")\n```\n\nAnd services register themselves with:\n```python\nregister_service(\"generators\", self)\n```\n\nThe registry is a singleton - `get_or_spawn_controller` ensures everyone gets the same one.\n\n## The Worker: Where the Actual Work Happens\n\nLet's define a worker actor. Each worker knows:\n- Its **replica ID** - which replica it belongs to (passed at spawn time)\n- Its **local rank** - its position within the replica's ActorMesh (0, 1, 2, ...)\n\"\"\")", "code_hash": "c410a32055a64fd2c123a2ba9248ed84", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "SFPL", "name": "_"}, {"code": "from monarch.actor import current_rank\n\nclass Worker(Actor):\n    \"\"\"A worker that does work. Knows its replica ID and local rank.\"\"\"\n\n    def __init__(self, replica_id: int, fail_rate: float = 0.0):\n        self.replica_id = replica_id\n        # Local rank within this replica's ActorMesh\n        self.local_rank = current_rank().rank  # 0, 1, 2, ... within this replica\n        self.fail_rate = fail_rate\n        self.calls = 0\n        print(f\"[WORKER] Replica {replica_id}, local rank {self.local_rank} ready\")\n\n    @endpoint\n    def ping(self) -\u003E bool:\n        \"\"\"Health check endpoint. Returns True if the worker is alive.\"\"\"\n        return True\n\n    @endpoint\n    def process(self, data: str) -\u003E dict:\n        \"\"\"Process some data. Might fail based on fail_rate.\"\"\"\n        import random\n        self.calls += 1\n\n        if random.random() \u003C self.fail_rate:\n            raise RuntimeError(f\"Worker failed! (replica={self.replica_id}, local={self.local_rank})\")\n\n        return {\n            \"replica_id\": self.replica_id,\n            \"local_rank\": self.local_rank,\n            \"calls\": self.calls,\n            \"result\": f\"Processed '{data}' by replica {self.replica_id}\",\n        }\n\n    @endpoint\n    def get_replica_id(self) -\u003E int:\n        \"\"\"Return which replica this worker belongs to.\"\"\"\n        return self.replica_id\n\n    @endpoint\n    def get_local_id(self) -\u003E int:\n        \"\"\"Return this worker's local rank within its replica.\"\"\"\n        return self.local_rank", "code_hash": "e3bc6deb1120a1aa52c227bc3870eaba", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "BYtC", "name": "_"}, {"code": "mo.md(r\"\"\"\nThe **local rank** is the worker's position within its ActorMesh (0, 1, 2, ...). This is how workers within a replica coordinate - for example, rank 0 might handle the first shard of a tensor-parallel model.\n\nThe **replica ID** is passed at spawn time so workers know which replica they belong to. This is useful for logging and debugging.\n\n## The Service: Routing and Health Tracking\n\nNow let's build the service that manages replicas. It needs to:\n- Slice a ProcMesh into replica-sized chunks\n- Spawn an ActorMesh for each replica (passing the replica ID)\n- Route requests round-robin to healthy replicas\n- Track which replicas are healthy\n- Handle failures via `__supervise__`\n\"\"\")", "code_hash": "4b2b47652b2ba7828db81d5669d20b5f", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "RGSE", "name": "_"}, {"code": "class Service(Actor):\n    \"\"\"\n    Manages a pool of worker replicas with routing and health tracking.\n\n    Each replica is an ActorMesh (potentially spanning multiple GPUs/hosts).\n    The service:\n    1. Slices resources into replica-sized chunks\n    2. Spawns an ActorMesh per replica\n    3. Routes requests round-robin to healthy replicas\n    4. Tracks health and handles failures\n    5. Can probe unhealthy replicas to check if they've recovered\n    \"\"\"\n\n    def __init__(\n        self,\n        service_name: str,\n        worker_class: type,\n        replica_procs,\n        procs_per_replica: int,\n        **worker_kwargs\n    ):\n        self.service_name = service_name\n        total_procs = len(replica_procs)\n        self.num_replicas = total_procs // procs_per_replica\n        self.procs_per_replica = procs_per_replica\n\n        # Slice the proc mesh into replica-sized chunks\n        self.replicas = []\n        for i in range(self.num_replicas):\n            start = i * procs_per_replica\n            end = start + procs_per_replica\n\n            # Slice out this replica's procs\n            replica_slice = replica_procs.slice(procs=slice(start, end))\n\n            # Spawn an ActorMesh on this slice, passing replica_id\n            replica_mesh = replica_slice.spawn(\n                f\"replica_{i}\",\n                worker_class,\n                replica_id=i,  # Pass replica ID to workers\n                **worker_kwargs\n            )\n            self.replicas.append(replica_mesh)\n\n        # Track health: healthy and unhealthy sets\n        self.healthy = set(range(self.num_replicas))\n        self.unhealthy: set[int] = set()\n\n        # Round-robin index\n        self.next_idx = 0\n\n        print(f\"[SERVICE:{service_name}] {self.num_replicas} replicas \u00d7 {procs_per_replica} procs each\")\n\n    def __supervise__(self, failure) -\u003E bool:\n        \"\"\"Called when a worker fails. Log it.\"\"\"\n        report = failure.report()\n        print(f\"[SERVICE:{self.service_name}] Failure detected: {report[:100]}...\")\n        return True  # Handled - real recovery is caller retrying with different replica\n\n    @endpoint\n    def get_replica(self):\n        \"\"\"Get a healthy replica (round-robin selection).\"\"\"\n        if not self.healthy:\n            raise RuntimeError(\"No healthy replicas available!\")\n\n        healthy_list = sorted(self.healthy)\n        idx = self.next_idx % len(healthy_list)\n        self.next_idx += 1\n\n        return self.replicas[healthy_list[idx]]\n\n    @endpoint\n    def get_replica_with_idx(self):\n        \"\"\"Get a healthy replica and its index (for marking unhealthy later).\"\"\"\n        if not self.healthy:\n            raise RuntimeError(\"No healthy replicas available!\")\n\n        healthy_list = sorted(self.healthy)\n        idx = self.next_idx % len(healthy_list)\n        self.next_idx += 1\n\n        replica_idx = healthy_list[idx]\n        return self.replicas[replica_idx], replica_idx\n\n    @endpoint\n    def mark_unhealthy(self, replica_idx: int) -\u003E None:\n        \"\"\"Mark a replica as unhealthy.\"\"\"\n        if replica_idx in self.healthy:\n            self.healthy.discard(replica_idx)\n            self.unhealthy.add(replica_idx)\n            print(f\"[SERVICE:{self.service_name}] Replica {replica_idx} marked unhealthy. \"\n                  f\"Healthy: {len(self.healthy)}/{self.num_replicas}\")\n\n    @endpoint\n    def mark_healthy(self, replica_idx: int) -\u003E None:\n        \"\"\"Mark a replica as healthy again.\"\"\"\n        if replica_idx \u003C self.num_replicas:\n            self.unhealthy.discard(replica_idx)\n            self.healthy.add(replica_idx)\n\n    @endpoint\n    def check_health(self) -\u003E dict:\n        \"\"\"\n        Probe all unhealthy replicas to see if they've recovered.\n        Returns a dict with recovery results.\n        \"\"\"\n        recovered = []\n        still_unhealthy = []\n\n        for replica_idx in list(self.unhealthy):\n            try:\n                # Ping the replica to see if it's alive\n                self.replicas[replica_idx].ping.call_one().get()\n                # Success - mark healthy\n                self.unhealthy.discard(replica_idx)\n                self.healthy.add(replica_idx)\n                recovered.append(replica_idx)\n                print(f\"[SERVICE:{self.service_name}] Replica {replica_idx} recovered!\")\n            except Exception:\n                # Still unhealthy\n                still_unhealthy.append(replica_idx)\n\n        return {\n            \"recovered\": recovered,\n            \"still_unhealthy\": still_unhealthy,\n            \"healthy_count\": len(self.healthy),\n        }\n\n    @endpoint\n    def get_health_status(self) -\u003E dict:\n        return {\n            \"total\": self.num_replicas,\n            \"healthy\": len(self.healthy),\n            \"unhealthy\": len(self.unhealthy),\n            \"healthy_indices\": sorted(self.healthy),\n            \"unhealthy_indices\": sorted(self.unhealthy),\n        }", "code_hash": "9882bbc734b412a17aa8cd4ffd019e62", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Kclp", "name": "_"}, {"code": "mo.md(r\"\"\"\nKey design decisions:\n\n1. **1 replica = 1 ActorMesh** - Each replica can span multiple GPUs (or even hosts)\n2. **Pass replica_id at spawn** - Workers know which replica they belong to\n3. **Caller registers the service** - After spawning, the caller calls `register_service()`. We can't do this in `__init__` because actors can't block on Futures during initialization.\n4. **Round-robin routing** - Simple, predictable, works well when replicas are similar\n5. **Caller marks unhealthy** - The service doesn't automatically detect which replica failed. Instead, the caller tells it after catching an exception.\n6. **Health probes for recovery** - Workers have a `ping()` endpoint. The service's `check_health()` method probes unhealthy replicas and recovers them if they respond.\n7. **`__supervise__`** - Monarch calls this when a child actor fails. We log it, but the real handling is the caller retrying with a different replica.\n\n## Let's Run It!\n\nLet's create a simple demo that shows:\n- Different replicas being called (round-robin)\n- What happens when a replica fails\n- How the service routes around failures\n- How health checks recover replicas\n\"\"\")", "code_hash": "0e74de5540f7a14d178403440f03574a", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "emfo", "name": "_"}, {"code": "# Demo: Create a service with 4 replicas, 1 worker each\n# We'll send 8 requests to see round-robin in action\n\nfrom monarch.actor import this_host\n\n# Get procs on this host\nhost = this_host()\n\n# The Service itself is an actor, so it needs to be spawned on a proc\nservice_proc = host.spawn_procs({\"procs\": 1})\n\n# Procs for the worker replicas\nworker_procs = host.spawn_procs({\"procs\": 4})\n\n# Spawn the service actor\ndemo_service = service_proc.spawn(\n    \"demo_service\",\n    Service,\n    service_name=\"demo\",\n    worker_class=Worker,\n    replica_procs=worker_procs,\n    procs_per_replica=1,\n    fail_rate=0.0,  # No failures for now\n)\n\n# Register the service so it can be discovered by name\nregister_service(\"demo\", demo_service)\n\n# Send 8 requests - should round-robin through replicas 0,1,2,3,0,1,2,3\nprint(\"Round-robin demo:\")\nfor _i in range(8):\n    replica, replica_idx = demo_service.get_replica_with_idx.call_one().get()\n    result = replica.process.call_one(f\"request_{_i}\").get()\n    print(f\"  Request {_i}: handled by replica {result['replica_id']}\")\n\n# Note: In production you'd call worker_procs.stop() and service_proc.stop()\n# to clean up, but there's currently a Monarch bug where stopping procs\n# can crash the kernel if there are lingering references.", "code_hash": "b8bea3e50eefc93cc87f38e60f9f5026", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hstk", "name": "_"}, {"code": "mo.md(r\"\"\"\n### Handling Failures\n\nNow let's see what happens when a replica fails. We'll create a service with a 30% failure rate and watch the retry logic in action. Then we'll use `check_health()` to recover replicas.\n\"\"\")", "code_hash": "ee7bfc2bf680355a3550e521cbc58ca5", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "nWHF", "name": "_"}, {"code": "# Create a service with a failure rate\n# Service needs its own proc, workers need their procs\nflaky_service_proc = host.spawn_procs({\"procs\": 1})\nflaky_worker_procs = host.spawn_procs({\"procs\": 4})\n\nflaky_service = flaky_service_proc.spawn(\n    \"flaky_service\",\n    Service,\n    service_name=\"flaky_demo\",\n    worker_class=Worker,\n    replica_procs=flaky_worker_procs,\n    procs_per_replica=1,\n    fail_rate=0.3,  # 30% failure rate\n)\n\n# Register the service\nregister_service(\"flaky_demo\", flaky_service)\n\n# Try to process with retry\ndef process_with_retry(svc, data, max_retries=3):\n    for attempt in range(max_retries):\n        replica, replica_idx = svc.get_replica_with_idx.call_one().get()\n        try:\n            result = replica.process.call_one(data).get()\n            print(f\"  Success on replica {replica_idx}\")\n            return result\n        except Exception as e:\n            print(f\"  Attempt {attempt+1} failed on replica {replica_idx}: {e}\")\n            svc.mark_unhealthy.call_one(replica_idx).get()\n    raise RuntimeError(\"All retries exhausted\")\n\n# Process several requests\nprint(\"Failure handling demo:\")\nfor _j in range(5):\n    print(f\"Request {_j}:\")\n    try:\n        process_with_retry(flaky_service, f\"data_{_j}\")\n    except RuntimeError as e:\n        print(f\"  {e}\")\n\n# Check health status after failures\nstatus = flaky_service.get_health_status.call_one().get()\nprint(f\"\\nAfter failures: {status['healthy']}/{status['total']} replicas healthy\")\nprint(f\"Unhealthy replicas: {status['unhealthy_indices']}\")\n\n# Now run health checks to recover replicas\n# (In our case, the replicas are still alive - they just had random failures)\nprint(\"\\nRunning health check to recover replicas...\")\nrecovery = flaky_service.check_health.call_one().get()\nprint(f\"Recovered: {recovery['recovered']}\")\nprint(f\"Still unhealthy: {recovery['still_unhealthy']}\")\n\n# Check health status after recovery\nstatus_after = flaky_service.get_health_status.call_one().get()\nprint(f\"\\nAfter health check: {status_after['healthy']}/{status_after['total']} replicas healthy\")", "code_hash": "1bd6b640bd5592acb78decb3b85a8bd4", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "iLit", "name": "_"}, {"code": "mo.md(r\"\"\"\n## What We Built\n\nA simple but complete service framework:\n\n| Component | Responsibility |\n|-----------|---------------|\n| **`get_service(name)`** | Find a service by name |\n| **`register_service(name, svc)`** | Register a service for discovery |\n| **Worker** | Does the actual work, knows its replica_id and local_rank |\n| **Service** | Owns replicas (ActorMeshes), routes requests, tracks health |\n\nThe pattern:\n1. Services register themselves on startup with `register_service()`\n2. Clients discover services with `get_service()`\n3. Clients get replicas, make calls, handle failures inline\n4. On failure, mark unhealthy and retry with a different replica\n\n## What's Missing?\n\nThe generators need **updated weights** after the trainer takes a gradient step. Right now they'd be using stale weights forever.\n\nHow do we efficiently sync weights from trainer to generators?\n\n**Next notebook: RDMA Weight Sync** - Using Monarch's RDMA primitives to transfer weights without blocking training.\n\"\"\")", "code_hash": "5489ec4e46b16f100e0820ec8924848f", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ZHCJ", "name": "_"}], "metadata": {"marimo_version": "0.19.7"}, "version": "1"},
            "session": {"cells": [{"code_hash": "1d0db38904205bec4d6f6f6a1f6cec3e", "console": [], "id": "Hbol", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "77c5b831ba37a669455ebd5a781cd41f", "console": [], "id": "MJUe", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch1 id=\"services-building-a-generator-pool\"\u003EServices: Building a Generator Pool\u003C/h1\u003E\n\u003Cspan class=\"paragraph\"\u003EWe just introduced async RL and why it matters. If you've used Claude Code or any coding-capable AI, you know that depending on the difficulty of your question, it could take a really long time to generate even one trajectory. As we showed in the previous notebook, there's also significant variance in how long generation takes.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EFor this reason, you'll typically want to run RL workloads with \u003Cstrong\u003Emany generator replicas running in parallel\u003C/strong\u003E.\u003C/span\u003E\n\u003Ch2 id=\"the-service-abstraction\"\u003EThe \"Service\" Abstraction\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EWhen you get to this point, there are a few ways you could model this. A pretty natural approach is to create a \u003Cstrong\u003E\"service\"\u003C/strong\u003E.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EIn traditional software engineering, a service is a component that:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003EHandles requests from clients\u003C/li\u003E\n\u003Cli\u003ECan be replicated for throughput and reliability\u003C/li\u003E\n\u003Cli\u003ELives behind some kind of load balancer (think Kubernetes)\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003EThis idea applies here too. You \u003Cem\u003Ecould\u003C/em\u003E find and grab an off-the-shelf implementation, but since we're always working in Python, it would be nice to have a \u003Cstrong\u003EPython-native implementation\u003C/strong\u003E - especially one you can easily customize to match your needs as an RL researcher.\u003C/span\u003E\n\u003Ch2 id=\"what-well-build\"\u003EWhat We'll Build\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EThere are a lot of ideas that could go into a service, but what we'll focus on implementing here - using \u003Cstrong\u003Epure Monarch\u003C/strong\u003E - is a service that can:\u003C/span\u003E\n\u003Col\u003E\n\u003Cli\u003E\u003Cstrong\u003ELoad balance\u003C/strong\u003E across replicas (round-robin for simplicity, but you could implement more exotic strategies based on your workload)\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ETrack and respond to faults\u003C/strong\u003E (health tracking, retry with different replica)\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EBe discoverable\u003C/strong\u003E (services register themselves, clients find them by name)\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ESupport multi-GPU replicas\u003C/strong\u003E (each replica is an ActorMesh that can span multiple GPUs)\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ETarget specific replicas\u003C/strong\u003E (grab a replica and keep using it - useful for stateful interactions)\u003C/li\u003E\n\u003C/ol\u003E\n\u003Cspan class=\"paragraph\"\u003ESince each replica is an ActorMesh, everything we build here \u003Cem\u003Ecould\u003C/em\u003E run multi-host - the abstraction supports it. For this tutorial, we'll run on a single node to keep things simple.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "a05ebbee8258d6c364673351f4ef2eee", "console": [], "id": "vblA", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"quick-recap-monarch-actors\"\u003EQuick Recap: Monarch Actors\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EBefore we dive in, a quick refresher on the Monarch primitives we'll use. If you've gone through the earlier notebooks, you'll recognize these:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Cstrong\u003E\u003Ccode\u003E@endpoint\u003C/code\u003E\u003C/strong\u003E - Marks a method as callable from other actors. Returns a \u003Ccode\u003EFuture\u003C/code\u003E that you \u003Ccode\u003E.get()\u003C/code\u003E to await.\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003E\u003Ccode\u003E__supervise__\u003C/code\u003E\u003C/strong\u003E - Called when a child actor fails. You can log the error and decide whether to handle it.\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003E\u003Ccode\u003Eget_or_spawn_controller\u003C/code\u003E\u003C/strong\u003E - Gets or creates a singleton actor by name. First caller spawns it, subsequent callers get the existing one.\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003E\u003Ccode\u003EActorMesh\u003C/code\u003E\u003C/strong\u003E - A group of actors spawned together. When you call an endpoint, it runs on all actors in the mesh.\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003EWith that in mind, let's think about what API we want for our service.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "743ee67cbd5641e5f143dc9ae4d01f99", "console": [], "id": "bkHC", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"a-key-assumption-1-replica-1-actormesh\"\u003EA Key Assumption: 1 Replica = 1 ActorMesh\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EMost workloads we care about will need to span multiple GPUs. A 70B model needs tensor parallelism across 8 GPUs. Models like DeepSeek V3 may need to span multiple \u003Cem\u003Ehosts\u003C/em\u003E.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003ESo rather than treating single-GPU replicas as the default and multi-GPU as a special case, we'll make a basic assumption: \u003Cstrong\u003E1 replica = 1 ActorMesh\u003C/strong\u003E.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThis means:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003EEach replica is a group of workers (an ActorMesh)\u003C/li\u003E\n\u003Cli\u003EWorkers within a replica coordinate via \u003Cstrong\u003Ecollectives\u003C/strong\u003E - each replica is its own distributed \"world\"\u003C/li\u003E\n\u003Cli\u003EThe service manages replicas, not individual workers\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003EThis design composes naturally with the existing ML ecosystem. A common pattern might be to plug \u003Cstrong\u003EvLLM\u003C/strong\u003E or another inference engine into one of these meshes - it just sees a standard distributed environment.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EIf you happen to have a small model that fits on one GPU, you just have a replica with 1 worker. The abstraction still works.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "03717b8a6c2d29da2e6a9d9bd0479128", "console": [], "id": "lEQa", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"designing-the-api-first\"\u003EDesigning the API First\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EBefore we implement anything, let's sketch what we want the usage to look like. This helps us work backwards to the implementation.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EWhat a client wants to do:\u003C/strong\u003E\n\u003Cdiv class=\"language-python codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"c1\"\u003E# Get a service by name\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Egen_service\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Eget_service\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s2\"\u003E\u0026quot;generators\u0026quot;\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\n\u003Cspan class=\"c1\"\u003E# Get a replica and call it\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Ereplica\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Ereplica_idx\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Egen_service\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eget_replica_with_idx\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Eresult\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Ereplica\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Egenerate\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Etask\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\n\u003Cspan class=\"c1\"\u003E# If something fails, mark it unhealthy and retry\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Egen_service\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Emark_unhealthy\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ereplica_idx\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EWhat a service wants to do on startup:\u003C/strong\u003E\n\u003Cdiv class=\"language-python codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"c1\"\u003E# Register itself so clients can find it\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Eregister_service\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s2\"\u003E\u0026quot;generators\u0026quot;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThis gives us a clean separation: services register themselves, clients discover them by name. You \u003Cem\u003Ecan\u003C/em\u003E pass actor references around directly - that works fine - but referring to services by name is often a cleaner pattern, especially when services and clients are spawned independently.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "dd567a8f958c4c88ad0d136988fc3e78", "console": [], "id": "PKri", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"service-discovery-the-registry-pattern\"\u003EService Discovery: The Registry Pattern\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003ELet's implement the discovery mechanism first. We'll create a \u003Ccode\u003EServiceRegistry\u003C/code\u003E singleton and wrap it with helper functions.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "526f89dbd8225f695dfa71a90e28a191", "console": [], "id": "Xref", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "c410a32055a64fd2c123a2ba9248ed84", "console": [], "id": "SFPL", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Cspan class=\"paragraph\"\u003ENow clients can simply call:\n\u003Cdiv class=\"language-python codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"n\"\u003Egen_service\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Eget_service\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s2\"\u003E\u0026quot;generators\u0026quot;\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EAnd services register themselves with:\n\u003Cdiv class=\"language-python codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"n\"\u003Eregister_service\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s2\"\u003E\u0026quot;generators\u0026quot;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThe registry is a singleton - \u003Ccode\u003Eget_or_spawn_controller\u003C/code\u003E ensures everyone gets the same one.\u003C/span\u003E\n\u003Ch2 id=\"the-worker-where-the-actual-work-happens\"\u003EThe Worker: Where the Actual Work Happens\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003ELet's define a worker actor. Each worker knows:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003EIts \u003Cstrong\u003Ereplica ID\u003C/strong\u003E - which replica it belongs to (passed at spawn time)\u003C/li\u003E\n\u003Cli\u003EIts \u003Cstrong\u003Elocal rank\u003C/strong\u003E - its position within the replica's ActorMesh (0, 1, 2, ...)\u003C/li\u003E\n\u003C/ul\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "e3bc6deb1120a1aa52c227bc3870eaba", "console": [], "id": "BYtC", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "4b2b47652b2ba7828db81d5669d20b5f", "console": [], "id": "RGSE", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Cspan class=\"paragraph\"\u003EThe \u003Cstrong\u003Elocal rank\u003C/strong\u003E is the worker's position within its ActorMesh (0, 1, 2, ...). This is how workers within a replica coordinate - for example, rank 0 might handle the first shard of a tensor-parallel model.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThe \u003Cstrong\u003Ereplica ID\u003C/strong\u003E is passed at spawn time so workers know which replica they belong to. This is useful for logging and debugging.\u003C/span\u003E\n\u003Ch2 id=\"the-service-routing-and-health-tracking\"\u003EThe Service: Routing and Health Tracking\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003ENow let's build the service that manages replicas. It needs to:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003ESlice a ProcMesh into replica-sized chunks\u003C/li\u003E\n\u003Cli\u003ESpawn an ActorMesh for each replica (passing the replica ID)\u003C/li\u003E\n\u003Cli\u003ERoute requests round-robin to healthy replicas\u003C/li\u003E\n\u003Cli\u003ETrack which replicas are healthy\u003C/li\u003E\n\u003Cli\u003EHandle failures via \u003Ccode\u003E__supervise__\u003C/code\u003E\u003C/li\u003E\n\u003C/ul\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "9882bbc734b412a17aa8cd4ffd019e62", "console": [], "id": "Kclp", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "0e74de5540f7a14d178403440f03574a", "console": [], "id": "emfo", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Cspan class=\"paragraph\"\u003EKey design decisions:\u003C/span\u003E\n\u003Col\u003E\n\u003Cli\u003E\u003Cstrong\u003E1 replica = 1 ActorMesh\u003C/strong\u003E - Each replica can span multiple GPUs (or even hosts)\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EPass replica_id at spawn\u003C/strong\u003E - Workers know which replica they belong to\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ECaller registers the service\u003C/strong\u003E - After spawning, the caller calls \u003Ccode\u003Eregister_service()\u003C/code\u003E. We can't do this in \u003Ccode\u003E__init__\u003C/code\u003E because actors can't block on Futures during initialization.\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ERound-robin routing\u003C/strong\u003E - Simple, predictable, works well when replicas are similar\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ECaller marks unhealthy\u003C/strong\u003E - The service doesn't automatically detect which replica failed. Instead, the caller tells it after catching an exception.\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EHealth probes for recovery\u003C/strong\u003E - Workers have a \u003Ccode\u003Eping()\u003C/code\u003E endpoint. The service's \u003Ccode\u003Echeck_health()\u003C/code\u003E method probes unhealthy replicas and recovers them if they respond.\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003E\u003Ccode\u003E__supervise__\u003C/code\u003E\u003C/strong\u003E - Monarch calls this when a child actor fails. We log it, but the real handling is the caller retrying with a different replica.\u003C/li\u003E\n\u003C/ol\u003E\n\u003Ch2 id=\"lets-run-it\"\u003ELet's Run It!\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003ELet's create a simple demo that shows:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003EDifferent replicas being called (round-robin)\u003C/li\u003E\n\u003Cli\u003EWhat happens when a replica fails\u003C/li\u003E\n\u003Cli\u003EHow the service routes around failures\u003C/li\u003E\n\u003Cli\u003EHow health checks recover replicas\u003C/li\u003E\n\u003C/ul\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "b8bea3e50eefc93cc87f38e60f9f5026", "console": [{"mimetype": "text/plain", "name": "stderr", "text": "Monarch internal logs are being written to /tmp/allencwang/monarch_log.log; execution id allencwang_Feb-03_07:36_51\n", "type": "stream"}, {"mimetype": "text/plain", "name": "stdout", "text": "[REGISTRY] ServiceRegistry spawned\n[REGISTRY] Registered 'demo'\nRound-robin demo:\n[SERVICE:demo] 4 replicas \u00d7 1 procs each\n[WORKER] Replica 0, local rank 0 ready\n[WORKER] Replica 3, local rank 0 ready\n  Request 0: handled by replica 0\n[WORKER] Replica 1, local rank 0 ready\n  Request 1: handled by replica 1\n[WORKER] Replica 2, local rank 0 ready\n  Request 2: handled by replica 2\n  Request 3: handled by replica 3\n  Request 4: handled by replica 0\n  Request 5: handled by replica 1\n  Request 6: handled by replica 2\n  Request 7: handled by replica 3\n", "type": "stream"}], "id": "Hstk", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "ee7bfc2bf680355a3550e521cbc58ca5", "console": [], "id": "nWHF", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"handling-failures\"\u003EHandling Failures\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003ENow let's see what happens when a replica fails. We'll create a service with a 30% failure rate and watch the retry logic in action. Then we'll use \u003Ccode\u003Echeck_health()\u003C/code\u003E to recover replicas.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "1bd6b640bd5592acb78decb3b85a8bd4", "console": [{"mimetype": "text/plain", "name": "stdout", "text": "[REGISTRY] Registered 'flaky_demo'\nFailure handling demo:\nRequest 0:\n[SERVICE:flaky_demo] 4 replicas \u00d7 1 procs each\n[WORKER] Replica 0, local rank 0 ready\n[WORKER] Replica 2, local rank 0 ready\n  Success on replica 0\nRequest 1:\n[WORKER] Replica 3, local rank 0 ready\n[WORKER] Replica 1, local rank 0 ready\n  Success on replica 1\nRequest 2:\n  Success on replica 2\nRequest 3:\n  Attempt 1 failed on replica 3: Actor call replica_3.process failed.\n Traceback of where the remote call failed (most recent call last):\n  File \"/home/allencwang/forge-dev/smol_projects/monarch-gpu-mode/.venv/lib/python3.12/site-packages/monarch/_src/actor/actor_mesh.py\", line 1384, in handle\n    result = the_method(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/tmp/marimo_1718246/__marimo__cell_BYtC_.py\", line 26, in process\n    raise RuntimeError(f\"Worker failed! (replica={self.replica_id}, local={self.local_rank})\")\nRuntimeError: Worker failed! (replica=3, local=0)\n\n[SERVICE:flaky_demo] Replica 3 marked unhealthy. Healthy: 3/4\n  Attempt 2 failed on replica 1: Actor call replica_1.process failed.\n Traceback of where the remote call failed (most recent call last):\n  File \"/home/allencwang/forge-dev/smol_projects/monarch-gpu-mode/.venv/lib/python3.12/site-packages/monarch/_src/actor/actor_mesh.py\", line 1384, in handle\n    result = the_method(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/tmp/marimo_1718246/__marimo__cell_BYtC_.py\", line 26, in process\n    raise RuntimeError(f\"Worker failed! (replica={self.replica_id}, local={self.local_rank})\")\nRuntimeError: Worker failed! (replica=1, local=0)\n\n[SERVICE:flaky_demo] Replica 1 marked unhealthy. Healthy: 2/4\n  Success on replica 2\nRequest 4:\n  Attempt 1 failed on replica 0: Actor call replica_0.process failed.\n Traceback of where the remote call failed (most recent call last):\n  File \"/home/allencwang/forge-dev/smol_projects/monarch-gpu-mode/.venv/lib/python3.12/site-packages/monarch/_src/actor/actor_mesh.py\", line 1384, in handle\n    result = the_method(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/tmp/marimo_1718246/__marimo__cell_BYtC_.py\", line 26, in process\n    raise RuntimeError(f\"Worker failed! (replica={self.replica_id}, local={self.local_rank})\")\nRuntimeError: Worker failed! (replica=0, local=0)\n\n[SERVICE:flaky_demo] Replica 0 marked unhealthy. Healthy: 1/4\n  Success on replica 2\n\nAfter failures: 1/4 replicas healthy\nUnhealthy replicas: [0, 1, 3]\n\nRunning health check to recover replicas...\n[SERVICE:flaky_demo] Replica 0 recovered!\n[SERVICE:flaky_demo] Replica 1 recovered!\n[SERVICE:flaky_demo] Replica 3 recovered!\nRecovered: [0, 1, 3]\nStill unhealthy: []\n\nAfter health check: 4/4 replicas healthy\n", "type": "stream"}], "id": "iLit", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "5489ec4e46b16f100e0820ec8924848f", "console": [], "id": "ZHCJ", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"what-we-built\"\u003EWhat We Built\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EA simple but complete service framework:\u003C/span\u003E\n\u003Ctable\u003E\n\u003Cthead\u003E\n\u003Ctr\u003E\n\u003Cth\u003EComponent\u003C/th\u003E\n\u003Cth\u003EResponsibility\u003C/th\u003E\n\u003C/tr\u003E\n\u003C/thead\u003E\n\u003Ctbody\u003E\n\u003Ctr\u003E\n\u003Ctd\u003E\u003Cstrong\u003E\u003Ccode\u003Eget_service(name)\u003C/code\u003E\u003C/strong\u003E\u003C/td\u003E\n\u003Ctd\u003EFind a service by name\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003E\u003Cstrong\u003E\u003Ccode\u003Eregister_service(name, svc)\u003C/code\u003E\u003C/strong\u003E\u003C/td\u003E\n\u003Ctd\u003ERegister a service for discovery\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003E\u003Cstrong\u003EWorker\u003C/strong\u003E\u003C/td\u003E\n\u003Ctd\u003EDoes the actual work, knows its replica_id and local_rank\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003E\u003Cstrong\u003EService\u003C/strong\u003E\u003C/td\u003E\n\u003Ctd\u003EOwns replicas (ActorMeshes), routes requests, tracks health\u003C/td\u003E\n\u003C/tr\u003E\n\u003C/tbody\u003E\n\u003C/table\u003E\n\u003Cspan class=\"paragraph\"\u003EThe pattern:\u003C/span\u003E\n\u003Col\u003E\n\u003Cli\u003EServices register themselves on startup with \u003Ccode\u003Eregister_service()\u003C/code\u003E\u003C/li\u003E\n\u003Cli\u003EClients discover services with \u003Ccode\u003Eget_service()\u003C/code\u003E\u003C/li\u003E\n\u003Cli\u003EClients get replicas, make calls, handle failures inline\u003C/li\u003E\n\u003Cli\u003EOn failure, mark unhealthy and retry with a different replica\u003C/li\u003E\n\u003C/ol\u003E\n\u003Ch2 id=\"whats-missing\"\u003EWhat's Missing?\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EThe generators need \u003Cstrong\u003Eupdated weights\u003C/strong\u003E after the trainer takes a gradient step. Right now they'd be using stale weights forever.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EHow do we efficiently sync weights from trainer to generators?\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003ENext notebook: RDMA Weight Sync\u003C/strong\u003E - Using Monarch's RDMA primitives to transfer weights without blocking training.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}], "metadata": {"marimo_version": "0.19.7"}, "version": "1"},
            "runtimeConfig": null,
        };
    </script>
  
<marimo-code hidden="">
    import%20marimo%0A%0A__generated_with%20%3D%20%220.19.7%22%0Aapp%20%3D%20marimo.App(width%3D%22medium%22)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20return%20(mo%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%20Services%3A%20Building%20a%20Generator%20Pool%0A%0A%20%20%20%20We%20just%20introduced%20async%20RL%20and%20why%20it%20matters.%20If%20you've%20used%20Claude%20Code%20or%20any%20coding-capable%20AI%2C%20you%20know%20that%20depending%20on%20the%20difficulty%20of%20your%20question%2C%20it%20could%20take%20a%20really%20long%20time%20to%20generate%20even%20one%20trajectory.%20As%20we%20showed%20in%20the%20previous%20notebook%2C%20there's%20also%20significant%20variance%20in%20how%20long%20generation%20takes.%0A%0A%20%20%20%20For%20this%20reason%2C%20you'll%20typically%20want%20to%20run%20RL%20workloads%20with%20**many%20generator%20replicas%20running%20in%20parallel**.%0A%0A%20%20%20%20%23%23%20The%20%22Service%22%20Abstraction%0A%0A%20%20%20%20When%20you%20get%20to%20this%20point%2C%20there%20are%20a%20few%20ways%20you%20could%20model%20this.%20A%20pretty%20natural%20approach%20is%20to%20create%20a%20**%22service%22**.%0A%0A%20%20%20%20In%20traditional%20software%20engineering%2C%20a%20service%20is%20a%20component%20that%3A%0A%20%20%20%20-%20Handles%20requests%20from%20clients%0A%20%20%20%20-%20Can%20be%20replicated%20for%20throughput%20and%20reliability%0A%20%20%20%20-%20Lives%20behind%20some%20kind%20of%20load%20balancer%20(think%20Kubernetes)%0A%0A%20%20%20%20This%20idea%20applies%20here%20too.%20You%20*could*%20find%20and%20grab%20an%20off-the-shelf%20implementation%2C%20but%20since%20we're%20always%20working%20in%20Python%2C%20it%20would%20be%20nice%20to%20have%20a%20**Python-native%20implementation**%20-%20especially%20one%20you%20can%20easily%20customize%20to%20match%20your%20needs%20as%20an%20RL%20researcher.%0A%0A%20%20%20%20%23%23%20What%20We'll%20Build%0A%0A%20%20%20%20There%20are%20a%20lot%20of%20ideas%20that%20could%20go%20into%20a%20service%2C%20but%20what%20we'll%20focus%20on%20implementing%20here%20-%20using%20**pure%20Monarch**%20-%20is%20a%20service%20that%20can%3A%0A%0A%20%20%20%201.%20**Load%20balance**%20across%20replicas%20(round-robin%20for%20simplicity%2C%20but%20you%20could%20implement%20more%20exotic%20strategies%20based%20on%20your%20workload)%0A%20%20%20%202.%20**Track%20and%20respond%20to%20faults**%20(health%20tracking%2C%20retry%20with%20different%20replica)%0A%20%20%20%203.%20**Be%20discoverable**%20(services%20register%20themselves%2C%20clients%20find%20them%20by%20name)%0A%20%20%20%204.%20**Support%20multi-GPU%20replicas**%20(each%20replica%20is%20an%20ActorMesh%20that%20can%20span%20multiple%20GPUs)%0A%20%20%20%205.%20**Target%20specific%20replicas**%20(grab%20a%20replica%20and%20keep%20using%20it%20-%20useful%20for%20stateful%20interactions)%0A%0A%20%20%20%20Since%20each%20replica%20is%20an%20ActorMesh%2C%20everything%20we%20build%20here%20*could*%20run%20multi-host%20-%20the%20abstraction%20supports%20it.%20For%20this%20tutorial%2C%20we'll%20run%20on%20a%20single%20node%20to%20keep%20things%20simple.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Quick%20Recap%3A%20Monarch%20Actors%0A%0A%20%20%20%20Before%20we%20dive%20in%2C%20a%20quick%20refresher%20on%20the%20Monarch%20primitives%20we'll%20use.%20If%20you've%20gone%20through%20the%20earlier%20notebooks%2C%20you'll%20recognize%20these%3A%0A%0A%20%20%20%20-%20**%60%40endpoint%60**%20-%20Marks%20a%20method%20as%20callable%20from%20other%20actors.%20Returns%20a%20%60Future%60%20that%20you%20%60.get()%60%20to%20await.%0A%20%20%20%20-%20**%60__supervise__%60**%20-%20Called%20when%20a%20child%20actor%20fails.%20You%20can%20log%20the%20error%20and%20decide%20whether%20to%20handle%20it.%0A%20%20%20%20-%20**%60get_or_spawn_controller%60**%20-%20Gets%20or%20creates%20a%20singleton%20actor%20by%20name.%20First%20caller%20spawns%20it%2C%20subsequent%20callers%20get%20the%20existing%20one.%0A%20%20%20%20-%20**%60ActorMesh%60**%20-%20A%20group%20of%20actors%20spawned%20together.%20When%20you%20call%20an%20endpoint%2C%20it%20runs%20on%20all%20actors%20in%20the%20mesh.%0A%0A%20%20%20%20With%20that%20in%20mind%2C%20let's%20think%20about%20what%20API%20we%20want%20for%20our%20service.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20A%20Key%20Assumption%3A%201%20Replica%20%3D%201%20ActorMesh%0A%0A%20%20%20%20Most%20workloads%20we%20care%20about%20will%20need%20to%20span%20multiple%20GPUs.%20A%2070B%20model%20needs%20tensor%20parallelism%20across%208%20GPUs.%20Models%20like%20DeepSeek%20V3%20may%20need%20to%20span%20multiple%20*hosts*.%0A%0A%20%20%20%20So%20rather%20than%20treating%20single-GPU%20replicas%20as%20the%20default%20and%20multi-GPU%20as%20a%20special%20case%2C%20we'll%20make%20a%20basic%20assumption%3A%20**1%20replica%20%3D%201%20ActorMesh**.%0A%0A%20%20%20%20This%20means%3A%0A%20%20%20%20-%20Each%20replica%20is%20a%20group%20of%20workers%20(an%20ActorMesh)%0A%20%20%20%20-%20Workers%20within%20a%20replica%20coordinate%20via%20**collectives**%20-%20each%20replica%20is%20its%20own%20distributed%20%22world%22%0A%20%20%20%20-%20The%20service%20manages%20replicas%2C%20not%20individual%20workers%0A%0A%20%20%20%20This%20design%20composes%20naturally%20with%20the%20existing%20ML%20ecosystem.%20A%20common%20pattern%20might%20be%20to%20plug%20**vLLM**%20or%20another%20inference%20engine%20into%20one%20of%20these%20meshes%20-%20it%20just%20sees%20a%20standard%20distributed%20environment.%0A%0A%20%20%20%20If%20you%20happen%20to%20have%20a%20small%20model%20that%20fits%20on%20one%20GPU%2C%20you%20just%20have%20a%20replica%20with%201%20worker.%20The%20abstraction%20still%20works.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Designing%20the%20API%20First%0A%0A%20%20%20%20Before%20we%20implement%20anything%2C%20let's%20sketch%20what%20we%20want%20the%20usage%20to%20look%20like.%20This%20helps%20us%20work%20backwards%20to%20the%20implementation.%0A%0A%20%20%20%20**What%20a%20client%20wants%20to%20do%3A**%0A%20%20%20%20%60%60%60python%0A%20%20%20%20%23%20Get%20a%20service%20by%20name%0A%20%20%20%20gen_service%20%3D%20get_service(%22generators%22)%0A%0A%20%20%20%20%23%20Get%20a%20replica%20and%20call%20it%0A%20%20%20%20replica%2C%20replica_idx%20%3D%20gen_service.get_replica_with_idx()%0A%20%20%20%20result%20%3D%20replica.generate(task)%0A%0A%20%20%20%20%23%20If%20something%20fails%2C%20mark%20it%20unhealthy%20and%20retry%0A%20%20%20%20gen_service.mark_unhealthy(replica_idx)%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20**What%20a%20service%20wants%20to%20do%20on%20startup%3A**%0A%20%20%20%20%60%60%60python%0A%20%20%20%20%23%20Register%20itself%20so%20clients%20can%20find%20it%0A%20%20%20%20register_service(%22generators%22%2C%20self)%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20This%20gives%20us%20a%20clean%20separation%3A%20services%20register%20themselves%2C%20clients%20discover%20them%20by%20name.%20You%20*can*%20pass%20actor%20references%20around%20directly%20-%20that%20works%20fine%20-%20but%20referring%20to%20services%20by%20name%20is%20often%20a%20cleaner%20pattern%2C%20especially%20when%20services%20and%20clients%20are%20spawned%20independently.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Service%20Discovery%3A%20The%20Registry%20Pattern%0A%0A%20%20%20%20Let's%20implement%20the%20discovery%20mechanism%20first.%20We'll%20create%20a%20%60ServiceRegistry%60%20singleton%20and%20wrap%20it%20with%20helper%20functions.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20from%20monarch.actor%20import%20Actor%2C%20endpoint%2C%20get_or_spawn_controller%0A%0A%20%20%20%20class%20ServiceRegistry(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20Singleton%20registry%20for%20service%20discovery.%0A%0A%20%20%20%20%20%20%20%20Found%20via%20get_or_spawn_controller(%22service_registry%22%2C%20ServiceRegistry).%0A%20%20%20%20%20%20%20%20First%20caller%20spawns%20it%2C%20subsequent%20callers%20get%20the%20existing%20one.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.services%3A%20dict%5Bstr%2C%20Actor%5D%20%3D%20%7B%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%22%5BREGISTRY%5D%20ServiceRegistry%20spawned%22)%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20register(self%2C%20name%3A%20str%2C%20service)%20-%3E%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Register%20a%20service%20by%20name.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20self.services%5Bname%5D%20%3D%20service%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%5BREGISTRY%5D%20Registered%20'%7Bname%7D'%22)%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20get(self%2C%20name%3A%20str)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Get%20a%20service%20by%20name.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20name%20not%20in%20self.services%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20KeyError(f%22Service%20'%7Bname%7D'%20not%20found%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self.services%5Bname%5D%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20list_services(self)%20-%3E%20list%5Bstr%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22List%20all%20registered%20service%20names.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20list(self.services.keys())%0A%0A%0A%20%20%20%20def%20_get_registry()%3A%0A%20%20%20%20%20%20%20%20%22%22%22Get%20the%20singleton%20ServiceRegistry.%22%22%22%0A%20%20%20%20%20%20%20%20return%20get_or_spawn_controller(%22service_registry%22%2C%20ServiceRegistry).get()%0A%0A%0A%20%20%20%20def%20get_service(name%3A%20str)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Get%20a%20service%20by%20name.%20Raises%20KeyError%20if%20not%20found.%22%22%22%0A%20%20%20%20%20%20%20%20registry%20%3D%20_get_registry()%0A%20%20%20%20%20%20%20%20return%20registry.get.call_one(name).get()%0A%0A%0A%20%20%20%20def%20register_service(name%3A%20str%2C%20service)%20-%3E%20None%3A%0A%20%20%20%20%20%20%20%20%22%22%22Register%20a%20service%20so%20others%20can%20find%20it%20by%20name.%22%22%22%0A%20%20%20%20%20%20%20%20registry%20%3D%20_get_registry()%0A%20%20%20%20%20%20%20%20registry.register.call_one(name%2C%20service).get()%0A%0A%0A%20%20%20%20def%20list_services()%20-%3E%20list%5Bstr%5D%3A%0A%20%20%20%20%20%20%20%20%22%22%22List%20all%20registered%20service%20names.%22%22%22%0A%20%20%20%20%20%20%20%20registry%20%3D%20_get_registry()%0A%20%20%20%20%20%20%20%20return%20registry.list_services.call_one().get()%0A%20%20%20%20return%20Actor%2C%20endpoint%2C%20register_service%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20Now%20clients%20can%20simply%20call%3A%0A%20%20%20%20%60%60%60python%0A%20%20%20%20gen_service%20%3D%20get_service(%22generators%22)%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20And%20services%20register%20themselves%20with%3A%0A%20%20%20%20%60%60%60python%0A%20%20%20%20register_service(%22generators%22%2C%20self)%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20The%20registry%20is%20a%20singleton%20-%20%60get_or_spawn_controller%60%20ensures%20everyone%20gets%20the%20same%20one.%0A%0A%20%20%20%20%23%23%20The%20Worker%3A%20Where%20the%20Actual%20Work%20Happens%0A%0A%20%20%20%20Let's%20define%20a%20worker%20actor.%20Each%20worker%20knows%3A%0A%20%20%20%20-%20Its%20**replica%20ID**%20-%20which%20replica%20it%20belongs%20to%20(passed%20at%20spawn%20time)%0A%20%20%20%20-%20Its%20**local%20rank**%20-%20its%20position%20within%20the%20replica's%20ActorMesh%20(0%2C%201%2C%202%2C%20...)%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Actor%2C%20endpoint)%3A%0A%20%20%20%20from%20monarch.actor%20import%20current_rank%0A%0A%20%20%20%20class%20Worker(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22A%20worker%20that%20does%20work.%20Knows%20its%20replica%20ID%20and%20local%20rank.%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20replica_id%3A%20int%2C%20fail_rate%3A%20float%20%3D%200.0)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.replica_id%20%3D%20replica_id%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Local%20rank%20within%20this%20replica's%20ActorMesh%0A%20%20%20%20%20%20%20%20%20%20%20%20self.local_rank%20%3D%20current_rank().rank%20%20%23%200%2C%201%2C%202%2C%20...%20within%20this%20replica%0A%20%20%20%20%20%20%20%20%20%20%20%20self.fail_rate%20%3D%20fail_rate%0A%20%20%20%20%20%20%20%20%20%20%20%20self.calls%20%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%5BWORKER%5D%20Replica%20%7Breplica_id%7D%2C%20local%20rank%20%7Bself.local_rank%7D%20ready%22)%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20ping(self)%20-%3E%20bool%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Health%20check%20endpoint.%20Returns%20True%20if%20the%20worker%20is%20alive.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20True%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20process(self%2C%20data%3A%20str)%20-%3E%20dict%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Process%20some%20data.%20Might%20fail%20based%20on%20fail_rate.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20import%20random%0A%20%20%20%20%20%20%20%20%20%20%20%20self.calls%20%2B%3D%201%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20random.random()%20%3C%20self.fail_rate%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20RuntimeError(f%22Worker%20failed!%20(replica%3D%7Bself.replica_id%7D%2C%20local%3D%7Bself.local_rank%7D)%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22replica_id%22%3A%20self.replica_id%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22local_rank%22%3A%20self.local_rank%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22calls%22%3A%20self.calls%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22result%22%3A%20f%22Processed%20'%7Bdata%7D'%20by%20replica%20%7Bself.replica_id%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20get_replica_id(self)%20-%3E%20int%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Return%20which%20replica%20this%20worker%20belongs%20to.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self.replica_id%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20get_local_id(self)%20-%3E%20int%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Return%20this%20worker's%20local%20rank%20within%20its%20replica.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self.local_rank%0A%20%20%20%20return%20(Worker%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20The%20**local%20rank**%20is%20the%20worker's%20position%20within%20its%20ActorMesh%20(0%2C%201%2C%202%2C%20...).%20This%20is%20how%20workers%20within%20a%20replica%20coordinate%20-%20for%20example%2C%20rank%200%20might%20handle%20the%20first%20shard%20of%20a%20tensor-parallel%20model.%0A%0A%20%20%20%20The%20**replica%20ID**%20is%20passed%20at%20spawn%20time%20so%20workers%20know%20which%20replica%20they%20belong%20to.%20This%20is%20useful%20for%20logging%20and%20debugging.%0A%0A%20%20%20%20%23%23%20The%20Service%3A%20Routing%20and%20Health%20Tracking%0A%0A%20%20%20%20Now%20let's%20build%20the%20service%20that%20manages%20replicas.%20It%20needs%20to%3A%0A%20%20%20%20-%20Slice%20a%20ProcMesh%20into%20replica-sized%20chunks%0A%20%20%20%20-%20Spawn%20an%20ActorMesh%20for%20each%20replica%20(passing%20the%20replica%20ID)%0A%20%20%20%20-%20Route%20requests%20round-robin%20to%20healthy%20replicas%0A%20%20%20%20-%20Track%20which%20replicas%20are%20healthy%0A%20%20%20%20-%20Handle%20failures%20via%20%60__supervise__%60%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Actor%2C%20endpoint)%3A%0A%20%20%20%20class%20Service(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20Manages%20a%20pool%20of%20worker%20replicas%20with%20routing%20and%20health%20tracking.%0A%0A%20%20%20%20%20%20%20%20Each%20replica%20is%20an%20ActorMesh%20(potentially%20spanning%20multiple%20GPUs%2Fhosts).%0A%20%20%20%20%20%20%20%20The%20service%3A%0A%20%20%20%20%20%20%20%201.%20Slices%20resources%20into%20replica-sized%20chunks%0A%20%20%20%20%20%20%20%202.%20Spawns%20an%20ActorMesh%20per%20replica%0A%20%20%20%20%20%20%20%203.%20Routes%20requests%20round-robin%20to%20healthy%20replicas%0A%20%20%20%20%20%20%20%204.%20Tracks%20health%20and%20handles%20failures%0A%20%20%20%20%20%20%20%205.%20Can%20probe%20unhealthy%20replicas%20to%20check%20if%20they've%20recovered%0A%20%20%20%20%20%20%20%20%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(%0A%20%20%20%20%20%20%20%20%20%20%20%20self%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20service_name%3A%20str%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20worker_class%3A%20type%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20replica_procs%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20procs_per_replica%3A%20int%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20**worker_kwargs%0A%20%20%20%20%20%20%20%20)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.service_name%20%3D%20service_name%0A%20%20%20%20%20%20%20%20%20%20%20%20total_procs%20%3D%20len(replica_procs)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.num_replicas%20%3D%20total_procs%20%2F%2F%20procs_per_replica%0A%20%20%20%20%20%20%20%20%20%20%20%20self.procs_per_replica%20%3D%20procs_per_replica%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Slice%20the%20proc%20mesh%20into%20replica-sized%20chunks%0A%20%20%20%20%20%20%20%20%20%20%20%20self.replicas%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%20in%20range(self.num_replicas)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20start%20%3D%20i%20*%20procs_per_replica%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20end%20%3D%20start%20%2B%20procs_per_replica%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Slice%20out%20this%20replica's%20procs%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20replica_slice%20%3D%20replica_procs.slice(procs%3Dslice(start%2C%20end))%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Spawn%20an%20ActorMesh%20on%20this%20slice%2C%20passing%20replica_id%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20replica_mesh%20%3D%20replica_slice.spawn(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22replica_%7Bi%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20worker_class%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20replica_id%3Di%2C%20%20%23%20Pass%20replica%20ID%20to%20workers%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20**worker_kwargs%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.replicas.append(replica_mesh)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Track%20health%3A%20healthy%20and%20unhealthy%20sets%0A%20%20%20%20%20%20%20%20%20%20%20%20self.healthy%20%3D%20set(range(self.num_replicas))%0A%20%20%20%20%20%20%20%20%20%20%20%20self.unhealthy%3A%20set%5Bint%5D%20%3D%20set()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Round-robin%20index%0A%20%20%20%20%20%20%20%20%20%20%20%20self.next_idx%20%3D%200%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%5BSERVICE%3A%7Bservice_name%7D%5D%20%7Bself.num_replicas%7D%20replicas%20%C3%97%20%7Bprocs_per_replica%7D%20procs%20each%22)%0A%0A%20%20%20%20%20%20%20%20def%20__supervise__(self%2C%20failure)%20-%3E%20bool%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Called%20when%20a%20worker%20fails.%20Log%20it.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20report%20%3D%20failure.report()%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%5BSERVICE%3A%7Bself.service_name%7D%5D%20Failure%20detected%3A%20%7Breport%5B%3A100%5D%7D...%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20True%20%20%23%20Handled%20-%20real%20recovery%20is%20caller%20retrying%20with%20different%20replica%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20get_replica(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Get%20a%20healthy%20replica%20(round-robin%20selection).%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20self.healthy%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20RuntimeError(%22No%20healthy%20replicas%20available!%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20healthy_list%20%3D%20sorted(self.healthy)%0A%20%20%20%20%20%20%20%20%20%20%20%20idx%20%3D%20self.next_idx%20%25%20len(healthy_list)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.next_idx%20%2B%3D%201%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self.replicas%5Bhealthy_list%5Bidx%5D%5D%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20get_replica_with_idx(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Get%20a%20healthy%20replica%20and%20its%20index%20(for%20marking%20unhealthy%20later).%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20self.healthy%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20RuntimeError(%22No%20healthy%20replicas%20available!%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20healthy_list%20%3D%20sorted(self.healthy)%0A%20%20%20%20%20%20%20%20%20%20%20%20idx%20%3D%20self.next_idx%20%25%20len(healthy_list)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.next_idx%20%2B%3D%201%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20replica_idx%20%3D%20healthy_list%5Bidx%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self.replicas%5Breplica_idx%5D%2C%20replica_idx%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20mark_unhealthy(self%2C%20replica_idx%3A%20int)%20-%3E%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Mark%20a%20replica%20as%20unhealthy.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20replica_idx%20in%20self.healthy%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.healthy.discard(replica_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.unhealthy.add(replica_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%5BSERVICE%3A%7Bself.service_name%7D%5D%20Replica%20%7Breplica_idx%7D%20marked%20unhealthy.%20%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22Healthy%3A%20%7Blen(self.healthy)%7D%2F%7Bself.num_replicas%7D%22)%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20mark_healthy(self%2C%20replica_idx%3A%20int)%20-%3E%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Mark%20a%20replica%20as%20healthy%20again.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20replica_idx%20%3C%20self.num_replicas%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.unhealthy.discard(replica_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.healthy.add(replica_idx)%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20check_health(self)%20-%3E%20dict%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20Probe%20all%20unhealthy%20replicas%20to%20see%20if%20they've%20recovered.%0A%20%20%20%20%20%20%20%20%20%20%20%20Returns%20a%20dict%20with%20recovery%20results.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20recovered%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20still_unhealthy%20%3D%20%5B%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20replica_idx%20in%20list(self.unhealthy)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Ping%20the%20replica%20to%20see%20if%20it's%20alive%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.replicas%5Breplica_idx%5D.ping.call_one().get()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Success%20-%20mark%20healthy%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.unhealthy.discard(replica_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.healthy.add(replica_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20recovered.append(replica_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%5BSERVICE%3A%7Bself.service_name%7D%5D%20Replica%20%7Breplica_idx%7D%20recovered!%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Still%20unhealthy%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20still_unhealthy.append(replica_idx)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22recovered%22%3A%20recovered%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22still_unhealthy%22%3A%20still_unhealthy%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22healthy_count%22%3A%20len(self.healthy)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20get_health_status(self)%20-%3E%20dict%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22total%22%3A%20self.num_replicas%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22healthy%22%3A%20len(self.healthy)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22unhealthy%22%3A%20len(self.unhealthy)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22healthy_indices%22%3A%20sorted(self.healthy)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22unhealthy_indices%22%3A%20sorted(self.unhealthy)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20return%20(Service%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20Key%20design%20decisions%3A%0A%0A%20%20%20%201.%20**1%20replica%20%3D%201%20ActorMesh**%20-%20Each%20replica%20can%20span%20multiple%20GPUs%20(or%20even%20hosts)%0A%20%20%20%202.%20**Pass%20replica_id%20at%20spawn**%20-%20Workers%20know%20which%20replica%20they%20belong%20to%0A%20%20%20%203.%20**Caller%20registers%20the%20service**%20-%20After%20spawning%2C%20the%20caller%20calls%20%60register_service()%60.%20We%20can't%20do%20this%20in%20%60__init__%60%20because%20actors%20can't%20block%20on%20Futures%20during%20initialization.%0A%20%20%20%204.%20**Round-robin%20routing**%20-%20Simple%2C%20predictable%2C%20works%20well%20when%20replicas%20are%20similar%0A%20%20%20%205.%20**Caller%20marks%20unhealthy**%20-%20The%20service%20doesn't%20automatically%20detect%20which%20replica%20failed.%20Instead%2C%20the%20caller%20tells%20it%20after%20catching%20an%20exception.%0A%20%20%20%206.%20**Health%20probes%20for%20recovery**%20-%20Workers%20have%20a%20%60ping()%60%20endpoint.%20The%20service's%20%60check_health()%60%20method%20probes%20unhealthy%20replicas%20and%20recovers%20them%20if%20they%20respond.%0A%20%20%20%207.%20**%60__supervise__%60**%20-%20Monarch%20calls%20this%20when%20a%20child%20actor%20fails.%20We%20log%20it%2C%20but%20the%20real%20handling%20is%20the%20caller%20retrying%20with%20a%20different%20replica.%0A%0A%20%20%20%20%23%23%20Let's%20Run%20It!%0A%0A%20%20%20%20Let's%20create%20a%20simple%20demo%20that%20shows%3A%0A%20%20%20%20-%20Different%20replicas%20being%20called%20(round-robin)%0A%20%20%20%20-%20What%20happens%20when%20a%20replica%20fails%0A%20%20%20%20-%20How%20the%20service%20routes%20around%20failures%0A%20%20%20%20-%20How%20health%20checks%20recover%20replicas%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Service%2C%20Worker%2C%20register_service)%3A%0A%20%20%20%20%23%20Demo%3A%20Create%20a%20service%20with%204%20replicas%2C%201%20worker%20each%0A%20%20%20%20%23%20We'll%20send%208%20requests%20to%20see%20round-robin%20in%20action%0A%0A%20%20%20%20from%20monarch.actor%20import%20this_host%0A%0A%20%20%20%20%23%20Get%20procs%20on%20this%20host%0A%20%20%20%20host%20%3D%20this_host()%0A%0A%20%20%20%20%23%20The%20Service%20itself%20is%20an%20actor%2C%20so%20it%20needs%20to%20be%20spawned%20on%20a%20proc%0A%20%20%20%20service_proc%20%3D%20host.spawn_procs(%7B%22procs%22%3A%201%7D)%0A%0A%20%20%20%20%23%20Procs%20for%20the%20worker%20replicas%0A%20%20%20%20worker_procs%20%3D%20host.spawn_procs(%7B%22procs%22%3A%204%7D)%0A%0A%20%20%20%20%23%20Spawn%20the%20service%20actor%0A%20%20%20%20demo_service%20%3D%20service_proc.spawn(%0A%20%20%20%20%20%20%20%20%22demo_service%22%2C%0A%20%20%20%20%20%20%20%20Service%2C%0A%20%20%20%20%20%20%20%20service_name%3D%22demo%22%2C%0A%20%20%20%20%20%20%20%20worker_class%3DWorker%2C%0A%20%20%20%20%20%20%20%20replica_procs%3Dworker_procs%2C%0A%20%20%20%20%20%20%20%20procs_per_replica%3D1%2C%0A%20%20%20%20%20%20%20%20fail_rate%3D0.0%2C%20%20%23%20No%20failures%20for%20now%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Register%20the%20service%20so%20it%20can%20be%20discovered%20by%20name%0A%20%20%20%20register_service(%22demo%22%2C%20demo_service)%0A%0A%20%20%20%20%23%20Send%208%20requests%20-%20should%20round-robin%20through%20replicas%200%2C1%2C2%2C3%2C0%2C1%2C2%2C3%0A%20%20%20%20print(%22Round-robin%20demo%3A%22)%0A%20%20%20%20for%20_i%20in%20range(8)%3A%0A%20%20%20%20%20%20%20%20replica%2C%20replica_idx%20%3D%20demo_service.get_replica_with_idx.call_one().get()%0A%20%20%20%20%20%20%20%20result%20%3D%20replica.process.call_one(f%22request_%7B_i%7D%22).get()%0A%20%20%20%20%20%20%20%20print(f%22%20%20Request%20%7B_i%7D%3A%20handled%20by%20replica%20%7Bresult%5B'replica_id'%5D%7D%22)%0A%0A%20%20%20%20%23%20Note%3A%20In%20production%20you'd%20call%20worker_procs.stop()%20and%20service_proc.stop()%0A%20%20%20%20%23%20to%20clean%20up%2C%20but%20there's%20currently%20a%20Monarch%20bug%20where%20stopping%20procs%0A%20%20%20%20%23%20can%20crash%20the%20kernel%20if%20there%20are%20lingering%20references.%0A%20%20%20%20return%20(host%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20Handling%20Failures%0A%0A%20%20%20%20Now%20let's%20see%20what%20happens%20when%20a%20replica%20fails.%20We'll%20create%20a%20service%20with%20a%2030%25%20failure%20rate%20and%20watch%20the%20retry%20logic%20in%20action.%20Then%20we'll%20use%20%60check_health()%60%20to%20recover%20replicas.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Service%2C%20Worker%2C%20host%2C%20register_service)%3A%0A%20%20%20%20%23%20Create%20a%20service%20with%20a%20failure%20rate%0A%20%20%20%20%23%20Service%20needs%20its%20own%20proc%2C%20workers%20need%20their%20procs%0A%20%20%20%20flaky_service_proc%20%3D%20host.spawn_procs(%7B%22procs%22%3A%201%7D)%0A%20%20%20%20flaky_worker_procs%20%3D%20host.spawn_procs(%7B%22procs%22%3A%204%7D)%0A%0A%20%20%20%20flaky_service%20%3D%20flaky_service_proc.spawn(%0A%20%20%20%20%20%20%20%20%22flaky_service%22%2C%0A%20%20%20%20%20%20%20%20Service%2C%0A%20%20%20%20%20%20%20%20service_name%3D%22flaky_demo%22%2C%0A%20%20%20%20%20%20%20%20worker_class%3DWorker%2C%0A%20%20%20%20%20%20%20%20replica_procs%3Dflaky_worker_procs%2C%0A%20%20%20%20%20%20%20%20procs_per_replica%3D1%2C%0A%20%20%20%20%20%20%20%20fail_rate%3D0.3%2C%20%20%23%2030%25%20failure%20rate%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Register%20the%20service%0A%20%20%20%20register_service(%22flaky_demo%22%2C%20flaky_service)%0A%0A%20%20%20%20%23%20Try%20to%20process%20with%20retry%0A%20%20%20%20def%20process_with_retry(svc%2C%20data%2C%20max_retries%3D3)%3A%0A%20%20%20%20%20%20%20%20for%20attempt%20in%20range(max_retries)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20replica%2C%20replica_idx%20%3D%20svc.get_replica_with_idx.call_one().get()%0A%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20result%20%3D%20replica.process.call_one(data).get()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20Success%20on%20replica%20%7Breplica_idx%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20result%0A%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%20as%20e%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20Attempt%20%7Battempt%2B1%7D%20failed%20on%20replica%20%7Breplica_idx%7D%3A%20%7Be%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svc.mark_unhealthy.call_one(replica_idx).get()%0A%20%20%20%20%20%20%20%20raise%20RuntimeError(%22All%20retries%20exhausted%22)%0A%0A%20%20%20%20%23%20Process%20several%20requests%0A%20%20%20%20print(%22Failure%20handling%20demo%3A%22)%0A%20%20%20%20for%20_j%20in%20range(5)%3A%0A%20%20%20%20%20%20%20%20print(f%22Request%20%7B_j%7D%3A%22)%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20process_with_retry(flaky_service%2C%20f%22data_%7B_j%7D%22)%0A%20%20%20%20%20%20%20%20except%20RuntimeError%20as%20e%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20%7Be%7D%22)%0A%0A%20%20%20%20%23%20Check%20health%20status%20after%20failures%0A%20%20%20%20status%20%3D%20flaky_service.get_health_status.call_one().get()%0A%20%20%20%20print(f%22%5CnAfter%20failures%3A%20%7Bstatus%5B'healthy'%5D%7D%2F%7Bstatus%5B'total'%5D%7D%20replicas%20healthy%22)%0A%20%20%20%20print(f%22Unhealthy%20replicas%3A%20%7Bstatus%5B'unhealthy_indices'%5D%7D%22)%0A%0A%20%20%20%20%23%20Now%20run%20health%20checks%20to%20recover%20replicas%0A%20%20%20%20%23%20(In%20our%20case%2C%20the%20replicas%20are%20still%20alive%20-%20they%20just%20had%20random%20failures)%0A%20%20%20%20print(%22%5CnRunning%20health%20check%20to%20recover%20replicas...%22)%0A%20%20%20%20recovery%20%3D%20flaky_service.check_health.call_one().get()%0A%20%20%20%20print(f%22Recovered%3A%20%7Brecovery%5B'recovered'%5D%7D%22)%0A%20%20%20%20print(f%22Still%20unhealthy%3A%20%7Brecovery%5B'still_unhealthy'%5D%7D%22)%0A%0A%20%20%20%20%23%20Check%20health%20status%20after%20recovery%0A%20%20%20%20status_after%20%3D%20flaky_service.get_health_status.call_one().get()%0A%20%20%20%20print(f%22%5CnAfter%20health%20check%3A%20%7Bstatus_after%5B'healthy'%5D%7D%2F%7Bstatus_after%5B'total'%5D%7D%20replicas%20healthy%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20What%20We%20Built%0A%0A%20%20%20%20A%20simple%20but%20complete%20service%20framework%3A%0A%0A%20%20%20%20%7C%20Component%20%7C%20Responsibility%20%7C%0A%20%20%20%20%7C-----------%7C---------------%7C%0A%20%20%20%20%7C%20**%60get_service(name)%60**%20%7C%20Find%20a%20service%20by%20name%20%7C%0A%20%20%20%20%7C%20**%60register_service(name%2C%20svc)%60**%20%7C%20Register%20a%20service%20for%20discovery%20%7C%0A%20%20%20%20%7C%20**Worker**%20%7C%20Does%20the%20actual%20work%2C%20knows%20its%20replica_id%20and%20local_rank%20%7C%0A%20%20%20%20%7C%20**Service**%20%7C%20Owns%20replicas%20(ActorMeshes)%2C%20routes%20requests%2C%20tracks%20health%20%7C%0A%0A%20%20%20%20The%20pattern%3A%0A%20%20%20%201.%20Services%20register%20themselves%20on%20startup%20with%20%60register_service()%60%0A%20%20%20%202.%20Clients%20discover%20services%20with%20%60get_service()%60%0A%20%20%20%203.%20Clients%20get%20replicas%2C%20make%20calls%2C%20handle%20failures%20inline%0A%20%20%20%204.%20On%20failure%2C%20mark%20unhealthy%20and%20retry%20with%20a%20different%20replica%0A%0A%20%20%20%20%23%23%20What's%20Missing%3F%0A%0A%20%20%20%20The%20generators%20need%20**updated%20weights**%20after%20the%20trainer%20takes%20a%20gradient%20step.%20Right%20now%20they'd%20be%20using%20stale%20weights%20forever.%0A%0A%20%20%20%20How%20do%20we%20efficiently%20sync%20weights%20from%20trainer%20to%20generators%3F%0A%0A%20%20%20%20**Next%20notebook%3A%20RDMA%20Weight%20Sync**%20-%20Using%20Monarch's%20RDMA%20primitives%20to%20transfer%20weights%20without%20blocking%20training.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A
</marimo-code>

<marimo-code-hash hidden="">34745f4d3c08810af745ccb1187b979a</marimo-code-hash>
</body>
</html>
