<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/apple-touch-icon.png" />
    <link rel="manifest" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        const scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          // Guard against race condition where iframe isn't ready
          if (!obj.contentWindow?.document?.documentElement) {
            return;
          }
          const element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          const hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          const newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((_entries) => {
          setHeight();
        });
        // Only observe if iframe content is ready
        if (obj.contentWindow?.document?.body) {
          resizeObserver.observe(obj.contentWindow.document.body);
        }
      }
    </script>
    <marimo-filename hidden>05_services.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>05 services</title>
    <script type="module" crossorigin crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/index-CD6Gw4UH.js"></script>
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/preload-helper-D2MJg03u.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/clsx-D8GwTfvk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/cn-BKtXLv3a.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/chunk-LvLJmgfZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/react-Bj1aDYRI.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/compiler-runtime-B3qBwwSJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/jsx-runtime-ZmTK25f3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/badge-DX6CQ6PA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/hotkeys-BHHWjLlp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useEventListener-Cb-RVVEn.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/button-CZ3Cs4qb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/react-dom-CSu739Rf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/Combination-BAEdC-rz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/menu-items-BMjcEb2j.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-DwV58Fb1.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/createLucideIcon-BCdY6lG5.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/check-Dr3SxUsb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/x-ZP5cObgf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/select-BVdzZKAh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/tooltip-CMQz28hC.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/use-toast-BDYuj3zG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_Uint8Array-BGESiCQL.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_baseIsEqual-B9N9Mw_N.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useEvent-BhXAndur.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/invariant-CAG_dYON.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_baseFor-Duhs3RiJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/merge-BBX6ug-N.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/zod-H_cgTO0M.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/utils-YqBXNpsM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/Deferred-DxQeE5uh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/uuid-DXdzqzcr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/DeferredRequestRegistry-CMf25YiV.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/constants-B6Cb__3x.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/session-BOFn9QrD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/config-Q0O7_stz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/requests-B4FYHTZl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/isSymbol-BGkTcW3U.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/toString-DlRqgfqz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_hasUnicode-CWqKLxBC.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/assertNever-CBU83Y6o.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_arrayReduce-TT0iOGKY.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useLifecycle-ClI_npeg.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useNonce-CS26E0hA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useTheme-DQozhcp1.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/once-Bul8mtFs.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/capabilities-MM7JYRxj.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/createReducer-B3rBsy4P.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/paths-BzSgteR-.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-DBwNzi3C.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-ChS0Dc_R.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-CtsanegT.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-Dcqqg9UU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-sMh6mJ2d.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-Btv5Rh1v.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-bBwmhqty.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-CoCQUAeM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-Gqv0jSNr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/stex-jWatZkll.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/toDate-DETS9bBd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/cjs-CH5Rj0g8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_baseProperty-NKyJO2oh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/now-6sUe0ZdD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/debounce-B3mjKxHe.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/toInteger-CDcO32Gx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/database-zap-k4ePIFAU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/main-U5Goe76G.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/cells-DPp5cDaO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/spinner-DA8-7wQv.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/chevron-right--18M_6o9.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dropdown-menu-ldcmQvIV.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/kbd-Cm6Ba9qg.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/renderShortcut-BckyRbYt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/multi-map-DxdLNTBd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/alert-BOoN6gJ1.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/card-OlSjYhmd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/alert-dialog-BW4srmS0.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dialog-eb-NieZw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-CDXJRSCj.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/label-E64zk6_7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useDebounce-7iEVSqwM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/textarea-CRI7xDBj.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/numbers-D7O23mOZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/SSRProvider-BIDQNg9Q.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/context-BfYAMNLF.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useNumberFormatter-Db6Vjve5.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/usePress-C__vuri5.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/input-DUrq2DiR.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/links-7AQBmdyV.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/popover-CH1FzjxU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/switch-dWLWbbtg.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/table-DScsXgJW.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/mode-Bn7pdJvO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useAsyncData-BMGLSTg8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/errors-TZBmrJmc.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/error-banner-B9ts0mNl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/copy-DHrHayPa.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/memoize-BCOZVFBt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/get-6uJrSKbw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/capitalize-CmNnkG9y.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/copy-D-8y6iMN.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/plus-B7DF33lD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/refresh-cw-Dx8TEWFP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/trash-2-DDsWrxuJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/triangle-alert-CebQ7XwA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/ai-model-dropdown-Dk2SdB3C.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/defaultLocale-JieDVWC_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/precisionRound-CU2C3Vxx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/defaultLocale-BLne0bXb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/vega-loader.browser-DXARUlxo.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/tooltip-DxKBXCGp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/ErrorBoundary-B9Ifj8Jf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useInstallPackage-D4fX0Ee_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/ImperativeModal-BNN1HA7x.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/cell-link-B9b7J8QK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/datasource-CtyqtITR.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/state-D4T75eZb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/MarimoErrorOutput-Lf9P8Fhl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/copy-icon-v8ME_JKB.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/html-to-image-CIQqSu-S.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/focus-C1YokgL7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/LazyAnyLanguageCodeMirror-DgZ8iknE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/chunk-5FQGJX7Z-DPlx2kjA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/katex-CDLTCvjQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/markdown-renderer-DJy8ww5d.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/command-2ElA5IkO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/download-os8QlW6l.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useRunCells-D2HBb4DB.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/purify.es-DZrAQFIu.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/RenderHTML-D-of_-s7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useIframeCapabilities-B_pQb20b.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/formats-CobRswjh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/en-US-CCVfmA-q.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/isValid-DDt9wNjK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dates-CrvjILe3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/maps-D2_Mq1pZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/extends-BiFDv3jB.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/emotion-is-prop-valid.esm-C59xfSYt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useDateFormatter-CqhdUl2n.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/range-D2UKkEg-.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/table-CfDbAm78.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/JsonOutput-PE5ko4gi.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useDeleteCell-DdRX94yC.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/icons-CCHmxi8d.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/process-output-ByfLnk6j.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/blob-D-eV0cU3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/objectWithoutPropertiesLoose-DfWeGRFv.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/esm-Bmu2DhPy.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/file-Ch78NKWp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/play-GLWQQs7F.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/add-cell-with-ai-e_HMl7UU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/isEmpty-CgX_-6Mt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/bot-message-square-B2ThzDUZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/chat-display--jAB7huF.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/chart-no-axes-column-qvVRjhv1.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/square-function-B6mgCeFJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/spec-Ch0xnJY4.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/column-preview-CXjSXUhP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/toggle-zVW4FXNz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/globals-BgACvYmr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/share-ipf2hrOh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_baseSet-5Rdwpmr3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/react-resizable-panels.browser.esm-Da3ksQXL.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/utilities.esm-dm9SQStE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/floating-outline-BtdqbkUq.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useAddCell-CmuX2hOk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/eye-off-AK_9uodG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/readonly-python-code-WjTf6Pdd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/file-video-camera-C3wGzBnE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/types-BRfQN3HL.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/refresh-ccw-DN_xCV6A.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/form-BidPUZUn.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/field-CySaBlkz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useBoolean-Ck_unDZw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useDeepCompareMemoize-5OUgerQ3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/types-C1UhS3qM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/prop-types-DaaA-ptl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/es-BYgU_srD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/hasIn-CycJImp8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_baseFlatten-CUZNxU8H.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/flatten-D-7VEN0q.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/pick-B_6Qi5aM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/code-xml-CgN_Yig7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/download-Dg7clfkc.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/square-CuJ72M8f.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/settings-OBbrbhij.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/bundle.esm-i_UbZC0w.js">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/cells-jmgGt1lS.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/markdown-renderer-DdDKmWlR.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/JsonOutput-B7vuddcd.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/index-CeUwN_0i.css">
  
<script data-marimo="true">
    window.__MARIMO_STATIC__ = {};
    window.__MARIMO_STATIC__.files = {};
</script>
</head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "05_services.py",
            "mode": "read",
            "version": "0.19.9",
            "serverToken": "static",
            "config": {"ai": {"custom_providers": {}, "models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false, "signature_hint_on_typing": false}, "diagnostics": {"sql_linter": true}, "display": {"cell_output": "below", "code_editor_font_size": 14, "dataframes": "rich", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "medium", "reference_highlighting": true, "theme": "light"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": false}}, "mcp": {"mcpServers": {}, "presets": []}, "package_management": {"manager": "uv"}, "runtime": {"auto_instantiate": false, "auto_reload": "off", "default_csv_encoding": "utf-8", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "after_delay", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"sql_output": "auto", "width": "medium"},
            "view": {"showAppCode": true},
            "notebook": {"cells": [{"code": "import marimo as mo", "code_hash": "1d0db38904205bec4d6f6f6a1f6cec3e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hbol", "name": "_"}, {"code": "mo.md(r\"\"\"\n# Services: Managing Worker Pools\n\nIn the last notebook, we saw how generation variance makes synchronous RL\nwasteful \u2014 the trainer sits idle waiting for the slowest generator. The fix\nis running many generators in parallel, decoupled from training.\n\nBut managing a pool of workers brings its own problems. Let's see what\nhappens when you try to do it by hand.\n\"\"\")", "code_hash": "d4bfd587ccd9cde6643dbfdfd39dab50", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "MJUe", "name": "_"}, {"code": "import random\nfrom monarch.actor import Actor, endpoint, current_rank, this_host, get_or_spawn_controller", "code_hash": "4106573a7b8b587bf66b819d405c4824", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "vblA", "name": "_"}, {"code": "class Worker(Actor):\n    \"\"\"A worker that processes requests. May fail randomly.\"\"\"\n\n    def __init__(self, fail_rate: float = 0.0):\n        self.rank = current_rank().rank\n        self.fail_rate = fail_rate\n        self.calls = 0\n\n    @endpoint\n    def ping(self) -\u003E bool:\n        return True\n\n    @endpoint\n    def process(self, data: str) -\u003E str:\n        \"\"\"Process a request. Might fail based on fail_rate.\"\"\"\n        self.calls += 1\n        if random.random() \u003C self.fail_rate:\n            raise RuntimeError(f\"Worker failed!\")\n        return f\"Processed '{data}'\"", "code_hash": "1461f5d6f38f230d17a1fdf86738ab4a", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "bkHC", "name": "_"}, {"code": "# === The Manual Approach ===\nhost = this_host()\nprocs = host.spawn_procs(per_host={\"procs\": 4})\n\n# Spawn 4 workers on individual proc slices\nmanual_workers = []\nfor i in range(4):\n    w = procs.slice(procs=i).spawn(f\"w_{i}\", Worker, fail_rate=0.3)\n    manual_workers.append(w)\n\n# Manual round-robin with manual failure tracking\nhealthy = list(range(4))\ncurrent_idx = 0\n\nprint(\"=== Manual Worker Management ===\")\nfor req in range(6):\n    if not healthy:\n        print(f\"  Request {req}: No workers left!\")\n        break\n\n    worker_idx = healthy[current_idx % len(healthy)]\n    try:\n        result = manual_workers[worker_idx].process.call_one(f\"req_{req}\").get()\n        print(f\"  Request {req}: Worker {worker_idx} -\u003E OK\")\n        current_idx += 1\n    except Exception:\n        print(f\"  Request {req}: Worker {worker_idx} FAILED \u2014 removing from pool\")\n        healthy.remove(worker_idx)\n        # But is it really dead? Or just a transient error?\n        # How do we check later? When do we add it back?\n\nprint(f\"\\n{len(healthy)}/4 workers still in pool\")\nprint(\"Questions:\")\nprint(\"  Who checks if failed workers recovered?\")\nprint(\"  What if multiple clients need this same pool?\")\nprint(\"  What if we have 50 workers across 10 nodes?\")", "code_hash": "96c4d3bbb2d298de63fc667340fa61e9", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "lEQa", "name": "_"}, {"code": "mo.md(r\"\"\"\n## The Problems with Manual Management\n\nThat works for 4 workers in a notebook. But at scale:\n\n- **Shared state**: Multiple clients need the same pool, but each tracks\n  its own `healthy` list \u2014 when one client discovers a failure, others\n  don't know\n- **Recovery**: No mechanism to check if failed workers come back\n- **Discovery**: Clients must know exactly which workers exist at spawn time\n- **Multi-GPU replicas**: A 70B model needs tensor parallelism across 8\n  GPUs \u2014 each \"replica\" is a group of workers, not a single process\n\nThe fix: centralize pool management in a **Service** actor. Since it's an\nactor, its state (which replicas are healthy, the round-robin index) is\nautomatically shared across all callers \u2014 no duplicate tracking.\n\"\"\")", "code_hash": "2cc26610795921c82606eef195089f2d", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "PKri", "name": "_"}, {"code": "mo.md(r\"\"\"\n## The Service Actor\n\nThe Service centralizes everything the manual approach did ad-hoc:\n\n1. Takes a `worker_class` and a ProcMesh, slices it into replica-sized\n   chunks, and spawns an ActorMesh on each\n2. Routes requests round-robin across healthy replicas\n3. Tracks health \u2014 callers mark replicas unhealthy, the Service can\n   probe for recovery\n\nWe treat **1 replica = 1 ActorMesh** \u2014 each replica can span multiple\nGPUs for tensor parallelism. If your model fits on one GPU, a replica is\njust size 1.\n\nThe methods fall into three groups:\n\n- **Routing**: `get_replica()` / `get_replica_with_idx()` \u2014 round-robin\n  across healthy replicas\n- **Health**: `mark_unhealthy()` / `check_health()` \u2014 callers report\n  failures, Service probes for recovery\n- **Lifecycle**: `__init__` slices the ProcMesh and spawns workers\n\"\"\")", "code_hash": "4f5135ed8638a9e5307a40d993adc40e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Xref", "name": "_"}, {"code": "class Service(Actor):\n    \"\"\"Manages a pool of worker replicas with routing and health tracking.\n\n    The Service owns worker lifecycle: it slices a ProcMesh into\n    replica-sized chunks and spawns an ActorMesh on each.\n    \"\"\"\n\n    def __init__(\n        self,\n        service_name: str,\n        worker_class: type,\n        procs,\n        procs_per_replica: int = 1,\n        **worker_kwargs,\n    ):\n        self.service_name = service_name\n        total = len(procs)\n        self.num_replicas = total // procs_per_replica\n\n        # Slice ProcMesh and spawn a replica on each chunk\n        self.replicas = []\n        for i in range(self.num_replicas):\n            start = i * procs_per_replica\n            end = start + procs_per_replica\n            replica_slice = procs.slice(procs=slice(start, end))\n            replica = replica_slice.spawn(\n                f\"replica_{i}\", worker_class, **worker_kwargs,\n            )\n            self.replicas.append(replica)\n\n        self.healthy = set(range(self.num_replicas))\n        self.unhealthy: set[int] = set()\n        self.next_idx = 0\n\n        print(f\"[SERVICE:{service_name}] {self.num_replicas} replicas \"\n              f\"x {procs_per_replica} procs each\")\n\n    # --- Routing ---\n\n    @endpoint\n    def get_replica(self):\n        \"\"\"Get a healthy replica (round-robin).\"\"\"\n        if not self.healthy:\n            raise RuntimeError(\"No healthy replicas available!\")\n        healthy_list = sorted(self.healthy)\n        idx = self.next_idx % len(healthy_list)\n        self.next_idx += 1\n        return self.replicas[healthy_list[idx]]\n\n    @endpoint\n    def get_replica_with_idx(self):\n        \"\"\"Get (replica, index). Use the index for mark_unhealthy().\"\"\"\n        if not self.healthy:\n            raise RuntimeError(\"No healthy replicas available!\")\n        healthy_list = sorted(self.healthy)\n        idx = self.next_idx % len(healthy_list)\n        self.next_idx += 1\n        replica_idx = healthy_list[idx]\n        return self.replicas[replica_idx], replica_idx\n\n    # --- Health tracking ---\n\n    @endpoint\n    def mark_unhealthy(self, replica_idx: int) -\u003E None:\n        \"\"\"Remove a replica from rotation.\"\"\"\n        if replica_idx in self.healthy:\n            self.healthy.discard(replica_idx)\n            self.unhealthy.add(replica_idx)\n            print(f\"[SERVICE:{self.service_name}] Replica {replica_idx} unhealthy. \"\n                  f\"Healthy: {len(self.healthy)}/{self.num_replicas}\")\n\n    @endpoint\n    def mark_healthy(self, replica_idx: int) -\u003E None:\n        \"\"\"Reinstate a replica.\"\"\"\n        if replica_idx \u003C self.num_replicas:\n            self.unhealthy.discard(replica_idx)\n            self.healthy.add(replica_idx)\n\n    @endpoint\n    def check_health(self) -\u003E dict:\n        \"\"\"Probe unhealthy replicas. Reinstate those that respond to ping().\"\"\"\n        recovered = []\n        still_unhealthy = []\n        for replica_idx in list(self.unhealthy):\n            try:\n                # Use .call() not .call_one() \u2014 works for multi-GPU replicas too\n                self.replicas[replica_idx].ping.call().get()\n                self.unhealthy.discard(replica_idx)\n                self.healthy.add(replica_idx)\n                recovered.append(replica_idx)\n                print(f\"[SERVICE:{self.service_name}] Replica {replica_idx} recovered!\")\n            except Exception:\n                still_unhealthy.append(replica_idx)\n        return {\n            \"recovered\": recovered,\n            \"still_unhealthy\": still_unhealthy,\n            \"healthy_count\": len(self.healthy),\n        }\n\n    @endpoint\n    def get_health_status(self) -\u003E dict:\n        return {\n            \"total\": self.num_replicas,\n            \"healthy\": len(self.healthy),\n            \"unhealthy\": len(self.unhealthy),\n            \"healthy_indices\": sorted(self.healthy),\n            \"unhealthy_indices\": sorted(self.unhealthy),\n        }\n\n    # --- Lifecycle ---\n\n    @endpoint\n    def get_all_replicas(self) -\u003E list:\n        \"\"\"Get all replicas (for operations that touch every replica).\"\"\"\n        return list(self.replicas)\n\n    @endpoint\n    def ping(self) -\u003E bool:\n        return True", "code_hash": "57b0a6a44685cb809ac855676293c33e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "SFPL", "name": "_"}, {"code": "mo.md(r\"\"\"\nKey design decisions:\n\n- **Service spawns workers** \u2014 it takes a `worker_class` and a ProcMesh,\n  slices it into replica-sized chunks, and spawns an ActorMesh on each.\n  Because the Service owns the lifecycle, it could also respawn failed\n  replicas.\n- **Caller marks unhealthy** \u2014 the Service doesn't auto-detect failures.\n  The caller catches the exception and tells the Service. This is the same\n  try/except pattern from notebook 03.\n- **Caller registers** \u2014 we call `register_service()` after spawning\n  because actors can't block on Futures during `__init__`.\n\"\"\")", "code_hash": "fdb50e0b721a713608452d16df8cc8b9", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "BYtC", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Service Discovery\n\nMultiple parts of the system need the same services \u2014 the trainer needs\ngenerators, the orchestrator needs the trainer. Rather than threading\nreferences everywhere, we use a **singleton registry**. Monarch's\n`get_or_spawn_controller` guarantees exactly one exists across all\nprocesses.\n\"\"\")", "code_hash": "0c01efb856349d55dae4ec0960cfc128", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "RGSE", "name": "_"}, {"code": "class ServiceRegistry(Actor):\n    \"\"\"Singleton registry for service discovery.\"\"\"\n\n    def __init__(self):\n        self.services: dict[str, Actor] = {}\n        print(\"[REGISTRY] ServiceRegistry spawned\")\n\n    @endpoint\n    def register(self, name: str, service) -\u003E None:\n        self.services[name] = service\n        print(f\"[REGISTRY] Registered '{name}'\")\n\n    @endpoint\n    def get(self, name: str):\n        if name not in self.services:\n            raise KeyError(f\"Service '{name}' not found\")\n        return self.services[name]\n\n    @endpoint\n    def list_services(self) -\u003E list[str]:\n        return list(self.services.keys())\n\n\ndef _get_registry():\n    return get_or_spawn_controller(\"service_registry\", ServiceRegistry).get()\n\ndef get_service(name: str):\n    \"\"\"Get a service by name.\"\"\"\n    return _get_registry().get.call_one(name).get()\n\ndef register_service(name: str, service) -\u003E None:\n    \"\"\"Register a service for discovery.\"\"\"\n    _get_registry().register.call_one(name, service).get()\n\ndef list_services() -\u003E list[str]:\n    \"\"\"List all registered services.\"\"\"\n    return _get_registry().list_services.call_one().get()", "code_hash": "b4b4d53e7836edad356f8493f82ca59e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Kclp", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Seeing It Work\n\nFirst, the happy path \u2014 4 replicas, no failures. Watch the round-robin\ndistribute requests evenly.\n\"\"\")", "code_hash": "54a3fa7fdadd5edfe61d96f8da5039ba", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "emfo", "name": "_"}, {"code": "# === Demo 1: Round-Robin Routing ===\nsvc_proc = host.spawn_procs(per_host={\"procs\": 1})\nworker_procs_demo = host.spawn_procs(per_host={\"procs\": 4})\n\ndemo_svc = svc_proc.spawn(\n    \"demo_svc\", Service,\n    service_name=\"demo\",\n    worker_class=Worker,\n    procs=worker_procs_demo,\n    procs_per_replica=1,\n    fail_rate=0.0,\n)\nregister_service(\"demo\", demo_svc)\n\nprint(\"=== Round-Robin Demo ===\")\nfor req_num in range(4):\n    worker, idx = demo_svc.get_replica_with_idx.call_one().get()\n    response = worker.process.call_one(f\"req_{req_num}\").get()\n    print(f\"  Request {req_num}: replica {idx} -\u003E {response}\")", "code_hash": "ca20964a8ca9a789475deea3ee454b0d", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hstk", "name": "_"}, {"code": "mo.md(r\"\"\"\n### Handling Failures\n\nNow with a 30% failure rate. The pattern: try, catch, `mark_unhealthy`,\nretry with a different replica. Then `check_health` to probe for recovery.\n\"\"\")", "code_hash": "10ba17485a0baacc3b7bfb0fd882aec9", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "nWHF", "name": "_"}, {"code": "# === Demo 2: Failure Handling + Recovery ===\nflaky_svc_proc = host.spawn_procs(per_host={\"procs\": 1})\nflaky_worker_procs = host.spawn_procs(per_host={\"procs\": 4})\n\nflaky_svc = flaky_svc_proc.spawn(\n    \"flaky_svc\", Service,\n    service_name=\"flaky\",\n    worker_class=Worker,\n    procs=flaky_worker_procs,\n    procs_per_replica=1,\n    fail_rate=0.3,\n)\nregister_service(\"flaky\", flaky_svc)\n\ndef process_with_retry(svc, data, max_retries=3):\n    \"\"\"The canonical pattern: try/except + mark_unhealthy + retry.\"\"\"\n    for attempt in range(max_retries):\n        replica, idx = None, None\n        try:\n            replica, idx = svc.get_replica_with_idx.call_one().get()\n            return replica.process.call_one(data).get()\n        except Exception:\n            if idx is not None:\n                print(f\"    Attempt {attempt + 1}: replica {idx} failed\")\n                svc.mark_unhealthy.call_one(idx).get()\n            else:\n                print(f\"    Attempt {attempt + 1}: no healthy replicas\")\n    raise RuntimeError(\"All retries exhausted\")\n\nprint(\"=== Failure Handling Demo ===\")\nfor j in range(5):\n    print(f\"  Request {j}:\")\n    try:\n        _result = process_with_retry(flaky_svc, f\"data_{j}\")\n        print(f\"    Success: {_result}\")\n    except RuntimeError as e:\n        print(f\"    {e}\")\n\n# Check health after failures\nstatus = flaky_svc.get_health_status.call_one().get()\nprint(f\"\\nAfter failures: {status['healthy']}/{status['total']} healthy\")\nprint(f\"Unhealthy: {status['unhealthy_indices']}\")\n\n# Recover \u2014 workers are still alive, they just had transient errors\nprint(\"\\nProbing unhealthy replicas...\")\nrecovery = flaky_svc.check_health.call_one().get()\nprint(f\"Recovered: {recovery['recovered']}\")\n\nstatus_after = flaky_svc.get_health_status.call_one().get()\nprint(f\"Now: {status_after['healthy']}/{status_after['total']} healthy\")", "code_hash": "28692af24992aa862362cb5560858919", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "iLit", "name": "_"}, {"code": "mo.md(r\"\"\"\n### Discovery in Action\n\nA completely separate part of the system can find services by name \u2014\nno need to pass actor references around.\n\"\"\")", "code_hash": "73e540ad5aa43a368d06f0734b5a3d79", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ZHCJ", "name": "_"}, {"code": "# === Demo 3: Service Discovery ===\nprint(\"=== Service Discovery Demo ===\")\nprint(f\"Registered services: {list_services()}\")\n\n# Find the demo service by name \u2014 no reference needed\ndiscovered = get_service(\"demo\")\nfound_worker = discovered.get_replica.call_one().get()\ndiscovery_result = found_worker.process.call_one(\"found via discovery!\").get()\nprint(f\"Discovered 'demo' service, got: {discovery_result}\")", "code_hash": "73b048b6f9297864f6f0afd3db4b7596", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ROlb", "name": "_"}, {"code": "mo.md(r\"\"\"\n## What We Built\n\n| Component | Responsibility |\n|-----------|---------------|\n| **Worker** | Processes requests, has `ping()` for health checks |\n| **Service** | Spawns replicas, routes round-robin, tracks health |\n| **ServiceRegistry** | Singleton for discovery (`get_service(\"name\")`) |\n\nThe pattern:\n1. Allocate procs and spawn a Service (which spawns its own workers)\n2. Register the service so clients can discover it by name\n3. Clients get replicas, make calls, handle failures inline\n4. On failure: `mark_unhealthy` + retry with a different replica\n5. Periodically: `check_health` to recover transient failures\n\nThis Service class lives in `src/monarch_utils/services.py` \u2014 in notebook\n07, we'll import it and use it to manage real generator workers.\n\n## What's Missing?\n\nThe generators need **updated weights** after the trainer takes a gradient\nstep. Right now they'd use stale weights forever.\n\nHow do we efficiently move hundreds of megabytes of model weights from\ntrainer to generators \u2014 without blocking training?\n\n**Next: RDMA Weight Sync** \u2014 using Monarch's RDMA primitives for direct\nGPU-to-GPU weight transfer.\n\n---\n\n**Previous:** [NB04 \u2014 RL Intro](./04_rl_intro.html) \u00b7 **Next:** [NB06 \u2014 RDMA Weight Sync](./06_rdma_weight_sync.html)\n\"\"\")", "code_hash": "962e89ba0f1e8373d48c784721adb803", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "qnkX", "name": "_"}], "metadata": {"marimo_version": "0.19.9"}, "version": "1"},
            "session": {"cells": [{"code_hash": "1d0db38904205bec4d6f6f6a1f6cec3e", "console": [], "id": "Hbol", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "d4bfd587ccd9cde6643dbfdfd39dab50", "console": [], "id": "MJUe", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch1 id=\"services-managing-worker-pools\"\u003EServices: Managing Worker Pools\u003C/h1\u003E\n\u003Cspan class=\"paragraph\"\u003EIn the last notebook, we saw how generation variance makes synchronous RL\nwasteful \u2014 the trainer sits idle waiting for the slowest generator. The fix\nis running many generators in parallel, decoupled from training.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EBut managing a pool of workers brings its own problems. Let's see what\nhappens when you try to do it by hand.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "4106573a7b8b587bf66b819d405c4824", "console": [], "id": "vblA", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "1461f5d6f38f230d17a1fdf86738ab4a", "console": [], "id": "bkHC", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "96c4d3bbb2d298de63fc667340fa61e9", "console": [{"mimetype": "text/plain", "name": "stderr", "text": "Monarch internal logs are being written to /tmp/allencwang/monarch_log.log; execution id allencwang_Feb-07_10:34_541\n", "type": "stream"}, {"mimetype": "text/plain", "name": "stdout", "text": "=== Manual Worker Management ===\n  Request 0: Worker 0 -\u003E OK\n  Request 1: Worker 1 FAILED \u2014 removing from pool\n  Request 2: Worker 2 -\u003E OK\n  Request 3: Worker 3 -\u003E OK\n  Request 4: Worker 0 FAILED \u2014 removing from pool\n  Request 5: Worker 3 -\u003E OK\n\n2/4 workers still in pool\nQuestions:\n  Who checks if failed workers recovered?\n  What if multiple clients need this same pool?\n  What if we have 50 workers across 10 nodes?\n", "type": "stream"}], "id": "lEQa", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "2cc26610795921c82606eef195089f2d", "console": [], "id": "PKri", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"the-problems-with-manual-management\"\u003EThe Problems with Manual Management\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EThat works for 4 workers in a notebook. But at scale:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Cstrong\u003EShared state\u003C/strong\u003E: Multiple clients need the same pool, but each tracks\n  its own \u003Ccode\u003Ehealthy\u003C/code\u003E list \u2014 when one client discovers a failure, others\n  don't know\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ERecovery\u003C/strong\u003E: No mechanism to check if failed workers come back\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EDiscovery\u003C/strong\u003E: Clients must know exactly which workers exist at spawn time\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EMulti-GPU replicas\u003C/strong\u003E: A 70B model needs tensor parallelism across 8\n  GPUs \u2014 each \"replica\" is a group of workers, not a single process\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003EThe fix: centralize pool management in a \u003Cstrong\u003EService\u003C/strong\u003E actor. Since it's an\nactor, its state (which replicas are healthy, the round-robin index) is\nautomatically shared across all callers \u2014 no duplicate tracking.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "4f5135ed8638a9e5307a40d993adc40e", "console": [], "id": "Xref", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"the-service-actor\"\u003EThe Service Actor\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EThe Service centralizes everything the manual approach did ad-hoc:\u003C/span\u003E\n\u003Col\u003E\n\u003Cli\u003ETakes a \u003Ccode\u003Eworker_class\u003C/code\u003E and a ProcMesh, slices it into replica-sized\n   chunks, and spawns an ActorMesh on each\u003C/li\u003E\n\u003Cli\u003ERoutes requests round-robin across healthy replicas\u003C/li\u003E\n\u003Cli\u003ETracks health \u2014 callers mark replicas unhealthy, the Service can\n   probe for recovery\u003C/li\u003E\n\u003C/ol\u003E\n\u003Cspan class=\"paragraph\"\u003EWe treat \u003Cstrong\u003E1 replica = 1 ActorMesh\u003C/strong\u003E \u2014 each replica can span multiple\nGPUs for tensor parallelism. If your model fits on one GPU, a replica is\njust size 1.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThe methods fall into three groups:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Cstrong\u003ERouting\u003C/strong\u003E: \u003Ccode\u003Eget_replica()\u003C/code\u003E / \u003Ccode\u003Eget_replica_with_idx()\u003C/code\u003E \u2014 round-robin\n  across healthy replicas\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EHealth\u003C/strong\u003E: \u003Ccode\u003Emark_unhealthy()\u003C/code\u003E / \u003Ccode\u003Echeck_health()\u003C/code\u003E \u2014 callers report\n  failures, Service probes for recovery\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ELifecycle\u003C/strong\u003E: \u003Ccode\u003E__init__\u003C/code\u003E slices the ProcMesh and spawns workers\u003C/li\u003E\n\u003C/ul\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "57b0a6a44685cb809ac855676293c33e", "console": [], "id": "SFPL", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "fdb50e0b721a713608452d16df8cc8b9", "console": [], "id": "BYtC", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Cspan class=\"paragraph\"\u003EKey design decisions:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Cstrong\u003EService spawns workers\u003C/strong\u003E \u2014 it takes a \u003Ccode\u003Eworker_class\u003C/code\u003E and a ProcMesh,\n  slices it into replica-sized chunks, and spawns an ActorMesh on each.\n  Because the Service owns the lifecycle, it could also respawn failed\n  replicas.\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ECaller marks unhealthy\u003C/strong\u003E \u2014 the Service doesn't auto-detect failures.\n  The caller catches the exception and tells the Service. This is the same\n  try/except pattern from notebook 03.\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ECaller registers\u003C/strong\u003E \u2014 we call \u003Ccode\u003Eregister_service()\u003C/code\u003E after spawning\n  because actors can't block on Futures during \u003Ccode\u003E__init__\u003C/code\u003E.\u003C/li\u003E\n\u003C/ul\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "0c01efb856349d55dae4ec0960cfc128", "console": [], "id": "RGSE", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"service-discovery\"\u003EService Discovery\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EMultiple parts of the system need the same services \u2014 the trainer needs\ngenerators, the orchestrator needs the trainer. Rather than threading\nreferences everywhere, we use a \u003Cstrong\u003Esingleton registry\u003C/strong\u003E. Monarch's\n\u003Ccode\u003Eget_or_spawn_controller\u003C/code\u003E guarantees exactly one exists across all\nprocesses.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "b4b4d53e7836edad356f8493f82ca59e", "console": [], "id": "Kclp", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "54a3fa7fdadd5edfe61d96f8da5039ba", "console": [], "id": "emfo", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"seeing-it-work\"\u003ESeeing It Work\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EFirst, the happy path \u2014 4 replicas, no failures. Watch the round-robin\ndistribute requests evenly.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "ca20964a8ca9a789475deea3ee454b0d", "console": [{"mimetype": "text/plain", "name": "stdout", "text": "[REGISTRY] ServiceRegistry spawned\n[REGISTRY] Registered 'demo'\n=== Round-Robin Demo ===\n[SERVICE:demo] 4 replicas x 1 procs each\n  Request 0: replica 0 -\u003E Processed 'req_0'\n  Request 1: replica 1 -\u003E Processed 'req_1'\n  Request 2: replica 2 -\u003E Processed 'req_2'\n  Request 3: replica 3 -\u003E Processed 'req_3'\n", "type": "stream"}], "id": "Hstk", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "10ba17485a0baacc3b7bfb0fd882aec9", "console": [], "id": "nWHF", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"handling-failures\"\u003EHandling Failures\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003ENow with a 30% failure rate. The pattern: try, catch, \u003Ccode\u003Emark_unhealthy\u003C/code\u003E,\nretry with a different replica. Then \u003Ccode\u003Echeck_health\u003C/code\u003E to probe for recovery.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "28692af24992aa862362cb5560858919", "console": [{"mimetype": "text/plain", "name": "stdout", "text": "[REGISTRY] Registered 'flaky'\n=== Failure Handling Demo ===\n  Request 0:\n[SERVICE:flaky] 4 replicas x 1 procs each\n    Success: Processed 'data_0'\n  Request 1:\n    Success: Processed 'data_1'\n  Request 2:\n    Success: Processed 'data_2'\n  Request 3:\n    Success: Processed 'data_3'\n  Request 4:\n    Success: Processed 'data_4'\n\nAfter failures: 4/4 healthy\nUnhealthy: []\n\nProbing unhealthy replicas...\nRecovered: []\nNow: 4/4 healthy\n", "type": "stream"}], "id": "iLit", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "73e540ad5aa43a368d06f0734b5a3d79", "console": [], "id": "ZHCJ", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"discovery-in-action\"\u003EDiscovery in Action\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003EA completely separate part of the system can find services by name \u2014\nno need to pass actor references around.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "73b048b6f9297864f6f0afd3db4b7596", "console": [{"mimetype": "text/plain", "name": "stdout", "text": "=== Service Discovery Demo ===\nRegistered services: ['demo', 'flaky']\nDiscovered 'demo' service, got: Processed 'found via discovery!'\n", "type": "stream"}], "id": "ROlb", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "962e89ba0f1e8373d48c784721adb803", "console": [], "id": "qnkX", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"what-we-built\"\u003EWhat We Built\u003C/h2\u003E\n\u003Ctable\u003E\n\u003Cthead\u003E\n\u003Ctr\u003E\n\u003Cth\u003EComponent\u003C/th\u003E\n\u003Cth\u003EResponsibility\u003C/th\u003E\n\u003C/tr\u003E\n\u003C/thead\u003E\n\u003Ctbody\u003E\n\u003Ctr\u003E\n\u003Ctd\u003E\u003Cstrong\u003EWorker\u003C/strong\u003E\u003C/td\u003E\n\u003Ctd\u003EProcesses requests, has \u003Ccode\u003Eping()\u003C/code\u003E for health checks\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003E\u003Cstrong\u003EService\u003C/strong\u003E\u003C/td\u003E\n\u003Ctd\u003ESpawns replicas, routes round-robin, tracks health\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003E\u003Cstrong\u003EServiceRegistry\u003C/strong\u003E\u003C/td\u003E\n\u003Ctd\u003ESingleton for discovery (\u003Ccode\u003Eget_service(\"name\")\u003C/code\u003E)\u003C/td\u003E\n\u003C/tr\u003E\n\u003C/tbody\u003E\n\u003C/table\u003E\n\u003Cspan class=\"paragraph\"\u003EThe pattern:\u003C/span\u003E\n\u003Col\u003E\n\u003Cli\u003EAllocate procs and spawn a Service (which spawns its own workers)\u003C/li\u003E\n\u003Cli\u003ERegister the service so clients can discover it by name\u003C/li\u003E\n\u003Cli\u003EClients get replicas, make calls, handle failures inline\u003C/li\u003E\n\u003Cli\u003EOn failure: \u003Ccode\u003Emark_unhealthy\u003C/code\u003E + retry with a different replica\u003C/li\u003E\n\u003Cli\u003EPeriodically: \u003Ccode\u003Echeck_health\u003C/code\u003E to recover transient failures\u003C/li\u003E\n\u003C/ol\u003E\n\u003Cspan class=\"paragraph\"\u003EThis Service class lives in \u003Ccode\u003Esrc/monarch_utils/services.py\u003C/code\u003E \u2014 in notebook\n07, we'll import it and use it to manage real generator workers.\u003C/span\u003E\n\u003Ch2 id=\"whats-missing\"\u003EWhat's Missing?\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EThe generators need \u003Cstrong\u003Eupdated weights\u003C/strong\u003E after the trainer takes a gradient\nstep. Right now they'd use stale weights forever.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EHow do we efficiently move hundreds of megabytes of model weights from\ntrainer to generators \u2014 without blocking training?\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003ENext: RDMA Weight Sync\u003C/strong\u003E \u2014 using Monarch's RDMA primitives for direct\nGPU-to-GPU weight transfer.\u003C/span\u003E\n\u003Chr /\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EPrevious:\u003C/strong\u003E \u003Ca href=\"./04_rl_intro.html\"\u003ENB04 \u2014 RL Intro\u003C/a\u003E \u00b7 \u003Cstrong\u003ENext:\u003C/strong\u003E \u003Ca href=\"./06_rdma_weight_sync.html\"\u003ENB06 \u2014 RDMA Weight Sync\u003C/a\u003E\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}], "metadata": {"marimo_version": "0.19.9"}, "version": "1"},
            "runtimeConfig": null,
        };
    </script>
  
<marimo-code hidden="">
    import%20marimo%0A%0A__generated_with%20%3D%20%220.19.9%22%0Aapp%20%3D%20marimo.App(width%3D%22medium%22)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%0A%20%20%20%20return%20(mo%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%20Services%3A%20Managing%20Worker%20Pools%0A%0A%20%20%20%20In%20the%20last%20notebook%2C%20we%20saw%20how%20generation%20variance%20makes%20synchronous%20RL%0A%20%20%20%20wasteful%20%E2%80%94%20the%20trainer%20sits%20idle%20waiting%20for%20the%20slowest%20generator.%20The%20fix%0A%20%20%20%20is%20running%20many%20generators%20in%20parallel%2C%20decoupled%20from%20training.%0A%0A%20%20%20%20But%20managing%20a%20pool%20of%20workers%20brings%20its%20own%20problems.%20Let's%20see%20what%0A%20%20%20%20happens%20when%20you%20try%20to%20do%20it%20by%20hand.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20random%0A%20%20%20%20from%20monarch.actor%20import%20Actor%2C%20endpoint%2C%20current_rank%2C%20this_host%2C%20get_or_spawn_controller%0A%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20Actor%2C%0A%20%20%20%20%20%20%20%20current_rank%2C%0A%20%20%20%20%20%20%20%20endpoint%2C%0A%20%20%20%20%20%20%20%20get_or_spawn_controller%2C%0A%20%20%20%20%20%20%20%20random%2C%0A%20%20%20%20%20%20%20%20this_host%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(Actor%2C%20current_rank%2C%20endpoint%2C%20random)%3A%0A%20%20%20%20class%20Worker(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22A%20worker%20that%20processes%20requests.%20May%20fail%20randomly.%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20fail_rate%3A%20float%20%3D%200.0)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.rank%20%3D%20current_rank().rank%0A%20%20%20%20%20%20%20%20%20%20%20%20self.fail_rate%20%3D%20fail_rate%0A%20%20%20%20%20%20%20%20%20%20%20%20self.calls%20%3D%200%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20ping(self)%20-%3E%20bool%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20True%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20process(self%2C%20data%3A%20str)%20-%3E%20str%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Process%20a%20request.%20Might%20fail%20based%20on%20fail_rate.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20self.calls%20%2B%3D%201%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20random.random()%20%3C%20self.fail_rate%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20RuntimeError(f%22Worker%20failed!%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20f%22Processed%20'%7Bdata%7D'%22%0A%0A%20%20%20%20return%20(Worker%2C)%0A%0A%0A%40app.cell%0Adef%20_(Worker%2C%20this_host)%3A%0A%20%20%20%20%23%20%3D%3D%3D%20The%20Manual%20Approach%20%3D%3D%3D%0A%20%20%20%20host%20%3D%20this_host()%0A%20%20%20%20procs%20%3D%20host.spawn_procs(per_host%3D%7B%22procs%22%3A%204%7D)%0A%0A%20%20%20%20%23%20Spawn%204%20workers%20on%20individual%20proc%20slices%0A%20%20%20%20manual_workers%20%3D%20%5B%5D%0A%20%20%20%20for%20i%20in%20range(4)%3A%0A%20%20%20%20%20%20%20%20w%20%3D%20procs.slice(procs%3Di).spawn(f%22w_%7Bi%7D%22%2C%20Worker%2C%20fail_rate%3D0.3)%0A%20%20%20%20%20%20%20%20manual_workers.append(w)%0A%0A%20%20%20%20%23%20Manual%20round-robin%20with%20manual%20failure%20tracking%0A%20%20%20%20healthy%20%3D%20list(range(4))%0A%20%20%20%20current_idx%20%3D%200%0A%0A%20%20%20%20print(%22%3D%3D%3D%20Manual%20Worker%20Management%20%3D%3D%3D%22)%0A%20%20%20%20for%20req%20in%20range(6)%3A%0A%20%20%20%20%20%20%20%20if%20not%20healthy%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20Request%20%7Breq%7D%3A%20No%20workers%20left!%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20break%0A%0A%20%20%20%20%20%20%20%20worker_idx%20%3D%20healthy%5Bcurrent_idx%20%25%20len(healthy)%5D%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20result%20%3D%20manual_workers%5Bworker_idx%5D.process.call_one(f%22req_%7Breq%7D%22).get()%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20Request%20%7Breq%7D%3A%20Worker%20%7Bworker_idx%7D%20-%3E%20OK%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20current_idx%20%2B%3D%201%0A%20%20%20%20%20%20%20%20except%20Exception%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20Request%20%7Breq%7D%3A%20Worker%20%7Bworker_idx%7D%20FAILED%20%E2%80%94%20removing%20from%20pool%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20healthy.remove(worker_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20But%20is%20it%20really%20dead%3F%20Or%20just%20a%20transient%20error%3F%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20How%20do%20we%20check%20later%3F%20When%20do%20we%20add%20it%20back%3F%0A%0A%20%20%20%20print(f%22%5Cn%7Blen(healthy)%7D%2F4%20workers%20still%20in%20pool%22)%0A%20%20%20%20print(%22Questions%3A%22)%0A%20%20%20%20print(%22%20%20Who%20checks%20if%20failed%20workers%20recovered%3F%22)%0A%20%20%20%20print(%22%20%20What%20if%20multiple%20clients%20need%20this%20same%20pool%3F%22)%0A%20%20%20%20print(%22%20%20What%20if%20we%20have%2050%20workers%20across%2010%20nodes%3F%22)%0A%20%20%20%20return%20(host%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20The%20Problems%20with%20Manual%20Management%0A%0A%20%20%20%20That%20works%20for%204%20workers%20in%20a%20notebook.%20But%20at%20scale%3A%0A%0A%20%20%20%20-%20**Shared%20state**%3A%20Multiple%20clients%20need%20the%20same%20pool%2C%20but%20each%20tracks%0A%20%20%20%20%20%20its%20own%20%60healthy%60%20list%20%E2%80%94%20when%20one%20client%20discovers%20a%20failure%2C%20others%0A%20%20%20%20%20%20don't%20know%0A%20%20%20%20-%20**Recovery**%3A%20No%20mechanism%20to%20check%20if%20failed%20workers%20come%20back%0A%20%20%20%20-%20**Discovery**%3A%20Clients%20must%20know%20exactly%20which%20workers%20exist%20at%20spawn%20time%0A%20%20%20%20-%20**Multi-GPU%20replicas**%3A%20A%2070B%20model%20needs%20tensor%20parallelism%20across%208%0A%20%20%20%20%20%20GPUs%20%E2%80%94%20each%20%22replica%22%20is%20a%20group%20of%20workers%2C%20not%20a%20single%20process%0A%0A%20%20%20%20The%20fix%3A%20centralize%20pool%20management%20in%20a%20**Service**%20actor.%20Since%20it's%20an%0A%20%20%20%20actor%2C%20its%20state%20(which%20replicas%20are%20healthy%2C%20the%20round-robin%20index)%20is%0A%20%20%20%20automatically%20shared%20across%20all%20callers%20%E2%80%94%20no%20duplicate%20tracking.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20The%20Service%20Actor%0A%0A%20%20%20%20The%20Service%20centralizes%20everything%20the%20manual%20approach%20did%20ad-hoc%3A%0A%0A%20%20%20%201.%20Takes%20a%20%60worker_class%60%20and%20a%20ProcMesh%2C%20slices%20it%20into%20replica-sized%0A%20%20%20%20%20%20%20chunks%2C%20and%20spawns%20an%20ActorMesh%20on%20each%0A%20%20%20%202.%20Routes%20requests%20round-robin%20across%20healthy%20replicas%0A%20%20%20%203.%20Tracks%20health%20%E2%80%94%20callers%20mark%20replicas%20unhealthy%2C%20the%20Service%20can%0A%20%20%20%20%20%20%20probe%20for%20recovery%0A%0A%20%20%20%20We%20treat%20**1%20replica%20%3D%201%20ActorMesh**%20%E2%80%94%20each%20replica%20can%20span%20multiple%0A%20%20%20%20GPUs%20for%20tensor%20parallelism.%20If%20your%20model%20fits%20on%20one%20GPU%2C%20a%20replica%20is%0A%20%20%20%20just%20size%201.%0A%0A%20%20%20%20The%20methods%20fall%20into%20three%20groups%3A%0A%0A%20%20%20%20-%20**Routing**%3A%20%60get_replica()%60%20%2F%20%60get_replica_with_idx()%60%20%E2%80%94%20round-robin%0A%20%20%20%20%20%20across%20healthy%20replicas%0A%20%20%20%20-%20**Health**%3A%20%60mark_unhealthy()%60%20%2F%20%60check_health()%60%20%E2%80%94%20callers%20report%0A%20%20%20%20%20%20failures%2C%20Service%20probes%20for%20recovery%0A%20%20%20%20-%20**Lifecycle**%3A%20%60__init__%60%20slices%20the%20ProcMesh%20and%20spawns%20workers%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Actor%2C%20endpoint)%3A%0A%20%20%20%20class%20Service(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Manages%20a%20pool%20of%20worker%20replicas%20with%20routing%20and%20health%20tracking.%0A%0A%20%20%20%20%20%20%20%20The%20Service%20owns%20worker%20lifecycle%3A%20it%20slices%20a%20ProcMesh%20into%0A%20%20%20%20%20%20%20%20replica-sized%20chunks%20and%20spawns%20an%20ActorMesh%20on%20each.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(%0A%20%20%20%20%20%20%20%20%20%20%20%20self%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20service_name%3A%20str%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20worker_class%3A%20type%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20procs%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20procs_per_replica%3A%20int%20%3D%201%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20**worker_kwargs%2C%0A%20%20%20%20%20%20%20%20)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.service_name%20%3D%20service_name%0A%20%20%20%20%20%20%20%20%20%20%20%20total%20%3D%20len(procs)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.num_replicas%20%3D%20total%20%2F%2F%20procs_per_replica%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Slice%20ProcMesh%20and%20spawn%20a%20replica%20on%20each%20chunk%0A%20%20%20%20%20%20%20%20%20%20%20%20self.replicas%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%20in%20range(self.num_replicas)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20start%20%3D%20i%20*%20procs_per_replica%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20end%20%3D%20start%20%2B%20procs_per_replica%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20replica_slice%20%3D%20procs.slice(procs%3Dslice(start%2C%20end))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20replica%20%3D%20replica_slice.spawn(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22replica_%7Bi%7D%22%2C%20worker_class%2C%20**worker_kwargs%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.replicas.append(replica)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.healthy%20%3D%20set(range(self.num_replicas))%0A%20%20%20%20%20%20%20%20%20%20%20%20self.unhealthy%3A%20set%5Bint%5D%20%3D%20set()%0A%20%20%20%20%20%20%20%20%20%20%20%20self.next_idx%20%3D%200%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%5BSERVICE%3A%7Bservice_name%7D%5D%20%7Bself.num_replicas%7D%20replicas%20%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22x%20%7Bprocs_per_replica%7D%20procs%20each%22)%0A%0A%20%20%20%20%20%20%20%20%23%20---%20Routing%20---%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20get_replica(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Get%20a%20healthy%20replica%20(round-robin).%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20self.healthy%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20RuntimeError(%22No%20healthy%20replicas%20available!%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20healthy_list%20%3D%20sorted(self.healthy)%0A%20%20%20%20%20%20%20%20%20%20%20%20idx%20%3D%20self.next_idx%20%25%20len(healthy_list)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.next_idx%20%2B%3D%201%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self.replicas%5Bhealthy_list%5Bidx%5D%5D%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20get_replica_with_idx(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Get%20(replica%2C%20index).%20Use%20the%20index%20for%20mark_unhealthy().%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20self.healthy%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20RuntimeError(%22No%20healthy%20replicas%20available!%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20healthy_list%20%3D%20sorted(self.healthy)%0A%20%20%20%20%20%20%20%20%20%20%20%20idx%20%3D%20self.next_idx%20%25%20len(healthy_list)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.next_idx%20%2B%3D%201%0A%20%20%20%20%20%20%20%20%20%20%20%20replica_idx%20%3D%20healthy_list%5Bidx%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self.replicas%5Breplica_idx%5D%2C%20replica_idx%0A%0A%20%20%20%20%20%20%20%20%23%20---%20Health%20tracking%20---%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20mark_unhealthy(self%2C%20replica_idx%3A%20int)%20-%3E%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Remove%20a%20replica%20from%20rotation.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20replica_idx%20in%20self.healthy%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.healthy.discard(replica_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.unhealthy.add(replica_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%5BSERVICE%3A%7Bself.service_name%7D%5D%20Replica%20%7Breplica_idx%7D%20unhealthy.%20%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22Healthy%3A%20%7Blen(self.healthy)%7D%2F%7Bself.num_replicas%7D%22)%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20mark_healthy(self%2C%20replica_idx%3A%20int)%20-%3E%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Reinstate%20a%20replica.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20replica_idx%20%3C%20self.num_replicas%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.unhealthy.discard(replica_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.healthy.add(replica_idx)%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20check_health(self)%20-%3E%20dict%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Probe%20unhealthy%20replicas.%20Reinstate%20those%20that%20respond%20to%20ping().%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20recovered%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20still_unhealthy%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20replica_idx%20in%20list(self.unhealthy)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Use%20.call()%20not%20.call_one()%20%E2%80%94%20works%20for%20multi-GPU%20replicas%20too%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.replicas%5Breplica_idx%5D.ping.call().get()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.unhealthy.discard(replica_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.healthy.add(replica_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20recovered.append(replica_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%5BSERVICE%3A%7Bself.service_name%7D%5D%20Replica%20%7Breplica_idx%7D%20recovered!%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20still_unhealthy.append(replica_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22recovered%22%3A%20recovered%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22still_unhealthy%22%3A%20still_unhealthy%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22healthy_count%22%3A%20len(self.healthy)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20get_health_status(self)%20-%3E%20dict%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22total%22%3A%20self.num_replicas%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22healthy%22%3A%20len(self.healthy)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22unhealthy%22%3A%20len(self.unhealthy)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22healthy_indices%22%3A%20sorted(self.healthy)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22unhealthy_indices%22%3A%20sorted(self.unhealthy)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20%23%20---%20Lifecycle%20---%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20get_all_replicas(self)%20-%3E%20list%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Get%20all%20replicas%20(for%20operations%20that%20touch%20every%20replica).%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20list(self.replicas)%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20ping(self)%20-%3E%20bool%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20True%0A%0A%20%20%20%20return%20(Service%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20Key%20design%20decisions%3A%0A%0A%20%20%20%20-%20**Service%20spawns%20workers**%20%E2%80%94%20it%20takes%20a%20%60worker_class%60%20and%20a%20ProcMesh%2C%0A%20%20%20%20%20%20slices%20it%20into%20replica-sized%20chunks%2C%20and%20spawns%20an%20ActorMesh%20on%20each.%0A%20%20%20%20%20%20Because%20the%20Service%20owns%20the%20lifecycle%2C%20it%20could%20also%20respawn%20failed%0A%20%20%20%20%20%20replicas.%0A%20%20%20%20-%20**Caller%20marks%20unhealthy**%20%E2%80%94%20the%20Service%20doesn't%20auto-detect%20failures.%0A%20%20%20%20%20%20The%20caller%20catches%20the%20exception%20and%20tells%20the%20Service.%20This%20is%20the%20same%0A%20%20%20%20%20%20try%2Fexcept%20pattern%20from%20notebook%2003.%0A%20%20%20%20-%20**Caller%20registers**%20%E2%80%94%20we%20call%20%60register_service()%60%20after%20spawning%0A%20%20%20%20%20%20because%20actors%20can't%20block%20on%20Futures%20during%20%60__init__%60.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Service%20Discovery%0A%0A%20%20%20%20Multiple%20parts%20of%20the%20system%20need%20the%20same%20services%20%E2%80%94%20the%20trainer%20needs%0A%20%20%20%20generators%2C%20the%20orchestrator%20needs%20the%20trainer.%20Rather%20than%20threading%0A%20%20%20%20references%20everywhere%2C%20we%20use%20a%20**singleton%20registry**.%20Monarch's%0A%20%20%20%20%60get_or_spawn_controller%60%20guarantees%20exactly%20one%20exists%20across%20all%0A%20%20%20%20processes.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Actor%2C%20endpoint%2C%20get_or_spawn_controller)%3A%0A%20%20%20%20class%20ServiceRegistry(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Singleton%20registry%20for%20service%20discovery.%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.services%3A%20dict%5Bstr%2C%20Actor%5D%20%3D%20%7B%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%22%5BREGISTRY%5D%20ServiceRegistry%20spawned%22)%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20register(self%2C%20name%3A%20str%2C%20service)%20-%3E%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.services%5Bname%5D%20%3D%20service%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%5BREGISTRY%5D%20Registered%20'%7Bname%7D'%22)%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20get(self%2C%20name%3A%20str)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20name%20not%20in%20self.services%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20KeyError(f%22Service%20'%7Bname%7D'%20not%20found%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self.services%5Bname%5D%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20list_services(self)%20-%3E%20list%5Bstr%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20list(self.services.keys())%0A%0A%0A%20%20%20%20def%20_get_registry()%3A%0A%20%20%20%20%20%20%20%20return%20get_or_spawn_controller(%22service_registry%22%2C%20ServiceRegistry).get()%0A%0A%20%20%20%20def%20get_service(name%3A%20str)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Get%20a%20service%20by%20name.%22%22%22%0A%20%20%20%20%20%20%20%20return%20_get_registry().get.call_one(name).get()%0A%0A%20%20%20%20def%20register_service(name%3A%20str%2C%20service)%20-%3E%20None%3A%0A%20%20%20%20%20%20%20%20%22%22%22Register%20a%20service%20for%20discovery.%22%22%22%0A%20%20%20%20%20%20%20%20_get_registry().register.call_one(name%2C%20service).get()%0A%0A%20%20%20%20def%20list_services()%20-%3E%20list%5Bstr%5D%3A%0A%20%20%20%20%20%20%20%20%22%22%22List%20all%20registered%20services.%22%22%22%0A%20%20%20%20%20%20%20%20return%20_get_registry().list_services.call_one().get()%0A%0A%20%20%20%20return%20get_service%2C%20list_services%2C%20register_service%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Seeing%20It%20Work%0A%0A%20%20%20%20First%2C%20the%20happy%20path%20%E2%80%94%204%20replicas%2C%20no%20failures.%20Watch%20the%20round-robin%0A%20%20%20%20distribute%20requests%20evenly.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Service%2C%20Worker%2C%20host%2C%20register_service)%3A%0A%20%20%20%20%23%20%3D%3D%3D%20Demo%201%3A%20Round-Robin%20Routing%20%3D%3D%3D%0A%20%20%20%20svc_proc%20%3D%20host.spawn_procs(per_host%3D%7B%22procs%22%3A%201%7D)%0A%20%20%20%20worker_procs_demo%20%3D%20host.spawn_procs(per_host%3D%7B%22procs%22%3A%204%7D)%0A%0A%20%20%20%20demo_svc%20%3D%20svc_proc.spawn(%0A%20%20%20%20%20%20%20%20%22demo_svc%22%2C%20Service%2C%0A%20%20%20%20%20%20%20%20service_name%3D%22demo%22%2C%0A%20%20%20%20%20%20%20%20worker_class%3DWorker%2C%0A%20%20%20%20%20%20%20%20procs%3Dworker_procs_demo%2C%0A%20%20%20%20%20%20%20%20procs_per_replica%3D1%2C%0A%20%20%20%20%20%20%20%20fail_rate%3D0.0%2C%0A%20%20%20%20)%0A%20%20%20%20register_service(%22demo%22%2C%20demo_svc)%0A%0A%20%20%20%20print(%22%3D%3D%3D%20Round-Robin%20Demo%20%3D%3D%3D%22)%0A%20%20%20%20for%20req_num%20in%20range(4)%3A%0A%20%20%20%20%20%20%20%20worker%2C%20idx%20%3D%20demo_svc.get_replica_with_idx.call_one().get()%0A%20%20%20%20%20%20%20%20response%20%3D%20worker.process.call_one(f%22req_%7Breq_num%7D%22).get()%0A%20%20%20%20%20%20%20%20print(f%22%20%20Request%20%7Breq_num%7D%3A%20replica%20%7Bidx%7D%20-%3E%20%7Bresponse%7D%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20Handling%20Failures%0A%0A%20%20%20%20Now%20with%20a%2030%25%20failure%20rate.%20The%20pattern%3A%20try%2C%20catch%2C%20%60mark_unhealthy%60%2C%0A%20%20%20%20retry%20with%20a%20different%20replica.%20Then%20%60check_health%60%20to%20probe%20for%20recovery.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Service%2C%20Worker%2C%20host%2C%20register_service)%3A%0A%20%20%20%20%23%20%3D%3D%3D%20Demo%202%3A%20Failure%20Handling%20%2B%20Recovery%20%3D%3D%3D%0A%20%20%20%20flaky_svc_proc%20%3D%20host.spawn_procs(per_host%3D%7B%22procs%22%3A%201%7D)%0A%20%20%20%20flaky_worker_procs%20%3D%20host.spawn_procs(per_host%3D%7B%22procs%22%3A%204%7D)%0A%0A%20%20%20%20flaky_svc%20%3D%20flaky_svc_proc.spawn(%0A%20%20%20%20%20%20%20%20%22flaky_svc%22%2C%20Service%2C%0A%20%20%20%20%20%20%20%20service_name%3D%22flaky%22%2C%0A%20%20%20%20%20%20%20%20worker_class%3DWorker%2C%0A%20%20%20%20%20%20%20%20procs%3Dflaky_worker_procs%2C%0A%20%20%20%20%20%20%20%20procs_per_replica%3D1%2C%0A%20%20%20%20%20%20%20%20fail_rate%3D0.3%2C%0A%20%20%20%20)%0A%20%20%20%20register_service(%22flaky%22%2C%20flaky_svc)%0A%0A%20%20%20%20def%20process_with_retry(svc%2C%20data%2C%20max_retries%3D3)%3A%0A%20%20%20%20%20%20%20%20%22%22%22The%20canonical%20pattern%3A%20try%2Fexcept%20%2B%20mark_unhealthy%20%2B%20retry.%22%22%22%0A%20%20%20%20%20%20%20%20for%20attempt%20in%20range(max_retries)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20replica%2C%20idx%20%3D%20None%2C%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20replica%2C%20idx%20%3D%20svc.get_replica_with_idx.call_one().get()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20replica.process.call_one(data).get()%0A%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20idx%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20%20%20Attempt%20%7Battempt%20%2B%201%7D%3A%20replica%20%7Bidx%7D%20failed%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svc.mark_unhealthy.call_one(idx).get()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20%20%20Attempt%20%7Battempt%20%2B%201%7D%3A%20no%20healthy%20replicas%22)%0A%20%20%20%20%20%20%20%20raise%20RuntimeError(%22All%20retries%20exhausted%22)%0A%0A%20%20%20%20print(%22%3D%3D%3D%20Failure%20Handling%20Demo%20%3D%3D%3D%22)%0A%20%20%20%20for%20j%20in%20range(5)%3A%0A%20%20%20%20%20%20%20%20print(f%22%20%20Request%20%7Bj%7D%3A%22)%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20_result%20%3D%20process_with_retry(flaky_svc%2C%20f%22data_%7Bj%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20%20%20Success%3A%20%7B_result%7D%22)%0A%20%20%20%20%20%20%20%20except%20RuntimeError%20as%20e%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20%20%20%7Be%7D%22)%0A%0A%20%20%20%20%23%20Check%20health%20after%20failures%0A%20%20%20%20status%20%3D%20flaky_svc.get_health_status.call_one().get()%0A%20%20%20%20print(f%22%5CnAfter%20failures%3A%20%7Bstatus%5B'healthy'%5D%7D%2F%7Bstatus%5B'total'%5D%7D%20healthy%22)%0A%20%20%20%20print(f%22Unhealthy%3A%20%7Bstatus%5B'unhealthy_indices'%5D%7D%22)%0A%0A%20%20%20%20%23%20Recover%20%E2%80%94%20workers%20are%20still%20alive%2C%20they%20just%20had%20transient%20errors%0A%20%20%20%20print(%22%5CnProbing%20unhealthy%20replicas...%22)%0A%20%20%20%20recovery%20%3D%20flaky_svc.check_health.call_one().get()%0A%20%20%20%20print(f%22Recovered%3A%20%7Brecovery%5B'recovered'%5D%7D%22)%0A%0A%20%20%20%20status_after%20%3D%20flaky_svc.get_health_status.call_one().get()%0A%20%20%20%20print(f%22Now%3A%20%7Bstatus_after%5B'healthy'%5D%7D%2F%7Bstatus_after%5B'total'%5D%7D%20healthy%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20Discovery%20in%20Action%0A%0A%20%20%20%20A%20completely%20separate%20part%20of%20the%20system%20can%20find%20services%20by%20name%20%E2%80%94%0A%20%20%20%20no%20need%20to%20pass%20actor%20references%20around.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(get_service%2C%20list_services)%3A%0A%20%20%20%20%23%20%3D%3D%3D%20Demo%203%3A%20Service%20Discovery%20%3D%3D%3D%0A%20%20%20%20print(%22%3D%3D%3D%20Service%20Discovery%20Demo%20%3D%3D%3D%22)%0A%20%20%20%20print(f%22Registered%20services%3A%20%7Blist_services()%7D%22)%0A%0A%20%20%20%20%23%20Find%20the%20demo%20service%20by%20name%20%E2%80%94%20no%20reference%20needed%0A%20%20%20%20discovered%20%3D%20get_service(%22demo%22)%0A%20%20%20%20found_worker%20%3D%20discovered.get_replica.call_one().get()%0A%20%20%20%20discovery_result%20%3D%20found_worker.process.call_one(%22found%20via%20discovery!%22).get()%0A%20%20%20%20print(f%22Discovered%20'demo'%20service%2C%20got%3A%20%7Bdiscovery_result%7D%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20What%20We%20Built%0A%0A%20%20%20%20%7C%20Component%20%7C%20Responsibility%20%7C%0A%20%20%20%20%7C-----------%7C---------------%7C%0A%20%20%20%20%7C%20**Worker**%20%7C%20Processes%20requests%2C%20has%20%60ping()%60%20for%20health%20checks%20%7C%0A%20%20%20%20%7C%20**Service**%20%7C%20Spawns%20replicas%2C%20routes%20round-robin%2C%20tracks%20health%20%7C%0A%20%20%20%20%7C%20**ServiceRegistry**%20%7C%20Singleton%20for%20discovery%20(%60get_service(%22name%22)%60)%20%7C%0A%0A%20%20%20%20The%20pattern%3A%0A%20%20%20%201.%20Allocate%20procs%20and%20spawn%20a%20Service%20(which%20spawns%20its%20own%20workers)%0A%20%20%20%202.%20Register%20the%20service%20so%20clients%20can%20discover%20it%20by%20name%0A%20%20%20%203.%20Clients%20get%20replicas%2C%20make%20calls%2C%20handle%20failures%20inline%0A%20%20%20%204.%20On%20failure%3A%20%60mark_unhealthy%60%20%2B%20retry%20with%20a%20different%20replica%0A%20%20%20%205.%20Periodically%3A%20%60check_health%60%20to%20recover%20transient%20failures%0A%0A%20%20%20%20This%20Service%20class%20lives%20in%20%60src%2Fmonarch_utils%2Fservices.py%60%20%E2%80%94%20in%20notebook%0A%20%20%20%2007%2C%20we'll%20import%20it%20and%20use%20it%20to%20manage%20real%20generator%20workers.%0A%0A%20%20%20%20%23%23%20What's%20Missing%3F%0A%0A%20%20%20%20The%20generators%20need%20**updated%20weights**%20after%20the%20trainer%20takes%20a%20gradient%0A%20%20%20%20step.%20Right%20now%20they'd%20use%20stale%20weights%20forever.%0A%0A%20%20%20%20How%20do%20we%20efficiently%20move%20hundreds%20of%20megabytes%20of%20model%20weights%20from%0A%20%20%20%20trainer%20to%20generators%20%E2%80%94%20without%20blocking%20training%3F%0A%0A%20%20%20%20**Next%3A%20RDMA%20Weight%20Sync**%20%E2%80%94%20using%20Monarch's%20RDMA%20primitives%20for%20direct%0A%20%20%20%20GPU-to-GPU%20weight%20transfer.%0A%0A%20%20%20%20---%0A%0A%20%20%20%20**Previous%3A**%20%5BNB04%20%E2%80%94%20RL%20Intro%5D(.%2F04_rl_intro.html)%20%C2%B7%20**Next%3A**%20%5BNB06%20%E2%80%94%20RDMA%20Weight%20Sync%5D(.%2F06_rdma_weight_sync.html)%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A
</marimo-code>

<marimo-code-hash hidden="">18f3da5be06aadc4d08e5458fd77ad11</marimo-code-hash>
</body>
</html>
