<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/apple-touch-icon.png" />
    <link rel="manifest" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        const scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          // Guard against race condition where iframe isn't ready
          if (!obj.contentWindow?.document?.documentElement) {
            return;
          }
          const element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          const hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          const newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((_entries) => {
          setHeight();
        });
        // Only observe if iframe content is ready
        if (obj.contentWindow?.document?.body) {
          resizeObserver.observe(obj.contentWindow.document.body);
        }
      }
    </script>
    <marimo-filename hidden>03_fault_tolerance.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>03 fault tolerance</title>
    <script type="module" crossorigin crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/index-DGasP9Lh.js"></script>
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/preload-helper-DItdS47A.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/clsx-D8GwTfvk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/cn-BKtXLv3a.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chunk-LvLJmgfZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/react-BGmjiNul.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/compiler-runtime-DeeZ7FnK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/jsx-runtime-ZmTK25f3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/badge-Ce8wRjuQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/hotkeys-BHHWjLlp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useEventListener-DIUKKfEy.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/button-YC1gW_kJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/react-dom-C9fstfnp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/Combination-CMPwuAmi.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/menu-items-CJhvWPOk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-uzvC4uAK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/createLucideIcon-CnW3RofX.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/check-DdfN0k2d.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/select-V5IdpNiR.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/tooltip-CEc2ajau.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/use-toast-rmUWldD_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_Uint8Array-BGESiCQL.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_baseIsEqual-B9N9Mw_N.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useEvent-DO6uJBas.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/invariant-CAG_dYON.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_baseFor-Duhs3RiJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/merge-BBX6ug-N.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/zod-Cg4WLWh2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/utils-DXvhzCGS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/constants-B6Cb__3x.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/Deferred-CrO5-0RA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/config-CIrPQIbt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/uuid-DercMavo.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/DeferredRequestRegistry-CO2AyNfd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/requests-BsVD4CdD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/isSymbol-BGkTcW3U.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/toString-DlRqgfqz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_hasUnicode-CWqKLxBC.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/assertNever-CBU83Y6o.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_arrayReduce-TT0iOGKY.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useLifecycle-D35CBukS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useNonce-_Aax6sXd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useTheme-DUdVAZI8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/once-Bul8mtFs.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/capabilities-MM7JYRxj.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/createReducer-Dnna-AUO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-DBwNzi3C.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-ChS0Dc_R.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-CtsanegT.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-BIKFl48f.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-B0VqT_4z.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-TiFCI16_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-Cayq-K1c.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-BYyu59D8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-Gqv0jSNr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/stex-CtmkcLz7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/toDate-CgbKQM5E.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/cjs-CH5Rj0g8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_baseProperty-NKyJO2oh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/now-6sUe0ZdD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/debounce-B3mjKxHe.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/toInteger-CDcO32Gx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/database-zap-B9y7063w.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/main-U5Goe76G.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/cells-BpZ7g6ok.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/spinner-DaIKav-i.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chevron-right-DwagBitu.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dropdown-menu-B-6unW-7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/kbd-C3JY7O_u.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/renderShortcut-DEwfrKeS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/multi-map-C8GlnP-4.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/alert-BrGyZf9c.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/alert-dialog-DwQffb13.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dialog-CxGKN4C_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-CdxIjAOP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/label-Be1daUcS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useDebounce-D5NcotGm.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/textarea-DBO30D7K.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/numbers-iQunIAXf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/SSRProvider-CEHRCdjA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/context-JwD-oSsl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useNumberFormatter-c6GXymzg.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/usePress-Bup4EGrp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/input-pAun1m1X.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/links-DHZUhGz-.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/popover-Gz-GJzym.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/switch-8sn_4qbh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/table-C8uQmBAN.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/mode-DX8pdI-l.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useAsyncData-C4XRy1BE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/errors-2SszdW9t.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/error-banner-DUzsIXtq.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/copy-Bv2DBpIS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/memoize-BCOZVFBt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/get-6uJrSKbw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/capitalize-CmNnkG9y.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/copy-CQ15EONK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/plus-BD5o34_i.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/refresh-cw-CQd-1kjx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/trash-2-CyqGun26.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/triangle-alert-B65rDESJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/ai-model-dropdown-71lgLrLy.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/defaultLocale-D_rSvXvJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/precisionRound-BMPhtTJQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/defaultLocale-C92Rrpmf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/vega-loader.browser-CRZ52CKf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/tooltip-BGrCWNss.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/ErrorBoundary-ChCiwl15.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useInstallPackage-Bdnnp5fe.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/ImperativeModal-CUbWEBci.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/cell-link-Bw5bzt4a.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/datasource-B0OJBphG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/state-BfXVTTtD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/MarimoErrorOutput-5rudBbo3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/copy-icon-BhONVREY.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/html-to-image-DjukyIj4.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/focus-D51fcwZX.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/LazyAnyLanguageCodeMirror-yzHjsVJt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chunk-5FQGJX7Z-CVUXBqX6.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/katex-Dc8yG8NU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/markdown-renderer-DhMlG2dP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/command-DhzFN2CJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/download-BhCZMKuQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useRunCells-24p6hn99.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/purify.es-DNVQZNFu.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/RenderHTML-CQZqVk1Z.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useIframeCapabilities-DuIDx9mD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/formats-W1SWxSE3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/en-US-pRRbZZHE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/isValid-DcYggVWP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dates-Dhn1r-h6.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/maps-t9yNKYA8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/extends-B2LJnKU3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/emotion-is-prop-valid.esm-DD4AwVTU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useDateFormatter-CS4kbWl2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/range-D2UKkEg-.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/table-DZR6ewbN.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/JsonOutput-CknFTI_u.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/file-Cs1JbsV6.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/play-BPIh-ZEU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chat-components-CGlO4yUw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/isEmpty-CgX_-6Mt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chat-display-B4mGvJ0X.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useDeleteCell-5uYlTcQZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/icons-BhEXrzsb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/process-output-CagdHMzs.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/blob-CuXvdYPX.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/objectWithoutPropertiesLoose-DaPAPabU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/esm-DpMp6qko.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/add-cell-with-ai-pVFp5LZG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chart-no-axes-column-W42b2ZIs.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/square-function-CqXXKtIq.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/spec-D1kBp3jX.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/column-preview-CxMrs0B_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/toggle-jWKnIArU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/globals-DKH14XH0.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/share-CbPtIlnM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_baseSet-5Rdwpmr3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/react-resizable-panels.browser.esm-Ctj_10o2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/utilities.esm-CIPARd6-.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/floating-outline-DcxjrFFt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useAddCell-BmeZUK02.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/eye-off-BhExYOph.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/readonly-python-code-DyP9LVLc.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/file-video-camera-DW3v07j2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/types-DuQOSW7G.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/refresh-ccw-DLEiQDS3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/form-DUA_Rz_a.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/field-BEg1eC0P.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useBoolean-B1Xeh6vA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useDeepCompareMemoize-ZPd9PxYl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/types-CS34eOZi.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/prop-types-BiQYf0aU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/es-D8BOePqo.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/hasIn-CycJImp8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_baseFlatten-CUZNxU8H.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/flatten-D-7VEN0q.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/pick-B_6Qi5aM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/code-xml-XLwHyDBr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/download-B9SUL40m.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/house-DhFkiXz7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/settings-DOXWMfVd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/square-C8Tw_XXG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/bundle.esm-2AjO7UK5.js">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/cells-jmgGt1lS.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/markdown-renderer-DdDKmWlR.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/JsonOutput-B7vuddcd.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/index-CikhHYAB.css">
  
<script data-marimo="true">
    window.__MARIMO_STATIC__ = {};
    window.__MARIMO_STATIC__.files = {};
</script>
</head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "03_fault_tolerance.py",
            "mode": "read",
            "version": "0.19.7",
            "serverToken": "static",
            "config": {"ai": {"custom_providers": {}, "models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false, "signature_hint_on_typing": false}, "diagnostics": {"sql_linter": true}, "display": {"cell_output": "below", "code_editor_font_size": 14, "dataframes": "rich", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "medium", "reference_highlighting": true, "theme": "light"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": false}}, "mcp": {"mcpServers": {}, "presets": []}, "package_management": {"manager": "uv"}, "runtime": {"auto_instantiate": false, "auto_reload": "off", "default_csv_encoding": "utf-8", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "after_delay", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"sql_output": "auto", "width": "medium"},
            "view": {"showAppCode": true},
            "notebook": {"cells": [{"code": "import marimo as mo", "code_hash": "1d0db38904205bec4d6f6f6a1f6cec3e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hbol", "name": "_"}, {"code": "# Shared imports for the notebook\nimport random\nfrom monarch.actor import Actor, endpoint, current_rank, this_host", "code_hash": "6cb94f47cecb3ca146e8603f0cd40deb", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "MJUe", "name": "_"}, {"code": "mo.md(r\"\"\"\n# Fault Tolerance in Monarch\n\nAt scale, failures are constant. This notebook shows how to handle them gracefully.\n\nWhat you'll learn:\n\n1. The canonical try/except pattern (covers 90% of cases)\n2. Supervision trees for centralized error surfacing\n3. TorchFT integration for fault-tolerant training at scale\n\"\"\")", "code_hash": "95f2d3846c7ee0a5cc01938487239548", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "vblA", "name": "_"}, {"code": "mo.md(r\"\"\"\n## When You're Running on Thousands of GPUs\n\nSomething is always failing:\n\n- GPU memory errors (ECC, OOM)\n- Network hiccups (transient, routing issues)\n- Node crashes (hardware, kernel panics)\n- Software bugs (race conditions, edge cases)\n\n**The real cost:** A single undetected failure can burn millions of dollars. Silent failures are especially dangerous - your training looks fine but is actually diverging or stalled.\n\n**The observability challenge:**\nYou need monitoring and observability at every layer to detect when systems are healthy or unhealthy. Of course, this is a prime target for automation.\n\n**Why SPMD makes this hard:**\nWith traditional SPMD, automating failure detection and recovery is difficult:\n\n- Making sense of thousands of ranks, each with their own view\n- Plumbing through logs scattered across nodes\n- Correlating failures across distributed processes\n- No centralized place to catch and handle errors\n\n**Monarch's approach:** Supervision trees provide centralized error surfacing. When an actor fails, the error bubbles up through a structured hierarchy - giving you one place to see what went wrong and why.\n\"\"\")", "code_hash": "e246ca3cf3f2e7539291e98315ef82a8", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "bkHC", "name": "_"}, {"code": "mo.md(r\"\"\"\n## The Simple Pattern: Try/Except\n\nThis is what you should reach for first. It's familiar, explicit, and works great.\n\"\"\")", "code_hash": "8a35c052ef71b8ab433287e8d61b6f4c", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "lEQa", "name": "_"}, {"code": "class UnreliableWorker(Actor):\n    \"\"\"A worker that sometimes fails.\"\"\"\n\n    def __init__(self, failure_rate: float = 0.3):\n        self.rank = current_rank().rank\n        self.failure_rate = failure_rate\n        self.call_count = 0\n\n    @endpoint\n    def process(self, data: int) -\u003E dict:\n        self.call_count += 1\n        if random.random() \u003C self.failure_rate:\n            raise RuntimeError(f\"Random failure on rank {self.rank}, call {self.call_count}\")\n        return {\"rank\": self.rank, \"result\": data * 2, \"calls\": self.call_count}\n\n# Spawn workers\nhost = this_host()\nprocs = host.spawn_procs(per_host={\"gpus\": 3})\nworkers = procs.spawn(\"unreliable\", UnreliableWorker, 0.3)\n\n# The canonical pattern: try/except with fallback\ndef process_with_retry(workers_mesh, data, max_retries=3):\n    \"\"\"Try each worker until one succeeds.\"\"\"\n    errors = []\n    for attempt in range(max_retries):\n        worker = workers_mesh.slice(gpus=attempt % 3)  # Round-robin through workers\n        try:\n            result = worker.process.call_one(data).get()\n            print(f\"  Attempt {attempt + 1}: Success! {result}\")\n            return result\n        except Exception as e:\n            errors.append(str(e))\n            print(f\"  Attempt {attempt + 1}: Failed - {type(e).__name__}\")\n    raise RuntimeError(f\"All {max_retries} attempts failed\")\n\nprint(\"=== Processing with retry ===\")\nfor i in range(5):\n    print(f\"\\nTask {i}:\")\n    try:\n        _result = process_with_retry(workers, i * 10)\n    except RuntimeError as e:\n        print(f\"  All retries exhausted: {e}\")", "code_hash": "503f5f199a97facdf7ae32c9c3a90877", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "PKri", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Why This Simple Pattern Works\n\nActors are **stateless from the caller's perspective**:\n\n- If one fails, try another\n- The caller doesn't need to know implementation details\n- Each actor can maintain its own state internally\n\nThis is the **90% solution**. Use it unless you have a specific reason not to.\n\n```python\n# The pattern in one line\nresult = try_call(actor1) or try_call(actor2) or try_call(actor3)\n```\n\"\"\")", "code_hash": "9b47ef66a886694ff261dfcfbfa1287f", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Xref", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Supervision Trees: Centralized Error Surfacing\n\nFor infrastructure builders who want **centralized failure handling**.\n\nThe `__supervise__` hook intercepts child actor failures before they propagate.\nThink of it as middleware for failure handling.\n\n```\n                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502 Supervisor  \u2502\n                    \u2502             \u2502\n                    \u2502 __supervise__() \u25c4\u2500\u2500 failure event\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n                           \u2502 spawns           \u2502\n           \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n           \u25bc               \u25bc               \u25bc  \u2502\n      [Worker 0]      [Worker 1]      [Worker 2]\n         \u2713              \u2717 FAIL \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\"\"\")", "code_hash": "ac97032a7ad459da16a612f43b27c4c2", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "SFPL", "name": "_"}, {"code": "mo.md(r\"\"\"\n### How Supervision Works\n\nWhen a child fails, the supervisor's `__supervise__` is called with:\n\n```python\nSupervisionEvent:\n  - actor_id: Which actor failed\n  - actor_status: Running | Stopped | Failed(error)\n  - occurred_at: Timestamp\n  - message_headers: Context from triggering message\n```\n\nThe supervisor can:\n\n- **Return True**: \"I handled it\" (stops propagation)\n- **Return False**: \"Propagate up\" (parent's `__supervise__` called)\n\n```python\nclass WorkerSupervisor(Actor):\n    def __init__(self):\n        self.failure_count = 0\n\n    async def __supervise__(self, event: SupervisionEvent) -\u003E bool:\n        self.failure_count += 1\n        print(f\"Caught failure #{self.failure_count}: {event.actor_id}\")\n\n        if self.failure_count \u003C 5:\n            print(\"  -\u003E Handling locally (restarting worker)\")\n            return True  # Handled - don't propagate\n        else:\n            print(\"  -\u003E Too many failures, propagating up\")\n            return False  # Propagate to our supervisor\n```\n\"\"\")", "code_hash": "07aee4c78a35f66d895a1cb129fb56e7", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "BYtC", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Failure Chain Visibility\n\nWhen failures propagate, Monarch maintains the full chain of causality:\n\n```\nERROR [orchestrator] Actor 'orchestrator' failed:\n  \u2514\u2500 UnhandledSupervisionEvent from 'trainer_controller':\n       \u2514\u2500 UnhandledSupervisionEvent from 'trainer_rank_3':\n            \u2514\u2500 ActorPanic: \"CUDA out of memory allocating 2.1GB\"\n               at train_step() line 142\n               message_id: \"batch_12847\"\n```\n\nThis gives you:\n\n- **Root cause**: The actual error (OOM on rank 3)\n- **Propagation path**: How the failure bubbled up\n- **Context**: Which message triggered the failure\n- **Actor identity**: Exact actor name and hierarchy\n\nTraditional distributed systems show scattered logs. Monarch shows **one structured chain**.\n\nSupervision trees help with error detection - they're foundational to how Monarch integrates with fault-tolerant training systems like TorchFT.\n\"\"\")", "code_hash": "372d027312d91e6a3f57854a0891871a", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "RGSE", "name": "_"}, {"code": "mo.md(r\"\"\"\n## TorchFT: Fault-Tolerant Training at Scale\n\n**Why does fault tolerance matter at scale?**\n\nAt large scales, failures become expected, not exceptional:\n\n\u003E In our Llama3 training runs we experienced **419 interruptions across a 54 day training window** for a 16k GPU training job. This averages to about **one failure every 3 hours**.\n\u003E\n\u003E If we project this out to 10s of thousands of GPUs, this represents a **failure once every hour or more frequently**.\n\n(from [Introducing PyTorch Monarch](https://pytorch.org/blog/introducing-pytorch-monarch/))\n\nRestarting the entire job for each of these failures will reduce the effective training time dramatically.\n\n**TorchFT's approach:** Instead of stopping the whole job, continue training with the healthy replicas while failed ones recover.\n\"\"\")", "code_hash": "b3a302602230f7cc1f23ea6b83eff0d2", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Kclp", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Approaches to Fault-Tolerant Training\n\nThe solution is to make training tolerant of replica failures without stopping the entire job.\n\n**TorchFT** (from PyTorch) provides a way to withstand GPU failures and allow training to continue.\n\n**Strategy: Hybrid Sharded Data Parallelism**\nCombines fault-tolerant DDP with FSDP v2 and Pipeline Parallelism.\n\nOn failure:\n\n- Use torchcomms to catch collective-related errors and bubble them up through Monarch\n- Continue training on the next batch without downtime\n- Isolate failures to a single \"replica group\"\n- Continue training with a subset of the original job (quorum shrinks)\n\n```\nTraditional Training:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502Replica 0\u2502 \u2502Replica 1\u2502 \u2502Replica 2\u2502 \u2502Replica 3\u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n     \u2502           \u2502           \u2502           \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                       \u25bc\n              All-reduce every step\n              Single failure \u2192 restart everything\n\nTorchFT Quorum-Based Training:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502Replica 0\u2502 \u2502Replica 1\u2502 \u2502Replica 2\u2502 \u2502Replica 3\u2502\n\u2502 healthy \u2502 \u2502  FAILED \u2502 \u2502 healthy \u2502 \u2502 healthy \u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n     \u2502                       \u2502           \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u25bc\n        Quorum shrinks to 3 replicas\n        Training continues without stopping\n        Failed replica recovers and rejoins\n```\n\"\"\")", "code_hash": "840d56317c8f309cb44e7e1fc06e69a9", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "emfo", "name": "_"}, {"code": "mo.md(r\"\"\"\n## How Monarch Integrates with TorchFT\n\nMonarch and TorchFT have a clear separation of concerns:\n\n**TorchFT: Step-Level Fault Tolerance**\n\n- Lighthouse (Rust gRPC service) coordinates quorum membership via heartbeats (~100ms)\n- Manager handles checkpoint recovery when replicas join/leave\n- Training continues with reduced world size - no global stop\n\n**Monarch: Orchestration-Level Recovery**\n\n- Job allocation (SLURM) and process mesh spawning\n- When a replica completely crashes, Monarch respins it with configurable retry logic\n- First attempts fast process-level restarts, then escalates to new allocation if needed\n\n**How they connect:**\n\n1. Monarch spawns trainer processes and sets `TORCHFT_LIGHTHOUSE` env var\n2. TorchFT trainers connect to Lighthouse using that address\n3. If individual trainer crashes \u2192 Monarch's orchestration respins the replica\n4. If GPU fails during a training step \u2192 TorchFT handles it via quorum shrink\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              Monarch Orchestration Layer                    \u2502\n\u2502                                                             \u2502\n\u2502  Job Allocation          Replica Lifecycle                  \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u2502\n\u2502  \u2502 SLURM /      \u2502       \u2502 Crash detected?     \u2502             \u2502\n\u2502  \u2502 Allocation   \u2502       \u2502 \u2192 Respin replica    \u2502             \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518       \u2502 \u2192 Retry logic       \u2502             \u2502\n\u2502                         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n              \u25bc               \u25bc               \u25bc\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502 Replica  \u2502    \u2502 Replica  \u2502    \u2502 Replica  \u2502\n        \u2502 Group 0  \u2502    \u2502 Group 1  \u2502    \u2502 Group 2  \u2502\n        \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518\n             \u2502               \u2502               \u2502\n             \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                             \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              TorchFT Fault Tolerance Layer                  \u2502\n\u2502                                                             \u2502\n\u2502  Lighthouse (gRPC)       Per-Step Recovery                  \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u2502\n\u2502  \u2502 Heartbeats   \u2502       \u2502 Quorum shrink/grow  \u2502             \u2502\n\u2502  \u2502 (~100ms)     \u2502       \u2502 Checkpoint transfer \u2502             \u2502\n\u2502  \u2502 Quorum       \u2502       \u2502 No global stop      \u2502             \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\"\"\")", "code_hash": "cef96ca12e6f0d6a41b7244667296a1a", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hstk", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Case Study: Qwen3-32B Training with Fault Injection\n\nWe ran this code on a **30 node (240 H100s) Coreweave cluster**, using the SLURM scheduler to train Qwen3-32B using torchtitan and TorchFT.\n\n**Test conditions:**\n\n- 100 injected failures every 3 minutes\n- Multiple failure modes: segfaults, process kills, NCCL abort, host eviction, GIL deadlock\n\n**Results:**\n\n| Metric | Result |\n|--------|--------|\n| Recovery speed vs full SLURM restart | **60% faster** |\n| Avg recovery time (process failures) | **90 seconds** |\n| Avg recovery time (machine failures) | **2.5 minutes** |\n\n**Why the improvement?**\nMonarch allows for configurable recovery strategies based on failure type \u2014 we avoid unnecessary job rescheduling by attempting fast process-level restarts first.\n\"\"\")", "code_hash": "802c57a3ca5c1ed221f9b1d46bdb7c84", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "nWHF", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Summary\n\n**Key takeaways:**\n\n1. **Try/except first**: The canonical pattern covers 90% of cases\n2. **Supervision trees**: Centralized error surfacing - one place to see what went wrong\n3. **Quorum-based training**: Continue with healthy replicas while failed ones recover\n4. **Monarch + TorchFT**: Orchestration-level recovery + step-level fault tolerance\n\n**When to use what:**\n\n| Situation | Pattern |\n|-----------|---------|\n| Simple actor calls | Try/except |\n| Building infrastructure | Supervision trees |\n| Massive scale training | TorchFT + Monarch |\n\n**Next:** Async RL - putting it all together with services, RDMA, and async loops\n\"\"\")", "code_hash": "b3b867675332f1249377f7e73341ef54", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "iLit", "name": "_"}], "metadata": {"marimo_version": "0.19.7"}, "version": "1"},
            "session": {"cells": [{"code_hash": "1d0db38904205bec4d6f6f6a1f6cec3e", "console": [], "id": "Hbol", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "6cb94f47cecb3ca146e8603f0cd40deb", "console": [], "id": "MJUe", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "95f2d3846c7ee0a5cc01938487239548", "console": [], "id": "vblA", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch1 id=\"fault-tolerance-in-monarch\"\u003EFault Tolerance in Monarch\u003C/h1\u003E\n\u003Cspan class=\"paragraph\"\u003EAt scale, failures are constant. This notebook shows how to handle them gracefully.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EWhat you'll learn:\u003C/span\u003E\n\u003Col\u003E\n\u003Cli\u003EThe canonical try/except pattern (covers 90% of cases)\u003C/li\u003E\n\u003Cli\u003ESupervision trees for centralized error surfacing\u003C/li\u003E\n\u003Cli\u003ETorchFT integration for fault-tolerant training at scale\u003C/li\u003E\n\u003C/ol\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "e246ca3cf3f2e7539291e98315ef82a8", "console": [], "id": "bkHC", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"when-youre-running-on-thousands-of-gpus\"\u003EWhen You're Running on Thousands of GPUs\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003ESomething is always failing:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003EGPU memory errors (ECC, OOM)\u003C/li\u003E\n\u003Cli\u003ENetwork hiccups (transient, routing issues)\u003C/li\u003E\n\u003Cli\u003ENode crashes (hardware, kernel panics)\u003C/li\u003E\n\u003Cli\u003ESoftware bugs (race conditions, edge cases)\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EThe real cost:\u003C/strong\u003E A single undetected failure can burn millions of dollars. Silent failures are especially dangerous - your training looks fine but is actually diverging or stalled.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EThe observability challenge:\u003C/strong\u003E\nYou need monitoring and observability at every layer to detect when systems are healthy or unhealthy. Of course, this is a prime target for automation.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EWhy SPMD makes this hard:\u003C/strong\u003E\nWith traditional SPMD, automating failure detection and recovery is difficult:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003EMaking sense of thousands of ranks, each with their own view\u003C/li\u003E\n\u003Cli\u003EPlumbing through logs scattered across nodes\u003C/li\u003E\n\u003Cli\u003ECorrelating failures across distributed processes\u003C/li\u003E\n\u003Cli\u003ENo centralized place to catch and handle errors\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EMonarch's approach:\u003C/strong\u003E Supervision trees provide centralized error surfacing. When an actor fails, the error bubbles up through a structured hierarchy - giving you one place to see what went wrong and why.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "8a35c052ef71b8ab433287e8d61b6f4c", "console": [], "id": "lEQa", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"the-simple-pattern-tryexcept\"\u003EThe Simple Pattern: Try/Except\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EThis is what you should reach for first. It's familiar, explicit, and works great.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "503f5f199a97facdf7ae32c9c3a90877", "console": [{"mimetype": "text/plain", "name": "stderr", "text": "Monarch internal logs are being written to /tmp/allencwang/monarch_log.log; execution id allencwang_Feb-03_15:15_653\n", "type": "stream"}, {"mimetype": "text/plain", "name": "stdout", "text": "=== Processing with retry ===\n\nTask 0:\n  Attempt 1: Failed - ActorError\n  Attempt 2: Failed - ActorError\n  Attempt 3: Failed - ActorError\n  All retries exhausted: All 3 attempts failed\n\nTask 1:\n  Attempt 1: Success! {'rank': 0, 'result': 20, 'calls': 2}\n\nTask 2:\n  Attempt 1: Success! {'rank': 0, 'result': 40, 'calls': 3}\n\nTask 3:\n  Attempt 1: Success! {'rank': 0, 'result': 60, 'calls': 4}\n\nTask 4:\n  Attempt 1: Failed - ActorError\n  Attempt 2: Failed - ActorError\n  Attempt 3: Success! {'rank': 2, 'result': 80, 'calls': 2}\n", "type": "stream"}], "id": "PKri", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "9b47ef66a886694ff261dfcfbfa1287f", "console": [], "id": "Xref", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"why-this-simple-pattern-works\"\u003EWhy This Simple Pattern Works\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EActors are \u003Cstrong\u003Estateless from the caller's perspective\u003C/strong\u003E:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003EIf one fails, try another\u003C/li\u003E\n\u003Cli\u003EThe caller doesn't need to know implementation details\u003C/li\u003E\n\u003Cli\u003EEach actor can maintain its own state internally\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003EThis is the \u003Cstrong\u003E90% solution\u003C/strong\u003E. Use it unless you have a specific reason not to.\u003C/span\u003E\n\u003Cdiv class=\"language-python codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"c1\"\u003E# The pattern in one line\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Eresult\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Etry_call\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Eactor1\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"ow\"\u003Eor\u003C/span\u003E \u003Cspan class=\"n\"\u003Etry_call\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Eactor2\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"ow\"\u003Eor\u003C/span\u003E \u003Cspan class=\"n\"\u003Etry_call\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Eactor3\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "ac97032a7ad459da16a612f43b27c4c2", "console": [], "id": "SFPL", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"supervision-trees-centralized-error-surfacing\"\u003ESupervision Trees: Centralized Error Surfacing\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EFor infrastructure builders who want \u003Cstrong\u003Ecentralized failure handling\u003C/strong\u003E.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThe \u003Ccode\u003E__supervise__\u003C/code\u003E hook intercepts child actor failures before they propagate.\nThink of it as middleware for failure handling.\u003C/span\u003E\n\u003Cdiv class=\"language-scdoc codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502 Supervisor  \u2502\n                    \u2502             \u2502\n                    \u2502 __supervise__() \u25c4\u2500\u2500 failure event\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n                           \u2502 spawns           \u2502\n           \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n           \u25bc               \u25bc               \u25bc  \u2502\n      [Worker 0]      [Worker 1]      [Worker 2]\n         \u2713              \u2717 FAIL \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "07aee4c78a35f66d895a1cb129fb56e7", "console": [], "id": "BYtC", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"how-supervision-works\"\u003EHow Supervision Works\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003EWhen a child fails, the supervisor's \u003Ccode\u003E__supervise__\u003C/code\u003E is called with:\u003C/span\u003E\n\u003Cdiv class=\"language-python codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"n\"\u003ESupervisionEvent\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E\n\n    \u003Cspan class=\"o\"\u003E-\u003C/span\u003E \u003Cspan class=\"n\"\u003Eactor_id\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E \u003Cspan class=\"n\"\u003EWhich\u003C/span\u003E \u003Cspan class=\"n\"\u003Eactor\u003C/span\u003E \u003Cspan class=\"n\"\u003Efailed\u003C/span\u003E\n\n    \u003Cspan class=\"o\"\u003E-\u003C/span\u003E \u003Cspan class=\"n\"\u003Eactor_status\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E \u003Cspan class=\"n\"\u003ERunning\u003C/span\u003E \u003Cspan class=\"o\"\u003E|\u003C/span\u003E \u003Cspan class=\"n\"\u003EStopped\u003C/span\u003E \u003Cspan class=\"o\"\u003E|\u003C/span\u003E \u003Cspan class=\"n\"\u003EFailed\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Eerror\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\n    \u003Cspan class=\"o\"\u003E-\u003C/span\u003E \u003Cspan class=\"n\"\u003Eoccurred_at\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E \u003Cspan class=\"n\"\u003ETimestamp\u003C/span\u003E\n\n    \u003Cspan class=\"o\"\u003E-\u003C/span\u003E \u003Cspan class=\"n\"\u003Emessage_headers\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E \u003Cspan class=\"n\"\u003EContext\u003C/span\u003E \u003Cspan class=\"kn\"\u003Efrom\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"nn\"\u003Etriggering\u003C/span\u003E \u003Cspan class=\"n\"\u003Emessage\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EThe supervisor can:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Cstrong\u003EReturn True\u003C/strong\u003E: \"I handled it\" (stops propagation)\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EReturn False\u003C/strong\u003E: \"Propagate up\" (parent's \u003Ccode\u003E__supervise__\u003C/code\u003E called)\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cdiv class=\"language-python codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"k\"\u003Eclass\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"nc\"\u003EWorkerSupervisor\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EActor\u003C/span\u003E\u003Cspan class=\"p\"\u003E):\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Edef\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"fm\"\u003E__init__\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"p\"\u003E):\u003C/span\u003E\n        \u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Efailure_count\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"mi\"\u003E0\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Easync\u003C/span\u003E \u003Cspan class=\"k\"\u003Edef\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"nf\"\u003E__supervise__\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Eevent\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E \u003Cspan class=\"n\"\u003ESupervisionEvent\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E \u003Cspan class=\"nb\"\u003Ebool\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E\n        \u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Efailure_count\u003C/span\u003E \u003Cspan class=\"o\"\u003E+=\u003C/span\u003E \u003Cspan class=\"mi\"\u003E1\u003C/span\u003E\n        \u003Cspan class=\"nb\"\u003Eprint\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"sa\"\u003Ef\u003C/span\u003E\u003Cspan class=\"s2\"\u003E\u0026quot;Caught failure #\u003C/span\u003E\u003Cspan class=\"si\"\u003E{\u003C/span\u003E\u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Efailure_count\u003C/span\u003E\u003Cspan class=\"si\"\u003E}\u003C/span\u003E\u003Cspan class=\"s2\"\u003E: \u003C/span\u003E\u003Cspan class=\"si\"\u003E{\u003C/span\u003E\u003Cspan class=\"n\"\u003Eevent\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eactor_id\u003C/span\u003E\u003Cspan class=\"si\"\u003E}\u003C/span\u003E\u003Cspan class=\"s2\"\u003E\u0026quot;\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\n        \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Efailure_count\u003C/span\u003E \u003Cspan class=\"o\"\u003E\u0026lt;\u003C/span\u003E \u003Cspan class=\"mi\"\u003E5\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E\n            \u003Cspan class=\"nb\"\u003Eprint\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s2\"\u003E\u0026quot;  -\u0026gt; Handling locally (restarting worker)\u0026quot;\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"kc\"\u003ETrue\u003C/span\u003E  \u003Cspan class=\"c1\"\u003E# Handled - don\u0026#39;t propagate\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Eelse\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E\n            \u003Cspan class=\"nb\"\u003Eprint\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s2\"\u003E\u0026quot;  -\u0026gt; Too many failures, propagating up\u0026quot;\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"kc\"\u003EFalse\u003C/span\u003E  \u003Cspan class=\"c1\"\u003E# Propagate to our supervisor\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "372d027312d91e6a3f57854a0891871a", "console": [], "id": "RGSE", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"failure-chain-visibility\"\u003EFailure Chain Visibility\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EWhen failures propagate, Monarch maintains the full chain of causality:\u003C/span\u003E\n\u003Cdiv class=\"language-tsql codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"n\"\u003EERROR\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"o\"\u003E[\u003C/span\u003E\u003Cspan class=\"n\"\u003Eorchestrator\u003C/span\u003E\u003Cspan class=\"o\"\u003E]\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003EActor\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;orchestrator\u0026#39;\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"nl\"\u003Efailed\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E\n\u003Cspan class=\"w\"\u003E  \u003C/span\u003E\u003Cspan class=\"err\"\u003E\u2514\u2500\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003EUnhandledSupervisionEvent\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"k\"\u003Efrom\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;trainer_controller\u0026#39;\u003C/span\u003E\u003Cspan class=\"err\"\u003E:\u003C/span\u003E\n\u003Cspan class=\"w\"\u003E       \u003C/span\u003E\u003Cspan class=\"err\"\u003E\u2514\u2500\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003EUnhandledSupervisionEvent\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"k\"\u003Efrom\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"s1\"\u003E\u0026#39;trainer_rank_3\u0026#39;\u003C/span\u003E\u003Cspan class=\"err\"\u003E:\u003C/span\u003E\n\u003Cspan class=\"w\"\u003E            \u003C/span\u003E\u003Cspan class=\"err\"\u003E\u2514\u2500\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"nl\"\u003EActorPanic\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"ss\"\u003E\u0026quot;CUDA out of memory allocating 2.1GB\u0026quot;\u003C/span\u003E\n\u003Cspan class=\"w\"\u003E               \u003C/span\u003E\u003Cspan class=\"k\"\u003Eat\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003Etrain_step\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003Eline\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"mi\"\u003E142\u003C/span\u003E\n\u003Cspan class=\"w\"\u003E               \u003C/span\u003E\u003Cspan class=\"nl\"\u003Emessage_id\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"ss\"\u003E\u0026quot;batch_12847\u0026quot;\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EThis gives you:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Cstrong\u003ERoot cause\u003C/strong\u003E: The actual error (OOM on rank 3)\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EPropagation path\u003C/strong\u003E: How the failure bubbled up\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EContext\u003C/strong\u003E: Which message triggered the failure\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EActor identity\u003C/strong\u003E: Exact actor name and hierarchy\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003ETraditional distributed systems show scattered logs. Monarch shows \u003Cstrong\u003Eone structured chain\u003C/strong\u003E.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003ESupervision trees help with error detection - they're foundational to how Monarch integrates with fault-tolerant training systems like TorchFT.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "b3a302602230f7cc1f23ea6b83eff0d2", "console": [], "id": "Kclp", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"torchft-fault-tolerant-training-at-scale\"\u003ETorchFT: Fault-Tolerant Training at Scale\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EWhy does fault tolerance matter at scale?\u003C/strong\u003E\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EAt large scales, failures become expected, not exceptional:\u003C/span\u003E\n\u003Cblockquote\u003E\n\u003Cspan class=\"paragraph\"\u003EIn our Llama3 training runs we experienced \u003Cstrong\u003E419 interruptions across a 54 day training window\u003C/strong\u003E for a 16k GPU training job. This averages to about \u003Cstrong\u003Eone failure every 3 hours\u003C/strong\u003E.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EIf we project this out to 10s of thousands of GPUs, this represents a \u003Cstrong\u003Efailure once every hour or more frequently\u003C/strong\u003E.\u003C/span\u003E\n\u003C/blockquote\u003E\n\u003Cspan class=\"paragraph\"\u003E(from \u003Ca href=\"https://pytorch.org/blog/introducing-pytorch-monarch/\" rel=\"noopener noreferrer\" target=\"_blank\"\u003EIntroducing PyTorch Monarch\u003C/a\u003E)\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003ERestarting the entire job for each of these failures will reduce the effective training time dramatically.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003ETorchFT's approach:\u003C/strong\u003E Instead of stopping the whole job, continue training with the healthy replicas while failed ones recover.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "840d56317c8f309cb44e7e1fc06e69a9", "console": [], "id": "emfo", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"approaches-to-fault-tolerant-training\"\u003EApproaches to Fault-Tolerant Training\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EThe solution is to make training tolerant of replica failures without stopping the entire job.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003ETorchFT\u003C/strong\u003E (from PyTorch) provides a way to withstand GPU failures and allow training to continue.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EStrategy: Hybrid Sharded Data Parallelism\u003C/strong\u003E\nCombines fault-tolerant DDP with FSDP v2 and Pipeline Parallelism.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EOn failure:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003EUse torchcomms to catch collective-related errors and bubble them up through Monarch\u003C/li\u003E\n\u003Cli\u003EContinue training on the next batch without downtime\u003C/li\u003E\n\u003Cli\u003EIsolate failures to a single \"replica group\"\u003C/li\u003E\n\u003Cli\u003EContinue training with a subset of the original job (quorum shrinks)\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cdiv class=\"language-text codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003ETraditional Training:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502Replica 0\u2502 \u2502Replica 1\u2502 \u2502Replica 2\u2502 \u2502Replica 3\u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n     \u2502           \u2502           \u2502           \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                       \u25bc\n              All-reduce every step\n              Single failure \u2192 restart everything\n\nTorchFT Quorum-Based Training:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502Replica 0\u2502 \u2502Replica 1\u2502 \u2502Replica 2\u2502 \u2502Replica 3\u2502\n\u2502 healthy \u2502 \u2502  FAILED \u2502 \u2502 healthy \u2502 \u2502 healthy \u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n     \u2502                       \u2502           \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u25bc\n        Quorum shrinks to 3 replicas\n        Training continues without stopping\n        Failed replica recovers and rejoins\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "cef96ca12e6f0d6a41b7244667296a1a", "console": [], "id": "Hstk", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"how-monarch-integrates-with-torchft\"\u003EHow Monarch Integrates with TorchFT\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EMonarch and TorchFT have a clear separation of concerns:\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003ETorchFT: Step-Level Fault Tolerance\u003C/strong\u003E\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003ELighthouse (Rust gRPC service) coordinates quorum membership via heartbeats (~100ms)\u003C/li\u003E\n\u003Cli\u003EManager handles checkpoint recovery when replicas join/leave\u003C/li\u003E\n\u003Cli\u003ETraining continues with reduced world size - no global stop\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EMonarch: Orchestration-Level Recovery\u003C/strong\u003E\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003EJob allocation (SLURM) and process mesh spawning\u003C/li\u003E\n\u003Cli\u003EWhen a replica completely crashes, Monarch respins it with configurable retry logic\u003C/li\u003E\n\u003Cli\u003EFirst attempts fast process-level restarts, then escalates to new allocation if needed\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EHow they connect:\u003C/strong\u003E\u003C/span\u003E\n\u003Col\u003E\n\u003Cli\u003EMonarch spawns trainer processes and sets \u003Ccode\u003ETORCHFT_LIGHTHOUSE\u003C/code\u003E env var\u003C/li\u003E\n\u003Cli\u003ETorchFT trainers connect to Lighthouse using that address\u003C/li\u003E\n\u003Cli\u003EIf individual trainer crashes \u2192 Monarch's orchestration respins the replica\u003C/li\u003E\n\u003Cli\u003EIf GPU fails during a training step \u2192 TorchFT handles it via quorum shrink\u003C/li\u003E\n\u003C/ol\u003E\n\u003Cdiv class=\"language-text codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              Monarch Orchestration Layer                    \u2502\n\u2502                                                             \u2502\n\u2502  Job Allocation          Replica Lifecycle                  \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u2502\n\u2502  \u2502 SLURM /      \u2502       \u2502 Crash detected?     \u2502             \u2502\n\u2502  \u2502 Allocation   \u2502       \u2502 \u2192 Respin replica    \u2502             \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518       \u2502 \u2192 Retry logic       \u2502             \u2502\n\u2502                         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n              \u25bc               \u25bc               \u25bc\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502 Replica  \u2502    \u2502 Replica  \u2502    \u2502 Replica  \u2502\n        \u2502 Group 0  \u2502    \u2502 Group 1  \u2502    \u2502 Group 2  \u2502\n        \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518\n             \u2502               \u2502               \u2502\n             \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                             \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              TorchFT Fault Tolerance Layer                  \u2502\n\u2502                                                             \u2502\n\u2502  Lighthouse (gRPC)       Per-Step Recovery                  \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u2502\n\u2502  \u2502 Heartbeats   \u2502       \u2502 Quorum shrink/grow  \u2502             \u2502\n\u2502  \u2502 (~100ms)     \u2502       \u2502 Checkpoint transfer \u2502             \u2502\n\u2502  \u2502 Quorum       \u2502       \u2502 No global stop      \u2502             \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "802c57a3ca5c1ed221f9b1d46bdb7c84", "console": [], "id": "nWHF", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"case-study-qwen3-32b-training-with-fault-injection\"\u003ECase Study: Qwen3-32B Training with Fault Injection\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EWe ran this code on a \u003Cstrong\u003E30 node (240 H100s) Coreweave cluster\u003C/strong\u003E, using the SLURM scheduler to train Qwen3-32B using torchtitan and TorchFT.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003ETest conditions:\u003C/strong\u003E\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003E100 injected failures every 3 minutes\u003C/li\u003E\n\u003Cli\u003EMultiple failure modes: segfaults, process kills, NCCL abort, host eviction, GIL deadlock\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EResults:\u003C/strong\u003E\u003C/span\u003E\n\u003Ctable\u003E\n\u003Cthead\u003E\n\u003Ctr\u003E\n\u003Cth\u003EMetric\u003C/th\u003E\n\u003Cth\u003EResult\u003C/th\u003E\n\u003C/tr\u003E\n\u003C/thead\u003E\n\u003Ctbody\u003E\n\u003Ctr\u003E\n\u003Ctd\u003ERecovery speed vs full SLURM restart\u003C/td\u003E\n\u003Ctd\u003E\u003Cstrong\u003E60% faster\u003C/strong\u003E\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003EAvg recovery time (process failures)\u003C/td\u003E\n\u003Ctd\u003E\u003Cstrong\u003E90 seconds\u003C/strong\u003E\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003EAvg recovery time (machine failures)\u003C/td\u003E\n\u003Ctd\u003E\u003Cstrong\u003E2.5 minutes\u003C/strong\u003E\u003C/td\u003E\n\u003C/tr\u003E\n\u003C/tbody\u003E\n\u003C/table\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EWhy the improvement?\u003C/strong\u003E\nMonarch allows for configurable recovery strategies based on failure type \u2014 we avoid unnecessary job rescheduling by attempting fast process-level restarts first.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "b3b867675332f1249377f7e73341ef54", "console": [], "id": "iLit", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"summary\"\u003ESummary\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EKey takeaways:\u003C/strong\u003E\u003C/span\u003E\n\u003Col\u003E\n\u003Cli\u003E\u003Cstrong\u003ETry/except first\u003C/strong\u003E: The canonical pattern covers 90% of cases\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ESupervision trees\u003C/strong\u003E: Centralized error surfacing - one place to see what went wrong\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EQuorum-based training\u003C/strong\u003E: Continue with healthy replicas while failed ones recover\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EMonarch + TorchFT\u003C/strong\u003E: Orchestration-level recovery + step-level fault tolerance\u003C/li\u003E\n\u003C/ol\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EWhen to use what:\u003C/strong\u003E\u003C/span\u003E\n\u003Ctable\u003E\n\u003Cthead\u003E\n\u003Ctr\u003E\n\u003Cth\u003ESituation\u003C/th\u003E\n\u003Cth\u003EPattern\u003C/th\u003E\n\u003C/tr\u003E\n\u003C/thead\u003E\n\u003Ctbody\u003E\n\u003Ctr\u003E\n\u003Ctd\u003ESimple actor calls\u003C/td\u003E\n\u003Ctd\u003ETry/except\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003EBuilding infrastructure\u003C/td\u003E\n\u003Ctd\u003ESupervision trees\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003EMassive scale training\u003C/td\u003E\n\u003Ctd\u003ETorchFT + Monarch\u003C/td\u003E\n\u003C/tr\u003E\n\u003C/tbody\u003E\n\u003C/table\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003ENext:\u003C/strong\u003E Async RL - putting it all together with services, RDMA, and async loops\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}], "metadata": {"marimo_version": "0.19.7"}, "version": "1"},
            "runtimeConfig": null,
        };
    </script>
  
<marimo-code hidden="">
    import%20marimo%0A%0A__generated_with%20%3D%20%220.19.7%22%0Aapp%20%3D%20marimo.App(width%3D%22medium%22)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20return%20(mo%2C)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20%23%20Shared%20imports%20for%20the%20notebook%0A%20%20%20%20import%20random%0A%20%20%20%20from%20monarch.actor%20import%20Actor%2C%20endpoint%2C%20current_rank%2C%20this_host%0A%20%20%20%20return%20Actor%2C%20current_rank%2C%20endpoint%2C%20random%2C%20this_host%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%20Fault%20Tolerance%20in%20Monarch%0A%0A%20%20%20%20At%20scale%2C%20failures%20are%20constant.%20This%20notebook%20shows%20how%20to%20handle%20them%20gracefully.%0A%0A%20%20%20%20What%20you'll%20learn%3A%0A%0A%20%20%20%201.%20The%20canonical%20try%2Fexcept%20pattern%20(covers%2090%25%20of%20cases)%0A%20%20%20%202.%20Supervision%20trees%20for%20centralized%20error%20surfacing%0A%20%20%20%203.%20TorchFT%20integration%20for%20fault-tolerant%20training%20at%20scale%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20When%20You're%20Running%20on%20Thousands%20of%20GPUs%0A%0A%20%20%20%20Something%20is%20always%20failing%3A%0A%0A%20%20%20%20-%20GPU%20memory%20errors%20(ECC%2C%20OOM)%0A%20%20%20%20-%20Network%20hiccups%20(transient%2C%20routing%20issues)%0A%20%20%20%20-%20Node%20crashes%20(hardware%2C%20kernel%20panics)%0A%20%20%20%20-%20Software%20bugs%20(race%20conditions%2C%20edge%20cases)%0A%0A%20%20%20%20**The%20real%20cost%3A**%20A%20single%20undetected%20failure%20can%20burn%20millions%20of%20dollars.%20Silent%20failures%20are%20especially%20dangerous%20-%20your%20training%20looks%20fine%20but%20is%20actually%20diverging%20or%20stalled.%0A%0A%20%20%20%20**The%20observability%20challenge%3A**%0A%20%20%20%20You%20need%20monitoring%20and%20observability%20at%20every%20layer%20to%20detect%20when%20systems%20are%20healthy%20or%20unhealthy.%20Of%20course%2C%20this%20is%20a%20prime%20target%20for%20automation.%0A%0A%20%20%20%20**Why%20SPMD%20makes%20this%20hard%3A**%0A%20%20%20%20With%20traditional%20SPMD%2C%20automating%20failure%20detection%20and%20recovery%20is%20difficult%3A%0A%0A%20%20%20%20-%20Making%20sense%20of%20thousands%20of%20ranks%2C%20each%20with%20their%20own%20view%0A%20%20%20%20-%20Plumbing%20through%20logs%20scattered%20across%20nodes%0A%20%20%20%20-%20Correlating%20failures%20across%20distributed%20processes%0A%20%20%20%20-%20No%20centralized%20place%20to%20catch%20and%20handle%20errors%0A%0A%20%20%20%20**Monarch's%20approach%3A**%20Supervision%20trees%20provide%20centralized%20error%20surfacing.%20When%20an%20actor%20fails%2C%20the%20error%20bubbles%20up%20through%20a%20structured%20hierarchy%20-%20giving%20you%20one%20place%20to%20see%20what%20went%20wrong%20and%20why.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20The%20Simple%20Pattern%3A%20Try%2FExcept%0A%0A%20%20%20%20This%20is%20what%20you%20should%20reach%20for%20first.%20It's%20familiar%2C%20explicit%2C%20and%20works%20great.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Actor%2C%20current_rank%2C%20endpoint%2C%20random%2C%20this_host)%3A%0A%20%20%20%20class%20UnreliableWorker(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22A%20worker%20that%20sometimes%20fails.%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20failure_rate%3A%20float%20%3D%200.3)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.rank%20%3D%20current_rank().rank%0A%20%20%20%20%20%20%20%20%20%20%20%20self.failure_rate%20%3D%20failure_rate%0A%20%20%20%20%20%20%20%20%20%20%20%20self.call_count%20%3D%200%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20process(self%2C%20data%3A%20int)%20-%3E%20dict%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.call_count%20%2B%3D%201%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20random.random()%20%3C%20self.failure_rate%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20RuntimeError(f%22Random%20failure%20on%20rank%20%7Bself.rank%7D%2C%20call%20%7Bself.call_count%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%22rank%22%3A%20self.rank%2C%20%22result%22%3A%20data%20*%202%2C%20%22calls%22%3A%20self.call_count%7D%0A%0A%20%20%20%20%23%20Spawn%20workers%0A%20%20%20%20host%20%3D%20this_host()%0A%20%20%20%20procs%20%3D%20host.spawn_procs(per_host%3D%7B%22gpus%22%3A%203%7D)%0A%20%20%20%20workers%20%3D%20procs.spawn(%22unreliable%22%2C%20UnreliableWorker%2C%200.3)%0A%0A%20%20%20%20%23%20The%20canonical%20pattern%3A%20try%2Fexcept%20with%20fallback%0A%20%20%20%20def%20process_with_retry(workers_mesh%2C%20data%2C%20max_retries%3D3)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Try%20each%20worker%20until%20one%20succeeds.%22%22%22%0A%20%20%20%20%20%20%20%20errors%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20for%20attempt%20in%20range(max_retries)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20worker%20%3D%20workers_mesh.slice(gpus%3Dattempt%20%25%203)%20%20%23%20Round-robin%20through%20workers%0A%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20result%20%3D%20worker.process.call_one(data).get()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20Attempt%20%7Battempt%20%2B%201%7D%3A%20Success!%20%7Bresult%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20result%0A%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%20as%20e%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20errors.append(str(e))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20Attempt%20%7Battempt%20%2B%201%7D%3A%20Failed%20-%20%7Btype(e).__name__%7D%22)%0A%20%20%20%20%20%20%20%20raise%20RuntimeError(f%22All%20%7Bmax_retries%7D%20attempts%20failed%22)%0A%0A%20%20%20%20print(%22%3D%3D%3D%20Processing%20with%20retry%20%3D%3D%3D%22)%0A%20%20%20%20for%20i%20in%20range(5)%3A%0A%20%20%20%20%20%20%20%20print(f%22%5CnTask%20%7Bi%7D%3A%22)%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20_result%20%3D%20process_with_retry(workers%2C%20i%20*%2010)%0A%20%20%20%20%20%20%20%20except%20RuntimeError%20as%20e%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20All%20retries%20exhausted%3A%20%7Be%7D%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Why%20This%20Simple%20Pattern%20Works%0A%0A%20%20%20%20Actors%20are%20**stateless%20from%20the%20caller's%20perspective**%3A%0A%0A%20%20%20%20-%20If%20one%20fails%2C%20try%20another%0A%20%20%20%20-%20The%20caller%20doesn't%20need%20to%20know%20implementation%20details%0A%20%20%20%20-%20Each%20actor%20can%20maintain%20its%20own%20state%20internally%0A%0A%20%20%20%20This%20is%20the%20**90%25%20solution**.%20Use%20it%20unless%20you%20have%20a%20specific%20reason%20not%20to.%0A%0A%20%20%20%20%60%60%60python%0A%20%20%20%20%23%20The%20pattern%20in%20one%20line%0A%20%20%20%20result%20%3D%20try_call(actor1)%20or%20try_call(actor2)%20or%20try_call(actor3)%0A%20%20%20%20%60%60%60%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Supervision%20Trees%3A%20Centralized%20Error%20Surfacing%0A%0A%20%20%20%20For%20infrastructure%20builders%20who%20want%20**centralized%20failure%20handling**.%0A%0A%20%20%20%20The%20%60__supervise__%60%20hook%20intercepts%20child%20actor%20failures%20before%20they%20propagate.%0A%20%20%20%20Think%20of%20it%20as%20middleware%20for%20failure%20handling.%0A%0A%20%20%20%20%60%60%60%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20Supervisor%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20__supervise__()%20%E2%97%84%E2%94%80%E2%94%80%20failure%20event%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20spawns%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%BC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%96%BC%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%96%BC%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%96%BC%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%20%5BWorker%200%5D%20%20%20%20%20%20%5BWorker%201%5D%20%20%20%20%20%20%5BWorker%202%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%9C%93%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%9C%97%20FAIL%20%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%60%60%60%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20How%20Supervision%20Works%0A%0A%20%20%20%20When%20a%20child%20fails%2C%20the%20supervisor's%20%60__supervise__%60%20is%20called%20with%3A%0A%0A%20%20%20%20%60%60%60python%0A%20%20%20%20SupervisionEvent%3A%0A%20%20%20%20%20%20-%20actor_id%3A%20Which%20actor%20failed%0A%20%20%20%20%20%20-%20actor_status%3A%20Running%20%7C%20Stopped%20%7C%20Failed(error)%0A%20%20%20%20%20%20-%20occurred_at%3A%20Timestamp%0A%20%20%20%20%20%20-%20message_headers%3A%20Context%20from%20triggering%20message%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20The%20supervisor%20can%3A%0A%0A%20%20%20%20-%20**Return%20True**%3A%20%22I%20handled%20it%22%20(stops%20propagation)%0A%20%20%20%20-%20**Return%20False**%3A%20%22Propagate%20up%22%20(parent's%20%60__supervise__%60%20called)%0A%0A%20%20%20%20%60%60%60python%0A%20%20%20%20class%20WorkerSupervisor(Actor)%3A%0A%20%20%20%20%20%20%20%20def%20__init__(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.failure_count%20%3D%200%0A%0A%20%20%20%20%20%20%20%20async%20def%20__supervise__(self%2C%20event%3A%20SupervisionEvent)%20-%3E%20bool%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.failure_count%20%2B%3D%201%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Caught%20failure%20%23%7Bself.failure_count%7D%3A%20%7Bevent.actor_id%7D%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20self.failure_count%20%3C%205%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(%22%20%20-%3E%20Handling%20locally%20(restarting%20worker)%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20True%20%20%23%20Handled%20-%20don't%20propagate%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(%22%20%20-%3E%20Too%20many%20failures%2C%20propagating%20up%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20False%20%20%23%20Propagate%20to%20our%20supervisor%0A%20%20%20%20%60%60%60%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Failure%20Chain%20Visibility%0A%0A%20%20%20%20When%20failures%20propagate%2C%20Monarch%20maintains%20the%20full%20chain%20of%20causality%3A%0A%0A%20%20%20%20%60%60%60%0A%20%20%20%20ERROR%20%5Borchestrator%5D%20Actor%20'orchestrator'%20failed%3A%0A%20%20%20%20%20%20%E2%94%94%E2%94%80%20UnhandledSupervisionEvent%20from%20'trainer_controller'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%20UnhandledSupervisionEvent%20from%20'trainer_rank_3'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%20ActorPanic%3A%20%22CUDA%20out%20of%20memory%20allocating%202.1GB%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20at%20train_step()%20line%20142%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20message_id%3A%20%22batch_12847%22%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20This%20gives%20you%3A%0A%0A%20%20%20%20-%20**Root%20cause**%3A%20The%20actual%20error%20(OOM%20on%20rank%203)%0A%20%20%20%20-%20**Propagation%20path**%3A%20How%20the%20failure%20bubbled%20up%0A%20%20%20%20-%20**Context**%3A%20Which%20message%20triggered%20the%20failure%0A%20%20%20%20-%20**Actor%20identity**%3A%20Exact%20actor%20name%20and%20hierarchy%0A%0A%20%20%20%20Traditional%20distributed%20systems%20show%20scattered%20logs.%20Monarch%20shows%20**one%20structured%20chain**.%0A%0A%20%20%20%20Supervision%20trees%20help%20with%20error%20detection%20-%20they're%20foundational%20to%20how%20Monarch%20integrates%20with%20fault-tolerant%20training%20systems%20like%20TorchFT.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20TorchFT%3A%20Fault-Tolerant%20Training%20at%20Scale%0A%0A%20%20%20%20**Why%20does%20fault%20tolerance%20matter%20at%20scale%3F**%0A%0A%20%20%20%20At%20large%20scales%2C%20failures%20become%20expected%2C%20not%20exceptional%3A%0A%0A%20%20%20%20%3E%20In%20our%20Llama3%20training%20runs%20we%20experienced%20**419%20interruptions%20across%20a%2054%20day%20training%20window**%20for%20a%2016k%20GPU%20training%20job.%20This%20averages%20to%20about%20**one%20failure%20every%203%20hours**.%0A%20%20%20%20%3E%0A%20%20%20%20%3E%20If%20we%20project%20this%20out%20to%2010s%20of%20thousands%20of%20GPUs%2C%20this%20represents%20a%20**failure%20once%20every%20hour%20or%20more%20frequently**.%0A%0A%20%20%20%20(from%20%5BIntroducing%20PyTorch%20Monarch%5D(https%3A%2F%2Fpytorch.org%2Fblog%2Fintroducing-pytorch-monarch%2F))%0A%0A%20%20%20%20Restarting%20the%20entire%20job%20for%20each%20of%20these%20failures%20will%20reduce%20the%20effective%20training%20time%20dramatically.%0A%0A%20%20%20%20**TorchFT's%20approach%3A**%20Instead%20of%20stopping%20the%20whole%20job%2C%20continue%20training%20with%20the%20healthy%20replicas%20while%20failed%20ones%20recover.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Approaches%20to%20Fault-Tolerant%20Training%0A%0A%20%20%20%20The%20solution%20is%20to%20make%20training%20tolerant%20of%20replica%20failures%20without%20stopping%20the%20entire%20job.%0A%0A%20%20%20%20**TorchFT**%20(from%20PyTorch)%20provides%20a%20way%20to%20withstand%20GPU%20failures%20and%20allow%20training%20to%20continue.%0A%0A%20%20%20%20**Strategy%3A%20Hybrid%20Sharded%20Data%20Parallelism**%0A%20%20%20%20Combines%20fault-tolerant%20DDP%20with%20FSDP%20v2%20and%20Pipeline%20Parallelism.%0A%0A%20%20%20%20On%20failure%3A%0A%0A%20%20%20%20-%20Use%20torchcomms%20to%20catch%20collective-related%20errors%20and%20bubble%20them%20up%20through%20Monarch%0A%20%20%20%20-%20Continue%20training%20on%20the%20next%20batch%20without%20downtime%0A%20%20%20%20-%20Isolate%20failures%20to%20a%20single%20%22replica%20group%22%0A%20%20%20%20-%20Continue%20training%20with%20a%20subset%20of%20the%20original%20job%20(quorum%20shrinks)%0A%0A%20%20%20%20%60%60%60%0A%20%20%20%20Traditional%20Training%3A%0A%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%20%20%20%20%E2%94%82Replica%200%E2%94%82%20%E2%94%82Replica%201%E2%94%82%20%E2%94%82Replica%202%E2%94%82%20%E2%94%82Replica%203%E2%94%82%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%B4%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%B4%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%96%BC%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20All-reduce%20every%20step%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Single%20failure%20%E2%86%92%20restart%20everything%0A%0A%20%20%20%20TorchFT%20Quorum-Based%20Training%3A%0A%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%20%20%20%20%E2%94%82Replica%200%E2%94%82%20%E2%94%82Replica%201%E2%94%82%20%E2%94%82Replica%202%E2%94%82%20%E2%94%82Replica%203%E2%94%82%0A%20%20%20%20%E2%94%82%20healthy%20%E2%94%82%20%E2%94%82%20%20FAILED%20%E2%94%82%20%E2%94%82%20healthy%20%E2%94%82%20%E2%94%82%20healthy%20%E2%94%82%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%B4%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%96%BC%0A%20%20%20%20%20%20%20%20%20%20%20%20Quorum%20shrinks%20to%203%20replicas%0A%20%20%20%20%20%20%20%20%20%20%20%20Training%20continues%20without%20stopping%0A%20%20%20%20%20%20%20%20%20%20%20%20Failed%20replica%20recovers%20and%20rejoins%0A%20%20%20%20%60%60%60%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20How%20Monarch%20Integrates%20with%20TorchFT%0A%0A%20%20%20%20Monarch%20and%20TorchFT%20have%20a%20clear%20separation%20of%20concerns%3A%0A%0A%20%20%20%20**TorchFT%3A%20Step-Level%20Fault%20Tolerance**%0A%0A%20%20%20%20-%20Lighthouse%20(Rust%20gRPC%20service)%20coordinates%20quorum%20membership%20via%20heartbeats%20(~100ms)%0A%20%20%20%20-%20Manager%20handles%20checkpoint%20recovery%20when%20replicas%20join%2Fleave%0A%20%20%20%20-%20Training%20continues%20with%20reduced%20world%20size%20-%20no%20global%20stop%0A%0A%20%20%20%20**Monarch%3A%20Orchestration-Level%20Recovery**%0A%0A%20%20%20%20-%20Job%20allocation%20(SLURM)%20and%20process%20mesh%20spawning%0A%20%20%20%20-%20When%20a%20replica%20completely%20crashes%2C%20Monarch%20respins%20it%20with%20configurable%20retry%20logic%0A%20%20%20%20-%20First%20attempts%20fast%20process-level%20restarts%2C%20then%20escalates%20to%20new%20allocation%20if%20needed%0A%0A%20%20%20%20**How%20they%20connect%3A**%0A%0A%20%20%20%201.%20Monarch%20spawns%20trainer%20processes%20and%20sets%20%60TORCHFT_LIGHTHOUSE%60%20env%20var%0A%20%20%20%202.%20TorchFT%20trainers%20connect%20to%20Lighthouse%20using%20that%20address%0A%20%20%20%203.%20If%20individual%20trainer%20crashes%20%E2%86%92%20Monarch's%20orchestration%20respins%20the%20replica%0A%20%20%20%204.%20If%20GPU%20fails%20during%20a%20training%20step%20%E2%86%92%20TorchFT%20handles%20it%20via%20quorum%20shrink%0A%0A%20%20%20%20%60%60%60%0A%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20Monarch%20Orchestration%20Layer%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20Job%20Allocation%20%20%20%20%20%20%20%20%20%20Replica%20Lifecycle%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%20%20%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%E2%94%82%20SLURM%20%2F%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%E2%94%82%20Crash%20detected%3F%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%E2%94%82%20Allocation%20%20%20%E2%94%82%20%20%20%20%20%20%20%E2%94%82%20%E2%86%92%20Respin%20replica%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%20%20%20%20%20%20%E2%94%82%20%E2%86%92%20Retry%20logic%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%BC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%96%BC%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%96%BC%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%96%BC%0A%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20Replica%20%20%E2%94%82%20%20%20%20%E2%94%82%20Replica%20%20%E2%94%82%20%20%20%20%E2%94%82%20Replica%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20Group%200%20%20%E2%94%82%20%20%20%20%E2%94%82%20Group%201%20%20%E2%94%82%20%20%20%20%E2%94%82%20Group%202%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%BC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%96%BC%0A%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20TorchFT%20Fault%20Tolerance%20Layer%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20Lighthouse%20(gRPC)%20%20%20%20%20%20%20Per-Step%20Recovery%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%20%20%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%E2%94%82%20Heartbeats%20%20%20%E2%94%82%20%20%20%20%20%20%20%E2%94%82%20Quorum%20shrink%2Fgrow%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%E2%94%82%20(~100ms)%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%E2%94%82%20Checkpoint%20transfer%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%E2%94%82%20Quorum%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%E2%94%82%20No%20global%20stop%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%60%60%60%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Case%20Study%3A%20Qwen3-32B%20Training%20with%20Fault%20Injection%0A%0A%20%20%20%20We%20ran%20this%20code%20on%20a%20**30%20node%20(240%20H100s)%20Coreweave%20cluster**%2C%20using%20the%20SLURM%20scheduler%20to%20train%20Qwen3-32B%20using%20torchtitan%20and%20TorchFT.%0A%0A%20%20%20%20**Test%20conditions%3A**%0A%0A%20%20%20%20-%20100%20injected%20failures%20every%203%20minutes%0A%20%20%20%20-%20Multiple%20failure%20modes%3A%20segfaults%2C%20process%20kills%2C%20NCCL%20abort%2C%20host%20eviction%2C%20GIL%20deadlock%0A%0A%20%20%20%20**Results%3A**%0A%0A%20%20%20%20%7C%20Metric%20%7C%20Result%20%7C%0A%20%20%20%20%7C--------%7C--------%7C%0A%20%20%20%20%7C%20Recovery%20speed%20vs%20full%20SLURM%20restart%20%7C%20**60%25%20faster**%20%7C%0A%20%20%20%20%7C%20Avg%20recovery%20time%20(process%20failures)%20%7C%20**90%20seconds**%20%7C%0A%20%20%20%20%7C%20Avg%20recovery%20time%20(machine%20failures)%20%7C%20**2.5%20minutes**%20%7C%0A%0A%20%20%20%20**Why%20the%20improvement%3F**%0A%20%20%20%20Monarch%20allows%20for%20configurable%20recovery%20strategies%20based%20on%20failure%20type%20%E2%80%94%20we%20avoid%20unnecessary%20job%20rescheduling%20by%20attempting%20fast%20process-level%20restarts%20first.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Summary%0A%0A%20%20%20%20**Key%20takeaways%3A**%0A%0A%20%20%20%201.%20**Try%2Fexcept%20first**%3A%20The%20canonical%20pattern%20covers%2090%25%20of%20cases%0A%20%20%20%202.%20**Supervision%20trees**%3A%20Centralized%20error%20surfacing%20-%20one%20place%20to%20see%20what%20went%20wrong%0A%20%20%20%203.%20**Quorum-based%20training**%3A%20Continue%20with%20healthy%20replicas%20while%20failed%20ones%20recover%0A%20%20%20%204.%20**Monarch%20%2B%20TorchFT**%3A%20Orchestration-level%20recovery%20%2B%20step-level%20fault%20tolerance%0A%0A%20%20%20%20**When%20to%20use%20what%3A**%0A%0A%20%20%20%20%7C%20Situation%20%7C%20Pattern%20%7C%0A%20%20%20%20%7C-----------%7C---------%7C%0A%20%20%20%20%7C%20Simple%20actor%20calls%20%7C%20Try%2Fexcept%20%7C%0A%20%20%20%20%7C%20Building%20infrastructure%20%7C%20Supervision%20trees%20%7C%0A%20%20%20%20%7C%20Massive%20scale%20training%20%7C%20TorchFT%20%2B%20Monarch%20%7C%0A%0A%20%20%20%20**Next%3A**%20Async%20RL%20-%20putting%20it%20all%20together%20with%20services%2C%20RDMA%2C%20and%20async%20loops%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A
</marimo-code>

<marimo-code-hash hidden="">613b5c6af6b0af6b5c7f671ad71fec9b</marimo-code-hash>
</body>
</html>
