<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/apple-touch-icon.png" />
    <link rel="manifest" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        const scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          // Guard against race condition where iframe isn't ready
          if (!obj.contentWindow?.document?.documentElement) {
            return;
          }
          const element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          const hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          const newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((_entries) => {
          setHeight();
        });
        // Only observe if iframe content is ready
        if (obj.contentWindow?.document?.body) {
          resizeObserver.observe(obj.contentWindow.document.body);
        }
      }
    </script>
    <marimo-filename hidden>03_fault_tolerance.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>03 fault tolerance</title>
    <script type="module" crossorigin crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/index-DGasP9Lh.js"></script>
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/preload-helper-DItdS47A.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/clsx-D8GwTfvk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/cn-BKtXLv3a.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chunk-LvLJmgfZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/react-BGmjiNul.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/compiler-runtime-DeeZ7FnK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/jsx-runtime-ZmTK25f3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/badge-Ce8wRjuQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/hotkeys-BHHWjLlp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useEventListener-DIUKKfEy.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/button-YC1gW_kJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/react-dom-C9fstfnp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/Combination-CMPwuAmi.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/menu-items-CJhvWPOk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-uzvC4uAK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/createLucideIcon-CnW3RofX.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/check-DdfN0k2d.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/select-V5IdpNiR.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/tooltip-CEc2ajau.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/use-toast-rmUWldD_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_Uint8Array-BGESiCQL.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_baseIsEqual-B9N9Mw_N.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useEvent-DO6uJBas.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/invariant-CAG_dYON.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_baseFor-Duhs3RiJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/merge-BBX6ug-N.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/zod-Cg4WLWh2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/utils-DXvhzCGS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/constants-B6Cb__3x.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/Deferred-CrO5-0RA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/config-CIrPQIbt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/uuid-DercMavo.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/DeferredRequestRegistry-CO2AyNfd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/requests-BsVD4CdD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/isSymbol-BGkTcW3U.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/toString-DlRqgfqz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_hasUnicode-CWqKLxBC.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/assertNever-CBU83Y6o.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_arrayReduce-TT0iOGKY.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useLifecycle-D35CBukS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useNonce-_Aax6sXd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useTheme-DUdVAZI8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/once-Bul8mtFs.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/capabilities-MM7JYRxj.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/createReducer-Dnna-AUO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-DBwNzi3C.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-ChS0Dc_R.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-CtsanegT.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-BIKFl48f.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-B0VqT_4z.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-TiFCI16_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-Cayq-K1c.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-BYyu59D8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-Gqv0jSNr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/stex-CtmkcLz7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/toDate-CgbKQM5E.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/cjs-CH5Rj0g8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_baseProperty-NKyJO2oh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/now-6sUe0ZdD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/debounce-B3mjKxHe.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/toInteger-CDcO32Gx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/database-zap-B9y7063w.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/main-U5Goe76G.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/cells-BpZ7g6ok.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/spinner-DaIKav-i.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chevron-right-DwagBitu.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dropdown-menu-B-6unW-7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/kbd-C3JY7O_u.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/renderShortcut-DEwfrKeS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/multi-map-C8GlnP-4.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/alert-BrGyZf9c.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/alert-dialog-DwQffb13.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dialog-CxGKN4C_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dist-CdxIjAOP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/label-Be1daUcS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useDebounce-D5NcotGm.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/textarea-DBO30D7K.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/numbers-iQunIAXf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/SSRProvider-CEHRCdjA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/context-JwD-oSsl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useNumberFormatter-c6GXymzg.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/usePress-Bup4EGrp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/input-pAun1m1X.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/links-DHZUhGz-.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/popover-Gz-GJzym.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/switch-8sn_4qbh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/table-C8uQmBAN.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/mode-DX8pdI-l.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useAsyncData-C4XRy1BE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/errors-2SszdW9t.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/error-banner-DUzsIXtq.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/copy-Bv2DBpIS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/memoize-BCOZVFBt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/get-6uJrSKbw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/capitalize-CmNnkG9y.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/copy-CQ15EONK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/plus-BD5o34_i.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/refresh-cw-CQd-1kjx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/trash-2-CyqGun26.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/triangle-alert-B65rDESJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/ai-model-dropdown-71lgLrLy.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/defaultLocale-D_rSvXvJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/precisionRound-BMPhtTJQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/defaultLocale-C92Rrpmf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/vega-loader.browser-CRZ52CKf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/tooltip-BGrCWNss.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/ErrorBoundary-ChCiwl15.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useInstallPackage-Bdnnp5fe.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/ImperativeModal-CUbWEBci.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/cell-link-Bw5bzt4a.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/datasource-B0OJBphG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/state-BfXVTTtD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/MarimoErrorOutput-5rudBbo3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/copy-icon-BhONVREY.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/html-to-image-DjukyIj4.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/focus-D51fcwZX.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/LazyAnyLanguageCodeMirror-yzHjsVJt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chunk-5FQGJX7Z-CVUXBqX6.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/katex-Dc8yG8NU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/markdown-renderer-DhMlG2dP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/command-DhzFN2CJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/download-BhCZMKuQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useRunCells-24p6hn99.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/purify.es-DNVQZNFu.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/RenderHTML-CQZqVk1Z.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useIframeCapabilities-DuIDx9mD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/formats-W1SWxSE3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/en-US-pRRbZZHE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/isValid-DcYggVWP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/dates-Dhn1r-h6.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/maps-t9yNKYA8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/extends-B2LJnKU3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/emotion-is-prop-valid.esm-DD4AwVTU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useDateFormatter-CS4kbWl2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/range-D2UKkEg-.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/table-DZR6ewbN.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/JsonOutput-CknFTI_u.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/file-Cs1JbsV6.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/play-BPIh-ZEU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chat-components-CGlO4yUw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/isEmpty-CgX_-6Mt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chat-display-B4mGvJ0X.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useDeleteCell-5uYlTcQZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/icons-BhEXrzsb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/process-output-CagdHMzs.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/blob-CuXvdYPX.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/objectWithoutPropertiesLoose-DaPAPabU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/esm-DpMp6qko.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/add-cell-with-ai-pVFp5LZG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/chart-no-axes-column-W42b2ZIs.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/square-function-CqXXKtIq.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/spec-D1kBp3jX.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/column-preview-CxMrs0B_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/toggle-jWKnIArU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/globals-DKH14XH0.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/share-CbPtIlnM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_baseSet-5Rdwpmr3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/react-resizable-panels.browser.esm-Ctj_10o2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/utilities.esm-CIPARd6-.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/floating-outline-DcxjrFFt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useAddCell-BmeZUK02.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/eye-off-BhExYOph.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/readonly-python-code-DyP9LVLc.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/file-video-camera-DW3v07j2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/types-DuQOSW7G.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/refresh-ccw-DLEiQDS3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/form-DUA_Rz_a.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/field-BEg1eC0P.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useBoolean-B1Xeh6vA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/useDeepCompareMemoize-ZPd9PxYl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/types-CS34eOZi.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/prop-types-BiQYf0aU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/es-D8BOePqo.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/hasIn-CycJImp8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/_baseFlatten-CUZNxU8H.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/flatten-D-7VEN0q.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/pick-B_6Qi5aM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/code-xml-XLwHyDBr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/download-B9SUL40m.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/house-DhFkiXz7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/settings-DOXWMfVd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/square-C8Tw_XXG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/bundle.esm-2AjO7UK5.js">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/cells-jmgGt1lS.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/markdown-renderer-DdDKmWlR.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/JsonOutput-B7vuddcd.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.7/dist/assets/index-CikhHYAB.css">
  
<script data-marimo="true">
    window.__MARIMO_STATIC__ = {};
    window.__MARIMO_STATIC__.files = {};
</script>
</head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "03_fault_tolerance.py",
            "mode": "read",
            "version": "0.19.7",
            "serverToken": "static",
            "config": {"ai": {"custom_providers": {}, "models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false, "signature_hint_on_typing": false}, "diagnostics": {"sql_linter": true}, "display": {"cell_output": "below", "code_editor_font_size": 14, "dataframes": "rich", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "medium", "reference_highlighting": true, "theme": "light"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": false}}, "mcp": {"mcpServers": {}, "presets": []}, "package_management": {"manager": "uv"}, "runtime": {"auto_instantiate": false, "auto_reload": "off", "default_csv_encoding": "utf-8", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "after_delay", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"sql_output": "auto", "width": "medium"},
            "view": {"showAppCode": true},
            "notebook": {"cells": [{"code": "import marimo as mo", "code_hash": "1d0db38904205bec4d6f6f6a1f6cec3e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hbol", "name": "_"}, {"code": "# Shared imports for the notebook\nimport random\nfrom monarch.actor import Actor, endpoint, current_rank, MeshFailure, this_host", "code_hash": "d3cbb393111da57393434cdee2844ee9", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "MJUe", "name": "_"}, {"code": "mo.md(r\"\"\"\n# Fault Tolerance in Monarch\n\nIn the last notebook, you caught a single error with try/except on a\nFlakyWorker. That works when you know which actor failed and have a backup\nready. But when failures hit every 3 hours across 16,000 GPUs, you need\npatterns that scale.\n\nThis notebook covers three layers of fault handling \u2014 from simple to\nindustrial:\n\n1. **Try/except with retry** \u2014 the 90% solution you'll reach for first\n2. **Supervision trees** \u2014 centralized error surfacing for infrastructure builders\n3. **TorchFT** \u2014 quorum-based training that continues through failures\n\"\"\")", "code_hash": "d4bac3277382806571f3e9b2333e25d9", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "vblA", "name": "_"}, {"code": "mo.md(r\"\"\"\n## The Simple Pattern: Try/Except\n\nThis is what you should reach for first. It's familiar, explicit, and works great.\n\"\"\")", "code_hash": "8a35c052ef71b8ab433287e8d61b6f4c", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "bkHC", "name": "_"}, {"code": "class UnreliableWorker(Actor):\n    \"\"\"A worker that sometimes fails.\"\"\"\n\n    def __init__(self, failure_rate: float = 0.3):\n        self.rank = current_rank().rank\n        self.failure_rate = failure_rate\n        self.call_count = 0\n\n    @endpoint\n    def process(self, data: int) -\u003E dict:\n        self.call_count += 1\n        if random.random() \u003C self.failure_rate:\n            raise RuntimeError(f\"Random failure on rank {self.rank}, call {self.call_count}\")\n        return {\"rank\": self.rank, \"result\": data * 2, \"calls\": self.call_count}\n\n# Spawn workers\nprocs = this_host().spawn_procs(per_host={\"gpus\": 3})\nworkers = procs.spawn(\"unreliable\", UnreliableWorker, 0.3)\n\n# The canonical pattern: try/except with fallback\ndef process_with_retry(workers_mesh, data, max_retries=3):\n    \"\"\"Try each worker until one succeeds.\"\"\"\n    errors = []\n    for attempt in range(max_retries):\n        worker = workers_mesh.slice(gpus=attempt % 3)  # Round-robin through workers\n        try:\n            result = worker.process.call_one(data).get()\n            print(f\"  Attempt {attempt + 1}: Success! {result}\")\n            return result\n        except Exception as e:\n            errors.append(str(e))\n            print(f\"  Attempt {attempt + 1}: Failed - {type(e).__name__}\")\n    raise RuntimeError(f\"All {max_retries} attempts failed\")\n\nprint(\"=== Processing with retry ===\")\nfor i in range(5):\n    print(f\"\\nTask {i}:\")\n    try:\n        _result = process_with_retry(workers, i * 10)\n    except RuntimeError as e:\n        print(f\"  All retries exhausted: {e}\")", "code_hash": "4af01b315cae1a7cc7409fe4dac43a21", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "lEQa", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Why This Simple Pattern Works\n\nActors are designed to be **stateless from the caller's perspective**:\n\n- If one fails, try another\n- The caller doesn't need to know implementation details\n- Each actor can maintain its own state internally\n\nThis is the **90% solution**. Use it unless you have a specific reason not to.\n\n```python\n# The pattern in one line\nresult = try_call(actor1) or try_call(actor2) or try_call(actor3)\n```\n\"\"\")", "code_hash": "9ab67c54df3acfe03d6a703ae60684a7", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "PKri", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Supervision Trees: Centralized Error Surfacing\n\nTry/except works when the **caller** catches failures. But what about failures\nyou don't directly trigger \u2014 a child actor crashing in the background, a\ncascading failure deep in a hierarchy?\n\nMonarch's answer is **supervision**. When an actor spawns children, it becomes\ntheir supervisor. If a child fails, the supervisor's `__supervise__` method is\ncalled with a `MeshFailure` describing what went wrong.\n\nThink of it like a management chain: when an employee hits a problem they can't\nsolve, it escalates to their manager. The manager can handle it (return `True`)\nor escalate further (return `False`).\n\"\"\")", "code_hash": "a8ee219fc1490cbe6513129ba2220fe0", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Xref", "name": "_"}, {"code": "import asyncio\nimport monarch.actor\n\nclass ActorCrash(BaseException):\n    \"\"\"Inherits from BaseException (not Exception) to trigger actor death.\n    Regular Exceptions are application errors \u2014 returned to the caller,\n    actor stays alive. BaseException causes the actor to crash, which\n    triggers the supervision tree.\"\"\"\n    pass\n\nclass FragileWorker(Actor):\n    \"\"\"A worker that crashes when asked.\"\"\"\n\n    @endpoint\n    async def do_work(self) -\u003E str:\n        raise ActorCrash(\"GPU memory error on this worker!\")\n\nclass Supervisor(Actor):\n    \"\"\"Spawns and supervises children. Catches their failures automatically.\"\"\"\n\n    def __init__(self, child_procs):\n        # Supervisor owns these children because it calls spawn()\n        self.workers = child_procs.spawn(\"fragile\", FragileWorker)\n        self.failure_log = []\n        self._supervised = asyncio.Event()\n\n    def __supervise__(self, failure: MeshFailure) -\u003E bool:\n        \"\"\"Called automatically when an owned child actor fails.\"\"\"\n        self.failure_log.append(str(failure))\n        print(f\"[Supervisor] Caught failure: {failure}\")\n        self._supervised.set()\n        return True  # Handled \u2014 don't propagate further\n\n    @endpoint\n    async def crash_a_child(self):\n        \"\"\"Tell the child to crash, then wait for supervision to fire.\"\"\"\n        self.workers.do_work.broadcast()  # fire-and-forget \u2014 triggers supervision\n        await asyncio.wait_for(self._supervised.wait(), timeout=30)\n\n    @endpoint\n    async def get_failure_log(self) -\u003E list:\n        \"\"\"Return failures caught by __supervise__ (as strings).\"\"\"\n        return list(self.failure_log)\n\n# Override the default fault hook (which calls sys.exit) so unhandled\n# supervision events don't kill our notebook\noriginal_hook = monarch.actor.unhandled_fault_hook\nmonarch.actor.unhandled_fault_hook = lambda f: print(f\"[Client] Unhandled fault: {f}\")\n\n# Create two separate proc meshes (supervisor and children MUST be on different meshes)\nsupervisor_procs = this_host().spawn_procs(per_host={\"gpus\": 1})\nchild_procs = this_host().spawn_procs(per_host={\"gpus\": 1})\n\n# Spawn supervisor, passing child procs for it to own\nsupervisor = supervisor_procs.spawn(\"supervisor\", Supervisor, child_procs)\n\n# Tell supervisor to trigger the child \u2014 broadcast() means the error has\n# no caller to return to, so the actor crashes and supervision fires\nsupervisor.crash_a_child.call_one().get()\n\n# Query the supervisor's failure log\nfailures = supervisor.get_failure_log.call_one().get()\nprint(f\"\\n=== Supervisor's failure log ({len(failures)} entries) ===\")\nfor j, f in enumerate(failures):\n    print(f\"  [{j}] {f}\")\n\nif failures:\n    print(\"\\n__supervise__ caught the child's failure automatically!\")\n\n# Restore original fault hook\nmonarch.actor.unhandled_fault_hook = original_hook", "code_hash": "9ecc49c4e539eee9e452516de32efe47", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "SFPL", "name": "_"}, {"code": "mo.md(r\"\"\"\n### What Just Happened\n\nThe supervisor **owns** the `FragileWorker` because it called `spawn()`. When\nthe child raised `ActorCrash` (a `BaseException`), the actor died and Monarch\ndelivered a `MeshFailure` to the supervisor's `__supervise__` method.\n\n**Why `BaseException`?** In Monarch, regular `Exception` subclasses are\napplication errors \u2014 they're returned to the caller and the actor stays alive.\n`BaseException` subclasses signal a fatal crash: the actor dies, and the\nsupervision tree is notified.\n\nKey points:\n\n- `__supervise__` receives a `MeshFailure` with `.report()` for readable output\n- Return `True` -\u003E \"I handled it\" (stops propagation up the tree)\n- Return `False` -\u003E escalate to the supervisor's supervisor\n- If no one handles it, the failure reaches the client as an unhandled fault\n\nThis gives you **one structured place** to see what went wrong \u2014 instead of\ngrepping through logs scattered across nodes.\n\"\"\")", "code_hash": "cc774b2493a36ba576a5be985a94af5c", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "BYtC", "name": "_"}, {"code": "mo.md(r\"\"\"\n### From One Supervisor to a Tree\n\nYou just saw a single supervisor catch one child's failure. Now imagine this\nat scale \u2014 supervision forms a **tree** where failures propagate upward:\n\n```\nYour Script (root)\n\u2514\u2500\u2500 Orchestrator\n    \u251c\u2500\u2500 TrainerSupervisor\n    \u2502   \u251c\u2500\u2500 Trainer Rank 0  \u2713\n    \u2502   \u251c\u2500\u2500 Trainer Rank 1  \u2713\n    \u2502   \u2514\u2500\u2500 Trainer Rank 2  \u2717 OOM\n    \u2514\u2500\u2500 GeneratorSupervisor\n        \u251c\u2500\u2500 Generator 0     \u2713\n        \u2514\u2500\u2500 Generator 1     \u2713\n```\n\nWhen Trainer Rank 2 crashes, `TrainerSupervisor.__supervise__` fires first.\nIf it returns `True`, the failure is handled locally \u2014 the Orchestrator never\neven knows. If it returns `False`, the TrainerSupervisor itself fails, and the\nevent propagates up to the Orchestrator.\n\nThis is just like exception handling in a call stack:\n\n```python\ntry:                          # Orchestrator.__supervise__\n    try:                      # TrainerSupervisor.__supervise__\n        raise OOMError()      # Trainer Rank 2 crashes\n    except OOMError:          #   -\u003E handle or re-raise\n        handle_or_reraise()\nexcept Exception:             #   -\u003E Orchestrator handles or crashes\n    handle_or_crash()\n```\n\nThe payoff: instead of grepping through 16,000 log files, you get **one\nstructured chain** showing exactly what failed and how the failure propagated.\n\"\"\")", "code_hash": "1e57428d7cd6d14330fbd29f89dd53fc", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "RGSE", "name": "_"}, {"code": "mo.md(r\"\"\"\n## TorchFT: Fault-Tolerant Training at Scale\n\nRecall the 419 interruptions from Notebook 1 \u2014 at that scale, restarting\nthe entire job each time is unacceptable. You need training to **continue\nwith healthy replicas** while failed ones recover.\n\nThe result: **60% faster recovery** than full SLURM restarts, with process\nfailures recovering in **~90 seconds**. Here's how.\n\"\"\")", "code_hash": "ed6f74e5d259396010fca8320ef89edb", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Kclp", "name": "_"}, {"code": "mo.md(r\"\"\"\n### How TorchFT Works\n\nTorchFT provides quorum-based training \u2014 instead of stopping the whole job\nwhen a replica fails, the remaining replicas continue:\n\n```\nTraditional Training:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502Replica 0\u2502 \u2502Replica 1\u2502 \u2502Replica 2\u2502 \u2502Replica 3\u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n     \u2502           \u2502           \u2502           \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                       \u25bc\n              All-reduce every step\n              Single failure \u2192 restart everything\n\nTorchFT Quorum-Based Training:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502Replica 0\u2502 \u2502Replica 1\u2502 \u2502Replica 2\u2502 \u2502Replica 3\u2502\n\u2502 healthy \u2502 \u2502  FAILED \u2502 \u2502 healthy \u2502 \u2502 healthy \u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n     \u2502                       \u2502           \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u25bc\n        Quorum shrinks to 3 replicas\n        Training continues without stopping\n        Failed replica recovers and rejoins\n```\n\nOn failure, TorchFT catches collective errors through its own\nManagedProcessGroup, isolates the failure to a single replica group, and\ncontinues training without restarting the entire job.\n\nA Lighthouse service (Rust gRPC) coordinates quorum membership via\nheartbeats (~100ms), while a Manager handles checkpoint recovery when\nreplicas join or leave.\n\"\"\")", "code_hash": "cf47db93ccf2b0664681061adc821bd4", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "emfo", "name": "_"}, {"code": "mo.md(r\"\"\"\n### Monarch + TorchFT: Separation of Concerns\n\nTorchFT handles **step-level fault tolerance** \u2014 catching errors mid-training\nand shrinking the quorum. Monarch handles **orchestration-level recovery** \u2014\nrespawning crashed replicas, managing job allocation, and escalating from\nfast process restarts to full reallocation when needed.\n\"\"\")", "code_hash": "2b5ff7a494de6f1a17f6e70cc4e7e263", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hstk", "name": "_"}, {"code": "mo.md(r\"\"\"\n### Case Study: Qwen3-32B Training with Fault Injection\n\nWe ran this on a **30 node (240 H100s) Coreweave cluster**, training\nQwen3-32B using torchtitan and TorchFT.\n\n**Test conditions:**\n\n- Failures injected at ~3-minute intervals, 100 total events\n- Multiple failure modes: segfaults, process kills, NCCL abort, host\n  eviction, GIL deadlock\n\n**Results:**\n\n| Metric | Result |\n|--------|--------|\n| Recovery speed vs full SLURM restart | **60% faster** |\n| Avg recovery time (process failures) | **90 seconds** |\n| Avg recovery time (machine failures) | **2.5 minutes** |\n\n**Why the improvement?**\nMonarch allows for configurable recovery strategies based on failure type \u2014\nwe avoid unnecessary job rescheduling by attempting fast process-level\nrestarts first.\n\"\"\")", "code_hash": "1b9e34010e34ac92259f7a0a0640e7a7", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "nWHF", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Summary\n\n**Key takeaways:**\n\n1. **Try/except first**: The canonical pattern covers 90% of cases\n2. **Supervision trees**: Centralized error surfacing \u2014 one place to see\n   what went wrong\n3. **Quorum-based training**: Continue with healthy replicas while failed\n   ones recover\n4. **Monarch + TorchFT**: Orchestration-level recovery + step-level fault\n   tolerance\n\nThese three patterns compose \u2014 try/except is your first line of defense,\nsupervision gives you visibility, and TorchFT handles training-specific\nrecovery at scale.\n\nWe've built patterns to handle failures. Next: putting it all together \u2014\nservices, weight sync, and async RL loops.\n\"\"\")", "code_hash": "6fdc2480a50f617a6dbd696fdf70db4d", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "iLit", "name": "_"}], "metadata": {"marimo_version": "0.19.7"}, "version": "1"},
            "session": {"cells": [{"code_hash": "1d0db38904205bec4d6f6f6a1f6cec3e", "console": [], "id": "Hbol", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "d3cbb393111da57393434cdee2844ee9", "console": [], "id": "MJUe", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "d4bac3277382806571f3e9b2333e25d9", "console": [], "id": "vblA", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch1 id=\"fault-tolerance-in-monarch\"\u003EFault Tolerance in Monarch\u003C/h1\u003E\n\u003Cspan class=\"paragraph\"\u003EIn the last notebook, you caught a single error with try/except on a\nFlakyWorker. That works when you know which actor failed and have a backup\nready. But when failures hit every 3 hours across 16,000 GPUs, you need\npatterns that scale.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThis notebook covers three layers of fault handling \u2014 from simple to\nindustrial:\u003C/span\u003E\n\u003Col\u003E\n\u003Cli\u003E\u003Cstrong\u003ETry/except with retry\u003C/strong\u003E \u2014 the 90% solution you'll reach for first\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ESupervision trees\u003C/strong\u003E \u2014 centralized error surfacing for infrastructure builders\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ETorchFT\u003C/strong\u003E \u2014 quorum-based training that continues through failures\u003C/li\u003E\n\u003C/ol\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "8a35c052ef71b8ab433287e8d61b6f4c", "console": [], "id": "bkHC", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"the-simple-pattern-tryexcept\"\u003EThe Simple Pattern: Try/Except\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EThis is what you should reach for first. It's familiar, explicit, and works great.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "4af01b315cae1a7cc7409fe4dac43a21", "console": [{"mimetype": "text/plain", "name": "stderr", "text": "Monarch internal logs are being written to /tmp/allencwang/monarch_log.log; execution id allencwang_Feb-06_09:59_913\n", "type": "stream"}, {"mimetype": "text/plain", "name": "stdout", "text": "=== Processing with retry ===\n\nTask 0:\n  Attempt 1: Success! {'rank': 0, 'result': 0, 'calls': 1}\n\nTask 1:\n  Attempt 1: Success! {'rank': 0, 'result': 20, 'calls': 2}\n\nTask 2:\n  Attempt 1: Success! {'rank': 0, 'result': 40, 'calls': 3}\n\nTask 3:\n  Attempt 1: Success! {'rank': 0, 'result': 60, 'calls': 4}\n\nTask 4:\n  Attempt 1: Success! {'rank': 0, 'result': 80, 'calls': 5}\n", "type": "stream"}], "id": "lEQa", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "9ab67c54df3acfe03d6a703ae60684a7", "console": [], "id": "PKri", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"why-this-simple-pattern-works\"\u003EWhy This Simple Pattern Works\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EActors are designed to be \u003Cstrong\u003Estateless from the caller's perspective\u003C/strong\u003E:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003EIf one fails, try another\u003C/li\u003E\n\u003Cli\u003EThe caller doesn't need to know implementation details\u003C/li\u003E\n\u003Cli\u003EEach actor can maintain its own state internally\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003EThis is the \u003Cstrong\u003E90% solution\u003C/strong\u003E. Use it unless you have a specific reason not to.\u003C/span\u003E\n\u003Cdiv class=\"language-python codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"c1\"\u003E# The pattern in one line\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Eresult\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Etry_call\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Eactor1\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"ow\"\u003Eor\u003C/span\u003E \u003Cspan class=\"n\"\u003Etry_call\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Eactor2\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"ow\"\u003Eor\u003C/span\u003E \u003Cspan class=\"n\"\u003Etry_call\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Eactor3\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "a8ee219fc1490cbe6513129ba2220fe0", "console": [], "id": "Xref", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"supervision-trees-centralized-error-surfacing\"\u003ESupervision Trees: Centralized Error Surfacing\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003ETry/except works when the \u003Cstrong\u003Ecaller\u003C/strong\u003E catches failures. But what about failures\nyou don't directly trigger \u2014 a child actor crashing in the background, a\ncascading failure deep in a hierarchy?\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EMonarch's answer is \u003Cstrong\u003Esupervision\u003C/strong\u003E. When an actor spawns children, it becomes\ntheir supervisor. If a child fails, the supervisor's \u003Ccode\u003E__supervise__\u003C/code\u003E method is\ncalled with a \u003Ccode\u003EMeshFailure\u003C/code\u003E describing what went wrong.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThink of it like a management chain: when an employee hits a problem they can't\nsolve, it escalates to their manager. The manager can handle it (return \u003Ccode\u003ETrue\u003C/code\u003E)\nor escalate further (return \u003Ccode\u003EFalse\u003C/code\u003E).\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "9ecc49c4e539eee9e452516de32efe47", "console": [{"mimetype": "text/plain", "name": "stdout", "text": "[Supervisor] Caught failure: MeshFailure(mesh_name=fragile-1avPskhyVT66, rank=0, event=The actor \u003Croot\u003E.\u003C__main__.Supervisor supervisor{'gpus': 0/1}\u003E.\u003C__main__.FragileWorker fragile{'gpus': 0/1}\u003E and all its descendants have failed.\nThis occurred because the actor itself failed.\nThe error was:\n actor explicitly aborted due to: monarch._src.actor.actor_mesh.ActorError: Actor call fragile.do_work failed with BaseException.\n  Traceback of where the remote call failed (most recent call last):\n   File \"/home/allencwang/forge-dev/smol_projects/monarch-gpu-mode/.venv/lib/python3.12/site-packages/monarch/_src/actor/actor_mesh.py\", line 1370, in handle\n     result = await the_method(*args, **kwargs)\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n   File \"/tmp/marimo_3664241/__marimo__cell_SFPL_.py\", line 16, in do_work\n     raise ActorCrash(\"GPU memory error on this worker!\")\n ActorCrash: GPU memory error on this worker!\n\n)\n\n=== Supervisor's failure log (1 entries) ===\n  [0] MeshFailure(mesh_name=fragile-1avPskhyVT66, rank=0, event=The actor \u003Croot\u003E.\u003C__main__.Supervisor supervisor{'gpus': 0/1}\u003E.\u003C__main__.FragileWorker fragile{'gpus': 0/1}\u003E and all its descendants have failed.\nThis occurred because the actor itself failed.\nThe error was:\n actor explicitly aborted due to: monarch._src.actor.actor_mesh.ActorError: Actor call fragile.do_work failed with BaseException.\n  Traceback of where the remote call failed (most recent call last):\n   File \"/home/allencwang/forge-dev/smol_projects/monarch-gpu-mode/.venv/lib/python3.12/site-packages/monarch/_src/actor/actor_mesh.py\", line 1370, in handle\n     result = await the_method(*args, **kwargs)\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n   File \"/tmp/marimo_3664241/__marimo__cell_SFPL_.py\", line 16, in do_work\n     raise ActorCrash(\"GPU memory error on this worker!\")\n ActorCrash: GPU memory error on this worker!\n\n)\n\n__supervise__ caught the child's failure automatically!\n", "type": "stream"}], "id": "SFPL", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "cc774b2493a36ba576a5be985a94af5c", "console": [], "id": "BYtC", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"what-just-happened\"\u003EWhat Just Happened\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003EThe supervisor \u003Cstrong\u003Eowns\u003C/strong\u003E the \u003Ccode\u003EFragileWorker\u003C/code\u003E because it called \u003Ccode\u003Espawn()\u003C/code\u003E. When\nthe child raised \u003Ccode\u003EActorCrash\u003C/code\u003E (a \u003Ccode\u003EBaseException\u003C/code\u003E), the actor died and Monarch\ndelivered a \u003Ccode\u003EMeshFailure\u003C/code\u003E to the supervisor's \u003Ccode\u003E__supervise__\u003C/code\u003E method.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EWhy \u003Ccode\u003EBaseException\u003C/code\u003E?\u003C/strong\u003E In Monarch, regular \u003Ccode\u003EException\u003C/code\u003E subclasses are\napplication errors \u2014 they're returned to the caller and the actor stays alive.\n\u003Ccode\u003EBaseException\u003C/code\u003E subclasses signal a fatal crash: the actor dies, and the\nsupervision tree is notified.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EKey points:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Ccode\u003E__supervise__\u003C/code\u003E receives a \u003Ccode\u003EMeshFailure\u003C/code\u003E with \u003Ccode\u003E.report()\u003C/code\u003E for readable output\u003C/li\u003E\n\u003Cli\u003EReturn \u003Ccode\u003ETrue\u003C/code\u003E -\u0026gt; \"I handled it\" (stops propagation up the tree)\u003C/li\u003E\n\u003Cli\u003EReturn \u003Ccode\u003EFalse\u003C/code\u003E -\u0026gt; escalate to the supervisor's supervisor\u003C/li\u003E\n\u003Cli\u003EIf no one handles it, the failure reaches the client as an unhandled fault\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003EThis gives you \u003Cstrong\u003Eone structured place\u003C/strong\u003E to see what went wrong \u2014 instead of\ngrepping through logs scattered across nodes.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "1e57428d7cd6d14330fbd29f89dd53fc", "console": [], "id": "RGSE", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"from-one-supervisor-to-a-tree\"\u003EFrom One Supervisor to a Tree\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003EYou just saw a single supervisor catch one child's failure. Now imagine this\nat scale \u2014 supervision forms a \u003Cstrong\u003Etree\u003C/strong\u003E where failures propagate upward:\u003C/span\u003E\n\u003Cdiv class=\"language-perl6 codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"n\"\u003EYour\u003C/span\u003E \u003Cspan class=\"n\"\u003EScript\u003C/span\u003E (\u003Cspan class=\"n\"\u003Eroot\u003C/span\u003E)\n\u2514\u2500\u2500 \u003Cspan class=\"n\"\u003EOrchestrator\u003C/span\u003E\n    \u251c\u2500\u2500 \u003Cspan class=\"n\"\u003ETrainerSupervisor\u003C/span\u003E\n    \u2502   \u251c\u2500\u2500 \u003Cspan class=\"n\"\u003ETrainer\u003C/span\u003E \u003Cspan class=\"n\"\u003ERank\u003C/span\u003E \u003Cspan class=\"mi\"\u003E0\u003C/span\u003E  \u2713\n    \u2502   \u251c\u2500\u2500 \u003Cspan class=\"n\"\u003ETrainer\u003C/span\u003E \u003Cspan class=\"n\"\u003ERank\u003C/span\u003E \u003Cspan class=\"mi\"\u003E1\u003C/span\u003E  \u2713\n    \u2502   \u2514\u2500\u2500 \u003Cspan class=\"n\"\u003ETrainer\u003C/span\u003E \u003Cspan class=\"n\"\u003ERank\u003C/span\u003E \u003Cspan class=\"mi\"\u003E2\u003C/span\u003E  \u2717 \u003Cspan class=\"n\"\u003EOOM\u003C/span\u003E\n    \u2514\u2500\u2500 \u003Cspan class=\"n\"\u003EGeneratorSupervisor\u003C/span\u003E\n        \u251c\u2500\u2500 \u003Cspan class=\"n\"\u003EGenerator\u003C/span\u003E \u003Cspan class=\"mi\"\u003E0\u003C/span\u003E     \u2713\n        \u2514\u2500\u2500 \u003Cspan class=\"n\"\u003EGenerator\u003C/span\u003E \u003Cspan class=\"mi\"\u003E1\u003C/span\u003E     \u2713\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EWhen Trainer Rank 2 crashes, \u003Ccode\u003ETrainerSupervisor.__supervise__\u003C/code\u003E fires first.\nIf it returns \u003Ccode\u003ETrue\u003C/code\u003E, the failure is handled locally \u2014 the Orchestrator never\neven knows. If it returns \u003Ccode\u003EFalse\u003C/code\u003E, the TrainerSupervisor itself fails, and the\nevent propagates up to the Orchestrator.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThis is just like exception handling in a call stack:\u003C/span\u003E\n\u003Cdiv class=\"language-python codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"k\"\u003Etry\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E                          \u003Cspan class=\"c1\"\u003E# Orchestrator.__supervise__\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Etry\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E                      \u003Cspan class=\"c1\"\u003E# TrainerSupervisor.__supervise__\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Eraise\u003C/span\u003E \u003Cspan class=\"n\"\u003EOOMError\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E      \u003Cspan class=\"c1\"\u003E# Trainer Rank 2 crashes\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Eexcept\u003C/span\u003E \u003Cspan class=\"n\"\u003EOOMError\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E          \u003Cspan class=\"c1\"\u003E#   -\u0026gt; handle or re-raise\u003C/span\u003E\n        \u003Cspan class=\"n\"\u003Ehandle_or_reraise\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n\u003Cspan class=\"k\"\u003Eexcept\u003C/span\u003E \u003Cspan class=\"ne\"\u003EException\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E             \u003Cspan class=\"c1\"\u003E#   -\u0026gt; Orchestrator handles or crashes\u003C/span\u003E\n    \u003Cspan class=\"n\"\u003Ehandle_or_crash\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EThe payoff: instead of grepping through 16,000 log files, you get \u003Cstrong\u003Eone\nstructured chain\u003C/strong\u003E showing exactly what failed and how the failure propagated.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "ed6f74e5d259396010fca8320ef89edb", "console": [], "id": "Kclp", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"torchft-fault-tolerant-training-at-scale\"\u003ETorchFT: Fault-Tolerant Training at Scale\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003ERecall the 419 interruptions from Notebook 1 \u2014 at that scale, restarting\nthe entire job each time is unacceptable. You need training to \u003Cstrong\u003Econtinue\nwith healthy replicas\u003C/strong\u003E while failed ones recover.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThe result: \u003Cstrong\u003E60% faster recovery\u003C/strong\u003E than full SLURM restarts, with process\nfailures recovering in \u003Cstrong\u003E~90 seconds\u003C/strong\u003E. Here's how.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "cf47db93ccf2b0664681061adc821bd4", "console": [], "id": "emfo", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"how-torchft-works\"\u003EHow TorchFT Works\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003ETorchFT provides quorum-based training \u2014 instead of stopping the whole job\nwhen a replica fails, the remaining replicas continue:\u003C/span\u003E\n\u003Cdiv class=\"language-text codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003ETraditional Training:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502Replica 0\u2502 \u2502Replica 1\u2502 \u2502Replica 2\u2502 \u2502Replica 3\u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n     \u2502           \u2502           \u2502           \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                       \u25bc\n              All-reduce every step\n              Single failure \u2192 restart everything\n\nTorchFT Quorum-Based Training:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502Replica 0\u2502 \u2502Replica 1\u2502 \u2502Replica 2\u2502 \u2502Replica 3\u2502\n\u2502 healthy \u2502 \u2502  FAILED \u2502 \u2502 healthy \u2502 \u2502 healthy \u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n     \u2502                       \u2502           \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u25bc\n        Quorum shrinks to 3 replicas\n        Training continues without stopping\n        Failed replica recovers and rejoins\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EOn failure, TorchFT catches collective errors through its own\nManagedProcessGroup, isolates the failure to a single replica group, and\ncontinues training without restarting the entire job.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EA Lighthouse service (Rust gRPC) coordinates quorum membership via\nheartbeats (~100ms), while a Manager handles checkpoint recovery when\nreplicas join or leave.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "2b5ff7a494de6f1a17f6e70cc4e7e263", "console": [], "id": "Hstk", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"monarch-torchft-separation-of-concerns\"\u003EMonarch + TorchFT: Separation of Concerns\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003ETorchFT handles \u003Cstrong\u003Estep-level fault tolerance\u003C/strong\u003E \u2014 catching errors mid-training\nand shrinking the quorum. Monarch handles \u003Cstrong\u003Eorchestration-level recovery\u003C/strong\u003E \u2014\nrespawning crashed replicas, managing job allocation, and escalating from\nfast process restarts to full reallocation when needed.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "1b9e34010e34ac92259f7a0a0640e7a7", "console": [], "id": "nWHF", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"case-study-qwen3-32b-training-with-fault-injection\"\u003ECase Study: Qwen3-32B Training with Fault Injection\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003EWe ran this on a \u003Cstrong\u003E30 node (240 H100s) Coreweave cluster\u003C/strong\u003E, training\nQwen3-32B using torchtitan and TorchFT.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003ETest conditions:\u003C/strong\u003E\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003EFailures injected at ~3-minute intervals, 100 total events\u003C/li\u003E\n\u003Cli\u003EMultiple failure modes: segfaults, process kills, NCCL abort, host\n  eviction, GIL deadlock\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EResults:\u003C/strong\u003E\u003C/span\u003E\n\u003Ctable\u003E\n\u003Cthead\u003E\n\u003Ctr\u003E\n\u003Cth\u003EMetric\u003C/th\u003E\n\u003Cth\u003EResult\u003C/th\u003E\n\u003C/tr\u003E\n\u003C/thead\u003E\n\u003Ctbody\u003E\n\u003Ctr\u003E\n\u003Ctd\u003ERecovery speed vs full SLURM restart\u003C/td\u003E\n\u003Ctd\u003E\u003Cstrong\u003E60% faster\u003C/strong\u003E\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003EAvg recovery time (process failures)\u003C/td\u003E\n\u003Ctd\u003E\u003Cstrong\u003E90 seconds\u003C/strong\u003E\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003EAvg recovery time (machine failures)\u003C/td\u003E\n\u003Ctd\u003E\u003Cstrong\u003E2.5 minutes\u003C/strong\u003E\u003C/td\u003E\n\u003C/tr\u003E\n\u003C/tbody\u003E\n\u003C/table\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EWhy the improvement?\u003C/strong\u003E\nMonarch allows for configurable recovery strategies based on failure type \u2014\nwe avoid unnecessary job rescheduling by attempting fast process-level\nrestarts first.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "6fdc2480a50f617a6dbd696fdf70db4d", "console": [], "id": "iLit", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"summary\"\u003ESummary\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EKey takeaways:\u003C/strong\u003E\u003C/span\u003E\n\u003Col\u003E\n\u003Cli\u003E\u003Cstrong\u003ETry/except first\u003C/strong\u003E: The canonical pattern covers 90% of cases\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ESupervision trees\u003C/strong\u003E: Centralized error surfacing \u2014 one place to see\n   what went wrong\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EQuorum-based training\u003C/strong\u003E: Continue with healthy replicas while failed\n   ones recover\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EMonarch + TorchFT\u003C/strong\u003E: Orchestration-level recovery + step-level fault\n   tolerance\u003C/li\u003E\n\u003C/ol\u003E\n\u003Cspan class=\"paragraph\"\u003EThese three patterns compose \u2014 try/except is your first line of defense,\nsupervision gives you visibility, and TorchFT handles training-specific\nrecovery at scale.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EWe've built patterns to handle failures. Next: putting it all together \u2014\nservices, weight sync, and async RL loops.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}], "metadata": {"marimo_version": "0.19.7"}, "version": "1"},
            "runtimeConfig": null,
        };
    </script>
  
<marimo-code hidden="">
    import%20marimo%0A%0A__generated_with%20%3D%20%220.19.7%22%0Aapp%20%3D%20marimo.App(width%3D%22medium%22)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20return%20(mo%2C)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20%23%20Shared%20imports%20for%20the%20notebook%0A%20%20%20%20import%20random%0A%20%20%20%20from%20monarch.actor%20import%20Actor%2C%20endpoint%2C%20current_rank%2C%20MeshFailure%2C%20this_host%0A%20%20%20%20return%20Actor%2C%20MeshFailure%2C%20current_rank%2C%20endpoint%2C%20random%2C%20this_host%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%20Fault%20Tolerance%20in%20Monarch%0A%0A%20%20%20%20In%20the%20last%20notebook%2C%20you%20caught%20a%20single%20error%20with%20try%2Fexcept%20on%20a%0A%20%20%20%20FlakyWorker.%20That%20works%20when%20you%20know%20which%20actor%20failed%20and%20have%20a%20backup%0A%20%20%20%20ready.%20But%20when%20failures%20hit%20every%203%20hours%20across%2016%2C000%20GPUs%2C%20you%20need%0A%20%20%20%20patterns%20that%20scale.%0A%0A%20%20%20%20This%20notebook%20covers%20three%20layers%20of%20fault%20handling%20%E2%80%94%20from%20simple%20to%0A%20%20%20%20industrial%3A%0A%0A%20%20%20%201.%20**Try%2Fexcept%20with%20retry**%20%E2%80%94%20the%2090%25%20solution%20you'll%20reach%20for%20first%0A%20%20%20%202.%20**Supervision%20trees**%20%E2%80%94%20centralized%20error%20surfacing%20for%20infrastructure%20builders%0A%20%20%20%203.%20**TorchFT**%20%E2%80%94%20quorum-based%20training%20that%20continues%20through%20failures%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20The%20Simple%20Pattern%3A%20Try%2FExcept%0A%0A%20%20%20%20This%20is%20what%20you%20should%20reach%20for%20first.%20It's%20familiar%2C%20explicit%2C%20and%20works%20great.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Actor%2C%20current_rank%2C%20endpoint%2C%20random%2C%20this_host)%3A%0A%20%20%20%20class%20UnreliableWorker(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22A%20worker%20that%20sometimes%20fails.%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20failure_rate%3A%20float%20%3D%200.3)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.rank%20%3D%20current_rank().rank%0A%20%20%20%20%20%20%20%20%20%20%20%20self.failure_rate%20%3D%20failure_rate%0A%20%20%20%20%20%20%20%20%20%20%20%20self.call_count%20%3D%200%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20process(self%2C%20data%3A%20int)%20-%3E%20dict%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.call_count%20%2B%3D%201%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20random.random()%20%3C%20self.failure_rate%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20RuntimeError(f%22Random%20failure%20on%20rank%20%7Bself.rank%7D%2C%20call%20%7Bself.call_count%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%22rank%22%3A%20self.rank%2C%20%22result%22%3A%20data%20*%202%2C%20%22calls%22%3A%20self.call_count%7D%0A%0A%20%20%20%20%23%20Spawn%20workers%0A%20%20%20%20procs%20%3D%20this_host().spawn_procs(per_host%3D%7B%22gpus%22%3A%203%7D)%0A%20%20%20%20workers%20%3D%20procs.spawn(%22unreliable%22%2C%20UnreliableWorker%2C%200.3)%0A%0A%20%20%20%20%23%20The%20canonical%20pattern%3A%20try%2Fexcept%20with%20fallback%0A%20%20%20%20def%20process_with_retry(workers_mesh%2C%20data%2C%20max_retries%3D3)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Try%20each%20worker%20until%20one%20succeeds.%22%22%22%0A%20%20%20%20%20%20%20%20errors%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20for%20attempt%20in%20range(max_retries)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20worker%20%3D%20workers_mesh.slice(gpus%3Dattempt%20%25%203)%20%20%23%20Round-robin%20through%20workers%0A%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20result%20%3D%20worker.process.call_one(data).get()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20Attempt%20%7Battempt%20%2B%201%7D%3A%20Success!%20%7Bresult%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20result%0A%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%20as%20e%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20errors.append(str(e))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20Attempt%20%7Battempt%20%2B%201%7D%3A%20Failed%20-%20%7Btype(e).__name__%7D%22)%0A%20%20%20%20%20%20%20%20raise%20RuntimeError(f%22All%20%7Bmax_retries%7D%20attempts%20failed%22)%0A%0A%20%20%20%20print(%22%3D%3D%3D%20Processing%20with%20retry%20%3D%3D%3D%22)%0A%20%20%20%20for%20i%20in%20range(5)%3A%0A%20%20%20%20%20%20%20%20print(f%22%5CnTask%20%7Bi%7D%3A%22)%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20_result%20%3D%20process_with_retry(workers%2C%20i%20*%2010)%0A%20%20%20%20%20%20%20%20except%20RuntimeError%20as%20e%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20All%20retries%20exhausted%3A%20%7Be%7D%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Why%20This%20Simple%20Pattern%20Works%0A%0A%20%20%20%20Actors%20are%20designed%20to%20be%20**stateless%20from%20the%20caller's%20perspective**%3A%0A%0A%20%20%20%20-%20If%20one%20fails%2C%20try%20another%0A%20%20%20%20-%20The%20caller%20doesn't%20need%20to%20know%20implementation%20details%0A%20%20%20%20-%20Each%20actor%20can%20maintain%20its%20own%20state%20internally%0A%0A%20%20%20%20This%20is%20the%20**90%25%20solution**.%20Use%20it%20unless%20you%20have%20a%20specific%20reason%20not%20to.%0A%0A%20%20%20%20%60%60%60python%0A%20%20%20%20%23%20The%20pattern%20in%20one%20line%0A%20%20%20%20result%20%3D%20try_call(actor1)%20or%20try_call(actor2)%20or%20try_call(actor3)%0A%20%20%20%20%60%60%60%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Supervision%20Trees%3A%20Centralized%20Error%20Surfacing%0A%0A%20%20%20%20Try%2Fexcept%20works%20when%20the%20**caller**%20catches%20failures.%20But%20what%20about%20failures%0A%20%20%20%20you%20don't%20directly%20trigger%20%E2%80%94%20a%20child%20actor%20crashing%20in%20the%20background%2C%20a%0A%20%20%20%20cascading%20failure%20deep%20in%20a%20hierarchy%3F%0A%0A%20%20%20%20Monarch's%20answer%20is%20**supervision**.%20When%20an%20actor%20spawns%20children%2C%20it%20becomes%0A%20%20%20%20their%20supervisor.%20If%20a%20child%20fails%2C%20the%20supervisor's%20%60__supervise__%60%20method%20is%0A%20%20%20%20called%20with%20a%20%60MeshFailure%60%20describing%20what%20went%20wrong.%0A%0A%20%20%20%20Think%20of%20it%20like%20a%20management%20chain%3A%20when%20an%20employee%20hits%20a%20problem%20they%20can't%0A%20%20%20%20solve%2C%20it%20escalates%20to%20their%20manager.%20The%20manager%20can%20handle%20it%20(return%20%60True%60)%0A%20%20%20%20or%20escalate%20further%20(return%20%60False%60).%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Actor%2C%20MeshFailure%2C%20endpoint%2C%20this_host)%3A%0A%20%20%20%20import%20asyncio%0A%20%20%20%20import%20monarch.actor%0A%0A%20%20%20%20class%20ActorCrash(BaseException)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Inherits%20from%20BaseException%20(not%20Exception)%20to%20trigger%20actor%20death.%0A%20%20%20%20%20%20%20%20Regular%20Exceptions%20are%20application%20errors%20%E2%80%94%20returned%20to%20the%20caller%2C%0A%20%20%20%20%20%20%20%20actor%20stays%20alive.%20BaseException%20causes%20the%20actor%20to%20crash%2C%20which%0A%20%20%20%20%20%20%20%20triggers%20the%20supervision%20tree.%22%22%22%0A%20%20%20%20%20%20%20%20pass%0A%0A%20%20%20%20class%20FragileWorker(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22A%20worker%20that%20crashes%20when%20asked.%22%22%22%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20async%20def%20do_work(self)%20-%3E%20str%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20raise%20ActorCrash(%22GPU%20memory%20error%20on%20this%20worker!%22)%0A%0A%20%20%20%20class%20Supervisor(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Spawns%20and%20supervises%20children.%20Catches%20their%20failures%20automatically.%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20child_procs)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Supervisor%20owns%20these%20children%20because%20it%20calls%20spawn()%0A%20%20%20%20%20%20%20%20%20%20%20%20self.workers%20%3D%20child_procs.spawn(%22fragile%22%2C%20FragileWorker)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.failure_log%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20self._supervised%20%3D%20asyncio.Event()%0A%0A%20%20%20%20%20%20%20%20def%20__supervise__(self%2C%20failure%3A%20MeshFailure)%20-%3E%20bool%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Called%20automatically%20when%20an%20owned%20child%20actor%20fails.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20self.failure_log.append(str(failure))%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%5BSupervisor%5D%20Caught%20failure%3A%20%7Bfailure%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20self._supervised.set()%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20True%20%20%23%20Handled%20%E2%80%94%20don't%20propagate%20further%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20async%20def%20crash_a_child(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Tell%20the%20child%20to%20crash%2C%20then%20wait%20for%20supervision%20to%20fire.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20self.workers.do_work.broadcast()%20%20%23%20fire-and-forget%20%E2%80%94%20triggers%20supervision%0A%20%20%20%20%20%20%20%20%20%20%20%20await%20asyncio.wait_for(self._supervised.wait()%2C%20timeout%3D30)%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20async%20def%20get_failure_log(self)%20-%3E%20list%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Return%20failures%20caught%20by%20__supervise__%20(as%20strings).%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20list(self.failure_log)%0A%0A%20%20%20%20%23%20Override%20the%20default%20fault%20hook%20(which%20calls%20sys.exit)%20so%20unhandled%0A%20%20%20%20%23%20supervision%20events%20don't%20kill%20our%20notebook%0A%20%20%20%20original_hook%20%3D%20monarch.actor.unhandled_fault_hook%0A%20%20%20%20monarch.actor.unhandled_fault_hook%20%3D%20lambda%20f%3A%20print(f%22%5BClient%5D%20Unhandled%20fault%3A%20%7Bf%7D%22)%0A%0A%20%20%20%20%23%20Create%20two%20separate%20proc%20meshes%20(supervisor%20and%20children%20MUST%20be%20on%20different%20meshes)%0A%20%20%20%20supervisor_procs%20%3D%20this_host().spawn_procs(per_host%3D%7B%22gpus%22%3A%201%7D)%0A%20%20%20%20child_procs%20%3D%20this_host().spawn_procs(per_host%3D%7B%22gpus%22%3A%201%7D)%0A%0A%20%20%20%20%23%20Spawn%20supervisor%2C%20passing%20child%20procs%20for%20it%20to%20own%0A%20%20%20%20supervisor%20%3D%20supervisor_procs.spawn(%22supervisor%22%2C%20Supervisor%2C%20child_procs)%0A%0A%20%20%20%20%23%20Tell%20supervisor%20to%20trigger%20the%20child%20%E2%80%94%20broadcast()%20means%20the%20error%20has%0A%20%20%20%20%23%20no%20caller%20to%20return%20to%2C%20so%20the%20actor%20crashes%20and%20supervision%20fires%0A%20%20%20%20supervisor.crash_a_child.call_one().get()%0A%0A%20%20%20%20%23%20Query%20the%20supervisor's%20failure%20log%0A%20%20%20%20failures%20%3D%20supervisor.get_failure_log.call_one().get()%0A%20%20%20%20print(f%22%5Cn%3D%3D%3D%20Supervisor's%20failure%20log%20(%7Blen(failures)%7D%20entries)%20%3D%3D%3D%22)%0A%20%20%20%20for%20j%2C%20f%20in%20enumerate(failures)%3A%0A%20%20%20%20%20%20%20%20print(f%22%20%20%5B%7Bj%7D%5D%20%7Bf%7D%22)%0A%0A%20%20%20%20if%20failures%3A%0A%20%20%20%20%20%20%20%20print(%22%5Cn__supervise__%20caught%20the%20child's%20failure%20automatically!%22)%0A%0A%20%20%20%20%23%20Restore%20original%20fault%20hook%0A%20%20%20%20monarch.actor.unhandled_fault_hook%20%3D%20original_hook%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20What%20Just%20Happened%0A%0A%20%20%20%20The%20supervisor%20**owns**%20the%20%60FragileWorker%60%20because%20it%20called%20%60spawn()%60.%20When%0A%20%20%20%20the%20child%20raised%20%60ActorCrash%60%20(a%20%60BaseException%60)%2C%20the%20actor%20died%20and%20Monarch%0A%20%20%20%20delivered%20a%20%60MeshFailure%60%20to%20the%20supervisor's%20%60__supervise__%60%20method.%0A%0A%20%20%20%20**Why%20%60BaseException%60%3F**%20In%20Monarch%2C%20regular%20%60Exception%60%20subclasses%20are%0A%20%20%20%20application%20errors%20%E2%80%94%20they're%20returned%20to%20the%20caller%20and%20the%20actor%20stays%20alive.%0A%20%20%20%20%60BaseException%60%20subclasses%20signal%20a%20fatal%20crash%3A%20the%20actor%20dies%2C%20and%20the%0A%20%20%20%20supervision%20tree%20is%20notified.%0A%0A%20%20%20%20Key%20points%3A%0A%0A%20%20%20%20-%20%60__supervise__%60%20receives%20a%20%60MeshFailure%60%20with%20%60.report()%60%20for%20readable%20output%0A%20%20%20%20-%20Return%20%60True%60%20-%3E%20%22I%20handled%20it%22%20(stops%20propagation%20up%20the%20tree)%0A%20%20%20%20-%20Return%20%60False%60%20-%3E%20escalate%20to%20the%20supervisor's%20supervisor%0A%20%20%20%20-%20If%20no%20one%20handles%20it%2C%20the%20failure%20reaches%20the%20client%20as%20an%20unhandled%20fault%0A%0A%20%20%20%20This%20gives%20you%20**one%20structured%20place**%20to%20see%20what%20went%20wrong%20%E2%80%94%20instead%20of%0A%20%20%20%20grepping%20through%20logs%20scattered%20across%20nodes.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20From%20One%20Supervisor%20to%20a%20Tree%0A%0A%20%20%20%20You%20just%20saw%20a%20single%20supervisor%20catch%20one%20child's%20failure.%20Now%20imagine%20this%0A%20%20%20%20at%20scale%20%E2%80%94%20supervision%20forms%20a%20**tree**%20where%20failures%20propagate%20upward%3A%0A%0A%20%20%20%20%60%60%60%0A%20%20%20%20Your%20Script%20(root)%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20Orchestrator%0A%20%20%20%20%20%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20TrainerSupervisor%0A%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20Trainer%20Rank%200%20%20%E2%9C%93%0A%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20Trainer%20Rank%201%20%20%E2%9C%93%0A%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20Trainer%20Rank%202%20%20%E2%9C%97%20OOM%0A%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20GeneratorSupervisor%0A%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20Generator%200%20%20%20%20%20%E2%9C%93%0A%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20Generator%201%20%20%20%20%20%E2%9C%93%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20When%20Trainer%20Rank%202%20crashes%2C%20%60TrainerSupervisor.__supervise__%60%20fires%20first.%0A%20%20%20%20If%20it%20returns%20%60True%60%2C%20the%20failure%20is%20handled%20locally%20%E2%80%94%20the%20Orchestrator%20never%0A%20%20%20%20even%20knows.%20If%20it%20returns%20%60False%60%2C%20the%20TrainerSupervisor%20itself%20fails%2C%20and%20the%0A%20%20%20%20event%20propagates%20up%20to%20the%20Orchestrator.%0A%0A%20%20%20%20This%20is%20just%20like%20exception%20handling%20in%20a%20call%20stack%3A%0A%0A%20%20%20%20%60%60%60python%0A%20%20%20%20try%3A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Orchestrator.__supervise__%0A%20%20%20%20%20%20%20%20try%3A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20TrainerSupervisor.__supervise__%0A%20%20%20%20%20%20%20%20%20%20%20%20raise%20OOMError()%20%20%20%20%20%20%23%20Trainer%20Rank%202%20crashes%0A%20%20%20%20%20%20%20%20except%20OOMError%3A%20%20%20%20%20%20%20%20%20%20%23%20%20%20-%3E%20handle%20or%20re-raise%0A%20%20%20%20%20%20%20%20%20%20%20%20handle_or_reraise()%0A%20%20%20%20except%20Exception%3A%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20%20%20-%3E%20Orchestrator%20handles%20or%20crashes%0A%20%20%20%20%20%20%20%20handle_or_crash()%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20The%20payoff%3A%20instead%20of%20grepping%20through%2016%2C000%20log%20files%2C%20you%20get%20**one%0A%20%20%20%20structured%20chain**%20showing%20exactly%20what%20failed%20and%20how%20the%20failure%20propagated.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20TorchFT%3A%20Fault-Tolerant%20Training%20at%20Scale%0A%0A%20%20%20%20Recall%20the%20419%20interruptions%20from%20Notebook%201%20%E2%80%94%20at%20that%20scale%2C%20restarting%0A%20%20%20%20the%20entire%20job%20each%20time%20is%20unacceptable.%20You%20need%20training%20to%20**continue%0A%20%20%20%20with%20healthy%20replicas**%20while%20failed%20ones%20recover.%0A%0A%20%20%20%20The%20result%3A%20**60%25%20faster%20recovery**%20than%20full%20SLURM%20restarts%2C%20with%20process%0A%20%20%20%20failures%20recovering%20in%20**~90%20seconds**.%20Here's%20how.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20How%20TorchFT%20Works%0A%0A%20%20%20%20TorchFT%20provides%20quorum-based%20training%20%E2%80%94%20instead%20of%20stopping%20the%20whole%20job%0A%20%20%20%20when%20a%20replica%20fails%2C%20the%20remaining%20replicas%20continue%3A%0A%0A%20%20%20%20%60%60%60%0A%20%20%20%20Traditional%20Training%3A%0A%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%20%20%20%20%E2%94%82Replica%200%E2%94%82%20%E2%94%82Replica%201%E2%94%82%20%E2%94%82Replica%202%E2%94%82%20%E2%94%82Replica%203%E2%94%82%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%B4%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%B4%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%96%BC%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20All-reduce%20every%20step%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Single%20failure%20%E2%86%92%20restart%20everything%0A%0A%20%20%20%20TorchFT%20Quorum-Based%20Training%3A%0A%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%20%20%20%20%E2%94%82Replica%200%E2%94%82%20%E2%94%82Replica%201%E2%94%82%20%E2%94%82Replica%202%E2%94%82%20%E2%94%82Replica%203%E2%94%82%0A%20%20%20%20%E2%94%82%20healthy%20%E2%94%82%20%E2%94%82%20%20FAILED%20%E2%94%82%20%E2%94%82%20healthy%20%E2%94%82%20%E2%94%82%20healthy%20%E2%94%82%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%B4%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%96%BC%0A%20%20%20%20%20%20%20%20%20%20%20%20Quorum%20shrinks%20to%203%20replicas%0A%20%20%20%20%20%20%20%20%20%20%20%20Training%20continues%20without%20stopping%0A%20%20%20%20%20%20%20%20%20%20%20%20Failed%20replica%20recovers%20and%20rejoins%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20On%20failure%2C%20TorchFT%20catches%20collective%20errors%20through%20its%20own%0A%20%20%20%20ManagedProcessGroup%2C%20isolates%20the%20failure%20to%20a%20single%20replica%20group%2C%20and%0A%20%20%20%20continues%20training%20without%20restarting%20the%20entire%20job.%0A%0A%20%20%20%20A%20Lighthouse%20service%20(Rust%20gRPC)%20coordinates%20quorum%20membership%20via%0A%20%20%20%20heartbeats%20(~100ms)%2C%20while%20a%20Manager%20handles%20checkpoint%20recovery%20when%0A%20%20%20%20replicas%20join%20or%20leave.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20Monarch%20%2B%20TorchFT%3A%20Separation%20of%20Concerns%0A%0A%20%20%20%20TorchFT%20handles%20**step-level%20fault%20tolerance**%20%E2%80%94%20catching%20errors%20mid-training%0A%20%20%20%20and%20shrinking%20the%20quorum.%20Monarch%20handles%20**orchestration-level%20recovery**%20%E2%80%94%0A%20%20%20%20respawning%20crashed%20replicas%2C%20managing%20job%20allocation%2C%20and%20escalating%20from%0A%20%20%20%20fast%20process%20restarts%20to%20full%20reallocation%20when%20needed.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20Case%20Study%3A%20Qwen3-32B%20Training%20with%20Fault%20Injection%0A%0A%20%20%20%20We%20ran%20this%20on%20a%20**30%20node%20(240%20H100s)%20Coreweave%20cluster**%2C%20training%0A%20%20%20%20Qwen3-32B%20using%20torchtitan%20and%20TorchFT.%0A%0A%20%20%20%20**Test%20conditions%3A**%0A%0A%20%20%20%20-%20Failures%20injected%20at%20~3-minute%20intervals%2C%20100%20total%20events%0A%20%20%20%20-%20Multiple%20failure%20modes%3A%20segfaults%2C%20process%20kills%2C%20NCCL%20abort%2C%20host%0A%20%20%20%20%20%20eviction%2C%20GIL%20deadlock%0A%0A%20%20%20%20**Results%3A**%0A%0A%20%20%20%20%7C%20Metric%20%7C%20Result%20%7C%0A%20%20%20%20%7C--------%7C--------%7C%0A%20%20%20%20%7C%20Recovery%20speed%20vs%20full%20SLURM%20restart%20%7C%20**60%25%20faster**%20%7C%0A%20%20%20%20%7C%20Avg%20recovery%20time%20(process%20failures)%20%7C%20**90%20seconds**%20%7C%0A%20%20%20%20%7C%20Avg%20recovery%20time%20(machine%20failures)%20%7C%20**2.5%20minutes**%20%7C%0A%0A%20%20%20%20**Why%20the%20improvement%3F**%0A%20%20%20%20Monarch%20allows%20for%20configurable%20recovery%20strategies%20based%20on%20failure%20type%20%E2%80%94%0A%20%20%20%20we%20avoid%20unnecessary%20job%20rescheduling%20by%20attempting%20fast%20process-level%0A%20%20%20%20restarts%20first.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Summary%0A%0A%20%20%20%20**Key%20takeaways%3A**%0A%0A%20%20%20%201.%20**Try%2Fexcept%20first**%3A%20The%20canonical%20pattern%20covers%2090%25%20of%20cases%0A%20%20%20%202.%20**Supervision%20trees**%3A%20Centralized%20error%20surfacing%20%E2%80%94%20one%20place%20to%20see%0A%20%20%20%20%20%20%20what%20went%20wrong%0A%20%20%20%203.%20**Quorum-based%20training**%3A%20Continue%20with%20healthy%20replicas%20while%20failed%0A%20%20%20%20%20%20%20ones%20recover%0A%20%20%20%204.%20**Monarch%20%2B%20TorchFT**%3A%20Orchestration-level%20recovery%20%2B%20step-level%20fault%0A%20%20%20%20%20%20%20tolerance%0A%0A%20%20%20%20These%20three%20patterns%20compose%20%E2%80%94%20try%2Fexcept%20is%20your%20first%20line%20of%20defense%2C%0A%20%20%20%20supervision%20gives%20you%20visibility%2C%20and%20TorchFT%20handles%20training-specific%0A%20%20%20%20recovery%20at%20scale.%0A%0A%20%20%20%20We've%20built%20patterns%20to%20handle%20failures.%20Next%3A%20putting%20it%20all%20together%20%E2%80%94%0A%20%20%20%20services%2C%20weight%20sync%2C%20and%20async%20RL%20loops.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A
</marimo-code>

<marimo-code-hash hidden="">17f35cec26f47123a1f6d4c8036c8bac</marimo-code-hash>
</body>
</html>
