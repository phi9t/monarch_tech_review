<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/apple-touch-icon.png" />
    <link rel="manifest" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        const scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          // Guard against race condition where iframe isn't ready
          if (!obj.contentWindow?.document?.documentElement) {
            return;
          }
          const element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          const hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          const newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((_entries) => {
          setHeight();
        });
        // Only observe if iframe content is ready
        if (obj.contentWindow?.document?.body) {
          resizeObserver.observe(obj.contentWindow.document.body);
        }
      }
    </script>
    <marimo-filename hidden>03_fault_tolerance.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>03 fault tolerance</title>
    <script type="module" crossorigin crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/index-CD6Gw4UH.js"></script>
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/preload-helper-D2MJg03u.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/clsx-D8GwTfvk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/cn-BKtXLv3a.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/chunk-LvLJmgfZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/react-Bj1aDYRI.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/compiler-runtime-B3qBwwSJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/jsx-runtime-ZmTK25f3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/badge-DX6CQ6PA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/hotkeys-BHHWjLlp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useEventListener-Cb-RVVEn.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/button-CZ3Cs4qb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/react-dom-CSu739Rf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/Combination-BAEdC-rz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/menu-items-BMjcEb2j.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-DwV58Fb1.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/createLucideIcon-BCdY6lG5.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/check-Dr3SxUsb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/x-ZP5cObgf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/select-BVdzZKAh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/tooltip-CMQz28hC.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/use-toast-BDYuj3zG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_Uint8Array-BGESiCQL.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_baseIsEqual-B9N9Mw_N.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useEvent-BhXAndur.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/invariant-CAG_dYON.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_baseFor-Duhs3RiJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/merge-BBX6ug-N.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/zod-H_cgTO0M.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/utils-YqBXNpsM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/Deferred-DxQeE5uh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/uuid-DXdzqzcr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/DeferredRequestRegistry-CMf25YiV.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/constants-B6Cb__3x.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/session-BOFn9QrD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/config-Q0O7_stz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/requests-B4FYHTZl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/isSymbol-BGkTcW3U.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/toString-DlRqgfqz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_hasUnicode-CWqKLxBC.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/assertNever-CBU83Y6o.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_arrayReduce-TT0iOGKY.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useLifecycle-ClI_npeg.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useNonce-CS26E0hA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useTheme-DQozhcp1.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/once-Bul8mtFs.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/capabilities-MM7JYRxj.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/createReducer-B3rBsy4P.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/paths-BzSgteR-.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-DBwNzi3C.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-ChS0Dc_R.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-CtsanegT.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-Dcqqg9UU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-sMh6mJ2d.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-Btv5Rh1v.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-bBwmhqty.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-CoCQUAeM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-Gqv0jSNr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/stex-jWatZkll.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/toDate-DETS9bBd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/cjs-CH5Rj0g8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_baseProperty-NKyJO2oh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/now-6sUe0ZdD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/debounce-B3mjKxHe.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/toInteger-CDcO32Gx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/database-zap-k4ePIFAU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/main-U5Goe76G.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/cells-DPp5cDaO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/spinner-DA8-7wQv.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/chevron-right--18M_6o9.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dropdown-menu-ldcmQvIV.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/kbd-Cm6Ba9qg.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/renderShortcut-BckyRbYt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/multi-map-DxdLNTBd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/alert-BOoN6gJ1.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/card-OlSjYhmd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/alert-dialog-BW4srmS0.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dialog-eb-NieZw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-CDXJRSCj.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/label-E64zk6_7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useDebounce-7iEVSqwM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/textarea-CRI7xDBj.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/numbers-D7O23mOZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/SSRProvider-BIDQNg9Q.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/context-BfYAMNLF.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useNumberFormatter-Db6Vjve5.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/usePress-C__vuri5.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/input-DUrq2DiR.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/links-7AQBmdyV.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/popover-CH1FzjxU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/switch-dWLWbbtg.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/table-DScsXgJW.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/mode-Bn7pdJvO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useAsyncData-BMGLSTg8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/errors-TZBmrJmc.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/error-banner-B9ts0mNl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/copy-DHrHayPa.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/memoize-BCOZVFBt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/get-6uJrSKbw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/capitalize-CmNnkG9y.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/copy-D-8y6iMN.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/plus-B7DF33lD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/refresh-cw-Dx8TEWFP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/trash-2-DDsWrxuJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/triangle-alert-CebQ7XwA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/ai-model-dropdown-Dk2SdB3C.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/defaultLocale-JieDVWC_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/precisionRound-CU2C3Vxx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/defaultLocale-BLne0bXb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/vega-loader.browser-DXARUlxo.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/tooltip-DxKBXCGp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/ErrorBoundary-B9Ifj8Jf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useInstallPackage-D4fX0Ee_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/ImperativeModal-BNN1HA7x.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/cell-link-B9b7J8QK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/datasource-CtyqtITR.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/state-D4T75eZb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/MarimoErrorOutput-Lf9P8Fhl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/copy-icon-v8ME_JKB.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/html-to-image-CIQqSu-S.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/focus-C1YokgL7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/LazyAnyLanguageCodeMirror-DgZ8iknE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/chunk-5FQGJX7Z-DPlx2kjA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/katex-CDLTCvjQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/markdown-renderer-DJy8ww5d.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/command-2ElA5IkO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/download-os8QlW6l.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useRunCells-D2HBb4DB.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/purify.es-DZrAQFIu.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/RenderHTML-D-of_-s7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useIframeCapabilities-B_pQb20b.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/formats-CobRswjh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/en-US-CCVfmA-q.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/isValid-DDt9wNjK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dates-CrvjILe3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/maps-D2_Mq1pZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/extends-BiFDv3jB.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/emotion-is-prop-valid.esm-C59xfSYt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useDateFormatter-CqhdUl2n.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/range-D2UKkEg-.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/table-CfDbAm78.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/JsonOutput-PE5ko4gi.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useDeleteCell-DdRX94yC.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/icons-CCHmxi8d.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/process-output-ByfLnk6j.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/blob-D-eV0cU3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/objectWithoutPropertiesLoose-DfWeGRFv.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/esm-Bmu2DhPy.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/file-Ch78NKWp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/play-GLWQQs7F.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/add-cell-with-ai-e_HMl7UU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/isEmpty-CgX_-6Mt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/bot-message-square-B2ThzDUZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/chat-display--jAB7huF.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/chart-no-axes-column-qvVRjhv1.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/square-function-B6mgCeFJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/spec-Ch0xnJY4.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/column-preview-CXjSXUhP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/toggle-zVW4FXNz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/globals-BgACvYmr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/share-ipf2hrOh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_baseSet-5Rdwpmr3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/react-resizable-panels.browser.esm-Da3ksQXL.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/utilities.esm-dm9SQStE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/floating-outline-BtdqbkUq.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useAddCell-CmuX2hOk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/eye-off-AK_9uodG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/readonly-python-code-WjTf6Pdd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/file-video-camera-C3wGzBnE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/types-BRfQN3HL.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/refresh-ccw-DN_xCV6A.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/form-BidPUZUn.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/field-CySaBlkz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useBoolean-Ck_unDZw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useDeepCompareMemoize-5OUgerQ3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/types-C1UhS3qM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/prop-types-DaaA-ptl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/es-BYgU_srD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/hasIn-CycJImp8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_baseFlatten-CUZNxU8H.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/flatten-D-7VEN0q.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/pick-B_6Qi5aM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/code-xml-CgN_Yig7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/download-Dg7clfkc.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/square-CuJ72M8f.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/settings-OBbrbhij.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/bundle.esm-i_UbZC0w.js">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/cells-jmgGt1lS.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/markdown-renderer-DdDKmWlR.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/JsonOutput-B7vuddcd.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/index-CeUwN_0i.css">
  
<script data-marimo="true">
    window.__MARIMO_STATIC__ = {};
    window.__MARIMO_STATIC__.files = {};
</script>
</head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "03_fault_tolerance.py",
            "mode": "read",
            "version": "0.19.9",
            "serverToken": "static",
            "config": {"ai": {"custom_providers": {}, "models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false, "signature_hint_on_typing": false}, "diagnostics": {"sql_linter": true}, "display": {"cell_output": "below", "code_editor_font_size": 14, "dataframes": "rich", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "medium", "reference_highlighting": true, "theme": "light"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": false}}, "mcp": {"mcpServers": {}, "presets": []}, "package_management": {"manager": "uv"}, "runtime": {"auto_instantiate": false, "auto_reload": "off", "default_csv_encoding": "utf-8", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "after_delay", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"sql_output": "auto", "width": "medium"},
            "view": {"showAppCode": true},
            "notebook": {"cells": [{"code": "import marimo as mo", "code_hash": "1d0db38904205bec4d6f6f6a1f6cec3e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hbol", "name": "_"}, {"code": "# Shared imports for the notebook\nimport random\nfrom monarch.actor import Actor, endpoint, current_rank, MeshFailure, this_host", "code_hash": "d3cbb393111da57393434cdee2844ee9", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "MJUe", "name": "_"}, {"code": "mo.md(r\"\"\"\n# Fault Tolerance in Monarch\n\nIn the last notebook, you caught a single error with try/except on a\nFlakyWorker. That works when you know which actor failed and have a backup\nready. But when failures hit every 3 hours across 16,000 GPUs, you need\npatterns that scale.\n\nThis notebook covers three layers of fault handling\n\n1. **Try/except with retry** \u2014 the 90% solution you'll reach for first\n2. **Supervision trees** \u2014 centralized error surfacing for infrastructure builders\n3. **TorchFT** \u2014 quorum-based training that continues through failures\n\"\"\")", "code_hash": "1d538d160108126be84d0a676e18f0bf", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "vblA", "name": "_"}, {"code": "mo.md(r\"\"\"\n## The Supervision Tree\n\nLarge scale training will run into issues with faulty hardware, flaky networks, and\nsoftware bugs. Monarch is designed to provide good behaviors for errors and faults by\ndefault with the option to define more sophisticated behavior for faster recovery or\nfault tolerance.\n\nWe borrow from Erlang the idea of a tree of supervision. Each process, and each actor\nhas a parent that launched it and is responsible for its health.\n\"\"\")", "code_hash": "f5a123b5062ba8c9db434d61f0616244", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "bkHC", "name": "_"}, {"code": "from monarch.actor import this_proc\n\nclass Errorful(Actor):\n    @endpoint\n    def say_hello(self):\n        raise Exception(\"I don't want to\")\n\ne = this_proc().spawn(\"errorful\", Errorful)\ntry:\n    e.say_hello.call_one().get()\nexcept Exception:\n    print(\"It didn't say hello\")", "code_hash": "b5e734e58a4cacd98ae133f48e0dd92e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "lEQa", "name": "_"}, {"code": "mo.md(r\"\"\"\nIf we are calling the endpoint and expecting a response, the error gets routed to\nthe caller. But we might also call something and provide it no way to respond \u2014 in\nthat case the error will be delivered to the owner of the actor:\n\n```python\ne.say_hello.broadcast()  # do not expect a response\n```\n\nThe default behavior of the supervision tree means that an error at any level of process\nor actor creation will not go unreported. This can prevent a lot of accidental deadlocks\ncompared to the standard unix-style defaults where threads and processes exiting do not\nstop the spawning processes.\n\n### Fine-grained Supervision\n\nSometimes fine-grained recovery is possible. For instance, if a data loader failed to\nread a URL, perhaps it would work to just restart it. If an actor defines a `__supervise__`\nspecial method, then it will get called to handle supervision events for meshes owned by\nthe actor. If an error happens on an ActorMesh that is a reference, such as a slice, or a\nmesh that is sent to another actor, then the recovery is done on the original creator of\nthat mesh, not the holder of the reference.\n\"\"\")", "code_hash": "e6892e8bfee3731784d6f8c4a281791d", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "PKri", "name": "_"}, {"code": "import monarch.actor\n\nclass SupervisorActor(Actor):\n    def __supervise__(self, failure: MeshFailure):\n        print(f\"Failure received: {failure}\")\n        # If a truthy value is returned, the supervision event is considered handled\n        # and will not be propagated further.\n        # Otherwise, the event will be propagated to the creator of this actor.\n        return True", "code_hash": "951dd4006477db9f22e68ae4d41f58c5", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Xref", "name": "_"}, {"code": "mo.md(r\"\"\"\nIf a `MeshFailure` is not handled by any `__supervise__` in the supervision tree, it will\nreach the client, where `monarch.actor.unhandled_fault_hook` will be called with the\n`MeshFailure` object. By default, this function crashes the client process with exit code 1.\n\"\"\")", "code_hash": "dc8b090d2334604af1fc4163eab0b347", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "SFPL", "name": "_"}, {"code": "import monarch.actor as _monarch_actor\n\ndef my_unhandled_fault_hook(failure: MeshFailure) -\u003E None:\n    print(f\"Mesh failure was not handled: {failure}\")\n\n_monarch_actor.unhandled_fault_hook = my_unhandled_fault_hook", "code_hash": "14bb6d526a3b5764e4b6f05494ebdc27", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "BYtC", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Supervision Trees: Centralized Error Surfacing\n\nTry/except works when the **caller** catches failures. But what about failures\nyou don't directly trigger \u2014 a child actor crashing in the background, a\ncascading failure deep in a hierarchy?\n\nMonarch's answer is the __supervise__ API. When an actor spawns children, it becomes\ntheir supervisor. If a child fails, the supervisor's `__supervise__` method is\ncalled with a `MeshFailure` describing what went wrong.\n\nThink of it like a management chain: when an employee hits a problem they can't\nsolve, it escalates to their manager. The manager can handle it (return `True`)\nor escalate further (return `False`).\n\"\"\")", "code_hash": "4e4e8fa2b8670abde619f381740e7dc9", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "RGSE", "name": "_"}, {"code": "import asyncio\n\nclass ActorCrash(BaseException):\n    pass\n\nclass FragileWorker(Actor):\n    \"\"\"A worker that crashes when asked.\"\"\"\n\n    @endpoint\n    async def do_work(self) -\u003E str:\n        raise ActorCrash(\"GPU memory error on this worker!\")\n\nclass Supervisor(Actor):\n    \"\"\"Spawns and supervises children. Catches their failures automatically.\"\"\"\n\n    def __init__(self, child_procs):\n        # Supervisor owns these children because it calls spawn()\n        self.workers = child_procs.spawn(\"fragile\", FragileWorker)\n        self.failure_log = []\n        self._supervised = asyncio.Event()\n\n    def __supervise__(self, failure: MeshFailure) -\u003E bool:\n        \"\"\"Called automatically when an owned child actor fails.\"\"\"\n        self.failure_log.append(str(failure))\n        print(f\"[Supervisor] Caught failure: {failure}\")\n        self._supervised.set()\n        return True  # Handled \u2014 don't propagate further\n\n    @endpoint\n    async def crash_a_child(self):\n        \"\"\"Tell the child to crash, then wait for supervision to fire.\"\"\"\n        self.workers.do_work.broadcast()  # fire-and-forget \u2014 triggers supervision\n        await asyncio.wait_for(self._supervised.wait(), timeout=30)\n\n    @endpoint\n    async def get_failure_log(self) -\u003E list:\n        \"\"\"Return failures caught by __supervise__ (as strings).\"\"\"\n        return list(self.failure_log)\n\n# Create two separate proc meshes (supervisor and children MUST be on different meshes)\nsupervisor_procs = this_host().spawn_procs(per_host={\"gpus\": 1})\nchild_procs = this_host().spawn_procs(per_host={\"gpus\": 1})\n\n# Spawn supervisor, passing child procs for it to own\nsupervisor = supervisor_procs.spawn(\"supervisor\", Supervisor, child_procs)\n\n# Tell supervisor to trigger the child \u2014 broadcast() means the error has\n# no caller to return to, so the actor crashes and supervision fires\nawait supervisor.crash_a_child.call_one()\n\n# Query the supervisor's failure log\nfailures = await supervisor.get_failure_log.call_one()\nprint(f\"\\n=== Supervisor's failure log ({len(failures)} entries) ===\")\nfor j, f in enumerate(failures):\n    print(f\"  [{j}] {f}\")", "code_hash": "4b36af29f3b16988be058bbb12f7be99", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Kclp", "name": "_"}, {"code": "mo.md(r\"\"\"\n### What Just Happened\n\nThe supervisor **owns** the `FragileWorker` because it called `spawn()`. When\nthe child raised `ActorCrash` (a `BaseException`), the actor died and Monarch\ndelivered a `MeshFailure` to the supervisor's `__supervise__` method.\n\n\nKey points:\n\n- `__supervise__` receives a `MeshFailure`\n- Return `True` -\u003E \"I handled it\" (stops propagation up the tree)\n- Return `False` -\u003E escalate to the supervisor's supervisor\n- If no one handles it, the failure reaches the client as an unhandled fault\n\nThis allows actors to define policies of what to do if Actors they own fail.\n\"\"\")", "code_hash": "fcc3e8c9149ee0752c1fc434623fcbfb", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "emfo", "name": "_"}, {"code": "mo.md(r\"\"\"\n### From One Supervisor to a Tree\n\nYou just saw a single supervisor catch one child's failure. Now imagine this\nat scale \u2014 supervision forms a **tree** where failures propagate upward:\n\n```\nYour Script (root)\n\u2514\u2500\u2500 Orchestrator\n    \u251c\u2500\u2500 TrainerSupervisor\n    \u2502   \u251c\u2500\u2500 Trainer Rank 0  \u2713\n    \u2502   \u251c\u2500\u2500 Trainer Rank 1  \u2713\n    \u2502   \u2514\u2500\u2500 Trainer Rank 2  \u2717 OOM\n    \u2514\u2500\u2500 GeneratorSupervisor\n        \u251c\u2500\u2500 Generator 0     \u2713\n        \u2514\u2500\u2500 Generator 1     \u2713\n```\n\nWhen Trainer Rank 2 crashes, `TrainerSupervisor.__supervise__` fires first.\nIf it returns `True`, the failure is handled locally \u2014 the Orchestrator never\neven knows. If it returns `False`, the TrainerSupervisor itself fails, and the\nevent propagates up to the Orchestrator.\n\nThis is just like exception handling in a call stack:\n\n```python\ntry:                          # Orchestrator.__supervise__\n    try:                      # TrainerSupervisor.__supervise__\n        raise OOMError()      # Trainer Rank 2 crashes\n    except OOMError:          #   -\u003E handle or re-raise\n        handle_or_reraise()\nexcept Exception:             #   -\u003E Orchestrator handles or crashes\n    handle_or_crash()\n```\n\nThe payoff: instead of grepping through 16,000 log files, you get **one\nstructured chain** showing exactly what failed and how the failure propagated.\n\"\"\")", "code_hash": "1e57428d7cd6d14330fbd29f89dd53fc", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hstk", "name": "_"}, {"code": "mo.md(r\"\"\"\n## TorchFT: Fault-Tolerant Training at Scale\n\nRecall the 419 interruptions from Notebook 1 \u2014 at that scale, restarting\nthe entire job each time is unacceptable. You need training to **continue\nwith healthy replicas** while failed ones recover.\n\nThe result: **60% faster recovery** than full SLURM restarts, with process\nfailures recovering in **~90 seconds**. Here's how.\n\"\"\")", "code_hash": "ed6f74e5d259396010fca8320ef89edb", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "nWHF", "name": "_"}, {"code": "mo.md(r\"\"\"\n### How TorchFT Works\n\nTorchFT provides quorum-based training \u2014 instead of stopping the whole job\nwhen a replica fails, the remaining replicas continue:\n\n```\nTraditional Training:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502Replica 0\u2502 \u2502Replica 1\u2502 \u2502Replica 2\u2502 \u2502Replica 3\u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n     \u2502           \u2502           \u2502           \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                       \u25bc\n              All-reduce every step\n              Single failure \u2192 restart everything\n\nTorchFT Quorum-Based Training:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502Replica 0\u2502 \u2502Replica 1\u2502 \u2502Replica 2\u2502 \u2502Replica 3\u2502\n\u2502 healthy \u2502 \u2502  FAILED \u2502 \u2502 healthy \u2502 \u2502 healthy \u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n     \u2502                       \u2502           \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u25bc\n        Quorum shrinks to 3 replicas\n        Training continues without stopping\n        Failed replica recovers and rejoins\n```\n\nOn failure, TorchFT catches collective errors through its own\nManagedProcessGroup, isolates the failure to a single replica group, and\ncontinues training without restarting the entire job.\n\nA Lighthouse service (Rust gRPC) coordinates quorum membership via\nheartbeats (~100ms), while a Manager handles checkpoint recovery when\nreplicas join or leave.\n\"\"\")", "code_hash": "cf47db93ccf2b0664681061adc821bd4", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "iLit", "name": "_"}, {"code": "mo.md(r\"\"\"\n### Monarch + TorchFT: Separation of Concerns\n\nTorchFT handles **step-level fault tolerance** \u2014 catching errors mid-training\nand shrinking the quorum. Monarch handles **orchestration-level recovery** \u2014\nrespawning crashed replicas, managing job allocation, and escalating from\nfast process restarts to full reallocation when needed.\n\"\"\")", "code_hash": "2b5ff7a494de6f1a17f6e70cc4e7e263", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ZHCJ", "name": "_"}, {"code": "mo.md(r\"\"\"\n### Case Study: Qwen3-32B Training with Fault Injection\n\nWe ran this on a **30 node (240 H100s) Coreweave cluster**, training\nQwen3-32B using torchtitan and TorchFT.\n\n**Test conditions:**\n\n- Failures injected at ~3-minute intervals, 100 total events\n- Multiple failure modes: segfaults, process kills, NCCL abort, host\n  eviction, GIL deadlock\n\n**Results:**\n\n| Metric | Result |\n|--------|--------|\n| Recovery speed vs full SLURM restart | **60% faster** |\n| Avg recovery time (process failures) | **90 seconds** |\n| Avg recovery time (machine failures) | **2.5 minutes** |\n\n**Why the improvement?**\nMonarch allows for configurable recovery strategies based on failure type \u2014\nwe avoid unnecessary job rescheduling by attempting fast process-level\nrestarts first.\n\"\"\")", "code_hash": "1b9e34010e34ac92259f7a0a0640e7a7", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ROlb", "name": "_"}, {"code": "mo.md(r\"\"\"\nFor more details on error handling in Monarch, see the\n[Error Handling in Meshes](https://meta-pytorch.org/monarch/actors.html#error-handling-in-meshes)\ndocumentation.\n\"\"\")", "code_hash": "4da47e3ebe119bac1ff944e403e2eba6", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "qnkX", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Summary\n\n**Key takeaways:**\n\n1. **Try/except first**: The canonical pattern covers 90% of cases\n2. **Supervision trees**: Centralized error surfacing \u2014 one place to see\n   what went wrong\n3. **Quorum-based training**: Continue with healthy replicas while failed\n   ones recover\n4. **Monarch + TorchFT**: Orchestration-level recovery + step-level fault\n   tolerance\n\nThese three patterns compose \u2014 try/except is your first line of defense,\nsupervision gives you visibility, and TorchFT handles training-specific\nrecovery at scale.\n\nWe've built patterns to handle failures. Next: putting it all together \u2014\nservices, weight sync, and async RL loops.\n\n---\n\n**Previous:** [NB02 \u2014 Interactive DevX](./02_interactive_devx.html) \u00b7 **Next:** [NB04 \u2014 Distributed Tensors](./04_distributed_tensors.html)\n\"\"\")", "code_hash": "655a44e1aabc5786d317cb11ba938e4c", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "TqIu", "name": "_"}], "metadata": {"marimo_version": "0.19.9"}, "version": "1"},
            "session": {"cells": [{"code_hash": "1d0db38904205bec4d6f6f6a1f6cec3e", "console": [], "id": "Hbol", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "d3cbb393111da57393434cdee2844ee9", "console": [], "id": "MJUe", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "1d538d160108126be84d0a676e18f0bf", "console": [], "id": "vblA", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch1 id=\"fault-tolerance-in-monarch\"\u003EFault Tolerance in Monarch\u003C/h1\u003E\n\u003Cspan class=\"paragraph\"\u003EIn the last notebook, you caught a single error with try/except on a\nFlakyWorker. That works when you know which actor failed and have a backup\nready. But when failures hit every 3 hours across 16,000 GPUs, you need\npatterns that scale.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThis notebook covers three layers of fault handling\u003C/span\u003E\n\u003Col\u003E\n\u003Cli\u003E\u003Cstrong\u003ETry/except with retry\u003C/strong\u003E \u2014 the 90% solution you'll reach for first\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ESupervision trees\u003C/strong\u003E \u2014 centralized error surfacing for infrastructure builders\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ETorchFT\u003C/strong\u003E \u2014 quorum-based training that continues through failures\u003C/li\u003E\n\u003C/ol\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "f5a123b5062ba8c9db434d61f0616244", "console": [], "id": "bkHC", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"the-supervision-tree\"\u003EThe Supervision Tree\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003ELarge scale training will run into issues with faulty hardware, flaky networks, and\nsoftware bugs. Monarch is designed to provide good behaviors for errors and faults by\ndefault with the option to define more sophisticated behavior for faster recovery or\nfault tolerance.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EWe borrow from Erlang the idea of a tree of supervision. Each process, and each actor\nhas a parent that launched it and is responsible for its health.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "b5e734e58a4cacd98ae133f48e0dd92e", "console": [{"mimetype": "text/plain", "name": "stderr", "text": "Monarch internal logs are being written to /tmp/allencwang/monarch_log.log; execution id allencwang_Feb-07_10:54_104\n", "type": "stream"}, {"mimetype": "text/plain", "name": "stdout", "text": "It didn't say hello\n", "type": "stream"}], "id": "lEQa", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "e6892e8bfee3731784d6f8c4a281791d", "console": [], "id": "PKri", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Cspan class=\"paragraph\"\u003EIf we are calling the endpoint and expecting a response, the error gets routed to\nthe caller. But we might also call something and provide it no way to respond \u2014 in\nthat case the error will be delivered to the owner of the actor:\u003C/span\u003E\n\u003Cdiv class=\"language-python codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"n\"\u003Ee\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Esay_hello\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Ebroadcast\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E  \u003Cspan class=\"c1\"\u003E# do not expect a response\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EThe default behavior of the supervision tree means that an error at any level of process\nor actor creation will not go unreported. This can prevent a lot of accidental deadlocks\ncompared to the standard unix-style defaults where threads and processes exiting do not\nstop the spawning processes.\u003C/span\u003E\n\u003Ch3 id=\"fine-grained-supervision\"\u003EFine-grained Supervision\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003ESometimes fine-grained recovery is possible. For instance, if a data loader failed to\nread a URL, perhaps it would work to just restart it. If an actor defines a \u003Ccode\u003E__supervise__\u003C/code\u003E\nspecial method, then it will get called to handle supervision events for meshes owned by\nthe actor. If an error happens on an ActorMesh that is a reference, such as a slice, or a\nmesh that is sent to another actor, then the recovery is done on the original creator of\nthat mesh, not the holder of the reference.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "951dd4006477db9f22e68ae4d41f58c5", "console": [], "id": "Xref", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "dc8b090d2334604af1fc4163eab0b347", "console": [], "id": "SFPL", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Cspan class=\"paragraph\"\u003EIf a \u003Ccode\u003EMeshFailure\u003C/code\u003E is not handled by any \u003Ccode\u003E__supervise__\u003C/code\u003E in the supervision tree, it will\nreach the client, where \u003Ccode\u003Emonarch.actor.unhandled_fault_hook\u003C/code\u003E will be called with the\n\u003Ccode\u003EMeshFailure\u003C/code\u003E object. By default, this function crashes the client process with exit code 1.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "14bb6d526a3b5764e4b6f05494ebdc27", "console": [], "id": "BYtC", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "4e4e8fa2b8670abde619f381740e7dc9", "console": [], "id": "RGSE", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"supervision-trees-centralized-error-surfacing\"\u003ESupervision Trees: Centralized Error Surfacing\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003ETry/except works when the \u003Cstrong\u003Ecaller\u003C/strong\u003E catches failures. But what about failures\nyou don't directly trigger \u2014 a child actor crashing in the background, a\ncascading failure deep in a hierarchy?\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EMonarch's answer is the \u003Cstrong\u003Esupervise\u003C/strong\u003E API. When an actor spawns children, it becomes\ntheir supervisor. If a child fails, the supervisor's \u003Ccode\u003E__supervise__\u003C/code\u003E method is\ncalled with a \u003Ccode\u003EMeshFailure\u003C/code\u003E describing what went wrong.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThink of it like a management chain: when an employee hits a problem they can't\nsolve, it escalates to their manager. The manager can handle it (return \u003Ccode\u003ETrue\u003C/code\u003E)\nor escalate further (return \u003Ccode\u003EFalse\u003C/code\u003E).\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "4b36af29f3b16988be058bbb12f7be99", "console": [{"mimetype": "text/plain", "name": "stdout", "text": "[Supervisor] Caught failure: MeshFailure(mesh_name=fragile-1t9XwRis2Uz1, rank=0, event=The actor \u003Croot\u003E.\u003C__main__.Supervisor supervisor{'gpus': 0/1}\u003E.\u003C__main__.FragileWorker fragile{'gpus': 0/1}\u003E and all its descendants have failed.\nThis occurred because the actor itself failed.\nThe error was:\n actor explicitly aborted due to: monarch._src.actor.actor_mesh.ActorError: Actor call fragile.do_work failed with BaseException.\n  Traceback of where the remote call failed (most recent call last):\n   File \"/home/allencwang/monarch-gpu-mode/.venv/lib/python3.12/site-packages/monarch/_src/actor/actor_mesh.py\", line 1370, in handle\n     result = await the_method(*args, **kwargs)\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n   File \"/tmp/marimo_2327484/__marimo__cell_Kclp_.py\", line 11, in do_work\n     raise ActorCrash(\"GPU memory error on this worker!\")\n ActorCrash: GPU memory error on this worker!\n\n)\n\n=== Supervisor's failure log (1 entries) ===\n  [0] MeshFailure(mesh_name=fragile-1t9XwRis2Uz1, rank=0, event=The actor \u003Croot\u003E.\u003C__main__.Supervisor supervisor{'gpus': 0/1}\u003E.\u003C__main__.FragileWorker fragile{'gpus': 0/1}\u003E and all its descendants have failed.\nThis occurred because the actor itself failed.\nThe error was:\n actor explicitly aborted due to: monarch._src.actor.actor_mesh.ActorError: Actor call fragile.do_work failed with BaseException.\n  Traceback of where the remote call failed (most recent call last):\n   File \"/home/allencwang/monarch-gpu-mode/.venv/lib/python3.12/site-packages/monarch/_src/actor/actor_mesh.py\", line 1370, in handle\n     result = await the_method(*args, **kwargs)\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n   File \"/tmp/marimo_2327484/__marimo__cell_Kclp_.py\", line 11, in do_work\n     raise ActorCrash(\"GPU memory error on this worker!\")\n ActorCrash: GPU memory error on this worker!\n\n)\n", "type": "stream"}], "id": "Kclp", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "fcc3e8c9149ee0752c1fc434623fcbfb", "console": [], "id": "emfo", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"what-just-happened\"\u003EWhat Just Happened\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003EThe supervisor \u003Cstrong\u003Eowns\u003C/strong\u003E the \u003Ccode\u003EFragileWorker\u003C/code\u003E because it called \u003Ccode\u003Espawn()\u003C/code\u003E. When\nthe child raised \u003Ccode\u003EActorCrash\u003C/code\u003E (a \u003Ccode\u003EBaseException\u003C/code\u003E), the actor died and Monarch\ndelivered a \u003Ccode\u003EMeshFailure\u003C/code\u003E to the supervisor's \u003Ccode\u003E__supervise__\u003C/code\u003E method.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EKey points:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Ccode\u003E__supervise__\u003C/code\u003E receives a \u003Ccode\u003EMeshFailure\u003C/code\u003E\u003C/li\u003E\n\u003Cli\u003EReturn \u003Ccode\u003ETrue\u003C/code\u003E -\u0026gt; \"I handled it\" (stops propagation up the tree)\u003C/li\u003E\n\u003Cli\u003EReturn \u003Ccode\u003EFalse\u003C/code\u003E -\u0026gt; escalate to the supervisor's supervisor\u003C/li\u003E\n\u003Cli\u003EIf no one handles it, the failure reaches the client as an unhandled fault\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003EThis allows actors to define policies of what to do if Actors they own fail.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "1e57428d7cd6d14330fbd29f89dd53fc", "console": [], "id": "Hstk", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"from-one-supervisor-to-a-tree\"\u003EFrom One Supervisor to a Tree\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003EYou just saw a single supervisor catch one child's failure. Now imagine this\nat scale \u2014 supervision forms a \u003Cstrong\u003Etree\u003C/strong\u003E where failures propagate upward:\u003C/span\u003E\n\u003Cdiv class=\"language-perl6 codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"n\"\u003EYour\u003C/span\u003E \u003Cspan class=\"n\"\u003EScript\u003C/span\u003E (\u003Cspan class=\"n\"\u003Eroot\u003C/span\u003E)\n\u2514\u2500\u2500 \u003Cspan class=\"n\"\u003EOrchestrator\u003C/span\u003E\n    \u251c\u2500\u2500 \u003Cspan class=\"n\"\u003ETrainerSupervisor\u003C/span\u003E\n    \u2502   \u251c\u2500\u2500 \u003Cspan class=\"n\"\u003ETrainer\u003C/span\u003E \u003Cspan class=\"n\"\u003ERank\u003C/span\u003E \u003Cspan class=\"mi\"\u003E0\u003C/span\u003E  \u2713\n    \u2502   \u251c\u2500\u2500 \u003Cspan class=\"n\"\u003ETrainer\u003C/span\u003E \u003Cspan class=\"n\"\u003ERank\u003C/span\u003E \u003Cspan class=\"mi\"\u003E1\u003C/span\u003E  \u2713\n    \u2502   \u2514\u2500\u2500 \u003Cspan class=\"n\"\u003ETrainer\u003C/span\u003E \u003Cspan class=\"n\"\u003ERank\u003C/span\u003E \u003Cspan class=\"mi\"\u003E2\u003C/span\u003E  \u2717 \u003Cspan class=\"n\"\u003EOOM\u003C/span\u003E\n    \u2514\u2500\u2500 \u003Cspan class=\"n\"\u003EGeneratorSupervisor\u003C/span\u003E\n        \u251c\u2500\u2500 \u003Cspan class=\"n\"\u003EGenerator\u003C/span\u003E \u003Cspan class=\"mi\"\u003E0\u003C/span\u003E     \u2713\n        \u2514\u2500\u2500 \u003Cspan class=\"n\"\u003EGenerator\u003C/span\u003E \u003Cspan class=\"mi\"\u003E1\u003C/span\u003E     \u2713\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EWhen Trainer Rank 2 crashes, \u003Ccode\u003ETrainerSupervisor.__supervise__\u003C/code\u003E fires first.\nIf it returns \u003Ccode\u003ETrue\u003C/code\u003E, the failure is handled locally \u2014 the Orchestrator never\neven knows. If it returns \u003Ccode\u003EFalse\u003C/code\u003E, the TrainerSupervisor itself fails, and the\nevent propagates up to the Orchestrator.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThis is just like exception handling in a call stack:\u003C/span\u003E\n\u003Cdiv class=\"language-python codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"k\"\u003Etry\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E                          \u003Cspan class=\"c1\"\u003E# Orchestrator.__supervise__\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Etry\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E                      \u003Cspan class=\"c1\"\u003E# TrainerSupervisor.__supervise__\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Eraise\u003C/span\u003E \u003Cspan class=\"n\"\u003EOOMError\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E      \u003Cspan class=\"c1\"\u003E# Trainer Rank 2 crashes\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Eexcept\u003C/span\u003E \u003Cspan class=\"n\"\u003EOOMError\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E          \u003Cspan class=\"c1\"\u003E#   -\u0026gt; handle or re-raise\u003C/span\u003E\n        \u003Cspan class=\"n\"\u003Ehandle_or_reraise\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n\u003Cspan class=\"k\"\u003Eexcept\u003C/span\u003E \u003Cspan class=\"ne\"\u003EException\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E             \u003Cspan class=\"c1\"\u003E#   -\u0026gt; Orchestrator handles or crashes\u003C/span\u003E\n    \u003Cspan class=\"n\"\u003Ehandle_or_crash\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EThe payoff: instead of grepping through 16,000 log files, you get \u003Cstrong\u003Eone\nstructured chain\u003C/strong\u003E showing exactly what failed and how the failure propagated.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "ed6f74e5d259396010fca8320ef89edb", "console": [], "id": "nWHF", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"torchft-fault-tolerant-training-at-scale\"\u003ETorchFT: Fault-Tolerant Training at Scale\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003ERecall the 419 interruptions from Notebook 1 \u2014 at that scale, restarting\nthe entire job each time is unacceptable. You need training to \u003Cstrong\u003Econtinue\nwith healthy replicas\u003C/strong\u003E while failed ones recover.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThe result: \u003Cstrong\u003E60% faster recovery\u003C/strong\u003E than full SLURM restarts, with process\nfailures recovering in \u003Cstrong\u003E~90 seconds\u003C/strong\u003E. Here's how.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "cf47db93ccf2b0664681061adc821bd4", "console": [], "id": "iLit", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"how-torchft-works\"\u003EHow TorchFT Works\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003ETorchFT provides quorum-based training \u2014 instead of stopping the whole job\nwhen a replica fails, the remaining replicas continue:\u003C/span\u003E\n\u003Cdiv class=\"language-text codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003ETraditional Training:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502Replica 0\u2502 \u2502Replica 1\u2502 \u2502Replica 2\u2502 \u2502Replica 3\u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n     \u2502           \u2502           \u2502           \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                       \u25bc\n              All-reduce every step\n              Single failure \u2192 restart everything\n\nTorchFT Quorum-Based Training:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502Replica 0\u2502 \u2502Replica 1\u2502 \u2502Replica 2\u2502 \u2502Replica 3\u2502\n\u2502 healthy \u2502 \u2502  FAILED \u2502 \u2502 healthy \u2502 \u2502 healthy \u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n     \u2502                       \u2502           \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u25bc\n        Quorum shrinks to 3 replicas\n        Training continues without stopping\n        Failed replica recovers and rejoins\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EOn failure, TorchFT catches collective errors through its own\nManagedProcessGroup, isolates the failure to a single replica group, and\ncontinues training without restarting the entire job.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EA Lighthouse service (Rust gRPC) coordinates quorum membership via\nheartbeats (~100ms), while a Manager handles checkpoint recovery when\nreplicas join or leave.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "2b5ff7a494de6f1a17f6e70cc4e7e263", "console": [], "id": "ZHCJ", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"monarch-torchft-separation-of-concerns\"\u003EMonarch + TorchFT: Separation of Concerns\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003ETorchFT handles \u003Cstrong\u003Estep-level fault tolerance\u003C/strong\u003E \u2014 catching errors mid-training\nand shrinking the quorum. Monarch handles \u003Cstrong\u003Eorchestration-level recovery\u003C/strong\u003E \u2014\nrespawning crashed replicas, managing job allocation, and escalating from\nfast process restarts to full reallocation when needed.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "1b9e34010e34ac92259f7a0a0640e7a7", "console": [], "id": "ROlb", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"case-study-qwen3-32b-training-with-fault-injection\"\u003ECase Study: Qwen3-32B Training with Fault Injection\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003EWe ran this on a \u003Cstrong\u003E30 node (240 H100s) Coreweave cluster\u003C/strong\u003E, training\nQwen3-32B using torchtitan and TorchFT.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003ETest conditions:\u003C/strong\u003E\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003EFailures injected at ~3-minute intervals, 100 total events\u003C/li\u003E\n\u003Cli\u003EMultiple failure modes: segfaults, process kills, NCCL abort, host\n  eviction, GIL deadlock\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EResults:\u003C/strong\u003E\u003C/span\u003E\n\u003Ctable\u003E\n\u003Cthead\u003E\n\u003Ctr\u003E\n\u003Cth\u003EMetric\u003C/th\u003E\n\u003Cth\u003EResult\u003C/th\u003E\n\u003C/tr\u003E\n\u003C/thead\u003E\n\u003Ctbody\u003E\n\u003Ctr\u003E\n\u003Ctd\u003ERecovery speed vs full SLURM restart\u003C/td\u003E\n\u003Ctd\u003E\u003Cstrong\u003E60% faster\u003C/strong\u003E\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003EAvg recovery time (process failures)\u003C/td\u003E\n\u003Ctd\u003E\u003Cstrong\u003E90 seconds\u003C/strong\u003E\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003EAvg recovery time (machine failures)\u003C/td\u003E\n\u003Ctd\u003E\u003Cstrong\u003E2.5 minutes\u003C/strong\u003E\u003C/td\u003E\n\u003C/tr\u003E\n\u003C/tbody\u003E\n\u003C/table\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EWhy the improvement?\u003C/strong\u003E\nMonarch allows for configurable recovery strategies based on failure type \u2014\nwe avoid unnecessary job rescheduling by attempting fast process-level\nrestarts first.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "4da47e3ebe119bac1ff944e403e2eba6", "console": [], "id": "qnkX", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Cspan class=\"paragraph\"\u003EFor more details on error handling in Monarch, see the\n\u003Ca href=\"https://meta-pytorch.org/monarch/actors.html#error-handling-in-meshes\" rel=\"noopener noreferrer\" target=\"_blank\"\u003EError Handling in Meshes\u003C/a\u003E\ndocumentation.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "655a44e1aabc5786d317cb11ba938e4c", "console": [], "id": "TqIu", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"summary\"\u003ESummary\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EKey takeaways:\u003C/strong\u003E\u003C/span\u003E\n\u003Col\u003E\n\u003Cli\u003E\u003Cstrong\u003ETry/except first\u003C/strong\u003E: The canonical pattern covers 90% of cases\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ESupervision trees\u003C/strong\u003E: Centralized error surfacing \u2014 one place to see\n   what went wrong\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EQuorum-based training\u003C/strong\u003E: Continue with healthy replicas while failed\n   ones recover\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EMonarch + TorchFT\u003C/strong\u003E: Orchestration-level recovery + step-level fault\n   tolerance\u003C/li\u003E\n\u003C/ol\u003E\n\u003Cspan class=\"paragraph\"\u003EThese three patterns compose \u2014 try/except is your first line of defense,\nsupervision gives you visibility, and TorchFT handles training-specific\nrecovery at scale.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EWe've built patterns to handle failures. Next: putting it all together \u2014\nservices, weight sync, and async RL loops.\u003C/span\u003E\n\u003Chr /\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EPrevious:\u003C/strong\u003E \u003Ca href=\"./02_interactive_devx.html\"\u003ENB02 \u2014 Interactive DevX\u003C/a\u003E \u00b7 \u003Cstrong\u003ENext:\u003C/strong\u003E \u003Ca href=\"./04_distributed_tensors.html\"\u003ENB04 \u2014 Distributed Tensors\u003C/a\u003E\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}], "metadata": {"marimo_version": "0.19.9"}, "version": "1"},
            "runtimeConfig": null,
        };
    </script>
  
<marimo-code hidden="">
    import%20marimo%0A%0A__generated_with%20%3D%20%220.19.9%22%0Aapp%20%3D%20marimo.App(width%3D%22medium%22)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%0A%20%20%20%20return%20(mo%2C)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20%23%20Shared%20imports%20for%20the%20notebook%0A%20%20%20%20import%20random%0A%20%20%20%20from%20monarch.actor%20import%20Actor%2C%20endpoint%2C%20current_rank%2C%20MeshFailure%2C%20this_host%0A%0A%20%20%20%20return%20Actor%2C%20MeshFailure%2C%20endpoint%2C%20this_host%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%20Fault%20Tolerance%20in%20Monarch%0A%0A%20%20%20%20In%20the%20last%20notebook%2C%20you%20caught%20a%20single%20error%20with%20try%2Fexcept%20on%20a%0A%20%20%20%20FlakyWorker.%20That%20works%20when%20you%20know%20which%20actor%20failed%20and%20have%20a%20backup%0A%20%20%20%20ready.%20But%20when%20failures%20hit%20every%203%20hours%20across%2016%2C000%20GPUs%2C%20you%20need%0A%20%20%20%20patterns%20that%20scale.%0A%0A%20%20%20%20This%20notebook%20covers%20three%20layers%20of%20fault%20handling%0A%0A%20%20%20%201.%20**Try%2Fexcept%20with%20retry**%20%E2%80%94%20the%2090%25%20solution%20you'll%20reach%20for%20first%0A%20%20%20%202.%20**Supervision%20trees**%20%E2%80%94%20centralized%20error%20surfacing%20for%20infrastructure%20builders%0A%20%20%20%203.%20**TorchFT**%20%E2%80%94%20quorum-based%20training%20that%20continues%20through%20failures%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20The%20Supervision%20Tree%0A%0A%20%20%20%20Large%20scale%20training%20will%20run%20into%20issues%20with%20faulty%20hardware%2C%20flaky%20networks%2C%20and%0A%20%20%20%20software%20bugs.%20Monarch%20is%20designed%20to%20provide%20good%20behaviors%20for%20errors%20and%20faults%20by%0A%20%20%20%20default%20with%20the%20option%20to%20define%20more%20sophisticated%20behavior%20for%20faster%20recovery%20or%0A%20%20%20%20fault%20tolerance.%0A%0A%20%20%20%20We%20borrow%20from%20Erlang%20the%20idea%20of%20a%20tree%20of%20supervision.%20Each%20process%2C%20and%20each%20actor%0A%20%20%20%20has%20a%20parent%20that%20launched%20it%20and%20is%20responsible%20for%20its%20health.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Actor%2C%20endpoint)%3A%0A%20%20%20%20from%20monarch.actor%20import%20this_proc%0A%0A%20%20%20%20class%20Errorful(Actor)%3A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20say_hello(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20raise%20Exception(%22I%20don't%20want%20to%22)%0A%0A%20%20%20%20e%20%3D%20this_proc().spawn(%22errorful%22%2C%20Errorful)%0A%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20e.say_hello.call_one().get()%0A%20%20%20%20except%20Exception%3A%0A%20%20%20%20%20%20%20%20print(%22It%20didn't%20say%20hello%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20If%20we%20are%20calling%20the%20endpoint%20and%20expecting%20a%20response%2C%20the%20error%20gets%20routed%20to%0A%20%20%20%20the%20caller.%20But%20we%20might%20also%20call%20something%20and%20provide%20it%20no%20way%20to%20respond%20%E2%80%94%20in%0A%20%20%20%20that%20case%20the%20error%20will%20be%20delivered%20to%20the%20owner%20of%20the%20actor%3A%0A%0A%20%20%20%20%60%60%60python%0A%20%20%20%20e.say_hello.broadcast()%20%20%23%20do%20not%20expect%20a%20response%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20The%20default%20behavior%20of%20the%20supervision%20tree%20means%20that%20an%20error%20at%20any%20level%20of%20process%0A%20%20%20%20or%20actor%20creation%20will%20not%20go%20unreported.%20This%20can%20prevent%20a%20lot%20of%20accidental%20deadlocks%0A%20%20%20%20compared%20to%20the%20standard%20unix-style%20defaults%20where%20threads%20and%20processes%20exiting%20do%20not%0A%20%20%20%20stop%20the%20spawning%20processes.%0A%0A%20%20%20%20%23%23%23%20Fine-grained%20Supervision%0A%0A%20%20%20%20Sometimes%20fine-grained%20recovery%20is%20possible.%20For%20instance%2C%20if%20a%20data%20loader%20failed%20to%0A%20%20%20%20read%20a%20URL%2C%20perhaps%20it%20would%20work%20to%20just%20restart%20it.%20If%20an%20actor%20defines%20a%20%60__supervise__%60%0A%20%20%20%20special%20method%2C%20then%20it%20will%20get%20called%20to%20handle%20supervision%20events%20for%20meshes%20owned%20by%0A%20%20%20%20the%20actor.%20If%20an%20error%20happens%20on%20an%20ActorMesh%20that%20is%20a%20reference%2C%20such%20as%20a%20slice%2C%20or%20a%0A%20%20%20%20mesh%20that%20is%20sent%20to%20another%20actor%2C%20then%20the%20recovery%20is%20done%20on%20the%20original%20creator%20of%0A%20%20%20%20that%20mesh%2C%20not%20the%20holder%20of%20the%20reference.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Actor%2C%20MeshFailure)%3A%0A%20%20%20%20import%20monarch.actor%0A%0A%20%20%20%20class%20SupervisorActor(Actor)%3A%0A%20%20%20%20%20%20%20%20def%20__supervise__(self%2C%20failure%3A%20MeshFailure)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Failure%20received%3A%20%7Bfailure%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20If%20a%20truthy%20value%20is%20returned%2C%20the%20supervision%20event%20is%20considered%20handled%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20and%20will%20not%20be%20propagated%20further.%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Otherwise%2C%20the%20event%20will%20be%20propagated%20to%20the%20creator%20of%20this%20actor.%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20True%0A%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20If%20a%20%60MeshFailure%60%20is%20not%20handled%20by%20any%20%60__supervise__%60%20in%20the%20supervision%20tree%2C%20it%20will%0A%20%20%20%20reach%20the%20client%2C%20where%20%60monarch.actor.unhandled_fault_hook%60%20will%20be%20called%20with%20the%0A%20%20%20%20%60MeshFailure%60%20object.%20By%20default%2C%20this%20function%20crashes%20the%20client%20process%20with%20exit%20code%201.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(MeshFailure)%3A%0A%20%20%20%20import%20monarch.actor%20as%20_monarch_actor%0A%0A%20%20%20%20def%20my_unhandled_fault_hook(failure%3A%20MeshFailure)%20-%3E%20None%3A%0A%20%20%20%20%20%20%20%20print(f%22Mesh%20failure%20was%20not%20handled%3A%20%7Bfailure%7D%22)%0A%0A%20%20%20%20_monarch_actor.unhandled_fault_hook%20%3D%20my_unhandled_fault_hook%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Supervision%20Trees%3A%20Centralized%20Error%20Surfacing%0A%0A%20%20%20%20Try%2Fexcept%20works%20when%20the%20**caller**%20catches%20failures.%20But%20what%20about%20failures%0A%20%20%20%20you%20don't%20directly%20trigger%20%E2%80%94%20a%20child%20actor%20crashing%20in%20the%20background%2C%20a%0A%20%20%20%20cascading%20failure%20deep%20in%20a%20hierarchy%3F%0A%0A%20%20%20%20Monarch's%20answer%20is%20the%20__supervise__%20API.%20When%20an%20actor%20spawns%20children%2C%20it%20becomes%0A%20%20%20%20their%20supervisor.%20If%20a%20child%20fails%2C%20the%20supervisor's%20%60__supervise__%60%20method%20is%0A%20%20%20%20called%20with%20a%20%60MeshFailure%60%20describing%20what%20went%20wrong.%0A%0A%20%20%20%20Think%20of%20it%20like%20a%20management%20chain%3A%20when%20an%20employee%20hits%20a%20problem%20they%20can't%0A%20%20%20%20solve%2C%20it%20escalates%20to%20their%20manager.%20The%20manager%20can%20handle%20it%20(return%20%60True%60)%0A%20%20%20%20or%20escalate%20further%20(return%20%60False%60).%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Aasync%20def%20_(Actor%2C%20MeshFailure%2C%20endpoint%2C%20this_host)%3A%0A%20%20%20%20import%20asyncio%0A%0A%20%20%20%20class%20ActorCrash(BaseException)%3A%0A%20%20%20%20%20%20%20%20pass%0A%0A%20%20%20%20class%20FragileWorker(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22A%20worker%20that%20crashes%20when%20asked.%22%22%22%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20async%20def%20do_work(self)%20-%3E%20str%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20raise%20ActorCrash(%22GPU%20memory%20error%20on%20this%20worker!%22)%0A%0A%20%20%20%20class%20Supervisor(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Spawns%20and%20supervises%20children.%20Catches%20their%20failures%20automatically.%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20child_procs)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Supervisor%20owns%20these%20children%20because%20it%20calls%20spawn()%0A%20%20%20%20%20%20%20%20%20%20%20%20self.workers%20%3D%20child_procs.spawn(%22fragile%22%2C%20FragileWorker)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.failure_log%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20self._supervised%20%3D%20asyncio.Event()%0A%0A%20%20%20%20%20%20%20%20def%20__supervise__(self%2C%20failure%3A%20MeshFailure)%20-%3E%20bool%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Called%20automatically%20when%20an%20owned%20child%20actor%20fails.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20self.failure_log.append(str(failure))%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%5BSupervisor%5D%20Caught%20failure%3A%20%7Bfailure%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20self._supervised.set()%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20True%20%20%23%20Handled%20%E2%80%94%20don't%20propagate%20further%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20async%20def%20crash_a_child(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Tell%20the%20child%20to%20crash%2C%20then%20wait%20for%20supervision%20to%20fire.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20self.workers.do_work.broadcast()%20%20%23%20fire-and-forget%20%E2%80%94%20triggers%20supervision%0A%20%20%20%20%20%20%20%20%20%20%20%20await%20asyncio.wait_for(self._supervised.wait()%2C%20timeout%3D30)%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20async%20def%20get_failure_log(self)%20-%3E%20list%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Return%20failures%20caught%20by%20__supervise__%20(as%20strings).%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20list(self.failure_log)%0A%0A%20%20%20%20%23%20Create%20two%20separate%20proc%20meshes%20(supervisor%20and%20children%20MUST%20be%20on%20different%20meshes)%0A%20%20%20%20supervisor_procs%20%3D%20this_host().spawn_procs(per_host%3D%7B%22gpus%22%3A%201%7D)%0A%20%20%20%20child_procs%20%3D%20this_host().spawn_procs(per_host%3D%7B%22gpus%22%3A%201%7D)%0A%0A%20%20%20%20%23%20Spawn%20supervisor%2C%20passing%20child%20procs%20for%20it%20to%20own%0A%20%20%20%20supervisor%20%3D%20supervisor_procs.spawn(%22supervisor%22%2C%20Supervisor%2C%20child_procs)%0A%0A%20%20%20%20%23%20Tell%20supervisor%20to%20trigger%20the%20child%20%E2%80%94%20broadcast()%20means%20the%20error%20has%0A%20%20%20%20%23%20no%20caller%20to%20return%20to%2C%20so%20the%20actor%20crashes%20and%20supervision%20fires%0A%20%20%20%20await%20supervisor.crash_a_child.call_one()%0A%0A%20%20%20%20%23%20Query%20the%20supervisor's%20failure%20log%0A%20%20%20%20failures%20%3D%20await%20supervisor.get_failure_log.call_one()%0A%20%20%20%20print(f%22%5Cn%3D%3D%3D%20Supervisor's%20failure%20log%20(%7Blen(failures)%7D%20entries)%20%3D%3D%3D%22)%0A%20%20%20%20for%20j%2C%20f%20in%20enumerate(failures)%3A%0A%20%20%20%20%20%20%20%20print(f%22%20%20%5B%7Bj%7D%5D%20%7Bf%7D%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20What%20Just%20Happened%0A%0A%20%20%20%20The%20supervisor%20**owns**%20the%20%60FragileWorker%60%20because%20it%20called%20%60spawn()%60.%20When%0A%20%20%20%20the%20child%20raised%20%60ActorCrash%60%20(a%20%60BaseException%60)%2C%20the%20actor%20died%20and%20Monarch%0A%20%20%20%20delivered%20a%20%60MeshFailure%60%20to%20the%20supervisor's%20%60__supervise__%60%20method.%0A%0A%0A%20%20%20%20Key%20points%3A%0A%0A%20%20%20%20-%20%60__supervise__%60%20receives%20a%20%60MeshFailure%60%0A%20%20%20%20-%20Return%20%60True%60%20-%3E%20%22I%20handled%20it%22%20(stops%20propagation%20up%20the%20tree)%0A%20%20%20%20-%20Return%20%60False%60%20-%3E%20escalate%20to%20the%20supervisor's%20supervisor%0A%20%20%20%20-%20If%20no%20one%20handles%20it%2C%20the%20failure%20reaches%20the%20client%20as%20an%20unhandled%20fault%0A%0A%20%20%20%20This%20allows%20actors%20to%20define%20policies%20of%20what%20to%20do%20if%20Actors%20they%20own%20fail.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20From%20One%20Supervisor%20to%20a%20Tree%0A%0A%20%20%20%20You%20just%20saw%20a%20single%20supervisor%20catch%20one%20child's%20failure.%20Now%20imagine%20this%0A%20%20%20%20at%20scale%20%E2%80%94%20supervision%20forms%20a%20**tree**%20where%20failures%20propagate%20upward%3A%0A%0A%20%20%20%20%60%60%60%0A%20%20%20%20Your%20Script%20(root)%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20Orchestrator%0A%20%20%20%20%20%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20TrainerSupervisor%0A%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20Trainer%20Rank%200%20%20%E2%9C%93%0A%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20Trainer%20Rank%201%20%20%E2%9C%93%0A%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20Trainer%20Rank%202%20%20%E2%9C%97%20OOM%0A%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20GeneratorSupervisor%0A%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20Generator%200%20%20%20%20%20%E2%9C%93%0A%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20Generator%201%20%20%20%20%20%E2%9C%93%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20When%20Trainer%20Rank%202%20crashes%2C%20%60TrainerSupervisor.__supervise__%60%20fires%20first.%0A%20%20%20%20If%20it%20returns%20%60True%60%2C%20the%20failure%20is%20handled%20locally%20%E2%80%94%20the%20Orchestrator%20never%0A%20%20%20%20even%20knows.%20If%20it%20returns%20%60False%60%2C%20the%20TrainerSupervisor%20itself%20fails%2C%20and%20the%0A%20%20%20%20event%20propagates%20up%20to%20the%20Orchestrator.%0A%0A%20%20%20%20This%20is%20just%20like%20exception%20handling%20in%20a%20call%20stack%3A%0A%0A%20%20%20%20%60%60%60python%0A%20%20%20%20try%3A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Orchestrator.__supervise__%0A%20%20%20%20%20%20%20%20try%3A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20TrainerSupervisor.__supervise__%0A%20%20%20%20%20%20%20%20%20%20%20%20raise%20OOMError()%20%20%20%20%20%20%23%20Trainer%20Rank%202%20crashes%0A%20%20%20%20%20%20%20%20except%20OOMError%3A%20%20%20%20%20%20%20%20%20%20%23%20%20%20-%3E%20handle%20or%20re-raise%0A%20%20%20%20%20%20%20%20%20%20%20%20handle_or_reraise()%0A%20%20%20%20except%20Exception%3A%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20%20%20-%3E%20Orchestrator%20handles%20or%20crashes%0A%20%20%20%20%20%20%20%20handle_or_crash()%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20The%20payoff%3A%20instead%20of%20grepping%20through%2016%2C000%20log%20files%2C%20you%20get%20**one%0A%20%20%20%20structured%20chain**%20showing%20exactly%20what%20failed%20and%20how%20the%20failure%20propagated.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20TorchFT%3A%20Fault-Tolerant%20Training%20at%20Scale%0A%0A%20%20%20%20Recall%20the%20419%20interruptions%20from%20Notebook%201%20%E2%80%94%20at%20that%20scale%2C%20restarting%0A%20%20%20%20the%20entire%20job%20each%20time%20is%20unacceptable.%20You%20need%20training%20to%20**continue%0A%20%20%20%20with%20healthy%20replicas**%20while%20failed%20ones%20recover.%0A%0A%20%20%20%20The%20result%3A%20**60%25%20faster%20recovery**%20than%20full%20SLURM%20restarts%2C%20with%20process%0A%20%20%20%20failures%20recovering%20in%20**~90%20seconds**.%20Here's%20how.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20How%20TorchFT%20Works%0A%0A%20%20%20%20TorchFT%20provides%20quorum-based%20training%20%E2%80%94%20instead%20of%20stopping%20the%20whole%20job%0A%20%20%20%20when%20a%20replica%20fails%2C%20the%20remaining%20replicas%20continue%3A%0A%0A%20%20%20%20%60%60%60%0A%20%20%20%20Traditional%20Training%3A%0A%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%20%20%20%20%E2%94%82Replica%200%E2%94%82%20%E2%94%82Replica%201%E2%94%82%20%E2%94%82Replica%202%E2%94%82%20%E2%94%82Replica%203%E2%94%82%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%B4%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%B4%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%96%BC%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20All-reduce%20every%20step%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Single%20failure%20%E2%86%92%20restart%20everything%0A%0A%20%20%20%20TorchFT%20Quorum-Based%20Training%3A%0A%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%20%20%20%20%E2%94%82Replica%200%E2%94%82%20%E2%94%82Replica%201%E2%94%82%20%E2%94%82Replica%202%E2%94%82%20%E2%94%82Replica%203%E2%94%82%0A%20%20%20%20%E2%94%82%20healthy%20%E2%94%82%20%E2%94%82%20%20FAILED%20%E2%94%82%20%E2%94%82%20healthy%20%E2%94%82%20%E2%94%82%20healthy%20%E2%94%82%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%AC%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%B4%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%96%BC%0A%20%20%20%20%20%20%20%20%20%20%20%20Quorum%20shrinks%20to%203%20replicas%0A%20%20%20%20%20%20%20%20%20%20%20%20Training%20continues%20without%20stopping%0A%20%20%20%20%20%20%20%20%20%20%20%20Failed%20replica%20recovers%20and%20rejoins%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20On%20failure%2C%20TorchFT%20catches%20collective%20errors%20through%20its%20own%0A%20%20%20%20ManagedProcessGroup%2C%20isolates%20the%20failure%20to%20a%20single%20replica%20group%2C%20and%0A%20%20%20%20continues%20training%20without%20restarting%20the%20entire%20job.%0A%0A%20%20%20%20A%20Lighthouse%20service%20(Rust%20gRPC)%20coordinates%20quorum%20membership%20via%0A%20%20%20%20heartbeats%20(~100ms)%2C%20while%20a%20Manager%20handles%20checkpoint%20recovery%20when%0A%20%20%20%20replicas%20join%20or%20leave.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20Monarch%20%2B%20TorchFT%3A%20Separation%20of%20Concerns%0A%0A%20%20%20%20TorchFT%20handles%20**step-level%20fault%20tolerance**%20%E2%80%94%20catching%20errors%20mid-training%0A%20%20%20%20and%20shrinking%20the%20quorum.%20Monarch%20handles%20**orchestration-level%20recovery**%20%E2%80%94%0A%20%20%20%20respawning%20crashed%20replicas%2C%20managing%20job%20allocation%2C%20and%20escalating%20from%0A%20%20%20%20fast%20process%20restarts%20to%20full%20reallocation%20when%20needed.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20Case%20Study%3A%20Qwen3-32B%20Training%20with%20Fault%20Injection%0A%0A%20%20%20%20We%20ran%20this%20on%20a%20**30%20node%20(240%20H100s)%20Coreweave%20cluster**%2C%20training%0A%20%20%20%20Qwen3-32B%20using%20torchtitan%20and%20TorchFT.%0A%0A%20%20%20%20**Test%20conditions%3A**%0A%0A%20%20%20%20-%20Failures%20injected%20at%20~3-minute%20intervals%2C%20100%20total%20events%0A%20%20%20%20-%20Multiple%20failure%20modes%3A%20segfaults%2C%20process%20kills%2C%20NCCL%20abort%2C%20host%0A%20%20%20%20%20%20eviction%2C%20GIL%20deadlock%0A%0A%20%20%20%20**Results%3A**%0A%0A%20%20%20%20%7C%20Metric%20%7C%20Result%20%7C%0A%20%20%20%20%7C--------%7C--------%7C%0A%20%20%20%20%7C%20Recovery%20speed%20vs%20full%20SLURM%20restart%20%7C%20**60%25%20faster**%20%7C%0A%20%20%20%20%7C%20Avg%20recovery%20time%20(process%20failures)%20%7C%20**90%20seconds**%20%7C%0A%20%20%20%20%7C%20Avg%20recovery%20time%20(machine%20failures)%20%7C%20**2.5%20minutes**%20%7C%0A%0A%20%20%20%20**Why%20the%20improvement%3F**%0A%20%20%20%20Monarch%20allows%20for%20configurable%20recovery%20strategies%20based%20on%20failure%20type%20%E2%80%94%0A%20%20%20%20we%20avoid%20unnecessary%20job%20rescheduling%20by%20attempting%20fast%20process-level%0A%20%20%20%20restarts%20first.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20For%20more%20details%20on%20error%20handling%20in%20Monarch%2C%20see%20the%0A%20%20%20%20%5BError%20Handling%20in%20Meshes%5D(https%3A%2F%2Fmeta-pytorch.org%2Fmonarch%2Factors.html%23error-handling-in-meshes)%0A%20%20%20%20documentation.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Summary%0A%0A%20%20%20%20**Key%20takeaways%3A**%0A%0A%20%20%20%201.%20**Try%2Fexcept%20first**%3A%20The%20canonical%20pattern%20covers%2090%25%20of%20cases%0A%20%20%20%202.%20**Supervision%20trees**%3A%20Centralized%20error%20surfacing%20%E2%80%94%20one%20place%20to%20see%0A%20%20%20%20%20%20%20what%20went%20wrong%0A%20%20%20%203.%20**Quorum-based%20training**%3A%20Continue%20with%20healthy%20replicas%20while%20failed%0A%20%20%20%20%20%20%20ones%20recover%0A%20%20%20%204.%20**Monarch%20%2B%20TorchFT**%3A%20Orchestration-level%20recovery%20%2B%20step-level%20fault%0A%20%20%20%20%20%20%20tolerance%0A%0A%20%20%20%20These%20three%20patterns%20compose%20%E2%80%94%20try%2Fexcept%20is%20your%20first%20line%20of%20defense%2C%0A%20%20%20%20supervision%20gives%20you%20visibility%2C%20and%20TorchFT%20handles%20training-specific%0A%20%20%20%20recovery%20at%20scale.%0A%0A%20%20%20%20We've%20built%20patterns%20to%20handle%20failures.%20Next%3A%20putting%20it%20all%20together%20%E2%80%94%0A%20%20%20%20services%2C%20weight%20sync%2C%20and%20async%20RL%20loops.%0A%0A%20%20%20%20---%0A%0A%20%20%20%20**Previous%3A**%20%5BNB02%20%E2%80%94%20Interactive%20DevX%5D(.%2F02_interactive_devx.html)%20%C2%B7%20**Next%3A**%20%5BNB04%20%E2%80%94%20Distributed%20Tensors%5D(.%2F04_distributed_tensors.html)%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A
</marimo-code>

<marimo-code-hash hidden="">fb6666bc1f11b79914350b483ff1a824</marimo-code-hash>
</body>
</html>
