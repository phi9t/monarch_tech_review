<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/apple-touch-icon.png" />
    <link rel="manifest" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        const scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          // Guard against race condition where iframe isn't ready
          if (!obj.contentWindow?.document?.documentElement) {
            return;
          }
          const element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          const hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          const newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((_entries) => {
          setHeight();
        });
        // Only observe if iframe content is ready
        if (obj.contentWindow?.document?.body) {
          resizeObserver.observe(obj.contentWindow.document.body);
        }
      }
    </script>
    <marimo-filename hidden>06b_weight_sync_deep_dive.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>06b weight sync deep dive</title>
    <script type="module" crossorigin crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/index-CD6Gw4UH.js"></script>
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/preload-helper-D2MJg03u.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/clsx-D8GwTfvk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/cn-BKtXLv3a.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/chunk-LvLJmgfZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/react-Bj1aDYRI.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/compiler-runtime-B3qBwwSJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/jsx-runtime-ZmTK25f3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/badge-DX6CQ6PA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/hotkeys-BHHWjLlp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useEventListener-Cb-RVVEn.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/button-CZ3Cs4qb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/react-dom-CSu739Rf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/Combination-BAEdC-rz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/menu-items-BMjcEb2j.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-DwV58Fb1.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/createLucideIcon-BCdY6lG5.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/check-Dr3SxUsb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/x-ZP5cObgf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/select-BVdzZKAh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/tooltip-CMQz28hC.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/use-toast-BDYuj3zG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_Uint8Array-BGESiCQL.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_baseIsEqual-B9N9Mw_N.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useEvent-BhXAndur.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/invariant-CAG_dYON.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_baseFor-Duhs3RiJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/merge-BBX6ug-N.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/zod-H_cgTO0M.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/utils-YqBXNpsM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/Deferred-DxQeE5uh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/uuid-DXdzqzcr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/DeferredRequestRegistry-CMf25YiV.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/constants-B6Cb__3x.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/session-BOFn9QrD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/config-Q0O7_stz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/requests-B4FYHTZl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/isSymbol-BGkTcW3U.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/toString-DlRqgfqz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_hasUnicode-CWqKLxBC.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/assertNever-CBU83Y6o.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_arrayReduce-TT0iOGKY.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useLifecycle-ClI_npeg.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useNonce-CS26E0hA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useTheme-DQozhcp1.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/once-Bul8mtFs.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/capabilities-MM7JYRxj.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/createReducer-B3rBsy4P.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/paths-BzSgteR-.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-DBwNzi3C.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-ChS0Dc_R.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-CtsanegT.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-Dcqqg9UU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-sMh6mJ2d.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-Btv5Rh1v.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-bBwmhqty.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-CoCQUAeM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-Gqv0jSNr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/stex-jWatZkll.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/toDate-DETS9bBd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/cjs-CH5Rj0g8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_baseProperty-NKyJO2oh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/now-6sUe0ZdD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/debounce-B3mjKxHe.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/toInteger-CDcO32Gx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/database-zap-k4ePIFAU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/main-U5Goe76G.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/cells-DPp5cDaO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/spinner-DA8-7wQv.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/chevron-right--18M_6o9.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dropdown-menu-ldcmQvIV.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/kbd-Cm6Ba9qg.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/renderShortcut-BckyRbYt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/multi-map-DxdLNTBd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/alert-BOoN6gJ1.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/card-OlSjYhmd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/alert-dialog-BW4srmS0.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dialog-eb-NieZw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dist-CDXJRSCj.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/label-E64zk6_7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useDebounce-7iEVSqwM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/textarea-CRI7xDBj.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/numbers-D7O23mOZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/SSRProvider-BIDQNg9Q.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/context-BfYAMNLF.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useNumberFormatter-Db6Vjve5.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/usePress-C__vuri5.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/input-DUrq2DiR.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/links-7AQBmdyV.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/popover-CH1FzjxU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/switch-dWLWbbtg.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/table-DScsXgJW.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/mode-Bn7pdJvO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useAsyncData-BMGLSTg8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/errors-TZBmrJmc.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/error-banner-B9ts0mNl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/copy-DHrHayPa.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/memoize-BCOZVFBt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/get-6uJrSKbw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/capitalize-CmNnkG9y.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/copy-D-8y6iMN.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/plus-B7DF33lD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/refresh-cw-Dx8TEWFP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/trash-2-DDsWrxuJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/triangle-alert-CebQ7XwA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/ai-model-dropdown-Dk2SdB3C.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/defaultLocale-JieDVWC_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/precisionRound-CU2C3Vxx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/defaultLocale-BLne0bXb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/vega-loader.browser-DXARUlxo.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/tooltip-DxKBXCGp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/ErrorBoundary-B9Ifj8Jf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useInstallPackage-D4fX0Ee_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/ImperativeModal-BNN1HA7x.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/cell-link-B9b7J8QK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/datasource-CtyqtITR.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/state-D4T75eZb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/MarimoErrorOutput-Lf9P8Fhl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/copy-icon-v8ME_JKB.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/html-to-image-CIQqSu-S.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/focus-C1YokgL7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/LazyAnyLanguageCodeMirror-DgZ8iknE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/chunk-5FQGJX7Z-DPlx2kjA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/katex-CDLTCvjQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/markdown-renderer-DJy8ww5d.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/command-2ElA5IkO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/download-os8QlW6l.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useRunCells-D2HBb4DB.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/purify.es-DZrAQFIu.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/RenderHTML-D-of_-s7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useIframeCapabilities-B_pQb20b.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/formats-CobRswjh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/en-US-CCVfmA-q.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/isValid-DDt9wNjK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/dates-CrvjILe3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/maps-D2_Mq1pZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/extends-BiFDv3jB.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/emotion-is-prop-valid.esm-C59xfSYt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useDateFormatter-CqhdUl2n.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/range-D2UKkEg-.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/table-CfDbAm78.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/JsonOutput-PE5ko4gi.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useDeleteCell-DdRX94yC.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/icons-CCHmxi8d.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/process-output-ByfLnk6j.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/blob-D-eV0cU3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/objectWithoutPropertiesLoose-DfWeGRFv.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/esm-Bmu2DhPy.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/file-Ch78NKWp.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/play-GLWQQs7F.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/add-cell-with-ai-e_HMl7UU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/isEmpty-CgX_-6Mt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/bot-message-square-B2ThzDUZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/chat-display--jAB7huF.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/chart-no-axes-column-qvVRjhv1.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/square-function-B6mgCeFJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/spec-Ch0xnJY4.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/column-preview-CXjSXUhP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/toggle-zVW4FXNz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/globals-BgACvYmr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/share-ipf2hrOh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_baseSet-5Rdwpmr3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/react-resizable-panels.browser.esm-Da3ksQXL.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/utilities.esm-dm9SQStE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/floating-outline-BtdqbkUq.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useAddCell-CmuX2hOk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/eye-off-AK_9uodG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/readonly-python-code-WjTf6Pdd.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/file-video-camera-C3wGzBnE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/types-BRfQN3HL.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/refresh-ccw-DN_xCV6A.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/form-BidPUZUn.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/field-CySaBlkz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useBoolean-Ck_unDZw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/useDeepCompareMemoize-5OUgerQ3.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/types-C1UhS3qM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/prop-types-DaaA-ptl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/es-BYgU_srD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/hasIn-CycJImp8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/_baseFlatten-CUZNxU8H.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/flatten-D-7VEN0q.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/pick-B_6Qi5aM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/code-xml-CgN_Yig7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/download-Dg7clfkc.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/square-CuJ72M8f.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/settings-OBbrbhij.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/bundle.esm-i_UbZC0w.js">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/cells-jmgGt1lS.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/markdown-renderer-DdDKmWlR.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/JsonOutput-B7vuddcd.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.19.9/dist/assets/index-CeUwN_0i.css">
  
<script data-marimo="true">
    window.__MARIMO_STATIC__ = {};
    window.__MARIMO_STATIC__.files = {};
</script>
</head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "06b_weight_sync_deep_dive.py",
            "mode": "read",
            "version": "0.19.9",
            "serverToken": "static",
            "config": {"ai": {"custom_providers": {}, "models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false, "signature_hint_on_typing": false}, "diagnostics": {"sql_linter": true}, "display": {"cell_output": "below", "code_editor_font_size": 14, "dataframes": "rich", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "medium", "reference_highlighting": true, "theme": "light"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": false}}, "mcp": {"mcpServers": {}, "presets": []}, "package_management": {"manager": "uv"}, "runtime": {"auto_instantiate": false, "auto_reload": "off", "default_csv_encoding": "utf-8", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "after_delay", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"sql_output": "auto", "width": "medium"},
            "view": {"showAppCode": true},
            "notebook": {"cells": [{"code": "import marimo as mo", "code_hash": "1d0db38904205bec4d6f6f6a1f6cec3e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hbol", "name": "_"}, {"code": "# Shared imports for the notebook\nimport time\nimport torch\nfrom monarch.actor import Actor, endpoint, this_host, current_rank\nfrom monarch.rdma import RDMABuffer, RDMAAction, is_rdma_available", "code_hash": "c7ac4d3804661f4817e054cbe05bc1c5", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "MJUe", "name": "_"}, {"code": "mo.md(r\"\"\"\n# RDMA Deep Dive\n\nNotebook 06 covered weight synchronization end-to-end: why RDMA matters for async RL,\nthe magic pointer pattern, circular buffers, and re-sharding. We used `RDMABuffer` and\n`read_into()` as black boxes \u2014 call the API, weights appear.\n\nThis notebook goes deeper into how RDMA actually works. We'll walk through the ibverbs\nprimitives that power every transfer, understand the costs that separate a fast\nimplementation from a slow one, and see the concrete patterns for managing RDMA buffers\nin production.\n\n**The central question: where do the milliseconds go?**\n\n1. **ibverbs Internals** \u2014 Queue Pairs, Memory Registration, Completion Queues\n2. **RDMA Buffer Patterns** \u2014 Three approaches to managing registration and transfers\n\n*We focus on **ibverbs** because that's what Monarch's RDMA subsystem supports today\n(InfiniBand and RoCE via Mellanox/NVIDIA ConnectX NICs). EFA (AWS Elastic Fabric Adapter)\nis a relevant transport but not yet supported \u2014 it's actively being worked on.*\n\"\"\")", "code_hash": "a923795fb3d99ee7dc4a09d50761fa4d", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "vblA", "name": "_"}, {"code": "mo.md(r\"\"\"\n## 1. ibverbs Internals\n\nRDMA (Remote Direct Memory Access) lets one machine read/write another machine's memory\ndirectly, bypassing the kernel and CPU on both sides.\n\n### The ibverbs Stack\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Application (PyTorch, Monarch, etc.)                   \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  libibverbs  (userspace RDMA API)                       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  Provider driver (mlx5, efa, rxe, etc.)                 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  Hardware (InfiniBand NIC, RoCE NIC, etc.)              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\nWe focus on **InfiniBand** and **RoCE** (RDMA over Converged Ethernet) \u2014 the two\ntransports Monarch supports today via the ibverbs API.\n\n### Key RDMA Operations\n\n| Operation | Description |\n|-----------|-------------|\n| `RDMA_WRITE` | Write to remote memory (one-sided) |\n| `RDMA_READ` | Read from remote memory (one-sided) |\n| `SEND/RECV` | Two-sided messaging (like TCP) |\n\nThe magic is in `RDMA_WRITE` and `RDMA_READ` - they're **one-sided**:\n- Remote CPU is not involved\n- Remote application doesn't need to call anything\n- NIC handles everything in hardware\n\n### Memory Registration\n\nBefore RDMA, memory must be **registered** with the NIC:\n\n```python\n# Conceptually (actual ibverbs API is in C)\nmr = rdma_register_memory(buffer, size)\n# Returns:\n#   - lkey: local access key (for local operations)\n#   - rkey: remote access key (share with remote peer)\n#   - addr: physical/virtual address\n```\n\nThe `(addr, rkey)` pair is a **remote-accessible pointer**. Share it with a peer,\nand they can read/write your memory directly.\n\n### Queue Pair Setup\n\nBefore any RDMA operations, you need to establish a **Queue Pair (QP)** between\nsender and receiver. This is a one-time connection setup:\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                           \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Sender    \u2502                           \u2502  Receiver   \u2502\n\u2502             \u2502                           \u2502             \u2502\n\u2502  Create QP  \u2502 \u2500\u2500\u2500 exchange QP info \u2500\u2500\u2500\u25ba \u2502  Create QP  \u2502\n\u2502  (qp_num,   \u2502 \u25c4\u2500\u2500 (qp_num, lid, gid) \u2500\u2500 \u2502             \u2502\n\u2502   lid, gid) \u2502                           \u2502             \u2502\n\u2502             \u2502                           \u2502             \u2502\n\u2502  Move QP to \u2502                           \u2502  Move QP to \u2502\n\u2502  RTR \u2192 RTS  \u2502                           \u2502  RTR \u2192 RTS  \u2502\n\u2502             \u2502                           \u2502             \u2502\n\u2502  Now ready  \u2502 \u2550\u2550\u2550 RDMA operations \u2550\u2550\u2550\u2550\u25ba \u2502  Now ready  \u2502\n\u2502  for RDMA!  \u2502                           \u2502  for RDMA!  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                           \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\nThis is where **Monarch actors** shine. Because you can spawn arbitrary actors,\nyou can create **RDMA Manager actors** that:\n- Initialize QPs on their respective hosts\n- Exchange QP info via actor messages\n- Manage the connection lifecycle\n\n```python\n# Monarch pattern: RDMA managers as actors\nclass RDMAManager(Actor):\n    def __init__(self):\n        self.qp = create_queue_pair()\n        self.qp_info = get_qp_info(self.qp)  # (qp_num, lid, gid)\n\n    @endpoint\n    def get_qp_info(self) -\u003E QpInfo:\n        return self.qp_info\n\n    @endpoint\n    def connect(self, remote_qp_info: QpInfo):\n        # Transition QP: INIT \u2192 RTR \u2192 RTS\n        connect_qp(self.qp, remote_qp_info)\n\n# Setup: exchange QP info via actor messages, then RDMA is ready\ntrainer_info = trainer_rdma.get_qp_info.call_one().get()\ngenerator_rdma.connect.call_one(trainer_info).get()\n```\n\nThe actor abstraction makes RDMA connection management natural and composable.\n\n### Completion Queues (CQs)\n\nHow does the initiator know an operation finished? Every QP is associated with a\n**Completion Queue (CQ)**. When the NIC finishes an\nRDMA operation, it posts a **completion event** to the CQ:\n\n```\nApp: post RDMA_READ to Send Queue\n          \u2193\nNIC: executes the read (bypasses remote CPU)\n          \u2193\nNIC: posts completion to CQ\n          \u2193\nApp: poll CQ \u2192 \"done, 4096 bytes transferred\"\n```\n\nMonarch's Rust layer (`RdmaManagerActor`) handles CQ polling internally. When you\ncall `.get()` on an RDMA future, you're ultimately waiting for a CQ completion event.\nThis is why RDMA is \"one-sided\" but not \"zero-sided\" - the *initiator* still needs\nto know when the transfer is done.\n\"\"\")", "code_hash": "5c1dab7fc56bc2617c00fd009010a5d8", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "bkHC", "name": "_"}, {"code": "mo.md(r\"\"\"\n### Monarch Using Monarch: RdmaController\n\nHere's the cool part: **Monarch uses itself** to manage RDMA infrastructure. Looking at\nthe actual Python code in `monarch/_src/rdma/rdma.py`:\n\n```python\n# From Monarch's RDMA implementation\nfrom monarch._src.actor.proc_mesh import get_or_spawn_controller\n\nclass RdmaController(Actor):\n    '''Singleton controller that coordinates RDMA initialization.'''\n\n    def __init__(self):\n        # Track which proc meshes have RDMA initialized\n        self._manager_futures: dict[ProcMesh, Future[RdmaManager]] = {}\n\n    @endpoint\n    async def init_rdma_on_mesh(self, proc_mesh: ProcMesh) -\u003E None:\n        '''Lazily initialize RDMA on a proc mesh.'''\n        if proc_mesh not in self._manager_futures:\n            self._manager_futures[proc_mesh] = Future(\n                coro=RdmaManager.create(proc_mesh)\n            )\n        await self._manager_futures[proc_mesh]\n\n# Cached initialization - only runs once per process\n@functools.cache\ndef _ensure_init_rdma_manager():\n    async def task():\n        controller = await get_or_spawn_controller(\"rdma_controller\", RdmaController)\n        await controller.init_rdma_on_mesh.call_one(current_proc_mesh())\n    return spawn_task(task())\n```\n\nThis is **Monarch building Monarch** - the RDMA subsystem uses the same patterns:\n\n- `get_or_spawn_controller(\"rdma_controller\", RdmaController)` ensures one global controller\n- The controller lazily initializes RDMA managers per proc mesh\n- `@functools.cache` ensures we only bootstrap once per process\n- Under the hood, the actual RDMA operations are in Rust (`RdmaManagerActor`)\n\nIt's actors all the way down.\n\nNow that we understand the primitives - QPs, MRs, CQs, and how Monarch wraps them -\nthe next question is: **what's the cost of getting them wrong?** Memory registration\nturns out to be the biggest hidden tax.\n\"\"\")", "code_hash": "33f2b95373a6bf0ddfc006121040d3dc", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "lEQa", "name": "_"}, {"code": "mo.md(r\"\"\"\n## 2. RDMA Buffer Patterns\n\nMemory registration is the hidden cost of RDMA. Before the NIC can read or write a\nbuffer, that buffer must be **registered** \u2014 the OS pins its physical pages and creates\nDMA mappings so the NIC can access them directly. This can take milliseconds for large\nbuffers.\n\nThe question isn't *whether* to pay this cost \u2014 it's *when and how often*. We'll\nlook at three patterns:\n\n| Pattern | Registration | Transfer | Trade-off |\n|---------|-------------|----------|-----------|\n| **Naive** | Every call | Per-buffer | Baseline \u2014 pays MR cost every step |\n| **Contiguous** | Once at init | One bulk read | Fastest, but requires copying to a contiguous region |\n| **Scattered + RDMAAction** | Once at init | Batched plan | Practical \u2014 works with non-contiguous layouts |\n\nThe benchmark at the end shows the performance difference.\n\"\"\")", "code_hash": "1cb8a360047818b1f85f4f3fba2e2064", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "PKri", "name": "_"}, {"code": "mo.md(r\"\"\"\n### Pattern 1: Naive\n\nCreate a new `RDMABuffer` on every transfer \u2014 pays memory registration cost each time:\n\"\"\")", "code_hash": "a974f9ee74e9e0cf72f1a34b5ea32cde", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Xref", "name": "_"}, {"code": "class NaiveSender(Actor):\n    \"\"\"Creates new RDMABuffer handles every transfer. Expensive!\"\"\"\n\n    def __init__(self, layer_sizes: list):\n        self.layer_sizes = layer_sizes\n        self.layers = [torch.zeros(size, dtype=torch.float32) for size in layer_sizes]\n        for i, layer in enumerate(self.layers):\n            layer.fill_(float(i + 1))\n\n    @endpoint\n    def get_fresh_handles(self) -\u003E list:\n        handles = []\n        for size, layer in zip(self.layer_sizes, self.layers):\n            byte_view = layer.view(torch.uint8).flatten()\n            handles.append((size, RDMABuffer(byte_view)))\n        return handles\n\n\nclass NaiveReceiver(Actor):\n    \"\"\"Receives from naive sender - pays MR cost every step.\"\"\"\n\n    def __init__(self, layer_sizes: list):\n        self.layer_sizes = layer_sizes\n        self.layers = [torch.zeros(size, dtype=torch.float32) for size in layer_sizes]\n        self.rank = current_rank().rank\n\n    @endpoint\n    def warmup(self, sender: NaiveSender):\n        \"\"\"Force RDMA subsystem init + QP establishment (not timed).\"\"\"\n        handles = sender.get_fresh_handles.call_one().get()\n        for i, (size, handle) in enumerate(handles):\n            byte_view = self.layers[i].view(torch.uint8).flatten()\n            handle.read_into(byte_view).get()\n\n    @endpoint\n    def receive_step(self, sender: NaiveSender) -\u003E dict:\n        start = time.perf_counter()\n        handles = sender.get_fresh_handles.call_one().get()\n        for i, (size, handle) in enumerate(handles):\n            byte_view = self.layers[i].view(torch.uint8).flatten()\n            handle.read_into(byte_view).get()\n        elapsed_ms = (time.perf_counter() - start) * 1000\n        return {\"elapsed_ms\": elapsed_ms}\n\nprint(\"NaiveSender: Re-registers all parameters on every call\")", "code_hash": "4e747c82c13bfc565a6b64491dae29c4", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "SFPL", "name": "_"}, {"code": "mo.md(r\"\"\"\n### Pattern 2: Contiguous Buffer\n\nPack all layers into one buffer, register once \u2014 one MR, one transfer:\n\"\"\")", "code_hash": "7b854cac2c79ad4e1d9543eab8db871c", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "BYtC", "name": "_"}, {"code": "class ContiguousSender(Actor):\n    \"\"\"One buffer, one MR, registered at startup.\"\"\"\n\n    def __init__(self, layer_sizes: list):\n        self.layer_sizes = layer_sizes\n        total_size = sum(layer_sizes)\n\n        # One contiguous buffer\n        self.buffer = torch.zeros(total_size, dtype=torch.float32)\n        offset = 0\n        for i, size in enumerate(layer_sizes):\n            self.buffer[offset : offset + size].fill_(float(i + 1))\n            offset += size\n\n        # Register ONCE at startup\n        byte_view = self.buffer.view(torch.uint8).flatten()\n        self.handle = RDMABuffer(byte_view)\n\n    @endpoint\n    def get_handle(self) -\u003E tuple:\n        return (len(self.buffer), self.handle)  # Same handle every time!\n\n\nclass ContiguousReceiver(Actor):\n    \"\"\"Receives from contiguous sender - one big read.\"\"\"\n\n    def __init__(self, total_size: int):\n        self.buffer = torch.zeros(total_size, dtype=torch.float32)\n        self.rank = current_rank().rank\n\n    @endpoint\n    def warmup(self, sender: ContiguousSender):\n        \"\"\"Force QP establishment (not timed).\"\"\"\n        size, handle = sender.get_handle.call_one().get()\n        byte_view = self.buffer.view(torch.uint8).flatten()\n        handle.read_into(byte_view).get()\n\n    @endpoint\n    def receive_step(self, sender: ContiguousSender) -\u003E dict:\n        start = time.perf_counter()\n        size, handle = sender.get_handle.call_one().get()\n        byte_view = self.buffer.view(torch.uint8).flatten()\n        handle.read_into(byte_view).get()\n        elapsed_ms = (time.perf_counter() - start) * 1000\n        return {\"elapsed_ms\": elapsed_ms}\n\nprint(\"ContiguousSender: Registers once, reuses same handle\")", "code_hash": "285285269c84982aee5ecef9ea23f419", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "RGSE", "name": "_"}, {"code": "mo.md(r\"\"\"\n### Pattern 3: Scattered + RDMAAction\n\nRegister each buffer at init, build a transfer plan once via handshake:\n\n**What is RDMAAction?**\n\nThink of `RDMAAction` as a **transfer plan**. You describe all the reads/writes you want\nto do, then `submit()` executes the whole plan at once:\n\n```python\n# Build the plan once\naction = RDMAAction()\naction.read_into(handle1, local_buffer1)\naction.read_into(handle2, local_buffer2)\naction.read_into(handle3, local_buffer3)\n\n# Execute whenever you want - just one call\naction.submit().get()\n```\n\nThis is useful when you have many scattered buffers (like model parameters) and want\nto batch them into a single logical operation.\n\"\"\")", "code_hash": "8b70f610b9d6fc5825efe5407bb1085e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Kclp", "name": "_"}, {"code": "class ScatteredSender(Actor):\n    \"\"\"Multiple buffers, each registered once at startup.\"\"\"\n\n    def __init__(self, layer_sizes: list):\n        self.layer_sizes = layer_sizes\n        self.layers = []\n        self.handles = []\n\n        for i, size in enumerate(layer_sizes):\n            layer = torch.zeros(size, dtype=torch.float32)\n            layer.fill_(float(i + 1))\n            self.layers.append(layer)\n            # Register ONCE at startup\n            byte_view = layer.view(torch.uint8).flatten()\n            self.handles.append(RDMABuffer(byte_view))\n\n    @endpoint\n    def get_handles(self) -\u003E list:\n        return [(size, handle) for size, handle in zip(self.layer_sizes, self.handles)]\n\nclass ScatteredReceiver(Actor):\n    \"\"\"Receives from scattered sender with RDMAAction batching.\"\"\"\n\n    def __init__(self, layer_sizes: list):\n        self.layer_sizes = layer_sizes\n        self.layers = [torch.zeros(size, dtype=torch.float32) for size in layer_sizes]\n        self.rank = current_rank().rank\n        self.action = None  # Built on handshake\n\n    @endpoint\n    def handshake(self, sender: ScatteredSender):\n        \"\"\"Call once to build the RDMAAction transfer plan.\"\"\"\n        handles = sender.get_handles.call_one().get()\n        self.action = RDMAAction()\n        for i, (size, handle) in enumerate(handles):\n            byte_view = self.layers[i].view(torch.uint8).flatten()\n            self.action.read_into(handle, byte_view)\n        return \"Transfer plan ready\"\n\n    @endpoint\n    def receive_step(self) -\u003E dict:\n        \"\"\"Execute the cached transfer plan.\"\"\"\n        start = time.perf_counter()\n        self.action.submit().get()\n        elapsed_ms = (time.perf_counter() - start) * 1000\n        return {\"elapsed_ms\": elapsed_ms}\n\nprint(\"ScatteredSender: Registers each layer once\")\nprint(\"ScatteredReceiver: handshake() builds plan, receive_step() executes it\")", "code_hash": "cf2558bd29e83f53df64e3e26f3b7b6d", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "emfo", "name": "_"}, {"code": "mo.md(r\"\"\"\n### Running the Benchmark\n\"\"\")", "code_hash": "b0fba7d210a61fd3620db9561c51d39e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hstk", "name": "_"}, {"code": "def run_benchmark():\n    \"\"\"Compare the three approaches over multiple steps.\"\"\"\n    if not is_rdma_available():\n        print(\"\u26a0 RDMA not available on this machine. Skipping benchmark.\")\n        print(\"  Run on an RDMA-capable host to see real results.\")\n        return None\n\n    layer_sizes = [10000, 50000, 20000]  # 80000 floats total\n    total_size = sum(layer_sizes)\n    num_steps = 5\n\n    host = this_host()\n    sender_procs = host.spawn_procs(per_host={\"procs\": 1})\n    receiver_procs = host.spawn_procs(per_host={\"procs\": 1})\n\n    # Spawn all actors\n    naive_sender = sender_procs.spawn(\"naive_s\", NaiveSender, layer_sizes)\n    naive_receiver = receiver_procs.spawn(\"naive_r\", NaiveReceiver, layer_sizes)\n\n    cont_sender = sender_procs.spawn(\"cont_s\", ContiguousSender, layer_sizes)\n    cont_receiver = receiver_procs.spawn(\"cont_r\", ContiguousReceiver, total_size)\n\n    scat_sender = sender_procs.spawn(\"scat_s\", ScatteredSender, layer_sizes)\n    scat_receiver = receiver_procs.spawn(\"scat_r\", ScatteredReceiver, layer_sizes)\n\n    # \u2500\u2500 WARMUP \u2500\u2500\n    # Force the full RDMA initialization chain (RdmaController spawn,\n    # RdmaManagerActor spawn, QP establishment) so benchmarks measure\n    # only what we intend to measure.\n    print(\"Warming up RDMA subsystem...\")\n    naive_receiver.warmup.call_one(naive_sender).get()\n    cont_receiver.warmup.call_one(cont_sender).get()\n    scat_receiver.handshake.call_one(scat_sender).get()\n    scat_receiver.receive_step.call_one().get()  # warm the transfer path\n    print(\"Warmup complete.\\n\")\n\n    print(\"=== RDMA Buffer Pattern Benchmark ===\")\n    print(f\"Transferring {total_size} floats ({total_size * 4 / 1024:.1f} KB) x {num_steps} steps\\n\")\n\n    results = {}\n\n    # Pattern 1: Naive (re-register each step)\n    times = []\n    for step in range(num_steps):\n        r = naive_receiver.receive_step.call_one(naive_sender).get()\n        times.append(r[\"elapsed_ms\"])\n    results[\"Naive\"] = times\n    print(f\"Pattern 1 \u2014 Naive (re-register each step):\")\n    for i, t in enumerate(times):\n        print(f\"  Step {i+1}: {t:.2f}ms\")\n    print(f\"  Average: {sum(times)/len(times):.2f}ms\\n\")\n\n    # Pattern 2: Contiguous (one buffer, one read)\n    times = []\n    for step in range(num_steps):\n        r = cont_receiver.receive_step.call_one(cont_sender).get()\n        times.append(r[\"elapsed_ms\"])\n    results[\"Contiguous\"] = times\n    print(f\"Pattern 2 \u2014 Contiguous (one buffer, one read):\")\n    for i, t in enumerate(times):\n        print(f\"  Step {i+1}: {t:.2f}ms\")\n    print(f\"  Average: {sum(times)/len(times):.2f}ms\\n\")\n\n    # Pattern 3: Scattered + RDMAAction (batched plan)\n    scat_receiver.handshake.call_one(scat_sender).get()  # rebuild plan\n    times = []\n    for step in range(num_steps):\n        r = scat_receiver.receive_step.call_one().get()\n        times.append(r[\"elapsed_ms\"])\n    results[\"Scattered\"] = times\n    print(f\"Pattern 3 \u2014 Scattered + RDMAAction (batched plan):\")\n    for i, t in enumerate(times):\n        print(f\"  Step {i+1}: {t:.2f}ms\")\n    print(f\"  Average: {sum(times)/len(times):.2f}ms\\n\")\n\n    print(\"=== What's Happening ===\")\n    print(\"Naive: Re-registers MRs + sequential per-layer reads (~9ms)\")\n    print(\"Contiguous: One MR, one read \u2014 fewest round trips (~3ms)\")\n    print(\"Scattered + RDMAAction: Pre-built transfer plan (~8ms, Python overhead)\")\n\n    return results\n\nbenchmark_results = run_benchmark()", "code_hash": "d6c47ce9b3f234f75fce19d91cf53566", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "nWHF", "name": "_"}, {"code": "mo.md(r\"\"\"\n**What the benchmark shows:**\n\n- **Naive** (~9ms): Re-registers MRs each step, plus sequential per-layer reads.\n  At larger buffer sizes the MR cost grows, but here it's masked by Python overhead.\n- **Contiguous** (~3ms): One MR, one `read_into()` \u2014 fewest round trips wins.\n  The trade-off: in practice, model parameters aren't contiguous, so you'd need\n  to copy into a contiguous staging buffer first.\n- **Scattered + RDMAAction** (~8ms): Pre-built transfer plan, works with non-contiguous\n  layouts. Currently has Python overhead from the batching logic; lowering `RDMAAction`\n  into Rust will close the gap with Contiguous.\n\nThe key lesson: **minimize round trips.** Whether that means packing into one buffer\nor batching via `RDMAAction`, the goal is the same \u2014 fewer Python-to-Rust-to-NIC\ntransitions per sync.\n\"\"\")", "code_hash": "e26765afa8b40806a593e1a1b764aa87", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "iLit", "name": "_"}, {"code": "mo.md(r\"\"\"\n## Summary\n\nWe started with a question \u2014 *where do the milliseconds go?* \u2014 and traced the answer\nthrough two layers:\n\n1. **ibverbs internals** \u2014 QPs, MRs, CQs: the primitives that make RDMA work, and how\n   Monarch's actor model wraps them into composable connections\n2. **RDMA buffer patterns** \u2014 From naive re-registration to contiguous buffers\n   and batched transfer plans via `RDMAAction` \u2014 minimizing Python round trips\n\nWe focused on **ibverbs** specifically because that's what Monarch's RDMA subsystem\nsupports today (InfiniBand and RoCE via Mellanox/NVIDIA ConnectX NICs). EFA (Elastic\nFabric Adapter, used on AWS) is a relevant transport but not yet supported \u2014 it's\nactively being worked on.\n\nThe main notebook (06) covers the high-level patterns for async RL weight sync \u2014\nmagic pointers, CPU staging, circular buffers, and DTensor re-sharding. This notebook\nshowed the RDMA specifics underneath: what the NIC is actually doing and how to avoid\npaying unnecessary costs on the hot path.\n\n---\n\n**Previous:** [NB06 \u2014 RDMA Weight Sync](./06_rdma_weight_sync.html) \u00b7 **Next:** [NB07 \u2014 Async RL E2E](./07_rl_e2e.html)\n\"\"\")", "code_hash": "e3f328fdfcc04f599be861bb18393742", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ZHCJ", "name": "_"}], "metadata": {"marimo_version": "0.19.9"}, "version": "1"},
            "session": {"cells": [{"code_hash": "1d0db38904205bec4d6f6f6a1f6cec3e", "console": [], "id": "Hbol", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "c7ac4d3804661f4817e054cbe05bc1c5", "console": [], "id": "MJUe", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "a923795fb3d99ee7dc4a09d50761fa4d", "console": [], "id": "vblA", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch1 id=\"rdma-deep-dive\"\u003ERDMA Deep Dive\u003C/h1\u003E\n\u003Cspan class=\"paragraph\"\u003ENotebook 06 covered weight synchronization end-to-end: why RDMA matters for async RL,\nthe magic pointer pattern, circular buffers, and re-sharding. We used \u003Ccode\u003ERDMABuffer\u003C/code\u003E and\n\u003Ccode\u003Eread_into()\u003C/code\u003E as black boxes \u2014 call the API, weights appear.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThis notebook goes deeper into how RDMA actually works. We'll walk through the ibverbs\nprimitives that power every transfer, understand the costs that separate a fast\nimplementation from a slow one, and see the concrete patterns for managing RDMA buffers\nin production.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EThe central question: where do the milliseconds go?\u003C/strong\u003E\u003C/span\u003E\n\u003Col\u003E\n\u003Cli\u003E\u003Cstrong\u003Eibverbs Internals\u003C/strong\u003E \u2014 Queue Pairs, Memory Registration, Completion Queues\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ERDMA Buffer Patterns\u003C/strong\u003E \u2014 Three approaches to managing registration and transfers\u003C/li\u003E\n\u003C/ol\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cem\u003EWe focus on \u003C/em\u003E\u003Cem\u003Eibverbs\u003C/em\u003E\u003Cem\u003E because that's what Monarch's RDMA subsystem supports today\n(InfiniBand and RoCE via Mellanox/NVIDIA ConnectX NICs). EFA (AWS Elastic Fabric Adapter)\nis a relevant transport but not yet supported \u2014 it's actively being worked on.\u003C/em\u003E\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "5c1dab7fc56bc2617c00fd009010a5d8", "console": [], "id": "bkHC", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"1-ibverbs-internals\"\u003E1. ibverbs Internals\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003ERDMA (Remote Direct Memory Access) lets one machine read/write another machine's memory\ndirectly, bypassing the kernel and CPU on both sides.\u003C/span\u003E\n\u003Ch3 id=\"the-ibverbs-stack\"\u003EThe ibverbs Stack\u003C/h3\u003E\n\u003Cdiv class=\"language-text codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Application (PyTorch, Monarch, etc.)                   \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  libibverbs  (userspace RDMA API)                       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  Provider driver (mlx5, efa, rxe, etc.)                 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  Hardware (InfiniBand NIC, RoCE NIC, etc.)              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EWe focus on \u003Cstrong\u003EInfiniBand\u003C/strong\u003E and \u003Cstrong\u003ERoCE\u003C/strong\u003E (RDMA over Converged Ethernet) \u2014 the two\ntransports Monarch supports today via the ibverbs API.\u003C/span\u003E\n\u003Ch3 id=\"key-rdma-operations\"\u003EKey RDMA Operations\u003C/h3\u003E\n\u003Ctable\u003E\n\u003Cthead\u003E\n\u003Ctr\u003E\n\u003Cth\u003EOperation\u003C/th\u003E\n\u003Cth\u003EDescription\u003C/th\u003E\n\u003C/tr\u003E\n\u003C/thead\u003E\n\u003Ctbody\u003E\n\u003Ctr\u003E\n\u003Ctd\u003E\u003Ccode\u003ERDMA_WRITE\u003C/code\u003E\u003C/td\u003E\n\u003Ctd\u003EWrite to remote memory (one-sided)\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003E\u003Ccode\u003ERDMA_READ\u003C/code\u003E\u003C/td\u003E\n\u003Ctd\u003ERead from remote memory (one-sided)\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003E\u003Ccode\u003ESEND/RECV\u003C/code\u003E\u003C/td\u003E\n\u003Ctd\u003ETwo-sided messaging (like TCP)\u003C/td\u003E\n\u003C/tr\u003E\n\u003C/tbody\u003E\n\u003C/table\u003E\n\u003Cspan class=\"paragraph\"\u003EThe magic is in \u003Ccode\u003ERDMA_WRITE\u003C/code\u003E and \u003Ccode\u003ERDMA_READ\u003C/code\u003E - they're \u003Cstrong\u003Eone-sided\u003C/strong\u003E:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003ERemote CPU is not involved\u003C/li\u003E\n\u003Cli\u003ERemote application doesn't need to call anything\u003C/li\u003E\n\u003Cli\u003ENIC handles everything in hardware\u003C/li\u003E\n\u003C/ul\u003E\n\u003Ch3 id=\"memory-registration\"\u003EMemory Registration\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003EBefore RDMA, memory must be \u003Cstrong\u003Eregistered\u003C/strong\u003E with the NIC:\u003C/span\u003E\n\u003Cdiv class=\"language-python codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"c1\"\u003E# Conceptually (actual ibverbs API is in C)\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Emr\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Erdma_register_memory\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ebuffer\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Esize\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\u003Cspan class=\"c1\"\u003E# Returns:\u003C/span\u003E\n\u003Cspan class=\"c1\"\u003E#   - lkey: local access key (for local operations)\u003C/span\u003E\n\u003Cspan class=\"c1\"\u003E#   - rkey: remote access key (share with remote peer)\u003C/span\u003E\n\u003Cspan class=\"c1\"\u003E#   - addr: physical/virtual address\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EThe \u003Ccode\u003E(addr, rkey)\u003C/code\u003E pair is a \u003Cstrong\u003Eremote-accessible pointer\u003C/strong\u003E. Share it with a peer,\nand they can read/write your memory directly.\u003C/span\u003E\n\u003Ch3 id=\"queue-pair-setup\"\u003EQueue Pair Setup\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003EBefore any RDMA operations, you need to establish a \u003Cstrong\u003EQueue Pair (QP)\u003C/strong\u003E between\nsender and receiver. This is a one-time connection setup:\u003C/span\u003E\n\u003Cdiv class=\"language-scdoc codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                           \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Sender    \u2502                           \u2502  Receiver   \u2502\n\u2502             \u2502                           \u2502             \u2502\n\u2502  Create QP  \u2502 \u2500\u2500\u2500 exchange QP info \u2500\u2500\u2500\u25ba \u2502  Create QP  \u2502\n\u2502  (qp_num,   \u2502 \u25c4\u2500\u2500 (qp_num, lid, gid) \u2500\u2500 \u2502             \u2502\n\u2502   lid, gid) \u2502                           \u2502             \u2502\n\u2502             \u2502                           \u2502             \u2502\n\u2502  Move QP to \u2502                           \u2502  Move QP to \u2502\n\u2502  RTR \u2192 RTS  \u2502                           \u2502  RTR \u2192 RTS  \u2502\n\u2502             \u2502                           \u2502             \u2502\n\u2502  Now ready  \u2502 \u2550\u2550\u2550 RDMA operations \u2550\u2550\u2550\u2550\u25ba \u2502  Now ready  \u2502\n\u2502  for RDMA!  \u2502                           \u2502  for RDMA!  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                           \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EThis is where \u003Cstrong\u003EMonarch actors\u003C/strong\u003E shine. Because you can spawn arbitrary actors,\nyou can create \u003Cstrong\u003ERDMA Manager actors\u003C/strong\u003E that:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003EInitialize QPs on their respective hosts\u003C/li\u003E\n\u003Cli\u003EExchange QP info via actor messages\u003C/li\u003E\n\u003Cli\u003EManage the connection lifecycle\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cdiv class=\"language-python codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"c1\"\u003E# Monarch pattern: RDMA managers as actors\u003C/span\u003E\n\u003Cspan class=\"k\"\u003Eclass\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"nc\"\u003ERDMAManager\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EActor\u003C/span\u003E\u003Cspan class=\"p\"\u003E):\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Edef\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"fm\"\u003E__init__\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"p\"\u003E):\u003C/span\u003E\n        \u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eqp\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Ecreate_queue_pair\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n        \u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eqp_info\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Eget_qp_info\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eqp\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E  \u003Cspan class=\"c1\"\u003E# (qp_num, lid, gid)\u003C/span\u003E\n\n    \u003Cspan class=\"nd\"\u003E@endpoint\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Edef\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"nf\"\u003Eget_qp_info\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E \u003Cspan class=\"n\"\u003EQpInfo\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eqp_info\u003C/span\u003E\n\n    \u003Cspan class=\"nd\"\u003E@endpoint\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Edef\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"nf\"\u003Econnect\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Eremote_qp_info\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E \u003Cspan class=\"n\"\u003EQpInfo\u003C/span\u003E\u003Cspan class=\"p\"\u003E):\u003C/span\u003E\n        \u003Cspan class=\"c1\"\u003E# Transition QP: INIT \u2192 RTR \u2192 RTS\u003C/span\u003E\n        \u003Cspan class=\"n\"\u003Econnect_qp\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eqp\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Eremote_qp_info\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\n\u003Cspan class=\"c1\"\u003E# Setup: exchange QP info via actor messages, then RDMA is ready\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Etrainer_info\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003Etrainer_rdma\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eget_qp_info\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Ecall_one\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eget\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Egenerator_rdma\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Econnect\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Ecall_one\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Etrainer_info\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eget\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EThe actor abstraction makes RDMA connection management natural and composable.\u003C/span\u003E\n\u003Ch3 id=\"completion-queues-cqs\"\u003ECompletion Queues (CQs)\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003EHow does the initiator know an operation finished? Every QP is associated with a\n\u003Cstrong\u003ECompletion Queue (CQ)\u003C/strong\u003E. When the NIC finishes an\nRDMA operation, it posts a \u003Cstrong\u003Ecompletion event\u003C/strong\u003E to the CQ:\u003C/span\u003E\n\u003Cdiv class=\"language-actionscript3 codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"n\"\u003EApp\u003C/span\u003E\u003Cspan class=\"o\"\u003E:\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003Epost\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003ERDMA_READ\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003Eto\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003ESend\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003EQueue\u003C/span\u003E\n\u003Cspan class=\"w\"\u003E          \u003C/span\u003E\u003Cspan class=\"err\"\u003E\u2193\u003C/span\u003E\n\u003Cspan class=\"n\"\u003ENIC\u003C/span\u003E\u003Cspan class=\"o\"\u003E:\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003Eexecutes\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003Ethe\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003Eread\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"o\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ebypasses\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003Eremote\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003ECPU\u003C/span\u003E\u003Cspan class=\"o\"\u003E)\u003C/span\u003E\n\u003Cspan class=\"w\"\u003E          \u003C/span\u003E\u003Cspan class=\"err\"\u003E\u2193\u003C/span\u003E\n\u003Cspan class=\"n\"\u003ENIC\u003C/span\u003E\u003Cspan class=\"o\"\u003E:\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003Eposts\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003Ecompletion\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003Eto\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003ECQ\u003C/span\u003E\n\u003Cspan class=\"w\"\u003E          \u003C/span\u003E\u003Cspan class=\"err\"\u003E\u2193\u003C/span\u003E\n\u003Cspan class=\"n\"\u003EApp\u003C/span\u003E\u003Cspan class=\"o\"\u003E:\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003Epoll\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"n\"\u003ECQ\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"err\"\u003E\u2192\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"s2\"\u003E\u0026quot;done, 4096 bytes transferred\u0026quot;\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EMonarch's Rust layer (\u003Ccode\u003ERdmaManagerActor\u003C/code\u003E) handles CQ polling internally. When you\ncall \u003Ccode\u003E.get()\u003C/code\u003E on an RDMA future, you're ultimately waiting for a CQ completion event.\nThis is why RDMA is \"one-sided\" but not \"zero-sided\" - the \u003Cem\u003Einitiator\u003C/em\u003E still needs\nto know when the transfer is done.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "33f2b95373a6bf0ddfc006121040d3dc", "console": [], "id": "lEQa", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"monarch-using-monarch-rdmacontroller\"\u003EMonarch Using Monarch: RdmaController\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003EHere's the cool part: \u003Cstrong\u003EMonarch uses itself\u003C/strong\u003E to manage RDMA infrastructure. Looking at\nthe actual Python code in \u003Ccode\u003Emonarch/_src/rdma/rdma.py\u003C/code\u003E:\u003C/span\u003E\n\u003Cdiv class=\"language-python codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"c1\"\u003E# From Monarch\u0026#39;s RDMA implementation\u003C/span\u003E\n\u003Cspan class=\"kn\"\u003Efrom\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"nn\"\u003Emonarch._src.actor.proc_mesh\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"kn\"\u003Eimport\u003C/span\u003E \u003Cspan class=\"n\"\u003Eget_or_spawn_controller\u003C/span\u003E\n\n\u003Cspan class=\"k\"\u003Eclass\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"nc\"\u003ERdmaController\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003EActor\u003C/span\u003E\u003Cspan class=\"p\"\u003E):\u003C/span\u003E\n\u003Cspan class=\"w\"\u003E    \u003C/span\u003E\u003Cspan class=\"sd\"\u003E\u0026#39;\u0026#39;\u0026#39;Singleton controller that coordinates RDMA initialization.\u0026#39;\u0026#39;\u0026#39;\u003C/span\u003E\n\n    \u003Cspan class=\"k\"\u003Edef\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"fm\"\u003E__init__\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"p\"\u003E):\u003C/span\u003E\n        \u003Cspan class=\"c1\"\u003E# Track which proc meshes have RDMA initialized\u003C/span\u003E\n        \u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003E_manager_futures\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E \u003Cspan class=\"nb\"\u003Edict\u003C/span\u003E\u003Cspan class=\"p\"\u003E[\u003C/span\u003E\u003Cspan class=\"n\"\u003EProcMesh\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003EFuture\u003C/span\u003E\u003Cspan class=\"p\"\u003E[\u003C/span\u003E\u003Cspan class=\"n\"\u003ERdmaManager\u003C/span\u003E\u003Cspan class=\"p\"\u003E]]\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"p\"\u003E{}\u003C/span\u003E\n\n    \u003Cspan class=\"nd\"\u003E@endpoint\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Easync\u003C/span\u003E \u003Cspan class=\"k\"\u003Edef\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"nf\"\u003Einit_rdma_on_mesh\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Eproc_mesh\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E \u003Cspan class=\"n\"\u003EProcMesh\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E \u003Cspan class=\"o\"\u003E-\u0026gt;\u003C/span\u003E \u003Cspan class=\"kc\"\u003ENone\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E\n\u003Cspan class=\"w\"\u003E        \u003C/span\u003E\u003Cspan class=\"sd\"\u003E\u0026#39;\u0026#39;\u0026#39;Lazily initialize RDMA on a proc mesh.\u0026#39;\u0026#39;\u0026#39;\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C/span\u003E \u003Cspan class=\"n\"\u003Eproc_mesh\u003C/span\u003E \u003Cspan class=\"ow\"\u003Enot\u003C/span\u003E \u003Cspan class=\"ow\"\u003Ein\u003C/span\u003E \u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003E_manager_futures\u003C/span\u003E\u003Cspan class=\"p\"\u003E:\u003C/span\u003E\n            \u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003E_manager_futures\u003C/span\u003E\u003Cspan class=\"p\"\u003E[\u003C/span\u003E\u003Cspan class=\"n\"\u003Eproc_mesh\u003C/span\u003E\u003Cspan class=\"p\"\u003E]\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003EFuture\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\n                \u003Cspan class=\"n\"\u003Ecoro\u003C/span\u003E\u003Cspan class=\"o\"\u003E=\u003C/span\u003E\u003Cspan class=\"n\"\u003ERdmaManager\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Ecreate\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Eproc_mesh\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n            \u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Eawait\u003C/span\u003E \u003Cspan class=\"bp\"\u003Eself\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003E_manager_futures\u003C/span\u003E\u003Cspan class=\"p\"\u003E[\u003C/span\u003E\u003Cspan class=\"n\"\u003Eproc_mesh\u003C/span\u003E\u003Cspan class=\"p\"\u003E]\u003C/span\u003E\n\n\u003Cspan class=\"c1\"\u003E# Cached initialization - only runs once per process\u003C/span\u003E\n\u003Cspan class=\"nd\"\u003E@functools\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Ecache\u003C/span\u003E\n\u003Cspan class=\"k\"\u003Edef\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"nf\"\u003E_ensure_init_rdma_manager\u003C/span\u003E\u003Cspan class=\"p\"\u003E():\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Easync\u003C/span\u003E \u003Cspan class=\"k\"\u003Edef\u003C/span\u003E\u003Cspan class=\"w\"\u003E \u003C/span\u003E\u003Cspan class=\"nf\"\u003Etask\u003C/span\u003E\u003Cspan class=\"p\"\u003E():\u003C/span\u003E\n        \u003Cspan class=\"n\"\u003Econtroller\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"k\"\u003Eawait\u003C/span\u003E \u003Cspan class=\"n\"\u003Eget_or_spawn_controller\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"s2\"\u003E\u0026quot;rdma_controller\u0026quot;\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003ERdmaController\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n        \u003Cspan class=\"k\"\u003Eawait\u003C/span\u003E \u003Cspan class=\"n\"\u003Econtroller\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Einit_rdma_on_mesh\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Ecall_one\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ecurrent_proc_mesh\u003C/span\u003E\u003Cspan class=\"p\"\u003E())\u003C/span\u003E\n    \u003Cspan class=\"k\"\u003Ereturn\u003C/span\u003E \u003Cspan class=\"n\"\u003Espawn_task\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Etask\u003C/span\u003E\u003Cspan class=\"p\"\u003E())\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EThis is \u003Cstrong\u003EMonarch building Monarch\u003C/strong\u003E - the RDMA subsystem uses the same patterns:\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Ccode\u003Eget_or_spawn_controller(\"rdma_controller\", RdmaController)\u003C/code\u003E ensures one global controller\u003C/li\u003E\n\u003Cli\u003EThe controller lazily initializes RDMA managers per proc mesh\u003C/li\u003E\n\u003Cli\u003E\u003Ccode\u003E@functools.cache\u003C/code\u003E ensures we only bootstrap once per process\u003C/li\u003E\n\u003Cli\u003EUnder the hood, the actual RDMA operations are in Rust (\u003Ccode\u003ERdmaManagerActor\u003C/code\u003E)\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003EIt's actors all the way down.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003ENow that we understand the primitives - QPs, MRs, CQs, and how Monarch wraps them -\nthe next question is: \u003Cstrong\u003Ewhat's the cost of getting them wrong?\u003C/strong\u003E Memory registration\nturns out to be the biggest hidden tax.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "1cb8a360047818b1f85f4f3fba2e2064", "console": [], "id": "PKri", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"2-rdma-buffer-patterns\"\u003E2. RDMA Buffer Patterns\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EMemory registration is the hidden cost of RDMA. Before the NIC can read or write a\nbuffer, that buffer must be \u003Cstrong\u003Eregistered\u003C/strong\u003E \u2014 the OS pins its physical pages and creates\nDMA mappings so the NIC can access them directly. This can take milliseconds for large\nbuffers.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThe question isn't \u003Cem\u003Ewhether\u003C/em\u003E to pay this cost \u2014 it's \u003Cem\u003Ewhen and how often\u003C/em\u003E. We'll\nlook at three patterns:\u003C/span\u003E\n\u003Ctable\u003E\n\u003Cthead\u003E\n\u003Ctr\u003E\n\u003Cth\u003EPattern\u003C/th\u003E\n\u003Cth\u003ERegistration\u003C/th\u003E\n\u003Cth\u003ETransfer\u003C/th\u003E\n\u003Cth\u003ETrade-off\u003C/th\u003E\n\u003C/tr\u003E\n\u003C/thead\u003E\n\u003Ctbody\u003E\n\u003Ctr\u003E\n\u003Ctd\u003E\u003Cstrong\u003ENaive\u003C/strong\u003E\u003C/td\u003E\n\u003Ctd\u003EEvery call\u003C/td\u003E\n\u003Ctd\u003EPer-buffer\u003C/td\u003E\n\u003Ctd\u003EBaseline \u2014 pays MR cost every step\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003E\u003Cstrong\u003EContiguous\u003C/strong\u003E\u003C/td\u003E\n\u003Ctd\u003EOnce at init\u003C/td\u003E\n\u003Ctd\u003EOne bulk read\u003C/td\u003E\n\u003Ctd\u003EFastest, but requires copying to a contiguous region\u003C/td\u003E\n\u003C/tr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003E\u003Cstrong\u003EScattered + RDMAAction\u003C/strong\u003E\u003C/td\u003E\n\u003Ctd\u003EOnce at init\u003C/td\u003E\n\u003Ctd\u003EBatched plan\u003C/td\u003E\n\u003Ctd\u003EPractical \u2014 works with non-contiguous layouts\u003C/td\u003E\n\u003C/tr\u003E\n\u003C/tbody\u003E\n\u003C/table\u003E\n\u003Cspan class=\"paragraph\"\u003EThe benchmark at the end shows the performance difference.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "a974f9ee74e9e0cf72f1a34b5ea32cde", "console": [], "id": "Xref", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"pattern-1-naive\"\u003EPattern 1: Naive\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003ECreate a new \u003Ccode\u003ERDMABuffer\u003C/code\u003E on every transfer \u2014 pays memory registration cost each time:\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "4e747c82c13bfc565a6b64491dae29c4", "console": [{"mimetype": "text/plain", "name": "stdout", "text": "NaiveSender: Re-registers all parameters on every call\n", "type": "stream"}], "id": "SFPL", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "7b854cac2c79ad4e1d9543eab8db871c", "console": [], "id": "BYtC", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"pattern-2-contiguous-buffer\"\u003EPattern 2: Contiguous Buffer\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003EPack all layers into one buffer, register once \u2014 one MR, one transfer:\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "285285269c84982aee5ecef9ea23f419", "console": [{"mimetype": "text/plain", "name": "stdout", "text": "ContiguousSender: Registers once, reuses same handle\n", "type": "stream"}], "id": "RGSE", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "8b70f610b9d6fc5825efe5407bb1085e", "console": [], "id": "Kclp", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"pattern-3-scattered-rdmaaction\"\u003EPattern 3: Scattered + RDMAAction\u003C/h3\u003E\n\u003Cspan class=\"paragraph\"\u003ERegister each buffer at init, build a transfer plan once via handshake:\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EWhat is RDMAAction?\u003C/strong\u003E\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThink of \u003Ccode\u003ERDMAAction\u003C/code\u003E as a \u003Cstrong\u003Etransfer plan\u003C/strong\u003E. You describe all the reads/writes you want\nto do, then \u003Ccode\u003Esubmit()\u003C/code\u003E executes the whole plan at once:\u003C/span\u003E\n\u003Cdiv class=\"language-python codehilite\"\u003E\u003Cpre\u003E\u003Cspan\u003E\u003C/span\u003E\u003Ccode\u003E\u003Cspan class=\"c1\"\u003E# Build the plan once\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Eaction\u003C/span\u003E \u003Cspan class=\"o\"\u003E=\u003C/span\u003E \u003Cspan class=\"n\"\u003ERDMAAction\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Eaction\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eread_into\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ehandle1\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Elocal_buffer1\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Eaction\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eread_into\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ehandle2\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Elocal_buffer2\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Eaction\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eread_into\u003C/span\u003E\u003Cspan class=\"p\"\u003E(\u003C/span\u003E\u003Cspan class=\"n\"\u003Ehandle3\u003C/span\u003E\u003Cspan class=\"p\"\u003E,\u003C/span\u003E \u003Cspan class=\"n\"\u003Elocal_buffer3\u003C/span\u003E\u003Cspan class=\"p\"\u003E)\u003C/span\u003E\n\n\u003Cspan class=\"c1\"\u003E# Execute whenever you want - just one call\u003C/span\u003E\n\u003Cspan class=\"n\"\u003Eaction\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Esubmit\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\u003Cspan class=\"o\"\u003E.\u003C/span\u003E\u003Cspan class=\"n\"\u003Eget\u003C/span\u003E\u003Cspan class=\"p\"\u003E()\u003C/span\u003E\n\u003C/code\u003E\u003C/pre\u003E\u003C/div\u003E\n\u003Cspan class=\"paragraph\"\u003EThis is useful when you have many scattered buffers (like model parameters) and want\nto batch them into a single logical operation.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "cf2558bd29e83f53df64e3e26f3b7b6d", "console": [{"mimetype": "text/plain", "name": "stdout", "text": "ScatteredSender: Registers each layer once\nScatteredReceiver: handshake() builds plan, receive_step() executes it\n", "type": "stream"}], "id": "emfo", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "b0fba7d210a61fd3620db9561c51d39e", "console": [], "id": "Hstk", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch3 id=\"running-the-benchmark\"\u003ERunning the Benchmark\u003C/h3\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "d6c47ce9b3f234f75fce19d91cf53566", "console": [{"mimetype": "text/plain", "name": "stderr", "text": "Monarch internal logs are being written to /tmp/allencwang/monarch_log.log; execution id allencwang_Feb-07_10:34_340\n", "type": "stream"}, {"mimetype": "text/plain", "name": "stdout", "text": "Warming up RDMA subsystem...\nWarmup complete.\n\n=== RDMA Buffer Pattern Benchmark ===\nTransferring 80000 floats (312.5 KB) x 5 steps\n\nPattern 1 \u2014 Naive (re-register each step):\n  Step 1: 13.36ms\n  Step 2: 11.26ms\n  Step 3: 11.50ms\n  Step 4: 10.75ms\n  Step 5: 11.19ms\n  Average: 11.61ms\n\nPattern 2 \u2014 Contiguous (one buffer, one read):\n  Step 1: 4.28ms\n  Step 2: 4.54ms\n  Step 3: 4.21ms\n  Step 4: 4.42ms\n  Step 5: 4.44ms\n  Average: 4.38ms\n\nPattern 3 \u2014 Scattered + RDMAAction (batched plan):\n  Step 1: 8.59ms\n  Step 2: 9.12ms\n  Step 3: 7.77ms\n  Step 4: 7.59ms\n  Step 5: 7.52ms\n  Average: 8.12ms\n\n=== What's Happening ===\nNaive: Re-registers MRs + sequential per-layer reads (~9ms)\nContiguous: One MR, one read \u2014 fewest round trips (~3ms)\nScattered + RDMAAction: Pre-built transfer plan (~8ms, Python overhead)\n", "type": "stream"}], "id": "nWHF", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "e26765afa8b40806a593e1a1b764aa87", "console": [], "id": "iLit", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EWhat the benchmark shows:\u003C/strong\u003E\u003C/span\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Cstrong\u003ENaive\u003C/strong\u003E (~9ms): Re-registers MRs each step, plus sequential per-layer reads.\n  At larger buffer sizes the MR cost grows, but here it's masked by Python overhead.\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EContiguous\u003C/strong\u003E (~3ms): One MR, one \u003Ccode\u003Eread_into()\u003C/code\u003E \u2014 fewest round trips wins.\n  The trade-off: in practice, model parameters aren't contiguous, so you'd need\n  to copy into a contiguous staging buffer first.\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003EScattered + RDMAAction\u003C/strong\u003E (~8ms): Pre-built transfer plan, works with non-contiguous\n  layouts. Currently has Python overhead from the batching logic; lowering \u003Ccode\u003ERDMAAction\u003C/code\u003E\n  into Rust will close the gap with Contiguous.\u003C/li\u003E\n\u003C/ul\u003E\n\u003Cspan class=\"paragraph\"\u003EThe key lesson: \u003Cstrong\u003Eminimize round trips.\u003C/strong\u003E Whether that means packing into one buffer\nor batching via \u003Ccode\u003ERDMAAction\u003C/code\u003E, the goal is the same \u2014 fewer Python-to-Rust-to-NIC\ntransitions per sync.\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}, {"code_hash": "e3f328fdfcc04f599be861bb18393742", "console": [], "id": "ZHCJ", "outputs": [{"data": {"text/markdown": "\u003Cspan class=\"markdown prose dark:prose-invert contents\"\u003E\u003Ch2 id=\"summary\"\u003ESummary\u003C/h2\u003E\n\u003Cspan class=\"paragraph\"\u003EWe started with a question \u2014 \u003Cem\u003Ewhere do the milliseconds go?\u003C/em\u003E \u2014 and traced the answer\nthrough two layers:\u003C/span\u003E\n\u003Col\u003E\n\u003Cli\u003E\u003Cstrong\u003Eibverbs internals\u003C/strong\u003E \u2014 QPs, MRs, CQs: the primitives that make RDMA work, and how\n   Monarch's actor model wraps them into composable connections\u003C/li\u003E\n\u003Cli\u003E\u003Cstrong\u003ERDMA buffer patterns\u003C/strong\u003E \u2014 From naive re-registration to contiguous buffers\n   and batched transfer plans via \u003Ccode\u003ERDMAAction\u003C/code\u003E \u2014 minimizing Python round trips\u003C/li\u003E\n\u003C/ol\u003E\n\u003Cspan class=\"paragraph\"\u003EWe focused on \u003Cstrong\u003Eibverbs\u003C/strong\u003E specifically because that's what Monarch's RDMA subsystem\nsupports today (InfiniBand and RoCE via Mellanox/NVIDIA ConnectX NICs). EFA (Elastic\nFabric Adapter, used on AWS) is a relevant transport but not yet supported \u2014 it's\nactively being worked on.\u003C/span\u003E\n\u003Cspan class=\"paragraph\"\u003EThe main notebook (06) covers the high-level patterns for async RL weight sync \u2014\nmagic pointers, CPU staging, circular buffers, and DTensor re-sharding. This notebook\nshowed the RDMA specifics underneath: what the NIC is actually doing and how to avoid\npaying unnecessary costs on the hot path.\u003C/span\u003E\n\u003Chr /\u003E\n\u003Cspan class=\"paragraph\"\u003E\u003Cstrong\u003EPrevious:\u003C/strong\u003E \u003Ca href=\"./06_rdma_weight_sync.html\"\u003ENB06 \u2014 RDMA Weight Sync\u003C/a\u003E \u00b7 \u003Cstrong\u003ENext:\u003C/strong\u003E \u003Ca href=\"./07_rl_e2e.html\"\u003ENB07 \u2014 Async RL E2E\u003C/a\u003E\u003C/span\u003E\u003C/span\u003E"}, "type": "data"}]}], "metadata": {"marimo_version": "0.19.9"}, "version": "1"},
            "runtimeConfig": null,
        };
    </script>
  
<marimo-code hidden="">
    import%20marimo%0A%0A__generated_with%20%3D%20%220.19.9%22%0Aapp%20%3D%20marimo.App(width%3D%22medium%22)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%0A%20%20%20%20return%20(mo%2C)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20%23%20Shared%20imports%20for%20the%20notebook%0A%20%20%20%20import%20time%0A%20%20%20%20import%20torch%0A%20%20%20%20from%20monarch.actor%20import%20Actor%2C%20endpoint%2C%20this_host%2C%20current_rank%0A%20%20%20%20from%20monarch.rdma%20import%20RDMABuffer%2C%20RDMAAction%2C%20is_rdma_available%0A%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20Actor%2C%0A%20%20%20%20%20%20%20%20RDMAAction%2C%0A%20%20%20%20%20%20%20%20RDMABuffer%2C%0A%20%20%20%20%20%20%20%20current_rank%2C%0A%20%20%20%20%20%20%20%20endpoint%2C%0A%20%20%20%20%20%20%20%20is_rdma_available%2C%0A%20%20%20%20%20%20%20%20this_host%2C%0A%20%20%20%20%20%20%20%20time%2C%0A%20%20%20%20%20%20%20%20torch%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%20RDMA%20Deep%20Dive%0A%0A%20%20%20%20Notebook%2006%20covered%20weight%20synchronization%20end-to-end%3A%20why%20RDMA%20matters%20for%20async%20RL%2C%0A%20%20%20%20the%20magic%20pointer%20pattern%2C%20circular%20buffers%2C%20and%20re-sharding.%20We%20used%20%60RDMABuffer%60%20and%0A%20%20%20%20%60read_into()%60%20as%20black%20boxes%20%E2%80%94%20call%20the%20API%2C%20weights%20appear.%0A%0A%20%20%20%20This%20notebook%20goes%20deeper%20into%20how%20RDMA%20actually%20works.%20We'll%20walk%20through%20the%20ibverbs%0A%20%20%20%20primitives%20that%20power%20every%20transfer%2C%20understand%20the%20costs%20that%20separate%20a%20fast%0A%20%20%20%20implementation%20from%20a%20slow%20one%2C%20and%20see%20the%20concrete%20patterns%20for%20managing%20RDMA%20buffers%0A%20%20%20%20in%20production.%0A%0A%20%20%20%20**The%20central%20question%3A%20where%20do%20the%20milliseconds%20go%3F**%0A%0A%20%20%20%201.%20**ibverbs%20Internals**%20%E2%80%94%20Queue%20Pairs%2C%20Memory%20Registration%2C%20Completion%20Queues%0A%20%20%20%202.%20**RDMA%20Buffer%20Patterns**%20%E2%80%94%20Three%20approaches%20to%20managing%20registration%20and%20transfers%0A%0A%20%20%20%20*We%20focus%20on%20**ibverbs**%20because%20that's%20what%20Monarch's%20RDMA%20subsystem%20supports%20today%0A%20%20%20%20(InfiniBand%20and%20RoCE%20via%20Mellanox%2FNVIDIA%20ConnectX%20NICs).%20EFA%20(AWS%20Elastic%20Fabric%20Adapter)%0A%20%20%20%20is%20a%20relevant%20transport%20but%20not%20yet%20supported%20%E2%80%94%20it's%20actively%20being%20worked%20on.*%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%201.%20ibverbs%20Internals%0A%0A%20%20%20%20RDMA%20(Remote%20Direct%20Memory%20Access)%20lets%20one%20machine%20read%2Fwrite%20another%20machine's%20memory%0A%20%20%20%20directly%2C%20bypassing%20the%20kernel%20and%20CPU%20on%20both%20sides.%0A%0A%20%20%20%20%23%23%23%20The%20ibverbs%20Stack%0A%0A%20%20%20%20%60%60%60%0A%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%20%20%20%20%E2%94%82%20%20Application%20(PyTorch%2C%20Monarch%2C%20etc.)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%9C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%A4%0A%20%20%20%20%E2%94%82%20%20libibverbs%20%20(userspace%20RDMA%20API)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%9C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%A4%0A%20%20%20%20%E2%94%82%20%20Provider%20driver%20(mlx5%2C%20efa%2C%20rxe%2C%20etc.)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%9C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%A4%0A%20%20%20%20%E2%94%82%20%20Hardware%20(InfiniBand%20NIC%2C%20RoCE%20NIC%2C%20etc.)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20We%20focus%20on%20**InfiniBand**%20and%20**RoCE**%20(RDMA%20over%20Converged%20Ethernet)%20%E2%80%94%20the%20two%0A%20%20%20%20transports%20Monarch%20supports%20today%20via%20the%20ibverbs%20API.%0A%0A%20%20%20%20%23%23%23%20Key%20RDMA%20Operations%0A%0A%20%20%20%20%7C%20Operation%20%7C%20Description%20%7C%0A%20%20%20%20%7C-----------%7C-------------%7C%0A%20%20%20%20%7C%20%60RDMA_WRITE%60%20%7C%20Write%20to%20remote%20memory%20(one-sided)%20%7C%0A%20%20%20%20%7C%20%60RDMA_READ%60%20%7C%20Read%20from%20remote%20memory%20(one-sided)%20%7C%0A%20%20%20%20%7C%20%60SEND%2FRECV%60%20%7C%20Two-sided%20messaging%20(like%20TCP)%20%7C%0A%0A%20%20%20%20The%20magic%20is%20in%20%60RDMA_WRITE%60%20and%20%60RDMA_READ%60%20-%20they're%20**one-sided**%3A%0A%20%20%20%20-%20Remote%20CPU%20is%20not%20involved%0A%20%20%20%20-%20Remote%20application%20doesn't%20need%20to%20call%20anything%0A%20%20%20%20-%20NIC%20handles%20everything%20in%20hardware%0A%0A%20%20%20%20%23%23%23%20Memory%20Registration%0A%0A%20%20%20%20Before%20RDMA%2C%20memory%20must%20be%20**registered**%20with%20the%20NIC%3A%0A%0A%20%20%20%20%60%60%60python%0A%20%20%20%20%23%20Conceptually%20(actual%20ibverbs%20API%20is%20in%20C)%0A%20%20%20%20mr%20%3D%20rdma_register_memory(buffer%2C%20size)%0A%20%20%20%20%23%20Returns%3A%0A%20%20%20%20%23%20%20%20-%20lkey%3A%20local%20access%20key%20(for%20local%20operations)%0A%20%20%20%20%23%20%20%20-%20rkey%3A%20remote%20access%20key%20(share%20with%20remote%20peer)%0A%20%20%20%20%23%20%20%20-%20addr%3A%20physical%2Fvirtual%20address%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20The%20%60(addr%2C%20rkey)%60%20pair%20is%20a%20**remote-accessible%20pointer**.%20Share%20it%20with%20a%20peer%2C%0A%20%20%20%20and%20they%20can%20read%2Fwrite%20your%20memory%20directly.%0A%0A%20%20%20%20%23%23%23%20Queue%20Pair%20Setup%0A%0A%20%20%20%20Before%20any%20RDMA%20operations%2C%20you%20need%20to%20establish%20a%20**Queue%20Pair%20(QP)**%20between%0A%20%20%20%20sender%20and%20receiver.%20This%20is%20a%20one-time%20connection%20setup%3A%0A%0A%20%20%20%20%60%60%60%0A%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%20%20%20%20%E2%94%82%20%20%20Sender%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20Receiver%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20Create%20QP%20%20%E2%94%82%20%E2%94%80%E2%94%80%E2%94%80%20exchange%20QP%20info%20%E2%94%80%E2%94%80%E2%94%80%E2%96%BA%20%E2%94%82%20%20Create%20QP%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20(qp_num%2C%20%20%20%E2%94%82%20%E2%97%84%E2%94%80%E2%94%80%20(qp_num%2C%20lid%2C%20gid)%20%E2%94%80%E2%94%80%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%20lid%2C%20gid)%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20Move%20QP%20to%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20Move%20QP%20to%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20RTR%20%E2%86%92%20RTS%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20RTR%20%E2%86%92%20RTS%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20Now%20ready%20%20%E2%94%82%20%E2%95%90%E2%95%90%E2%95%90%20RDMA%20operations%20%E2%95%90%E2%95%90%E2%95%90%E2%95%90%E2%96%BA%20%E2%94%82%20%20Now%20ready%20%20%E2%94%82%0A%20%20%20%20%E2%94%82%20%20for%20RDMA!%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%20%20for%20RDMA!%20%20%E2%94%82%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%98%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20This%20is%20where%20**Monarch%20actors**%20shine.%20Because%20you%20can%20spawn%20arbitrary%20actors%2C%0A%20%20%20%20you%20can%20create%20**RDMA%20Manager%20actors**%20that%3A%0A%20%20%20%20-%20Initialize%20QPs%20on%20their%20respective%20hosts%0A%20%20%20%20-%20Exchange%20QP%20info%20via%20actor%20messages%0A%20%20%20%20-%20Manage%20the%20connection%20lifecycle%0A%0A%20%20%20%20%60%60%60python%0A%20%20%20%20%23%20Monarch%20pattern%3A%20RDMA%20managers%20as%20actors%0A%20%20%20%20class%20RDMAManager(Actor)%3A%0A%20%20%20%20%20%20%20%20def%20__init__(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.qp%20%3D%20create_queue_pair()%0A%20%20%20%20%20%20%20%20%20%20%20%20self.qp_info%20%3D%20get_qp_info(self.qp)%20%20%23%20(qp_num%2C%20lid%2C%20gid)%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20get_qp_info(self)%20-%3E%20QpInfo%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self.qp_info%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20connect(self%2C%20remote_qp_info%3A%20QpInfo)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Transition%20QP%3A%20INIT%20%E2%86%92%20RTR%20%E2%86%92%20RTS%0A%20%20%20%20%20%20%20%20%20%20%20%20connect_qp(self.qp%2C%20remote_qp_info)%0A%0A%20%20%20%20%23%20Setup%3A%20exchange%20QP%20info%20via%20actor%20messages%2C%20then%20RDMA%20is%20ready%0A%20%20%20%20trainer_info%20%3D%20trainer_rdma.get_qp_info.call_one().get()%0A%20%20%20%20generator_rdma.connect.call_one(trainer_info).get()%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20The%20actor%20abstraction%20makes%20RDMA%20connection%20management%20natural%20and%20composable.%0A%0A%20%20%20%20%23%23%23%20Completion%20Queues%20(CQs)%0A%0A%20%20%20%20How%20does%20the%20initiator%20know%20an%20operation%20finished%3F%20Every%20QP%20is%20associated%20with%20a%0A%20%20%20%20**Completion%20Queue%20(CQ)**.%20When%20the%20NIC%20finishes%20an%0A%20%20%20%20RDMA%20operation%2C%20it%20posts%20a%20**completion%20event**%20to%20the%20CQ%3A%0A%0A%20%20%20%20%60%60%60%0A%20%20%20%20App%3A%20post%20RDMA_READ%20to%20Send%20Queue%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%86%93%0A%20%20%20%20NIC%3A%20executes%20the%20read%20(bypasses%20remote%20CPU)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%86%93%0A%20%20%20%20NIC%3A%20posts%20completion%20to%20CQ%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%86%93%0A%20%20%20%20App%3A%20poll%20CQ%20%E2%86%92%20%22done%2C%204096%20bytes%20transferred%22%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20Monarch's%20Rust%20layer%20(%60RdmaManagerActor%60)%20handles%20CQ%20polling%20internally.%20When%20you%0A%20%20%20%20call%20%60.get()%60%20on%20an%20RDMA%20future%2C%20you're%20ultimately%20waiting%20for%20a%20CQ%20completion%20event.%0A%20%20%20%20This%20is%20why%20RDMA%20is%20%22one-sided%22%20but%20not%20%22zero-sided%22%20-%20the%20*initiator*%20still%20needs%0A%20%20%20%20to%20know%20when%20the%20transfer%20is%20done.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20Monarch%20Using%20Monarch%3A%20RdmaController%0A%0A%20%20%20%20Here's%20the%20cool%20part%3A%20**Monarch%20uses%20itself**%20to%20manage%20RDMA%20infrastructure.%20Looking%20at%0A%20%20%20%20the%20actual%20Python%20code%20in%20%60monarch%2F_src%2Frdma%2Frdma.py%60%3A%0A%0A%20%20%20%20%60%60%60python%0A%20%20%20%20%23%20From%20Monarch's%20RDMA%20implementation%0A%20%20%20%20from%20monarch._src.actor.proc_mesh%20import%20get_or_spawn_controller%0A%0A%20%20%20%20class%20RdmaController(Actor)%3A%0A%20%20%20%20%20%20%20%20'''Singleton%20controller%20that%20coordinates%20RDMA%20initialization.'''%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Track%20which%20proc%20meshes%20have%20RDMA%20initialized%0A%20%20%20%20%20%20%20%20%20%20%20%20self._manager_futures%3A%20dict%5BProcMesh%2C%20Future%5BRdmaManager%5D%5D%20%3D%20%7B%7D%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20async%20def%20init_rdma_on_mesh(self%2C%20proc_mesh%3A%20ProcMesh)%20-%3E%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20'''Lazily%20initialize%20RDMA%20on%20a%20proc%20mesh.'''%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20proc_mesh%20not%20in%20self._manager_futures%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self._manager_futures%5Bproc_mesh%5D%20%3D%20Future(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20coro%3DRdmaManager.create(proc_mesh)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20await%20self._manager_futures%5Bproc_mesh%5D%0A%0A%20%20%20%20%23%20Cached%20initialization%20-%20only%20runs%20once%20per%20process%0A%20%20%20%20%40functools.cache%0A%20%20%20%20def%20_ensure_init_rdma_manager()%3A%0A%20%20%20%20%20%20%20%20async%20def%20task()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20controller%20%3D%20await%20get_or_spawn_controller(%22rdma_controller%22%2C%20RdmaController)%0A%20%20%20%20%20%20%20%20%20%20%20%20await%20controller.init_rdma_on_mesh.call_one(current_proc_mesh())%0A%20%20%20%20%20%20%20%20return%20spawn_task(task())%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20This%20is%20**Monarch%20building%20Monarch**%20-%20the%20RDMA%20subsystem%20uses%20the%20same%20patterns%3A%0A%0A%20%20%20%20-%20%60get_or_spawn_controller(%22rdma_controller%22%2C%20RdmaController)%60%20ensures%20one%20global%20controller%0A%20%20%20%20-%20The%20controller%20lazily%20initializes%20RDMA%20managers%20per%20proc%20mesh%0A%20%20%20%20-%20%60%40functools.cache%60%20ensures%20we%20only%20bootstrap%20once%20per%20process%0A%20%20%20%20-%20Under%20the%20hood%2C%20the%20actual%20RDMA%20operations%20are%20in%20Rust%20(%60RdmaManagerActor%60)%0A%0A%20%20%20%20It's%20actors%20all%20the%20way%20down.%0A%0A%20%20%20%20Now%20that%20we%20understand%20the%20primitives%20-%20QPs%2C%20MRs%2C%20CQs%2C%20and%20how%20Monarch%20wraps%20them%20-%0A%20%20%20%20the%20next%20question%20is%3A%20**what's%20the%20cost%20of%20getting%20them%20wrong%3F**%20Memory%20registration%0A%20%20%20%20turns%20out%20to%20be%20the%20biggest%20hidden%20tax.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%202.%20RDMA%20Buffer%20Patterns%0A%0A%20%20%20%20Memory%20registration%20is%20the%20hidden%20cost%20of%20RDMA.%20Before%20the%20NIC%20can%20read%20or%20write%20a%0A%20%20%20%20buffer%2C%20that%20buffer%20must%20be%20**registered**%20%E2%80%94%20the%20OS%20pins%20its%20physical%20pages%20and%20creates%0A%20%20%20%20DMA%20mappings%20so%20the%20NIC%20can%20access%20them%20directly.%20This%20can%20take%20milliseconds%20for%20large%0A%20%20%20%20buffers.%0A%0A%20%20%20%20The%20question%20isn't%20*whether*%20to%20pay%20this%20cost%20%E2%80%94%20it's%20*when%20and%20how%20often*.%20We'll%0A%20%20%20%20look%20at%20three%20patterns%3A%0A%0A%20%20%20%20%7C%20Pattern%20%7C%20Registration%20%7C%20Transfer%20%7C%20Trade-off%20%7C%0A%20%20%20%20%7C---------%7C-------------%7C----------%7C-----------%7C%0A%20%20%20%20%7C%20**Naive**%20%7C%20Every%20call%20%7C%20Per-buffer%20%7C%20Baseline%20%E2%80%94%20pays%20MR%20cost%20every%20step%20%7C%0A%20%20%20%20%7C%20**Contiguous**%20%7C%20Once%20at%20init%20%7C%20One%20bulk%20read%20%7C%20Fastest%2C%20but%20requires%20copying%20to%20a%20contiguous%20region%20%7C%0A%20%20%20%20%7C%20**Scattered%20%2B%20RDMAAction**%20%7C%20Once%20at%20init%20%7C%20Batched%20plan%20%7C%20Practical%20%E2%80%94%20works%20with%20non-contiguous%20layouts%20%7C%0A%0A%20%20%20%20The%20benchmark%20at%20the%20end%20shows%20the%20performance%20difference.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20Pattern%201%3A%20Naive%0A%0A%20%20%20%20Create%20a%20new%20%60RDMABuffer%60%20on%20every%20transfer%20%E2%80%94%20pays%20memory%20registration%20cost%20each%20time%3A%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Actor%2C%20RDMABuffer%2C%20current_rank%2C%20endpoint%2C%20time%2C%20torch)%3A%0A%20%20%20%20class%20NaiveSender(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Creates%20new%20RDMABuffer%20handles%20every%20transfer.%20Expensive!%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20layer_sizes%3A%20list)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.layer_sizes%20%3D%20layer_sizes%0A%20%20%20%20%20%20%20%20%20%20%20%20self.layers%20%3D%20%5Btorch.zeros(size%2C%20dtype%3Dtorch.float32)%20for%20size%20in%20layer_sizes%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%2C%20layer%20in%20enumerate(self.layers)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20layer.fill_(float(i%20%2B%201))%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20get_fresh_handles(self)%20-%3E%20list%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20handles%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20size%2C%20layer%20in%20zip(self.layer_sizes%2C%20self.layers)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20byte_view%20%3D%20layer.view(torch.uint8).flatten()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20handles.append((size%2C%20RDMABuffer(byte_view)))%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20handles%0A%0A%0A%20%20%20%20class%20NaiveReceiver(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Receives%20from%20naive%20sender%20-%20pays%20MR%20cost%20every%20step.%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20layer_sizes%3A%20list)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.layer_sizes%20%3D%20layer_sizes%0A%20%20%20%20%20%20%20%20%20%20%20%20self.layers%20%3D%20%5Btorch.zeros(size%2C%20dtype%3Dtorch.float32)%20for%20size%20in%20layer_sizes%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20self.rank%20%3D%20current_rank().rank%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20warmup(self%2C%20sender%3A%20NaiveSender)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Force%20RDMA%20subsystem%20init%20%2B%20QP%20establishment%20(not%20timed).%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20handles%20%3D%20sender.get_fresh_handles.call_one().get()%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%2C%20(size%2C%20handle)%20in%20enumerate(handles)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20byte_view%20%3D%20self.layers%5Bi%5D.view(torch.uint8).flatten()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20handle.read_into(byte_view).get()%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20receive_step(self%2C%20sender%3A%20NaiveSender)%20-%3E%20dict%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20start%20%3D%20time.perf_counter()%0A%20%20%20%20%20%20%20%20%20%20%20%20handles%20%3D%20sender.get_fresh_handles.call_one().get()%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%2C%20(size%2C%20handle)%20in%20enumerate(handles)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20byte_view%20%3D%20self.layers%5Bi%5D.view(torch.uint8).flatten()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20handle.read_into(byte_view).get()%0A%20%20%20%20%20%20%20%20%20%20%20%20elapsed_ms%20%3D%20(time.perf_counter()%20-%20start)%20*%201000%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%22elapsed_ms%22%3A%20elapsed_ms%7D%0A%0A%20%20%20%20print(%22NaiveSender%3A%20Re-registers%20all%20parameters%20on%20every%20call%22)%0A%20%20%20%20return%20NaiveReceiver%2C%20NaiveSender%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20Pattern%202%3A%20Contiguous%20Buffer%0A%0A%20%20%20%20Pack%20all%20layers%20into%20one%20buffer%2C%20register%20once%20%E2%80%94%20one%20MR%2C%20one%20transfer%3A%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Actor%2C%20RDMABuffer%2C%20current_rank%2C%20endpoint%2C%20time%2C%20torch)%3A%0A%20%20%20%20class%20ContiguousSender(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22One%20buffer%2C%20one%20MR%2C%20registered%20at%20startup.%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20layer_sizes%3A%20list)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.layer_sizes%20%3D%20layer_sizes%0A%20%20%20%20%20%20%20%20%20%20%20%20total_size%20%3D%20sum(layer_sizes)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20One%20contiguous%20buffer%0A%20%20%20%20%20%20%20%20%20%20%20%20self.buffer%20%3D%20torch.zeros(total_size%2C%20dtype%3Dtorch.float32)%0A%20%20%20%20%20%20%20%20%20%20%20%20offset%20%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%2C%20size%20in%20enumerate(layer_sizes)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.buffer%5Boffset%20%3A%20offset%20%2B%20size%5D.fill_(float(i%20%2B%201))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20offset%20%2B%3D%20size%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Register%20ONCE%20at%20startup%0A%20%20%20%20%20%20%20%20%20%20%20%20byte_view%20%3D%20self.buffer.view(torch.uint8).flatten()%0A%20%20%20%20%20%20%20%20%20%20%20%20self.handle%20%3D%20RDMABuffer(byte_view)%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20get_handle(self)%20-%3E%20tuple%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20(len(self.buffer)%2C%20self.handle)%20%20%23%20Same%20handle%20every%20time!%0A%0A%0A%20%20%20%20class%20ContiguousReceiver(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Receives%20from%20contiguous%20sender%20-%20one%20big%20read.%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20total_size%3A%20int)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.buffer%20%3D%20torch.zeros(total_size%2C%20dtype%3Dtorch.float32)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.rank%20%3D%20current_rank().rank%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20warmup(self%2C%20sender%3A%20ContiguousSender)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Force%20QP%20establishment%20(not%20timed).%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20size%2C%20handle%20%3D%20sender.get_handle.call_one().get()%0A%20%20%20%20%20%20%20%20%20%20%20%20byte_view%20%3D%20self.buffer.view(torch.uint8).flatten()%0A%20%20%20%20%20%20%20%20%20%20%20%20handle.read_into(byte_view).get()%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20receive_step(self%2C%20sender%3A%20ContiguousSender)%20-%3E%20dict%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20start%20%3D%20time.perf_counter()%0A%20%20%20%20%20%20%20%20%20%20%20%20size%2C%20handle%20%3D%20sender.get_handle.call_one().get()%0A%20%20%20%20%20%20%20%20%20%20%20%20byte_view%20%3D%20self.buffer.view(torch.uint8).flatten()%0A%20%20%20%20%20%20%20%20%20%20%20%20handle.read_into(byte_view).get()%0A%20%20%20%20%20%20%20%20%20%20%20%20elapsed_ms%20%3D%20(time.perf_counter()%20-%20start)%20*%201000%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%22elapsed_ms%22%3A%20elapsed_ms%7D%0A%0A%20%20%20%20print(%22ContiguousSender%3A%20Registers%20once%2C%20reuses%20same%20handle%22)%0A%20%20%20%20return%20ContiguousReceiver%2C%20ContiguousSender%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20Pattern%203%3A%20Scattered%20%2B%20RDMAAction%0A%0A%20%20%20%20Register%20each%20buffer%20at%20init%2C%20build%20a%20transfer%20plan%20once%20via%20handshake%3A%0A%0A%20%20%20%20**What%20is%20RDMAAction%3F**%0A%0A%20%20%20%20Think%20of%20%60RDMAAction%60%20as%20a%20**transfer%20plan**.%20You%20describe%20all%20the%20reads%2Fwrites%20you%20want%0A%20%20%20%20to%20do%2C%20then%20%60submit()%60%20executes%20the%20whole%20plan%20at%20once%3A%0A%0A%20%20%20%20%60%60%60python%0A%20%20%20%20%23%20Build%20the%20plan%20once%0A%20%20%20%20action%20%3D%20RDMAAction()%0A%20%20%20%20action.read_into(handle1%2C%20local_buffer1)%0A%20%20%20%20action.read_into(handle2%2C%20local_buffer2)%0A%20%20%20%20action.read_into(handle3%2C%20local_buffer3)%0A%0A%20%20%20%20%23%20Execute%20whenever%20you%20want%20-%20just%20one%20call%0A%20%20%20%20action.submit().get()%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20This%20is%20useful%20when%20you%20have%20many%20scattered%20buffers%20(like%20model%20parameters)%20and%20want%0A%20%20%20%20to%20batch%20them%20into%20a%20single%20logical%20operation.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Actor%2C%20RDMAAction%2C%20RDMABuffer%2C%20current_rank%2C%20endpoint%2C%20time%2C%20torch)%3A%0A%20%20%20%20class%20ScatteredSender(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Multiple%20buffers%2C%20each%20registered%20once%20at%20startup.%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20layer_sizes%3A%20list)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.layer_sizes%20%3D%20layer_sizes%0A%20%20%20%20%20%20%20%20%20%20%20%20self.layers%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20self.handles%20%3D%20%5B%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%2C%20size%20in%20enumerate(layer_sizes)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20layer%20%3D%20torch.zeros(size%2C%20dtype%3Dtorch.float32)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20layer.fill_(float(i%20%2B%201))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.layers.append(layer)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Register%20ONCE%20at%20startup%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20byte_view%20%3D%20layer.view(torch.uint8).flatten()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.handles.append(RDMABuffer(byte_view))%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20get_handles(self)%20-%3E%20list%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%5B(size%2C%20handle)%20for%20size%2C%20handle%20in%20zip(self.layer_sizes%2C%20self.handles)%5D%0A%0A%20%20%20%20class%20ScatteredReceiver(Actor)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Receives%20from%20scattered%20sender%20with%20RDMAAction%20batching.%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20layer_sizes%3A%20list)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.layer_sizes%20%3D%20layer_sizes%0A%20%20%20%20%20%20%20%20%20%20%20%20self.layers%20%3D%20%5Btorch.zeros(size%2C%20dtype%3Dtorch.float32)%20for%20size%20in%20layer_sizes%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20self.rank%20%3D%20current_rank().rank%0A%20%20%20%20%20%20%20%20%20%20%20%20self.action%20%3D%20None%20%20%23%20Built%20on%20handshake%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20handshake(self%2C%20sender%3A%20ScatteredSender)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Call%20once%20to%20build%20the%20RDMAAction%20transfer%20plan.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20handles%20%3D%20sender.get_handles.call_one().get()%0A%20%20%20%20%20%20%20%20%20%20%20%20self.action%20%3D%20RDMAAction()%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%2C%20(size%2C%20handle)%20in%20enumerate(handles)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20byte_view%20%3D%20self.layers%5Bi%5D.view(torch.uint8).flatten()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.action.read_into(handle%2C%20byte_view)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%22Transfer%20plan%20ready%22%0A%0A%20%20%20%20%20%20%20%20%40endpoint%0A%20%20%20%20%20%20%20%20def%20receive_step(self)%20-%3E%20dict%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Execute%20the%20cached%20transfer%20plan.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20start%20%3D%20time.perf_counter()%0A%20%20%20%20%20%20%20%20%20%20%20%20self.action.submit().get()%0A%20%20%20%20%20%20%20%20%20%20%20%20elapsed_ms%20%3D%20(time.perf_counter()%20-%20start)%20*%201000%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%22elapsed_ms%22%3A%20elapsed_ms%7D%0A%0A%20%20%20%20print(%22ScatteredSender%3A%20Registers%20each%20layer%20once%22)%0A%20%20%20%20print(%22ScatteredReceiver%3A%20handshake()%20builds%20plan%2C%20receive_step()%20executes%20it%22)%0A%20%20%20%20return%20ScatteredReceiver%2C%20ScatteredSender%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%23%20Running%20the%20Benchmark%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20ContiguousReceiver%2C%0A%20%20%20%20ContiguousSender%2C%0A%20%20%20%20NaiveReceiver%2C%0A%20%20%20%20NaiveSender%2C%0A%20%20%20%20ScatteredReceiver%2C%0A%20%20%20%20ScatteredSender%2C%0A%20%20%20%20is_rdma_available%2C%0A%20%20%20%20this_host%2C%0A)%3A%0A%20%20%20%20def%20run_benchmark()%3A%0A%20%20%20%20%20%20%20%20%22%22%22Compare%20the%20three%20approaches%20over%20multiple%20steps.%22%22%22%0A%20%20%20%20%20%20%20%20if%20not%20is_rdma_available()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%22%E2%9A%A0%20RDMA%20not%20available%20on%20this%20machine.%20Skipping%20benchmark.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%22%20%20Run%20on%20an%20RDMA-capable%20host%20to%20see%20real%20results.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20None%0A%0A%20%20%20%20%20%20%20%20layer_sizes%20%3D%20%5B10000%2C%2050000%2C%2020000%5D%20%20%23%2080000%20floats%20total%0A%20%20%20%20%20%20%20%20total_size%20%3D%20sum(layer_sizes)%0A%20%20%20%20%20%20%20%20num_steps%20%3D%205%0A%0A%20%20%20%20%20%20%20%20host%20%3D%20this_host()%0A%20%20%20%20%20%20%20%20sender_procs%20%3D%20host.spawn_procs(per_host%3D%7B%22procs%22%3A%201%7D)%0A%20%20%20%20%20%20%20%20receiver_procs%20%3D%20host.spawn_procs(per_host%3D%7B%22procs%22%3A%201%7D)%0A%0A%20%20%20%20%20%20%20%20%23%20Spawn%20all%20actors%0A%20%20%20%20%20%20%20%20naive_sender%20%3D%20sender_procs.spawn(%22naive_s%22%2C%20NaiveSender%2C%20layer_sizes)%0A%20%20%20%20%20%20%20%20naive_receiver%20%3D%20receiver_procs.spawn(%22naive_r%22%2C%20NaiveReceiver%2C%20layer_sizes)%0A%0A%20%20%20%20%20%20%20%20cont_sender%20%3D%20sender_procs.spawn(%22cont_s%22%2C%20ContiguousSender%2C%20layer_sizes)%0A%20%20%20%20%20%20%20%20cont_receiver%20%3D%20receiver_procs.spawn(%22cont_r%22%2C%20ContiguousReceiver%2C%20total_size)%0A%0A%20%20%20%20%20%20%20%20scat_sender%20%3D%20sender_procs.spawn(%22scat_s%22%2C%20ScatteredSender%2C%20layer_sizes)%0A%20%20%20%20%20%20%20%20scat_receiver%20%3D%20receiver_procs.spawn(%22scat_r%22%2C%20ScatteredReceiver%2C%20layer_sizes)%0A%0A%20%20%20%20%20%20%20%20%23%20%E2%94%80%E2%94%80%20WARMUP%20%E2%94%80%E2%94%80%0A%20%20%20%20%20%20%20%20%23%20Force%20the%20full%20RDMA%20initialization%20chain%20(RdmaController%20spawn%2C%0A%20%20%20%20%20%20%20%20%23%20RdmaManagerActor%20spawn%2C%20QP%20establishment)%20so%20benchmarks%20measure%0A%20%20%20%20%20%20%20%20%23%20only%20what%20we%20intend%20to%20measure.%0A%20%20%20%20%20%20%20%20print(%22Warming%20up%20RDMA%20subsystem...%22)%0A%20%20%20%20%20%20%20%20naive_receiver.warmup.call_one(naive_sender).get()%0A%20%20%20%20%20%20%20%20cont_receiver.warmup.call_one(cont_sender).get()%0A%20%20%20%20%20%20%20%20scat_receiver.handshake.call_one(scat_sender).get()%0A%20%20%20%20%20%20%20%20scat_receiver.receive_step.call_one().get()%20%20%23%20warm%20the%20transfer%20path%0A%20%20%20%20%20%20%20%20print(%22Warmup%20complete.%5Cn%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%3D%3D%3D%20RDMA%20Buffer%20Pattern%20Benchmark%20%3D%3D%3D%22)%0A%20%20%20%20%20%20%20%20print(f%22Transferring%20%7Btotal_size%7D%20floats%20(%7Btotal_size%20*%204%20%2F%201024%3A.1f%7D%20KB)%20x%20%7Bnum_steps%7D%20steps%5Cn%22)%0A%0A%20%20%20%20%20%20%20%20results%20%3D%20%7B%7D%0A%0A%20%20%20%20%20%20%20%20%23%20Pattern%201%3A%20Naive%20(re-register%20each%20step)%0A%20%20%20%20%20%20%20%20times%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20for%20step%20in%20range(num_steps)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20r%20%3D%20naive_receiver.receive_step.call_one(naive_sender).get()%0A%20%20%20%20%20%20%20%20%20%20%20%20times.append(r%5B%22elapsed_ms%22%5D)%0A%20%20%20%20%20%20%20%20results%5B%22Naive%22%5D%20%3D%20times%0A%20%20%20%20%20%20%20%20print(f%22Pattern%201%20%E2%80%94%20Naive%20(re-register%20each%20step)%3A%22)%0A%20%20%20%20%20%20%20%20for%20i%2C%20t%20in%20enumerate(times)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20Step%20%7Bi%2B1%7D%3A%20%7Bt%3A.2f%7Dms%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20Average%3A%20%7Bsum(times)%2Flen(times)%3A.2f%7Dms%5Cn%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Pattern%202%3A%20Contiguous%20(one%20buffer%2C%20one%20read)%0A%20%20%20%20%20%20%20%20times%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20for%20step%20in%20range(num_steps)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20r%20%3D%20cont_receiver.receive_step.call_one(cont_sender).get()%0A%20%20%20%20%20%20%20%20%20%20%20%20times.append(r%5B%22elapsed_ms%22%5D)%0A%20%20%20%20%20%20%20%20results%5B%22Contiguous%22%5D%20%3D%20times%0A%20%20%20%20%20%20%20%20print(f%22Pattern%202%20%E2%80%94%20Contiguous%20(one%20buffer%2C%20one%20read)%3A%22)%0A%20%20%20%20%20%20%20%20for%20i%2C%20t%20in%20enumerate(times)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20Step%20%7Bi%2B1%7D%3A%20%7Bt%3A.2f%7Dms%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20Average%3A%20%7Bsum(times)%2Flen(times)%3A.2f%7Dms%5Cn%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Pattern%203%3A%20Scattered%20%2B%20RDMAAction%20(batched%20plan)%0A%20%20%20%20%20%20%20%20scat_receiver.handshake.call_one(scat_sender).get()%20%20%23%20rebuild%20plan%0A%20%20%20%20%20%20%20%20times%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20for%20step%20in%20range(num_steps)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20r%20%3D%20scat_receiver.receive_step.call_one().get()%0A%20%20%20%20%20%20%20%20%20%20%20%20times.append(r%5B%22elapsed_ms%22%5D)%0A%20%20%20%20%20%20%20%20results%5B%22Scattered%22%5D%20%3D%20times%0A%20%20%20%20%20%20%20%20print(f%22Pattern%203%20%E2%80%94%20Scattered%20%2B%20RDMAAction%20(batched%20plan)%3A%22)%0A%20%20%20%20%20%20%20%20for%20i%2C%20t%20in%20enumerate(times)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20Step%20%7Bi%2B1%7D%3A%20%7Bt%3A.2f%7Dms%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20Average%3A%20%7Bsum(times)%2Flen(times)%3A.2f%7Dms%5Cn%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%3D%3D%3D%20What's%20Happening%20%3D%3D%3D%22)%0A%20%20%20%20%20%20%20%20print(%22Naive%3A%20Re-registers%20MRs%20%2B%20sequential%20per-layer%20reads%20(~9ms)%22)%0A%20%20%20%20%20%20%20%20print(%22Contiguous%3A%20One%20MR%2C%20one%20read%20%E2%80%94%20fewest%20round%20trips%20(~3ms)%22)%0A%20%20%20%20%20%20%20%20print(%22Scattered%20%2B%20RDMAAction%3A%20Pre-built%20transfer%20plan%20(~8ms%2C%20Python%20overhead)%22)%0A%0A%20%20%20%20%20%20%20%20return%20results%0A%0A%20%20%20%20benchmark_results%20%3D%20run_benchmark()%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20**What%20the%20benchmark%20shows%3A**%0A%0A%20%20%20%20-%20**Naive**%20(~9ms)%3A%20Re-registers%20MRs%20each%20step%2C%20plus%20sequential%20per-layer%20reads.%0A%20%20%20%20%20%20At%20larger%20buffer%20sizes%20the%20MR%20cost%20grows%2C%20but%20here%20it's%20masked%20by%20Python%20overhead.%0A%20%20%20%20-%20**Contiguous**%20(~3ms)%3A%20One%20MR%2C%20one%20%60read_into()%60%20%E2%80%94%20fewest%20round%20trips%20wins.%0A%20%20%20%20%20%20The%20trade-off%3A%20in%20practice%2C%20model%20parameters%20aren't%20contiguous%2C%20so%20you'd%20need%0A%20%20%20%20%20%20to%20copy%20into%20a%20contiguous%20staging%20buffer%20first.%0A%20%20%20%20-%20**Scattered%20%2B%20RDMAAction**%20(~8ms)%3A%20Pre-built%20transfer%20plan%2C%20works%20with%20non-contiguous%0A%20%20%20%20%20%20layouts.%20Currently%20has%20Python%20overhead%20from%20the%20batching%20logic%3B%20lowering%20%60RDMAAction%60%0A%20%20%20%20%20%20into%20Rust%20will%20close%20the%20gap%20with%20Contiguous.%0A%0A%20%20%20%20The%20key%20lesson%3A%20**minimize%20round%20trips.**%20Whether%20that%20means%20packing%20into%20one%20buffer%0A%20%20%20%20or%20batching%20via%20%60RDMAAction%60%2C%20the%20goal%20is%20the%20same%20%E2%80%94%20fewer%20Python-to-Rust-to-NIC%0A%20%20%20%20transitions%20per%20sync.%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%23%23%20Summary%0A%0A%20%20%20%20We%20started%20with%20a%20question%20%E2%80%94%20*where%20do%20the%20milliseconds%20go%3F*%20%E2%80%94%20and%20traced%20the%20answer%0A%20%20%20%20through%20two%20layers%3A%0A%0A%20%20%20%201.%20**ibverbs%20internals**%20%E2%80%94%20QPs%2C%20MRs%2C%20CQs%3A%20the%20primitives%20that%20make%20RDMA%20work%2C%20and%20how%0A%20%20%20%20%20%20%20Monarch's%20actor%20model%20wraps%20them%20into%20composable%20connections%0A%20%20%20%202.%20**RDMA%20buffer%20patterns**%20%E2%80%94%20From%20naive%20re-registration%20to%20contiguous%20buffers%0A%20%20%20%20%20%20%20and%20batched%20transfer%20plans%20via%20%60RDMAAction%60%20%E2%80%94%20minimizing%20Python%20round%20trips%0A%0A%20%20%20%20We%20focused%20on%20**ibverbs**%20specifically%20because%20that's%20what%20Monarch's%20RDMA%20subsystem%0A%20%20%20%20supports%20today%20(InfiniBand%20and%20RoCE%20via%20Mellanox%2FNVIDIA%20ConnectX%20NICs).%20EFA%20(Elastic%0A%20%20%20%20Fabric%20Adapter%2C%20used%20on%20AWS)%20is%20a%20relevant%20transport%20but%20not%20yet%20supported%20%E2%80%94%20it's%0A%20%20%20%20actively%20being%20worked%20on.%0A%0A%20%20%20%20The%20main%20notebook%20(06)%20covers%20the%20high-level%20patterns%20for%20async%20RL%20weight%20sync%20%E2%80%94%0A%20%20%20%20magic%20pointers%2C%20CPU%20staging%2C%20circular%20buffers%2C%20and%20DTensor%20re-sharding.%20This%20notebook%0A%20%20%20%20showed%20the%20RDMA%20specifics%20underneath%3A%20what%20the%20NIC%20is%20actually%20doing%20and%20how%20to%20avoid%0A%20%20%20%20paying%20unnecessary%20costs%20on%20the%20hot%20path.%0A%0A%20%20%20%20---%0A%0A%20%20%20%20**Previous%3A**%20%5BNB06%20%E2%80%94%20RDMA%20Weight%20Sync%5D(.%2F06_rdma_weight_sync.html)%20%C2%B7%20**Next%3A**%20%5BNB07%20%E2%80%94%20Async%20RL%20E2E%5D(.%2F07_rl_e2e.html)%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A
</marimo-code>

<marimo-code-hash hidden="">b357552be3ee2f895d8681ad65bc8f78</marimo-code-hash>
</body>
</html>
